/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/ui/base/ManagedObject","./Billboard","../thirdparty/html2canvas","./PolylineGeometry","./PolylineMaterial","./PolylineMesh","../BillboardStyle","../LeaderLineMarkStyle","./ThreeUtils"],function(t,e,a,r,i,l,s,o,n,h){"use strict";var p=a.extend("sap.ui.vk.threejs.Callout",{metadata:{library:"sap.ui.vk",properties:{anchorNode:{type:"any",defaultValue:null},depthTest:{type:"boolean",defaultValue:true}}}});p.prototype.init=function(){if(a.prototype.init){a.prototype.init.call(this)}this._lines=[];this._heads=[]};p.prototype.exit=function(){if(a.prototype.exit){a.prototype.exit.call(this)}this._lines.forEach(function(t){h.disposeObject(t)});this._lines=null;this._heads.forEach(function(t){h.disposeObject(t)});this._heads=null};p.prototype._traverse=function(t){a.prototype._traverse.call(this,t);this._lines.forEach(t);this._heads.forEach(t)};p.prototype.setDepthTest=function(t){this.setProperty("depthTest",t,true);this._traverse(function(e){e.material.depthTest=t});return this};var d=new THREE.Vector4,u=new THREE.Vector4,y=new THREE.Vector4,c=new THREE.Vector2,x=new THREE.Vector2,m=new THREE.Vector2,f=new THREE.Quaternion,v=new THREE.Matrix4,M=new THREE.Vector2,g=new THREE.Vector3,w=new THREE.Vector3,E=new THREE.Vector3(0,0,1),T=new THREE.Matrix4,b=new THREE.Matrix4;p.prototype._update=function(t,e,a){var r=this.getNode();if(!r||!r.visible){return}if(this._needUpdateTexture){this._needUpdateTexture=false;this._updateTexture()}r.matrix.copy(r.parent.matrixWorld).invert();r.matrix.decompose(r.position,r.quaternion,r.scale);r.matrixWorld.identity();var i=this.getPosition(),l=this._billboard.position;if(i){l.copy(i)}else{l.setScalar(0)}var s=this.getAnchorNode();if(s){l.applyMatrix4(s.matrixWorld)}this._billboard.quaternion.copy(e.quaternion);T.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);d.copy(l).applyMatrix4(T);c.copy(d).multiplyScalar(1/d.w).multiply(a);var n=d.w*2/(a.x*e.projectionMatrix.elements[0]);this._billboard.scale.set(n*this._width,n*this._height,1);g.setFromMatrixColumn(e.matrixWorld,0).multiplyScalar(n*(Math.round(c.x*.5)-c.x*.5));w.setFromMatrixColumn(e.matrixWorld,1).multiplyScalar(n*(Math.round(c.y*.5)-c.y*.5));l.add(g).add(w);this._billboard.updateMatrix();this._billboard.updateMatrixWorld();var h=this.getStyle()===o.CircularShape;var p=e.near;function _(t,e,a){if(t<e){return t-e}else if(t>a){return t-a}return 0}this._lines.forEach(function(t){if(t.userData.targetNode){t.matrix.copy(t.userData.targetNode.matrixWorld)}else{t.matrix.identity()}t.matrixWorld.copy(t.matrix);if(t.isPolylineMesh){t.material.resolution.copy(a)}if(t.isHaloMesh){return}var r=t.geometry.vertices;var i=r[0];var l=r[r.length-2];var s=r[r.length-1];var o=t.userData.startPointMesh;var n=false;var g=[0,r.length-1];if(o!==undefined){i.copy(o.userData.targetVertex)}b.multiplyMatrices(T,t.matrixWorld);if(t.userData.extensionLength>0&&r.length>2){g.push(r.length-2);d.copy(r[r.length-3]).applyMatrix4(b);x.copy(d).multiplyScalar(1/d.w).multiply(a);l.set(Math.sign(x.x-c.x)*.5*(1+t.userData.extensionLength/this._width),0,0);l.applyMatrix4(this._billboard.matrixWorld).applyMatrix4(v.copy(t.matrixWorld).invert())}d.copy(l).applyMatrix4(b);x.copy(d).multiplyScalar(1/d.w).multiply(a);if(h){var w=M.copy(x).sub(c).length();n=w<this._width;M.multiplyScalar(.5/w);s.set(M.x,M.y,0)}else{var S=_(x.x,c.x-this._width,c.x+this._width),D=_(x.y,c.y-this._height,c.y+this._height);n=S===0&&D===0;if(Math.abs(S)>Math.abs(D)){s.set(Math.sign(S)*.5,0,0)}else{s.set(0,Math.sign(D)*.5,0)}}if(n){s.copy(l)}else{s.applyMatrix4(this._billboard.matrixWorld).applyMatrix4(v.copy(t.matrixWorld).invert())}t.geometry.verticesNeedUpdate=true;if(o!==undefined){o.position.copy(o.userData.targetVertex).applyMatrix4(t.matrixWorld);d.copy(o.position).applyMatrix4(T);var R=d.w/(a.x*e.projectionMatrix.elements[0]);o.scale.setScalar(R);o.visible=false;var H=false;if(d.w>=p){u.copy(d);y.copy(r[1]).applyMatrix4(b);if(y.w<p){var P=(u.w-p)/(u.w-y.w);y.sub(u).multiplyScalar(P).add(u)}m.copy(u).multiplyScalar(1/u.w);x.copy(y).multiplyScalar(1/y.w);M.copy(x).sub(m).multiply(a);H=M.length()<o.userData.lineOffset;f.setFromAxisAngle(E,Math.atan2(M.y,M.x));o.quaternion.copy(e.quaternion).multiply(f);o.updateMatrix();o.matrixWorld.copy(o.matrix);o.matrixWorldNeedsUpdate=false;m.multiply(a).sub(c);o.visible=h?m.length()>this._width:Math.abs(m.x)>this._width||Math.abs(m.y)>this._height;if(H||!o.visible){i.copy(r[1])}else{i.set(o.userData.lineOffset,0,0).applyMatrix4(o.matrixWorld).applyMatrix4(v.copy(t.matrixWorld).invert())}}}t.geometry._updateVertices(g);t.computeLineDistances(b,a,e instanceof THREE.PerspectiveCamera?p:undefined);if(t.userData.haloMesh){t.userData.haloMesh.material.lineLength=t.material.lineLength}}.bind(this))};p.prototype._createMarkMesh=function(t,e,a,r){var i=a===n.Arrow;var l=window.devicePixelRatio;var s=e.width;var o=s*e.haloWidth;r=(Array.isArray(r)||r instanceof Float32Array)&&r.length===2?r:[1,1];var h,p;if(i){h=Math.max(35*r[0],s*5);p=Math.max(15*r[1],s*2)}else{h=p=Math.max(2*r[0],s*2)}h=Math.ceil(h+o*2);p=Math.ceil(p+o*2);var d=document.createElement("canvas");d.width=THREE.MathUtils.ceilPowerOfTwo(h*l);d.height=THREE.MathUtils.ceilPowerOfTwo(p*l);var u=d.getContext("2d");var y=h/2,c=p/2;u.fillStyle="#FFF";u.scale(l,l);if(i){u.beginPath();u.moveTo(0,c);u.lineTo(h,0);u.lineTo(h,p);u.closePath();u.fill();var x=h*c/Math.sqrt(h*h+c*c),m=(x-o)/x;var f=h-h*m,v=c*(h*m-o)/h;u.fillStyle=t.getStyle();u.beginPath();u.moveTo(f,c);u.lineTo(h-o,c-v);u.lineTo(h-o,c+v);u.closePath();u.fill()}else{var M=h*.5,g=M-o;u.beginPath();u.ellipse(y,c,M,M,0,0,Math.PI*2);u.fill();u.fillStyle=t.getStyle();u.beginPath();u.ellipse(y,c,g,g,0,0,Math.PI*2);u.fill()}u.fillRect(h-o,c-s*.5,o,s);var w=new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(d),transparent:true,alphaTest:.05,premultipliedAlpha:true,side:THREE.DoubleSide,depthTest:this.getDepthTest()});var E=new THREE.PlaneGeometry(h*2,p*2);if(i){E.translate(h,0,0)}var T=new THREE.Mesh(E,w);T.userData.skipIt=true;T.userData.lineOffset=i?h*2-1:h-o*2;var b=new THREE.Vector2(h*l/d.width,p*l/d.height);var _=T.geometry.attributes.uv.array;for(var S=0,D=_.length;S<D;S+=2){_[S]*=b.x;_[S+1]=1-(1-_[S+1])*b.y}return T};p.prototype.addLeaderLine=function(t,e,a,r,o,h,p){var d=this.getNode();if(p>0&&t.length<3){t.push(t[t.length-1].clone())}var u=a.userData.lineStyle||{};u.width=u.width||1;u.haloWidth=u.haloWidth||0;u.endCapStyle=u.endCapStyle||0;var y=u.endCapStyle||t.length>2?1:0;var c=(y&&(r!==n.None||u.endCapStyle===0)?1:0)|(y&&(o!==n.None||u.endCapStyle===0)?2:0);var x=new i;x.setVertices(t);var m;if(u.haloWidth>0){var f=new l({color:16777215,lineColor:16777215,linewidth:u.width*(u.haloWidth*2+1),dashCapStyle:u.endCapStyle,segmentCapStyle:y,trimStyle:c,transparent:true,depthTest:this.getDepthTest()});m=new s(x,f);m.userData.skipIt=true;m.userData.targetNode=e;m.matrixAutoUpdate=false;m.renderOrder=this.getRenderOrder();m.isHaloMesh=true;d.add(m);this._lines.push(m)}var v=new l({color:16777215,lineColor:a.color,linewidth:u.width,dashCapStyle:u.endCapStyle,segmentCapStyle:y,trimStyle:c,dashPattern:u.dashPattern||[],dashScale:u.dashPatternScale||1,transparent:true,depthTest:this.getDepthTest()});var M=new s(x,v);M.userData.skipIt=true;M.userData.targetNode=e;M.userData.extensionLength=p;M.userData.haloMesh=m;M.matrixAutoUpdate=false;M.renderOrder=this.getRenderOrder();d.add(M);this._lines.push(M);if(r!==n.None){var g=this._createMarkMesh(a.color,u,r,h);g.userData.targetVertex=x.vertices[0].clone();g.matrixAutoUpdate=false;g.renderOrder=this.getRenderOrder();M.userData.startPointMesh=g;d.add(g);this._heads.push(g)}return M};return p});
//# sourceMappingURL=Callout.js.map