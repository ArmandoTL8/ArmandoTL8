/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.script","sap/base/Log","../thirdparty/three","../ContentManager","./Scene","../TransformationMatrix","./PerspectiveCamera","./OrthographicCamera","../Messages","../getResourceBundle","./ContentDeliveryService","./ThreeUtils","./Viewport","./ViewStateManager"],function(jQuery,e,r,t,a,o,n,i,s,d,l,u){"use strict";var c=function(e){Object.defineProperties(this,{source:{value:e.getSource()},sourceType:{value:e.getSourceType()},sourceId:{value:null,writable:true},name:{value:null,writable:true},localMatrix:{value:null,writable:true},children:{value:[]},nodeProxy:{value:null,writable:true},loader:{value:null,writable:true},builder:{value:null,writable:true}});e._shadowContentResource=this};var f=t.extend("sap.ui.vk.threejs.ContentManager",{metadata:{library:"sap.ui.vk"}});var h=f.getMetadata().getParent().getClass().prototype;f.prototype.init=function(){if(h.init){h.init.call(this)}this._shadowContentResources=[]};f.prototype.exit=function(){if(this.defaultCdsLoader){this.defaultCdsLoader.destroy();this.defaultCdsLoader=null}if(this.defaultMataiLoader){this.defaultMataiLoader.destroy();this.defaultMataiLoader=null}if(h.exit){h.exit.call(this)}this._shadowContentResources=null};f.prototype._handleContentChangesProgress=function(e){this.fireContentChangesProgress({phase:e.getParameter("phase"),source:e.getParameter("source"),percentage:e.getParameter("percentage")})};f.prototype._handleContentLoadingFinished=function(e){this.fireContentLoadingFinished({source:e.getParameter("source"),node:e.getParameter("node")})};function g(e){if(e&&e.isMesh){e.castShadow=true;e.receiveShadow=false}if(e&&e.children){for(var r=0;r<e.children.length;r++){g(e.children[r])}}}function p(e,r){if(e){var t=new THREE.Group;e.add(t);t.name="DefaultLights";t.private=true;var a=(new THREE.Box3).setFromObject(e);var o=a.getSize(new THREE.Vector3);var n=a.getCenter(new THREE.Vector3);var i=o.length();var s=new THREE.PointLight;s.color.setRGB(.72,.72,.81);s.visible=true;s.private=true;t.add(s);var d=[new THREE.Color(.2,.2,.2),new THREE.Color(.32,.32,.36),new THREE.Color(.36,.36,.36)];var l=[new THREE.Vector3(2,-.5,-1.5),new THREE.Vector3(-2,-2.5,1.1),new THREE.Vector3(-.04,2,.01)];for(var u=0,c=d.length;u<c;u++){var f=new THREE.DirectionalLight;f.color.copy(d[u]);f.position.copy(l[u]);f.private=true;f.updateWorldMatrix(false,false);t.add(f)}if(r){g(e);var h=new THREE.DirectionalLight;h.color.setRGB(.5,.5,.5);h.position.set(0,1,0);h.castShadow=true;h.shadow.mapSize.width=512;h.shadow.mapSize.height=512;var p=2e3;h.shadow.camera.left=-p;h.shadow.camera.right=p;h.shadow.camera.top=p;h.shadow.camera.bottom=-p;h.shadow.camera.far=3500;h.shadow.bias=-1e-4;h.private=true;t.add(h);var v=new THREE.PlaneGeometry(o.x,o.z);var C=new THREE.ShadowMaterial;C.opacity=.2;var y=new THREE.Mesh(v,C);y.rotation.x=-Math.PI/2;y.position.x=n.x;y.position.y=a.min.y-i*.1;y.position.z=n.z;e.add(y);y.receiveShadow=true}}}f.prototype.loadContent=function(r,t){this.fireContentChangesStarted();var o=r||new a(new THREE.Scene);var n=this;this._loadContentResources(o,t).then(function(t){e.info("Content loading resolved");if(t){for(var a=0;a<t.length;++a){if(!o.getInitialView()&&t[a].initialView){o.setInitialView(t[a].initialView)}o.camera=o.camera||t[a].camera;var i=t[a].contentResource?t[a].contentResource._shadowContentResource:null;if(t[a].loader){if(i){i.loader=t[a].loader}o.loaders=o.loaders||[];o.loaders.push(t[a].loader)}if(t[a].builder){if(i){i.builder=t[a].builder}o.builders=o.builders||[];o.builders.push(t[a].builder)}}if(t.length>0){var s=t[0];o.backgroundTopColor=s.backgroundTopColor;o.backgroundBottomColor=s.backgroundBottomColor;o.renderMode=s.renderMode;o.upAxis=s.upAxis}}o.getSceneRef().updateMatrixWorld();if(!r){p(o.getSceneRef(),false)}if(o.loaders){n._initSceneWithCDSLoaderIfExists(o,o.loaders)}n.fireContentChangesFinished({content:o})},function(r){e.info("Content loading rejected:",r);var t;if(typeof r==="string"){t=r}else if(r.errorText){t=r.errorText}else if(r.message){t=r.message}t=t||d().getText(s.VIT37.summary);e.error(d().getText("CONTENTMANAGER_MSG_CONTENTRESOURCESFAILEDTOLOAD"),t);n.fireContentChangesFinished({content:null,failureReason:[{error:r,errorMessage:t}]})});return this};f.prototype._findLoader=function(e){if(e._contentManagerResolver&&e._contentManagerResolver.settings&&e._contentManagerResolver.settings.loader){return Promise.resolve(e._contentManagerResolver.settings.loader)}if(e.getSource()){var r=e.getSourceType().toLowerCase();var t=this;switch(r){case"stream":{if(this.defaultCdsLoader==null){return new Promise(function(e){var r="sap/ui/vk/threejs/ContentDeliveryService";sap.ui.require([r],function(r){e(t.defaultCdsLoader=new r({authorizationHandler:t._authorizationHandler}))})})}return Promise.resolve(this.defaultCdsLoader)}case"vds4":{if(this.defaultMataiLoader==null){return new Promise(function(e){var r="sap/ui/vk/matai/MataiLoader";sap.ui.require([r],function(r){e(t.defaultMataiLoader=new r)})})}return Promise.resolve(this.defaultMataiLoader)}default:break}}return Promise.resolve(null)};f.prototype._loadContentResources=function(e,r){function t(e,r){if(typeof r==="string"){return(e||"")+r}return null}function a(e,r){if(!e&&!r){return true}else if(!!e^!!r){return false}else{return e.source===r.getSource()&&e.sourceType===r.getSourceType()}}function n(e,r){r._shadowContentResource=e;var t=e.nodeProxy.getNodeRef();e.name=r.getName();t.name=e.name;e.sourceId=r.getSourceId();t.sourceId=e.sourceId;function a(e,r){if(!e&&!r){return true}var t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var a=e||t,o=r||t;for(var n=0;n<t.length;++n){if(a[n]!==o[n]){return false}}return true}if(!a(e.localMatrix,r.getLocalMatrix())){e.localMatrix=r.getLocalMatrix();t.matrix.fromArray(o.convertTo4x4(e.localMatrix));t.matrix.decompose(t.position,t.quaternion,t.scale);t.matrixWorldNeedsUpdate=true}}var i=[];var s=new Map;function d(e){var r=t(e.sourceType,e.source);var a=s.get(r);if(!a){a=[];s.set(r,a)}a.push(e);var o=e.nodeProxy.getNodeRef();o.parent.remove(o);e.children.forEach(function(e){d(e)});e.children.length=0}function l(r,t){var a=new c(r);var o=new THREE.Group;t.add(o);o.matrixWorldNeedsUpdate=true;a.nodeProxy=e.getDefaultNodeHierarchy().createNodeProxy(o);n(a,r);i.push(r);return a}(function e(r,t,o){var i=0;var s=jQuery.sap.arrayDiff(r,t,a,true);s.forEach(function(a){for(;i<a.index;++i){n(r[i],t[i]);e(r[i].children,t[i].getContentResources(),r[i].nodeProxy.getNodeRef())}if(a.type==="delete"){d(r[a.index]);r.splice(a.index,1)}else if(a.type==="insert"){var s=l(t[a.index],o);r.splice(a.index,0,s);e(s.children,t[a.index].getContentResources(),s.nodeProxy.getNodeRef())}++i});for(;i<r.length;++i){n(r[i],t[i]);e(r[i].children,t[i].getContentResources(),r[i].nodeProxy.getNodeRef())}})(this._shadowContentResources,r,e.getSceneRef());var f=[];i.forEach(function(r){var a=r._shadowContentResource.nodeProxy.getNodeRef();var o=t(r.getSourceType(),r.getSource());var n=s.get(o);if(o&&n&&n.length>0){var i=n.pop();var d=i.nodeProxy.getNodeRef();for(var l=0;l<d.children.length;++l){a.add(d.children[l])}if(i.loader){r._shadowContentResource.loader=i.loader}if(i.builder){r._shadowContentResource.builder=i.builder}e.getDefaultNodeHierarchy().destroyNodeProxy(i.nodeProxy);i.nodeProxy=null}else{var u=this;f.push(this._findLoader(r).then(function(e){if(e){if(e.attachContentChangesProgress){e.attachContentChangesProgress(u._handleContentChangesProgress,u)}if(e.attachContentLoadingFinished){e.attachContentLoadingFinished(u._handleContentLoadingFinished,u)}}if(typeof e==="function"){return e(a,r,u._authorizationHandler,u._retryCount)}else if(e&&e.load){return e.load(a,r,u._authorizationHandler,u._retryCount)}else{return Promise.resolve({node:a,contentResource:r})}}))}},this);function h(e){var r=[];var t=[];u.getAllTHREENodes([e],r,t);var a=new Map;var o=new Map;r.forEach(function(e){if(e instanceof THREE.Mesh){if(!o.has(e.geometry.uuid)){u.disposeGeometry(e);o.set(e.geometry.uuid,true)}if(e.material){if(!a.has(e.material.uuid)){u.disposeMaterial(e.material);a.set(e.material.uuid,true)}}if(e.userData&&e.userData.originalMaterial&&e.userData.originalMaterial.uuid!==e.material.uuid&&!a.has(e.userData.originalMaterial.uuid)){u.disposeMaterial(e.userData.originalMaterial);a.set(e.userData.originalMaterial.uuid,true)}}if(e.parent){e.parent.remove(e)}});t.forEach(function(e){if(e.parent){e.parent.remove(e)}});a.clear();o.clear()}s.forEach(function(e,r){for(var t=0;t<e.length;++t){var a=e[t];h(a.nodeProxy.getNodeRef());if(a.builder){a.builder.cleanup()}if(a.loader){if(a.loader._loader&&a.loader._loader.sceneBuilder){a.loader._loader.removeContext(a.loader._loader.currentSceneInfo.id);a.loader._loader.sceneBuilder.cleanup()}if(a.loader.detachContentChangesProgress){a.loader.detachContentChangesProgress(this._handleContentChangesProgress,this)}if(a.loader.detachContentLoadingFinished){a.loader.detachContentLoadingFinished(this._handleContentLoadingFinished,this)}}}},this);if(r.length===1&&r[0].getName()==null&&r[0].getLocalMatrix()==null){r[0]._shadowContentResource.nodeProxy.getNodeRef().userData.skipIt=true}else{r.forEach(function(e){e._shadowContentResource.nodeProxy.getNodeRef().userData.skipIt=false})}return Promise.all(f)};f.prototype._initSceneWithCDSLoaderIfExists=function(e,r){if(r){var t;for(var a=0;a<r.length;a++){if(r[a]instanceof l){t=r[a].getSceneBuilder();break}}if(t){e.setSceneBuilder(t);e.getDefaultNodeHierarchy().attachNodeRemoving(function(e){var r=e.getParameter("nodeRef");if(r.userData.treeNode&&r.userData.treeNode.sid){t.decrementResourceCountersForDeletedTreeNode(r.userData.treeNode.sid)}});return true}}return false};f.prototype.destroyContent=function(e){if(e){e.destroy();this._shadowContentResources=[];if(e.loaders&&Array.isArray(e.loaders)&&e.loaders.length>0){if(e.loaders[0]._loader&&e.loaders[0]._loader.sceneBuilder){e.loaders[0]._loader.removeContext(e.loaders[0]._loader.currentSceneInfo.id);e.loaders[0]._loader.sceneBuilder.cleanup()}if(e.loaders[0].detachContentChangesProgress){e.loaders[0].detachContentChangesProgress(this._handleContentChangesProgress,this)}if(e.loaders[0].detachContentLoadingFinished){e.loaders[0].detachContentLoadingFinished(this._handleContentLoadingFinished,this)}}else if(e.builders&&Array.isArray(e.builders)){e.builders.forEach(function(e){if(e){e.cleanup()}})}}return this};f.prototype.createOrthographicCamera=function(){return new i};f.prototype.createPerspectiveCamera=function(){return new n};return f});
//# sourceMappingURL=ContentManager.js.map