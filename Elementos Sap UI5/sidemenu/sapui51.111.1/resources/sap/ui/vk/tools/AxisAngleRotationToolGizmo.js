/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../thirdparty/three","./Gizmo","./AxisAngleRotationToolGizmoRenderer","./AxisColours","../AnimationTrackType","sap/base/assert"],function(t,e,i,a,o,r,n){"use strict";var s=i.extend("sap.ui.vk.tools.AxisAngleRotationToolGizmo",{metadata:{library:"sap.ui.vk"}});var l=[16711808,o.y,o.z];var h=Math.PI*2,u=Math.PI/2,d=13;var p=THREE.MathUtils.degToRad,c=THREE.MathUtils.radToDeg;s.prototype.init=function(){if(i.prototype.init){i.prototype.init.apply(this)}this._createEditingForm(String.fromCharCode(176),84);this._gizmoIndex=-1;this._handleIndex=-1;this._value=new THREE.Vector3;this._rotationDelta=new THREE.Vector3;this._viewport=null;this._tool=null;this._sceneGizmo=new THREE.Scene;var t=new THREE.DirectionalLight(16777215,.5);t.position.set(1,3,2);this._sceneGizmo.add(t);this._sceneGizmo.add(new THREE.AmbientLight(16777215,.5));this._gizmo=new THREE.Group;this._sceneGizmo.add(this._gizmo);this._touchAreas=new THREE.Group;this._nodes=[];this._matViewProj=new THREE.Matrix4;this._gizmoSize=96;function e(t,e,i){var a=new THREE.TorusGeometry(e,16/96,4,i,t===2?Math.PI:h);if(t===0){a.rotateY(u)}else if(t===1){a.rotateX(u)}else{a.rotateZ(-u)}return new THREE.Mesh(a,new THREE.MeshBasicMaterial({opacity:.2,transparent:true}))}var a;for(a=0;a<3;a++){this._touchAreas.add(e(a,1,24))}for(a=0;a<3;a++){var o=new THREE.Mesh(new THREE.IcosahedronGeometry(.25,0),new THREE.MeshBasicMaterial({opacity:.2,transparent:true}));o.position.setComponent(a,1.6);this._touchAreas.add(o)}};s.prototype._createGizmoObject=function(){var t=new THREE.Group;var e=t.userData;function i(t,e,i,a){var o=new THREE.TorusGeometry(i,1/96,4,a,t===2?Math.PI:h);if(t===0){o.rotateY(u)}else if(t===1){o.rotateX(u)}else{o.rotateZ(-u)}var r=new THREE.Mesh(o,new THREE.MeshBasicMaterial({color:e,transparent:true}));r.matrixAutoUpdate=false;r.userData.color=e;return r}function a(t,e){var i=96*3,a=2,o=12*3,r=2*3;t.multiplyScalar(1/i);var n=new THREE.MeshLambertMaterial({color:e});var s=new THREE.CylinderGeometry(a,a,i-o,4);var l=(new THREE.Matrix4).makeBasis(new THREE.Vector3(t.y,t.z,t.x),t,new THREE.Vector3(t.z,t.x,t.y));l.setPosition(t.clone().multiplyScalar((i-o)*.5));s.applyMatrix4(l);var h=new THREE.Mesh(s,n);h.matrixAutoUpdate=false;h.userData.color=e;var u=new THREE.CylinderGeometry(0,r,o,12,1);l.setPosition(t.clone().multiplyScalar(i-o*.5));u.applyMatrix4(l);var d=new THREE.Mesh(u,n);d.matrixAutoUpdate=false;h.add(d);return h}var o;for(o=0;o<3;o++){t.add(i(o,l[o],1,128))}e.axisArrow=a(new THREE.Vector3(3,0,0),l[0]);t.add(e.axisArrow);var r=new THREE.BufferGeometry;r.setAttribute("position",new THREE.Float32BufferAttribute(new Float32Array([0,0,0,3,0,0]),3));e.arrowProjection=new THREE.Line(r,new THREE.LineDashedMaterial({color:l[0],transparent:true,scale:10,dashSize:1,gapSize:1}));e.arrowProjection.computeLineDistances();t.add(e.arrowProjection);t.add(new THREE.AxesHelper(1.5));e.arcMeshes=[];for(o=0;o<3;o++){var n=new THREE.Mesh(new THREE.BufferGeometry,new THREE.MeshBasicMaterial({vertexColors:true,opacity:.5,transparent:true,side:THREE.DoubleSide,depthWrite:false}));n.visible=false;e.arcMeshes.push(n);t.add(n)}e.valueLabels=[];for(o=0;o<3;o++){var s=this._createTextMesh("",64,32,d,16777215,false);s.renderOrder=10;s.material.depthTest=false;s.visible=false;e.valueLabels.push(s);t.add(s)}var p=e.axisTitles=this._createAxisTitles();p.scale.setScalar(1/this._gizmoSize);var c=this._gizmoSize*1.6;p.children[0].position.x=c;p.children[1].position.y=c;p.children[2].position.z=c;t.add(p);return t};s.prototype.hasDomElement=function(){return true};s.prototype.resetValues=function(){this._value.setScalar(0)};s.prototype.show=function(t,e){this._viewport=t;this._tool=e;this.handleSelectionChanged();this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:this._getNodesProperties()},true)};s.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._gizmoIndex=this._handleIndex=-1;this._updateEditingForm(false)};s.prototype.getGizmoCount=function(){return this._nodes.length};s.prototype.getTouchObject=function(t){if(this._nodes.length===0){return null}var e=this._gizmo.children[t];v(this._touchAreas.children[2],e.children[2]);v(this._touchAreas.children[0],e.children[0]);this._updateGizmoObjectTransformation(this._touchAreas,t);return this._touchAreas};s.prototype.highlightHandle=function(t,e,i){for(var a=0,o=this._gizmo.children.length;a<o;a++){var r=this._gizmo.children[a];var n=r.userData;for(var s=0;s<3;s++){var l=r.children[s];var h=s===t&&a===e?16776960:l.userData.color;l.material.color.setHex(h);l.material.opacity=t===-1||s===t?1:.35;l.material.visible=i||s===t;var u=n.axisTitles.children[s];u.material.color.setHex(a===e&&s===t-3?16776960:l.userData.color);u.material.opacity=i?1:.35;n.arcMeshes[s].material.visible=i||s===t||s===2&&t===1}}};s.prototype._snapToAxis=function(t){var e=-this._value.y,i=-this._value.z;switch(t){case 0:e+=90;break;case 1:i+=90;break;default:break}this.beginGesture();this._rotate(new THREE.Euler(0,p(e),p(i)));this.endGesture()};s.prototype.selectHandle=function(t,e){this._gizmoIndex=e;this._handleIndex=t;if(t>=3&&t<6){this._snapToAxis(t-3)}this._updateEditValue();this._viewport.setShouldRenderFrame()};function v(t,e){t.quaternion.copy(e.quaternion);t.position.copy(e.position);t.updateMatrix();t.updateMatrixWorld(true)}function m(t){return c(Math.atan2(t[0],t[2]))}function _(t){return c(Math.atan2(t[1],Math.sqrt(t[0]*t[0]+t[2]*t[2])))}function f(t,e){t=p(t);e=p(e);var i=Math.sin(t),a=Math.cos(t);var o=Math.sin(e),r=Math.cos(e);return[i*r,o,a*r]}function g(t,e,i,a){if(t.userData.angle1===i&&t.userData.angle2===a){return}t.userData.angle1=i;t.userData.angle2=a;var o=(new THREE.Color).setHex(l[e]);var r=[0,0,0];var n=[o.r,o.g,o.b];var s=new THREE.Vector3;var u=(e+1)%3,d=(e+2)%3;var p=a-i;var c,v=Math.min(Math.max(Math.ceil(Math.abs(p)*64/Math.PI),1),1e4);var m=Math.min(h/Math.abs(p),1);var _=THREE.MathUtils.lerp;for(c=0;c<=v;c++){var f=1-c/v;var g=i+p*f;var E=_(m,1,f);s.set(0,0,0).setComponent(u,Math.cos(g)*E).setComponent(d,Math.sin(g)*E);r.push(s.x,s.y,s.z);var x=_(1,.5,f);n.push(o.r*x,o.g*x,o.b*x)}var y=[];for(c=0;c<v;c++){y.push(0,c+1,c+2)}var z=t.geometry;z.setIndex(y);z.setAttribute("position",new THREE.Float32BufferAttribute(r,3));z.setAttribute("color",new THREE.Float32BufferAttribute(n,3));t.visible=p!==0}s.prototype._updateGizmoObject=function(t,e,i,a){var o=this._gizmo.children[t];var r=new THREE.Euler(0,p(i-90),0,"YZX");var n=o.children[2];n.quaternion.setFromEuler(r);n.updateMatrix();r.z=p(a);var s=o.children[0];s.quaternion.setFromEuler(r);s.updateMatrix();s.position.setFromMatrixColumn(s.matrix,0).multiplyScalar(2);s.updateMatrix();var l=o.userData;var h=l.axisArrow;h.quaternion.copy(s.quaternion);h.updateMatrix();var u=l.arrowProjection;var d=Math.cos(r.z);u.quaternion.copy(n.quaternion);u.scale.setScalar(d);u.updateMatrix();u.material.scale=d*10;var c=l.arcMeshes;g(c[0],0,0,p(e));v(c[0],o.children[0]);g(c[1],1,0,p(i));v(c[1],o.children[1]);g(c[2],2,0,p(a));v(c[2],o.children[2]);var m=l.valueLabels;x(m[0],e);x(m[1],i);x(m[2],a)};s.prototype.beginGesture=function(){this._rotationDelta.setScalar(0);this._nodes.forEach(function(t){t.beginAngle=t.angle;t.beginAzimuth=t.azimuth;t.beginElevation=t.elevation})};s.prototype._getNodesProperties=function(){return this.getValues()};s.prototype.endGesture=function(){this._nodes.forEach(function(t){delete t.beginAngle;delete t.beginAzimuth;delete t.beginElevation});var t=this._getNodesProperties();this._tool.fireRotated({x:this._rotationDelta.x,y:this._rotationDelta.y,z:this._rotationDelta.z,nodesProperties:t})};function E(t,e){var i=window.devicePixelRatio;var a=t.width;var o=t.height;var r=a*.5;var n=o*.5;var s=Math.min(d*.85*i,r-1);var l=t.getContext("2d");l.font="Bold "+d*i+"px Arial";var h=l.measureText(e);var p=Math.min(h.width*.5-s*.5,r-s-1);l.clearRect(0,0,a,o);l.beginPath();l.arc(r-p,n,s,u,u*3,false);l.lineTo(r+p,n-s);l.arc(r+p,n,s,-u,u,false);l.lineTo(r-p,n+s);l.closePath();l.globalAlpha=.75;l.fillStyle="#fff";l.fill();l.globalAlpha=1;l.lineWidth=i;l.strokeStyle="#000";l.stroke();l.fillStyle="#000";l.textAlign="center";if(sap.ui.Device.browser.chrome||sap.ui.Device.browser.firefox){l.textBaseline="top";l.fillText(e,r,n-h.actualBoundingBoxDescent*.5)}else{l.textBaseline="middle";l.fillText(e,r,n)}}function x(t,e){t.visible=e!==0;if(t.visible&&t.userData.value!==e){t.userData.value=e;var i=e.toLocaleString("fullwide",{useGrouping:false,minimumFractionDigits:1,maximumFractionDigits:1})+"Â°";var a=t.material.map;E(a.image,i);a.needsUpdate=true}}s.prototype._updateEditValue=function(){var t=this._nodes[this._gizmoIndex];if(t){this._value.set(t.angle,t.azimuth,t.elevation)}};s.prototype._calculateRotationQuaternion=function(t){var e=(new THREE.Vector3).fromArray(f(t.azimuth,t.elevation));var i=this._getEffectiveParent(t.node);if(i!==t.node.parent){e.transformDirection(i.matrixWorld);e.transformDirection(t.node.parent.matrixWorld.clone().invert())}return(new THREE.Quaternion).setFromAxisAngle(e,p(t.angle))};s.prototype._updateNodeRotation=function(t){var e=this._calculateRotationQuaternion(t);t.node.quaternion.multiplyQuaternions(e,t.quaternion);t.node.updateMatrix();if(t.node.userData){delete t.node.userData.skipUpdateJointNode}this._viewport._viewStateManager._setJointNodeOffsets(t.node,r.Rotate)};s.prototype._rotate=function(t){this._rotationDelta.set(c(t.x),c(t.y),c(t.z));this._nodes.forEach(function(t){t.angle=t.beginAngle+this._rotationDelta.x;t.azimuth=(t.beginAzimuth+this._rotationDelta.y)%360;t.elevation=THREE.MathUtils.clamp(t.beginElevation+this._rotationDelta.z,-90,90);if(t.azimuth>180){t.azimuth-=360}if(t.azimuth<-180){t.azimuth+=360}this._updateNodeRotation(t)},this);this._updateEditValue();this._viewport.setShouldRenderFrame()};s.prototype._setRotationAxisAngle=function(t,e,i){var a=i-e;if(t!==0){a%=h}var o=new THREE.Euler;o[["x","y","z"][t]]=a;var r=this._getNodesProperties();if(this._tool.fireEvent("rotating",{x:c(o.x),y:c(o.y),z:c(o.z),nodesProperties:r},true)){this._rotate(o)}};s.prototype.rotate=function(t,e,i){this.beginGesture();this._rotate(new THREE.Euler(p(t||0),p(e||0),p(i||0)))};s.prototype._getValueLocaleOptions=function(){return{useGrouping:false,minimumFractionDigits:1,maximumFractionDigits:2}};s.prototype.getValue=function(){return this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3?this._value.getComponent(this._handleIndex):0};s.prototype.setValue=function(t){if(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3){var e=new THREE.Euler;e[["x","y","z"][this._handleIndex]]=p(t-this._value.getComponent(this._handleIndex));this.beginGesture();this._rotate(e);this.endGesture()}};s.prototype.rotateBy=function(t){this.beginGesture();this._rotate(new THREE.Euler(p(t),0,0));this.endGesture()};s.prototype.setAxis=function(t){this.beginGesture();var e=0;var i=0;if(Array.isArray(t)){e=m(t);i=_(t)}else{if("azimuth"in t){e=t.azimuth}if("elevation"in t){i=t.elevation}}this._nodes.forEach(function(t){t.azimuth=e;t.elevation=i;this._updateNodeRotation(t)},this);this._updateEditValue();this._viewport.setShouldRenderFrame();this.endGesture()};s.prototype.getValues=function(){var t=[];this._nodes.forEach(function(e){t.push({node:e.node,angle:e.angle,azimuth:e.azimuth,elevation:e.elevation,axis:f(e.azimuth,e.elevation)})});return t};s.prototype._getNodeInfoByNode=function(t){var e=this._nodes;for(var i=0,a=e.length;i<a;i++){if(e[i].node===t){return e[i]}}return null};s.prototype.setValues=function(t){t.forEach(function(t){var e=this._getNodeInfoByNode(t.node);if(e){e.angle=t.angle;if(t.axis){e.azimuth=m(t.axis);e.elevation=_(t.axis)}else{e.azimuth=t.azimuth;e.elevation=t.elevation}var i=this._calculateRotationQuaternion(e);e.quaternion.multiplyQuaternions(i.invert(),e.node.quaternion);this._updateNodeRotation(e)}},this);this._updateEditValue();this._viewport.setShouldRenderFrame()};s.prototype.expandBoundingBox=function(t){if(this._viewport){this._expandBoundingBox(t,this._viewport.getCamera().getCameraRef(),true)}};s.prototype._updateSelection=function(t){i.prototype._updateSelection.call(this,t);if(this._tool.getEnableSnapping()){this._tool.getDetector().setSource(t)}};s.prototype.handleSelectionChanged=function(t){this._nodes.length=0;this._gizmoIndex=this._handleIndex=-1;if(this._viewport){this._updateSelection(this._viewport._viewStateManager);this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:this._getNodesProperties()},true);this._nodes.forEach(function(t){t.quaternion=t.node.quaternion.clone();t.angle=0;t.azimuth=0;t.elevation=0});var e=this._nodes.length;var i=this._gizmo;while(i.children.length>e){i.remove(i.children[i.children.length-1])}while(i.children.length<e){i.add(this._createGizmoObject())}}};s.prototype._getObjectSize=function(t){var e=new THREE.Box3;this._nodes[t].node._expandBoundingBox(e,true,false);if(e.isEmpty()){return 0}var i=new THREE.Vector3;e.getSize(i);return i.length()};s.prototype._updateGizmoObjectTransformation=function(t,e){var i=this._nodes[e].node;var a=this._getEffectiveParent(i);t.position.setFromMatrixPosition(i.matrixWorld);if(a){t.quaternion.setFromRotationMatrix(a.matrixWorld)}else{t.quaternion.set(0,0,0,1)}var o=this._getGizmoScale(t.position);t.scale.setScalar(this._gizmoSize*o);t.updateMatrix();t.updateMatrixWorld(true);return o};s.prototype._getValuePosition=function(t,e,i,a){i=p(i);a=p(a);var o=new THREE.Euler(0,0,0,"YZX");if(e===0){o.set(0,i,a)}else if(e===1){o.set(0,i*.5,0)}else{o.set(0,i,a*.5)}o.y-=u;t.set(e===0?3.25:1.25,0,0).applyEuler(o)};var y=new THREE.Vector3;s.prototype._updateGizmoTransformation=function(t,e){var i=this._gizmo.children[t];var a=this._nodes[t];var o=this._updateGizmoObjectTransformation(i,t);i.userData.axisTitles.children.forEach(function(t){t.quaternion.copy(i.quaternion).invert().multiply(e.quaternion)});for(var r=0;r<3;r++){var n=i.userData.valueLabels[r];this._getValuePosition(n.position,r,a.azimuth,a.elevation);n.quaternion.copy(i.quaternion).invert().multiply(e.quaternion);y.copy(n.position).applyMatrix4(i.matrixWorld);n.scale.setScalar(this._getGizmoScale(y)/(o*this._gizmoSize))}};s.prototype._getEditingFormPosition=function(){var t=this._gizmo.children[this._gizmoIndex];var e=this._nodes[this._gizmoIndex];this._updateGizmoObjectTransformation(t,this._gizmoIndex);this._getValuePosition(y,this._handleIndex,e.azimuth,e.elevation);return y.applyMatrix4(t.matrixWorld).applyMatrix4(this._matViewProj)};s.prototype.render=function(){n(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._nodes.length>0){var t=this._viewport.getRenderer(),e=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);t.clearDepth();for(var i=0,a=this.getGizmoCount();i<a;i++){var o=this._nodes[i];this._updateGizmoObject(i,o.angle,o.azimuth,o.elevation);this._updateGizmoTransformation(i,e)}t.render(this._sceneGizmo,e);this._updateEditValue()}this._updateEditingForm(this._nodes.length>0&&this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3,this._handleIndex,["Î´","Î³","Î±"][this._handleIndex])};s.prototype._getOffsetForRestTransformation=function(t){};return s});
//# sourceMappingURL=AxisAngleRotationToolGizmo.js.map