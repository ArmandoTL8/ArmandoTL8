/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../getResourceBundle","../thirdparty/three","../thirdparty/BufferGeometryUtils","./Gizmo","./AxisColours","./ExplodeAxis","./ExplodeDirection","./ExplodeType","../AnimationTrackType","sap/base/assert","sap/base/Log","sap/ui/core/Core"],function(t,e,i,o,r,s,a,n,h,u,d,l){"use strict";var c=o.extend("sap.ui.vk.tools.ExplodeToolGizmo",{metadata:{library:"sap.ui.vk"}});var p=96;var _=48;var m={PositiveX:0,PositiveY:1,PositiveZ:2,NegativeX:3,NegativeY:4,NegativeZ:5,ResetAdjustment:6,AdjustUp:7,AdjustDown:8,MoveUp:9,MoveDown:10};c.prototype.init=function(){if(o.prototype.init){o.prototype.init.apply(this)}this._createEditingForm(t().getText("TOOL_UNITS_MM"),84);this._moveDelta=new THREE.Vector3;this._anchorPosition=new THREE.Vector3;this._axisDirection=new THREE.Vector3;this._axisColor=0;this._magnitude=0;this._viewport=null;this._tool=null;this._groups=[];this._nodes=[];this._groupsMap=new Map;this._sceneGizmo=new THREE.Scene;var e=new THREE.AmbientLight(16777215,.5);e.layers.enableAll();this._sceneGizmo.add(e);var i=new THREE.DirectionalLight(16777215,.5);i.position.set(1,3,2);i.layers.enableAll();this._sceneGizmo.add(i);this._gizmo=new THREE.Group;this._touchAreas=new THREE.Group;this._touchAreas2=new THREE.Group;this._sceneGizmo.add(this._gizmo);this._matViewProj=new THREE.Matrix4;var s=new THREE.MeshLambertMaterial({color:33023,transparent:true,opacity:.2});function a(t,e,i,o){var r=1,s=4,a=24;var n=new THREE.MeshLambertMaterial({color:i});var h=new THREE.CylinderGeometry(r,r,t-a,4);var u=new THREE.Vector3(e.y,e.z,e.x);var d=new THREE.Vector3(e.z,e.x,e.y);var l=e.x<0||e.y<0||e.z<0?(new THREE.Matrix4).makeBasis(d,e,u):(new THREE.Matrix4).makeBasis(u,e,d);l.setPosition(e.clone().multiplyScalar((t-a)*.5));h.applyMatrix4(l);var c=new THREE.Mesh(h,n);c.matrixAutoUpdate=false;c.userData.color=i;var p=new THREE.CylinderGeometry(0,s,a,12,1);l.setPosition(e.clone().multiplyScalar(t-a*.5));p.applyMatrix4(l);var m=new THREE.Mesh(p,n);m.matrixAutoUpdate=false;c.add(m);if(o){var g=new THREE.CylinderGeometry(_*.5,_*.5,t-_+a*.5,12,1);l.setPosition(e.clone().multiplyScalar(_+g.parameters.height*.5));g.applyMatrix4(l);var f=new THREE.CylinderGeometry(_*.5,0,_,12,1);l.setPosition(e.clone().multiplyScalar(_*.5));f.applyMatrix4(l);var E=THREE.BufferGeometryUtils.mergeBufferGeometries([g,f]);o.add(new THREE.Mesh(E,n))}return c}this._gizmo.add(a(p,new THREE.Vector3(1,0,0),r.x,this._touchAreas));this._gizmo.add(a(p,new THREE.Vector3(0,1,0),r.y,this._touchAreas));this._gizmo.add(a(p,new THREE.Vector3(0,0,1),r.z,this._touchAreas));this._gizmo.add(a(p,new THREE.Vector3(-1,0,0),r.x,this._touchAreas));this._gizmo.add(a(p,new THREE.Vector3(0,-1,0),r.y,this._touchAreas));this._gizmo.add(a(p,new THREE.Vector3(0,0,-1),r.z,this._touchAreas));this._axisTitles=this._createAxisTitles(undefined,undefined,false,true);this._sceneGizmo.add(this._axisTitles);var n=32;var h=n*1.75;this._groupGizmo=new THREE.Group;this._sceneGizmo.add(this._groupGizmo);var u=new THREE.Mesh(new THREE.IcosahedronGeometry(8,1),new THREE.MeshLambertMaterial);this._groupGizmo.add(u);this._groupGizmo.add(a(n*1.5,new THREE.Vector3(0,1,0),16777215));this._groupGizmo.add(a(n*1.5,new THREE.Vector3(0,-1,0),16777215));var d=16;var l=THREE.BufferGeometryUtils.mergeBufferGeometries([new THREE.CylinderGeometry(0,6,d,16).applyMatrix4((new THREE.Matrix4).setPosition(0,h+d*.5,0)),new THREE.CylinderGeometry(0,6,d,16).applyMatrix4((new THREE.Matrix4).setPosition(0,h+d*1.5,0))]);this._groupGizmo.add(new THREE.Mesh(l,new THREE.MeshLambertMaterial));this._groupGizmo.add(new THREE.Mesh(l.clone().rotateX(Math.PI),new THREE.MeshLambertMaterial));this._groupGizmo.add(new THREE.Mesh(new THREE.CylinderGeometry(16,16,n*6,12,1),new THREE.MeshBasicMaterial({color:16777215,transparent:true,opacity:.5,side:THREE.BackSide})));function c(t,e,i){var o=new THREE.IcosahedronGeometry(_*.5,1);o.applyMatrix4((new THREE.Matrix4).setPosition(0,(t+e)*.5,0));i.add(new THREE.Mesh(o,s))}c(n*-.5,n*.5,this._touchAreas2);c(n*.5,n*1.5,this._touchAreas2);c(n*-1.5,n*-.5,this._touchAreas2);c(h,h+n,this._touchAreas2);c(-h-n,-h,this._touchAreas2);function m(t){t.traverse(function(t){t.layers.enableAll()})}function g(t){t.children.forEach(function(t,e){t.traverse(function(t){t.layers.enable(Math.min(e,6)+1)})})}g(this._gizmo);g(this._axisTitles);g(this._touchAreas);m(this._groupGizmo);m(this._touchAreas2)};c.prototype.hasDomElement=function(){return false};c.prototype.show=function(t,e){this._viewport=t;this._tool=e;this._nodes.length=0;this._handleGroupsChanged()};c.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._updateEditingForm(false)};c.prototype.getGizmoCount=function(){if(!this._groups.length){return 0}return this._getActiveAxisIndex()>=0&&this._magnitude>0&&this._getSelectedItem()?2:1};c.prototype.getTouchObject=function(t){if(t===0){this._updateGizmoObjectTransformation(this._touchAreas);return this._touchAreas}else{this._updateGroupGizmoTransformation(this._touchAreas2);return this._touchAreas2}};c.prototype._handleGroupsChanged=function(t){this._setMagnitude(0);var e=this._groupsMap;e.clear();this._groups=this._tool.getItems().slice();var i=this._nodes=[];this._groups.forEach(function(t){var o=t.getItems();for(var r=0;r<o.length;r++){var s=o[r].getNodeRef();e.set(s,t);var a=new THREE.Box3;s._expandBoundingBox(a,false,true,true);i.push({node:s,center:a.getCenter(new THREE.Vector3),group:t,local:(new THREE.Vector3).setFromMatrixPosition(s.matrix),origin:(new THREE.Vector3).setFromMatrixPosition(s.matrixWorld),matParentInv:s.parent?(new THREE.Matrix4).copy(s.parent.matrixWorld).invert():new THREE.Matrix4})}});this._calculateGroupOffsets();this._setMagnitude(this._tool.getMagnitude())};c.prototype._getSelectedItem=function(){return l.byId(this._tool.getSelectedItem())};c.prototype._handleSelectedItemChanged=function(){var t=this._viewport._viewStateManager;var e=new Set;var i=this._getSelectedItem();if(i){i.getItems().forEach(function(t){e.add(t.getNodeRef())})}var o=[];t.enumerateOutlinedNodes(function(t){if(!e.has(t)){o.push(t)}});t.setOutliningStates(Array.from(e),o,false)};c.prototype.highlightHandle=function(t,e){this._handleIndex=t;this._gizmo.children.forEach(function(e,i){var o=t===i;var r=o?16776960:e.userData.color;e.material.color.setHex(r);this._axisTitles.children[i].material.color.setHex(r)}.bind(this));for(var i=0;i<5;i++){this._groupGizmo.children[i].material.color.setHex(i+6===t?16776960:this._axisColor)}};c.prototype._calculateGroupOffsets=function(){var t=this._axisDirection;if(this._tool.getType()===n.Linear){var e=new THREE.Vector3(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z));var i=new THREE.Vector3;var o=0,r=0;this._groups.forEach(function(t,s){var a=t.getBoundingBox();a.getCenter(t._center);a.getSize(i);o=e.dot(i);if(s>0){r+=o*.5}t._offset=r;t._deltaOffset=o*.5;r+=o*.5});r+=o*.5;var s=r>0?1/r:1;this._groups.forEach(function(t){t._offset=1-t._offset*s;t._deltaOffset*=s})}else{var a=1/this._groups.length;this._groups.forEach(function(t,e){var i=t.getBoundingBox();i.getCenter(t._center);t._offset=1-e*a;t._deltaOffset=a*.5;var o=-1;var r=new THREE.Vector3;var s=t.getItems();for(var n=0;n<s.length;n++){var h=s[n].getNodeRef();var u=new THREE.Box3;h._expandBoundingBox(u,false,true,true);var d=u.getSize(new THREE.Vector3).manhattanLength();if(o<d){o=d;u.getCenter(r)}}})}};c.prototype._getActiveAxisIndex=function(){var t=this._tool.getAxis();var e=this._tool.getDirection();var i=t&&e?[s.X,s.Y,s.Z].indexOf(t):-1;if(i>=0&&e===a.Negative){i+=3}return i};c.prototype._recalculateOffsets=function(){this._setMagnitude(0);this._calculateGroupOffsets();this._setMagnitude(this._tool.getMagnitude());this._viewport.setShouldRenderFrame()};c.prototype._updateAxis=function(){var t=this._getActiveAxisIndex();if(t>=0){this._updateGizmoObjectTransformation(this._gizmo);this._axisDirection.setFromMatrixColumn(this._gizmo.matrixWorld,t%3).normalize().multiplyScalar(t<3?1:-1);this._anchorPosition.setFromMatrixPosition(this._gizmo.matrixWorld);this._axisColor=this._gizmo.children[t].userData.color;for(var e=0;e<5;e++){this._groupGizmo.children[e].material.color.setHex(this._axisColor)}this._recalculateOffsets()}else{this._setMagnitude(0);this._viewport.setShouldRenderFrame()}};c.prototype._moveSelectedGroup=function(t){var e=this._tool;var i=this._getSelectedItem();var o=e.getItems();var r=o.indexOf(i);if(r>=0&&r+t>=0&&r+t<o.length){e.removeItem(i);e.insertItem(i,r+t);e.fireItemSequenceChangePressed({item:i,moveUp:t<0})}};c.prototype._setMagnitudeAdjustmentMultiplier=function(t,e){var i=this._getSelectedItem();if(i){i.setMagnitudeAdjustmentMultiplier(t);this._updatePositions();this._tool[e?"fireItemPositionAdjusted":"fireItemPositionAdjusting"]({item:i,magnitudeAdjustmentMultiplier:i.getMagnitudeAdjustmentMultiplier()})}};c.prototype._beginGesture=function(){this._moveDelta.setScalar(0);this._beginMagnitude=this._magnitude;var t=this._tool;switch(this._handleIndex){case m.ResetAdjustment:this._setMagnitudeAdjustmentMultiplier(0,true);break;case m.AdjustUp:case m.AdjustDown:var e=this._getSelectedItem();this._magnitudeAdjustmentMultiplier=e?e.getMagnitudeAdjustmentMultiplier():0;break;case m.MoveUp:this._moveSelectedGroup(-1);break;case m.MoveDown:this._moveSelectedGroup(+1);break;default:if(this._handleIndex<6&&(!t.getAxis()||!t.getDirection())){t.setAxis([s.X,s.Y,s.Z][this._handleIndex%3]);t.setDirection(this._handleIndex<3?a.Positive:a.Negative);t.fireAxisSelected({axis:t.getAxis(),direction:t.getDirection()})}break}};c.prototype._setMagnitude=function(t){this._magnitude=t;this._groups.forEach(function(e){e._magnitude=t});this._updatePositions()};c.prototype._setOffset=function(t){var e=this._tool;if(this._handleIndex<6){e.setMagnitude(this._beginMagnitude+t);e.fireMagnitudeChanging({type:e.getType(),axis:e.getAxis(),direction:e.getDirection(),magnitude:e.getMagnitude()})}else if(this._handleIndex===m.AdjustUp||this._handleIndex===m.AdjustDown){var i=this._magnitude>0?this._getSelectedItem():null;if(i){this._setMagnitudeAdjustmentMultiplier(this._magnitudeAdjustmentMultiplier+t/(this._magnitude*i._deltaOffset))}}};c.prototype._updatePositions=function(){var t=this._tool.getType()===n.Linear;var e=new THREE.Vector3;var i=new THREE.Vector3;var o=new THREE.Vector3;this._nodes.forEach(function(r){var s=r.node;if(t){i.copy(this._axisDirection)}else{i.copy(r.center).sub(this._anchorPosition);o.copy(this._axisDirection).multiplyScalar(i.dot(o));i.sub(o).normalize()}i.multiplyScalar(r.group.getMagnitude());e.copy(r.origin).add(i);s.matrixWorld.setPosition(e);s.matrix.multiplyMatrices(r.matParentInv,s.matrixWorld);s.position.setFromMatrixPosition(s.matrix);s.updateMatrixWorld(true);if(s.parent!==this._getEffectiveParent(s)){this._viewport._viewStateManager._setJointNodeOffsets(s,h.Translate)}}.bind(this));this._viewport.setShouldRenderFrame()};c.prototype._endGesture=function(){var t=this._tool;if(this._handleIndex<6){t.fireMagnitudeChanged({type:t.getType(),axis:t.getAxis(),direction:t.getDirection(),magnitude:t.getMagnitude()})}else if(this._handleIndex===m.AdjustUp||this._handleIndex===m.AdjustDown){var e=this._magnitude>0?this._getSelectedItem():null;if(e){t.fireItemPositionAdjusted({item:e,magnitudeAdjustmentMultiplier:e.getMagnitudeAdjustmentMultiplier()})}}};c.prototype.expandBoundingBox=function(t){if(this._viewport){this._expandBoundingBox(t,this._viewport.getCamera().getCameraRef(),true)}};c.prototype._updateGizmoObjectTransformation=function(t){t.matrix.fromArray(this._tool.getAnchor());t.matrix.decompose(t.position,t.quaternion,t.scale);var e=this._getGizmoScale(t.position);t.scale.setScalar(e);t.matrixAutoUpdate=true;t.updateMatrixWorld(true);return e};c.prototype._updateGroupGizmoTransformation=function(t){var e=this._getActiveAxisIndex();var i=e>=0&&this._magnitude>0?this._getSelectedItem():null;t.visible=!!i;if(i){if(this._tool.getType()===n.Linear){t.position.copy(this._axisDirection).multiplyScalar(i.getMagnitude()).add(i._center)}else{t.position.copy(i._center)}t.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0),this._axisDirection);t.scale.setScalar(this._getGizmoScale(t.position));t.updateMatrix();t.updateMatrixWorld()}};c.prototype._updateGizmoTransformation=function(t,e){this._updateGizmoObjectTransformation(this._gizmo)};c.prototype._getCameraLayersMask=function(){var t=0|0;var e=this._getActiveAxisIndex();t=1<<e+1;if(e>=0&&this._magnitude>0&&this._getSelectedItem()){t|=1<<7}return t};c.prototype.render=function(){u(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._tool&&this._groups.length>0){var t=this._viewport.getRenderer(),e=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);t.clearDepth();var i=this._updateGizmoObjectTransformation(this._gizmo);this._updateAxisTitles(this._axisTitles,this._gizmo,e,p+18,i);this._updateGroupGizmoTransformation(this._groupGizmo);var o=e.layers.mask;e.layers.mask=this._getCameraLayersMask();t.render(this._sceneGizmo,e);e.layers.mask=o}};return c});
//# sourceMappingURL=ExplodeToolGizmo.js.map