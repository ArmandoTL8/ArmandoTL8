/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/Device","sap/ui/core/Core","sap/gantt/simple/BaseLine","sap/gantt/simple/RenderUtils","sap/gantt/simple/GanttExtension","sap/gantt/simple/Relationship","sap/gantt/misc/Format","sap/gantt/misc/Utility","sap/gantt/library","sap/m/Toolbar","./GanttUtils","./AdhocLineRenderer","sap/gantt/simple/DeltaLineRenderer","sap/gantt/simple/AggregationUtils","./BaseText"],function(e,t,n,a,r,i,o,s,l,d,g,p,c,h,f){"use strict";var u={apiVersion:2};var v=l.AdhocLineLayer;var S=l.DeltaLineLayer;u.render=function(e,t){var n=t.getParent(),a=n.getParent()._bToolbarSettingsItemChanged;if(a){n.getParent()._bToolbarSettingsItemChanged=false;n._getScrollExtension().needRerenderGantt(function(){this.renderImmediately(n)}.bind(this),"initialRender",a)}else{var r=n.getTable().getRows(),i=false;if(r.length>0){var o=r[0].getIndex(),s,l=[];s=n.getPrimaryShapeScheme();n._aExpandedIndices.forEach(function(e){var t=e-o;if(t>=0&&r.length-1>=t){l.push(t)}});l.forEach(function(e){var t=o+e;var a=r[e].getAggregation("_settings").getRowUid();var l=n._oExpandModel.mExpanded[a];if(l){var d,g=l[l.length-1]&&l[l.length-1].scheme,p;d=n.getShapeSchemes().filter(function(e){return e.getKey()===g});if(d[0]!==undefined||n.getEnablePseudoShapesDisplay()&&l[l.length-1].expandSchemeShape){n._oExpandModel.isTableRowHeightNeedChange(true,n.getTable(),[t],s,d[0]);p=n._oExpandModel.getMainRowScheme(a);if(n._oExpandModel.rowMaxLevelMap&&n._oExpandModel.rowMaxLevelMap["row"+t]!==undefined&&p!==undefined&&p.value.numberOfRows!==undefined&&p.value.numberOfRows!==n._oExpandModel.rowMaxLevelMap["row"+t]){p.value.numberOfRows=n._oExpandModel.rowMaxLevelMap["row"+t];i=true}}}})}if(i===true||n.pseudoShapeSpecificData&&n.pseudoShapeSpecificData.needUpdateForTasksInAggr){i=false;if(n.pseudoShapeSpecificData&&n.pseudoShapeSpecificData.needUpdateForTasksInAggr){n._addBackTasksToRows();n.pseudoShapeSpecificData.needUpdateForTasksInAggr=false}n.getTable().invalidate()}else{this.renderGanttChart(e,n);var d=n._getScrollExtension();if(!d.mOffsetWidth){d.updateSvgOffsetWidth()}n._getScrollExtension().scrollGanttChartToVisibleHorizon();n.getSyncedControl().scrollContentIfNecessary()}}};u.renderGanttChart=function(e,n){var a=t.getLibraryResourceBundle("sap.gantt");e.openStart("div",n.getId()+"-cnt");e.class("sapGanttChartCnt");e.style("height","100%");e.style("width","100%");e.attr("aria-label",a.getText("ARIA_GANTT_CHART"));e.openEnd();this.rerenderAllShapes(e,n);var r=n.getLocale()||n.getAxisTime().getLocale();if(r){n.setLocale(r,true);n.getAxisTime().setLocale(r,true)}e.close("div")};u.renderImmediately=function(e){var n=t.createRenderManager();this.renderGanttChart(n,e);var a=window.document.getElementById(e.getId()+"-gantt");if(a){n.flush(a,true,false)}this.renderRelationships(n,e);e._updateShapeSelections(e.getSelectedShapeUid(),[]);e.updateShapeHighlights(e.getHighlightedShapeUid(),[]);r.attachEvents(e);if(e.getParent().isA("sap.gantt.simple.GanttChartContainer")&&e.getParent().getShowSearchSidePanel()){e.getParent().getSearchSidePanel().setContainerHeight()}n.destroy();e.getInnerGantt().fireGanttReady({supressEvent:true})};u.rerenderAllShapes=function(e,t){var n=t.getSyncedControl().getRowStates();if(n.length===0){return}t.getAggregation("_header").renderElement();if(t._getScrollExtension&&t._getScrollExtension.mOffsetWidth){t._getScrollExtension().scrollGanttChartToVisibleHorizon()}var r=t.getSimpleAdhocLines().filter(function(e){return e.MarkerType!=sap.gantt.simple.MarkerType.None});var i=t.getDeltaLines();if((r.length>0||i.length>0)&&t.getShowGanttHeader()){var o=t.getAggregation("table");g.addToolbarToTable(this,o,false)}var s=n.reduce(function(e,t){return e+t.height},0);e.openStart("svg",t.getId()+"-svg");e.class("sapGanttChartSvg");e.attr("height",s+"px");var l=a.getGanttRenderWidth(t);e.attr("width",l+"px");e.openEnd();if(t.getEnableDeltaLine()){this.renderChartAreaOfDeltaLines(e,t)}this.renderGanttBackgrounds(e,t,n);this.renderGanttRowBorders(e,t,n);this.renderCalendarShapes(e,t);this.renderExpandedRowBackground(e,t);this.renderVerticalLines(e,t);this.renderNowLineBody(e,t);var d=a.createOrderedListOfRenderFunctionsFromTemplate(this.createTemplateForOrderedListOfRenderFunctions(t));d.forEach(function(n){n.apply(u,[e,t])});e.openStart("svg",t.getId()+"-svgDefs");e.attr("width",0);e.attr("height",0);e.style("position","absolute");e.class("sapGanttChartSvgDefs");e.openEnd();this.renderHelperDefs(e,t.getId(),t);this.renderCalendarPattern(e,t);e.close("svg");e.close("svg");if(!t._bPreventInitialRender){t._bPreventInitialRender=true}};u.createTemplateForOrderedListOfRenderFunctions=function(e){var t=[{fnCallback:this.renderAllShapesInRows},{fnCallback:this.renderRlsContainer,bUnshift:e.getShapeOverRelationship()},{fnCallback:this.renderAssistedContainer}];if(e.getEnableAdhocLine()){t.push({fnCallback:this.renderAdhocLines,bUnshift:e.getAdhocLineLayer()===v.Bottom})}if(e.getEnableDeltaLine()){t.push({fnCallback:this.renderDeltaLines,bUnshift:e.getDeltaLineLayer()===S.Bottom})}return t};u.renderHelperDefs=function(e,t,n){e.openStart("defs").openEnd();var a=t+"-helperDef-linePattern";e.openStart("pattern",a);e.attr("width",2);e.attr("height",2);e.attr("x",0);e.attr("y",0);e.attr("patternUnits","userSpaceOnUse");e.openEnd();e.openStart("line");e.attr("x1",1);e.attr("x2",1);e.attr("y1",0);e.attr("y2",2);e.attr("stroke-width",1);e.attr("stroke","white");e.attr("shape-rendering","crispEdges");e.openEnd();e.close("line");e.close("pattern");e.close("defs");var r=n?n.getSvgDefs():null;var i=n?n.getAggregation("_pseudoSvgDefs"):null;if(i){e.unsafeHtml(i._getDefString())}if(r){e.unsafeHtml(r._getDefString(n._bClonedGantt))}};u.renderGanttRowBorders=function(e,t,n){e.openStart("g",t.getId()+"-ganttRowBorder");e.openEnd();this.renderRowBorders(e,t,n);e.close("g")};u.renderGanttBackgrounds=function(e,t,n){e.openStart("g",t.getId()+"-bg");e.openEnd();this.renderRowBackgrounds(e,t,n);e.close("g")};u.renderRowBackgrounds=function(e,t,n){var a=0;var r=t.getTable().getVisibleRowCount();e.openStart("g",t.getId()+"-rowBackgrounds");e.class("rowBackgrounds");e.openEnd();n.forEach(function(n,i){e.openStart("rect",t.getId()+"-bgRow-"+i);e.attr("y",a);e.attr("width","100%");e.attr("height",n.height);e.attr("data-sap-ui-index",i);e.class("sapGanttBackgroundSVGRow");if(n.selected&&t.getEnableChartSelectionState()){e.class("sapGanttBackgroundSVGRowSelected")}if(n.hovered&&t.getEnableChartHoverState()){e.class("sapGanttBackgroundSVGRowHovered")}e.openEnd().close("rect");if(i<r){a+=n.height}});e.close("g");if(t.getDisplayType()===l.simple.GanttChartWithTableDisplayType.Chart){document.getElementById(t.getId()+"-sapGanttBackgroundTableContent").style.height=a+"px";var i=document.getElementById(t.getId()+"-sapUiTableCnt");var o=document.getElementsByClassName("sapUiTableColHdrCnt");var s=i&&i.offsetTop;var d=o&&o[0].getBoundingClientRect().height;document.getElementById(t.getId()+"-ganttHeader").style.height=s+d+"px"}};u.renderRowBorders=function(e,t,n){e.openStart("g",t.getId()+"-rowBorders");e.class("rowBorders");e.openEnd();var a=0;n.forEach(function(n,r){var i=a+n.height-.5;e.openStart("line",t.getId()+"-bgRowBorder-"+r);e.attr("x1",0);e.attr("x2","100%");e.attr("y1",i);e.attr("y2",i);e.style("pointer-events","none");e.class("sapGanttBackgroundSVGRowBorder");e.openEnd().close("line");a+=n.height});e.close("g")};u.renderAdhocLines=function(e,t){var a=t.getSimpleAdhocLines();var r=t.getRenderedTimeRange(),i=r[0],s=r[1];a=a.filter(function(e){var t=o.abapTimestampToDate(e.getTimeStamp());return t>=i&&t<=s&&e.getProperty("visible")});var l=t.getAdhocLines();l=l.filter(function(e){var t=sap.gantt.misc.Format.abapTimestampToDate(e.getTimeStamp());return t>=i&&t<=s});if(l.length===0&&a.length===0){return}var d=t.getAxisTime();e.openStart("g");e.class("sapGanttChartAdhocLine");e.openEnd();a.forEach(function(n){p.renderLine(e,n,t)});l.map(function(e){var t=d.timeToView(o.abapTimestampToDate(e.getTimeStamp()));return new n({x1:t,y1:0,x2:t,y2:"100%",stroke:e.getStroke(),strokeWidth:e.getStrokeWidth(),strokeDasharray:e.getStrokeDasharray(),strokeOpacity:e.getStrokeOpacity(),tooltip:e.getDescription()}).setProperty("childElement",true)}).forEach(function(t){t.renderElement(e,t)});e.close("g")};u.renderDeltaLines=function(e,t){var n=t.getDeltaLines();n=n.filter(function(e){return e.getVisible()});if(n.length===0){return}e.openStart("g");e.class("sapGanttChartDeltaLine");e.openEnd();n.forEach(function(n){c.renderDeltaLines(e,n,t)});e.close("g")};u.renderChartAreaOfDeltaLines=function(e,t){var n=t.getDeltaLines();n=n.filter(function(e){return e.getVisible()});if(n.length===0){return}e.openStart("g");e.class("sapGanttChartAreaDeltaLine");e.openEnd();n.forEach(function(n){c.renderChartAreaOfDeltaLines(e,n,t)});e.close("g")};u.renderVerticalLines=function(e,t){if(t.getEnableVerticalLine()){var n=a.getGanttRenderWidth(t),r=jQuery(document.getElementById(t.getId())).height(),i=t.getAxisTime();var o=i.getZoomStrategy();var s=i.getTickTimeIntervalLabel(o.getTimeLineOption(),null,[0,n]);var l=s[1];var d="";for(var g=0;g<l.length;g++){d+=" M"+" "+(l[g].value-1/2)+" 0"+" v "+r}if(d){e.openStart("path");e.class("sapGanttChartVerticalLine");e.attr("d",d);e.openEnd().close("path")}}};u.renderAssistedContainer=function(e,t){e.openStart("g");e.class("sapGanttChartSelection");e.openEnd().close("g");e.openStart("g");e.class("sapGanttChartHighlight");e.openEnd().close("g");e.openStart("g");e.class("sapGanttChartShapeConnect");e.openEnd().close("g");e.openStart("g");e.class("sapGanttChartLasso");e.openEnd().close("g")};u.renderNowLineBody=function(e,t){var a=t.getAxisTime().getNowLabel(t.getNowLineInUTC())[0].value;if(t.getEnableNowLine()===false||isNaN(a)){return}e.openStart("g");e.class("sapGanttNowLineBodySvgLine");e.openEnd();var r=new n({x1:a,y1:0,x2:a,y2:"100%",strokeWidth:1}).setProperty("childElement",true);r.renderElement(e,r);e.close("g")};u.renderRlsContainer=function(e,t){e.openStart("g");e.class("sapGanttChartRls");e.openEnd().close("g")};u.renderAllShapesInRows=function(e,t){if(!jQuery(document.getElementById(t.getId()+"-gantt"))){return}e.openStart("g",t.getId()+"-shapes");e.class("sapGanttChartShapes");e.openEnd();this._eachVisibleRowSettings(t,function(n){n.renderElement(e,t)});e.close("g")};u._eachVisibleRowSettings=function(e,t){var n=e.getTable().getRows();var a=e.getTable().getBindingInfo("rows"),r=a&&a.model;for(var i=0;i<n.length;i++){var o=n[i];var s=o.getBindingContext(r);if(s&&o.getIndex()!==-1){var l=o.getAggregation("_settings");if(t){t(l)}}}};u.renderRelationships=function(e,t){t.relSet={};t.relSetFake={};t._edgePoint=g.getEdgePoint(t);var n=window.document.getElementById(t.getId()+"-svg");var a=jQuery(n).children("g.sapGanttChartRls").get(0);if(n==null||a==null){return}var r=Object.create(null);this._eachVisibleRowSettings(t,this._renderVisibleRowRelationships.bind(this,e,t,r));this._renderNonVisibleRowRelationships(e,t,r);for(var i in t.relSet){if(t.relSet[i].mAnchors.predecessor||t.relSet[i].mAnchors.successor){t.relSet[i].renderElement(e,t.relSet[i],t.getId())}}for(var o in t.relSetFake){if(t.relSetFake[o].mAnchors.predecessor||t.relSetFake[o].mAnchors.successor){t.relSetFake[o].renderElement(e,t.relSetFake[o],t.getId());t.relSetFake[o].destroy()}}e.flush(a,true,false)};u._renderVisibleRowRelationships=function(e,t,n,a){a.getRelationships().forEach(function(e){var r=e.getShapeId();var i=a.getShapeUid(e);if(!n[r]){n[r]=true;e.setProperty("shapeUid",i,true);if(g.relationexist(t,e)){g.setLmarker(t,e,true)}}})};u._renderNonVisibleRowRelationships=function(e,t,n){var a=s.safeCall(t,["getTable","getRowSettingsTemplate","getBindingInfo"],null,["relationships"]);if(!a){return}var r=a.template.getBindingInfo("shapeId");if(!r){return}var i=r.parts[0].path,o=t.getTable().getModel(a.model);var l=function(e,r){if(!n[e]){n[e]=true;var i=a.factory();i.setModel(o,a.model);i.bindObject({path:r,model:a.model});if(g.relationexist(t,i)){g.setLmarker(t,i,false)}}};if(o.isA("sap.ui.model.json.JSONModel")){var d=o.mContexts;Object.keys(d).forEach(function(e){if(e.indexOf(a.path)>0){l(d[e].getProperty(i),e[0]==="/"?e:"/"+e)}})}else{var d=o.getProperty("/");Object.keys(d).forEach(function(e){if(e.startsWith(a.path)){l(d[e][i],e[0]==="/"?e:"/"+e)}})}};u.renderSvgDefs=function(e,t){var n=t.getSvgDefs();if(n){e.openStart("svg",t.getId()+"-svg-psdef");e.attr("aria-hidden","true");e.style("float","left");e.style("width","0px");e.style("height","0px");e.openEnd();e.unsafeHtml(n.getDefString());e.close("svg")}};u.renderCalendarPattern=function(e,t){if(t.getEnableNonWorkingTime()===false){return}var n=t.getCalendarDef(),r=t.getId(),i=t.iGanttRenderedWidth;var o=t.getSyncedControl().getRowStates();if(n){var s=h.getAllNonLazyAggregations(n);var l=Object.keys(s).filter(function(e){return e.indexOf("defs")===0}).map(function(e){return n.getAggregation(e)||[]}.bind(n));var d=function(e){return new f(e)};l.forEach(function(t,s){if(t.length>0){var l=n.getDefNode(t);if(l&&l.defNodes&&i>0){var g=r+"-calendardefs-"+s;e.openStart("defs",g);e.openEnd();for(var p=0;p<l.defNodes.length;p++){var c=l.defNodes[p];e.openStart("pattern",c.id);e.class("calendarPattern");e.attr("patternUnits","userSpaceOnUse");e.attr("x",0);e.attr("y",0);e.attr("width",i);e.attr("height",o[0].height);e.openEnd();for(var h=0;h<c.timeIntervals.length;h++){var f=c.timeIntervals[h];f.height=o[0].height;e.openStart("rect");e.attr("x",f.x);e.attr("y",f.y);e.attr("width",f.width);e.attr("height",o[0].height);e.attr("fill",f.fill);e.openEnd().close("rect");if(c.title!==null){a.renderCalenderTitle(e,c,f,d)}}e.close("pattern")}e.close("defs")}}})}};u.renderCalendarShapes=function(e,t){e.openStart("g");e.class("sapGanttChartCalendar");e.openEnd();var n=t.getSyncedControl().getRowStates();this._eachVisibleRowSettings(t,function(r){var i=a.calcRowDomPosition(r,n);var o=h.getAllNonLazyAggregations(r);var s=Object.keys(o).filter(function(e){return e.indexOf("calendars")===0}).map(function(e){return r.getAggregation(e)||[]}.bind(r));s.forEach(function(n){n.forEach(function(n){if(t.isShapeVisible(n)){n.setProperty("rowYCenter",i.rowYCenter,true);n._iBaseRowHeight=i.rowHeight;if(n.getVisible()){n.renderElement(e,n)}}})})});e.close("g")};u.renderExpandedRowBackground=function(e,t){var n=t.getExpandedBackgroundData();if(jQuery.isEmptyObject(n)){return}var a=t._oExpandModel.refreshRowYAxis(t.getTable());var r=Array.prototype.concat.apply([],n);var i=t.iGanttRenderedWidth;e.openStart("g");e.class("sapGanttChartRowBackground");e.openEnd();for(var o=0;o<r.length;o++){var s=r[o];var l;var d;if(t.getEnableExpandedRowBackground()===true){l="sapGanttExpandChartCntBG"}else{l="sapGanttExpandedRowBackground"}d=s.rowHeight;e.openStart("g");e.class("expandedRow");e.openEnd();var g;if(t.getShowParentRowOnExpand()&&!t.getUseParentShapeOnExpand()){g=s.y}else{g=s.y-a}e.openStart("rect");e.attr("x",s.x);e.attr("y",g);e.attr("height",d);e.attr("width","100%");e.class(l);e.openEnd();e.close("rect");e.openStart("path");if(t.getEnableExpandedRowBorders()===true){e.class("sapGanttExpandChartLine")}e.attr("d","M0 "+g+" H"+(i-1));e.openEnd().close("path");e.close("g")}e.close("g")};return u},true);
//# sourceMappingURL=InnerGanttChartRenderer.js.map