// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/ushell/components/applicationIntegration/application/Application"],function(e,n,s){"use strict";var t={},i={},r={};var a=function(){this.processPostMessage=function(n){return new Promise(function(s,t){var i=n.oMessageData,r=i.body,a=n.oMessage,c=a.origin,u=a.source;r.requestId=i.request_id;if(!u){e.error("Missing iframe object");return t("Missing iframe object")}this._handlePostMessageRequest(r,u,c).then(function(e){return s(e)}).catch(function(e){return t(e)})}.bind(this))};this.subscribe=function(n,s,t,a,c,u,o){return new Promise(function(d,l){if(r[n]){e.error("MessageBroker.subscribe: attempt to subscribe twice");return l("Client already subscribed")}if(!n||!s.length||typeof u!=="object"&&(typeof a!=="function"||typeof c!=="function")){e.error("MessageBroker.subscribe: Missing required parameter(s)");return l("Missing required parameter(s)")}for(var h in s){var f=s[h];var b={clientId:n,subscribedChannels:s,data:t,messageCallback:a,clientConnectionCallback:c,iframe:u||{},origin:o||"",isUI5:!u&&!o};if(!i[f.channelId]){i[f.channelId]=[]}i[f.channelId].push(b)}var g={clientId:n,subscribedChannels:s};var I=Object.values(r);r[n]=g;if(Object.keys(r).length>1){this._emitEvent("clientConnected",n,s,t)}return d(I)}.bind(this))};this.unsubscribe=function(n){return new Promise(function(s,t){var a=[];if(!n){e.error("MessageBroker.unsubscribe: Missing required parameter sClientId");return t("MessageBroker.unsubscribe: Missing required parameter sClientId")}if(!r[n]){e.error("MessageBroker.unsubscribe: attempt to unsubscribe twice");return t("Client already unsubscribed")}delete r[n];for(var c in i){var u=i[c];for(var o in u){var d=u[o];if(d.clientId===n){a=d.subscribedChannels;u.splice(o,1);break}}}this._emitEvent("clientDisconnected",n,a,{});return s()}.bind(this))};this.publish=function(n,s,t,r,a,c){return new Promise(function(u,o){var d;if(!i[n]){d="Unknown channel Id: "+n;e.error(d);return o(d)}var l=[];for(var h in a){var f=a[h];if(f==="*"){l=i[n].concat();break}else{var b=i[n].find(function(e){return e.clientId===f});if(b){l.push(this._deepCopy(b))}}}if(l.length){this._sendMessage("request",l,n,t,r,s,c).then(function(e){return u(e)}).catch(function(e){return o(e)})}else{d="Target client(s) not found in the provided channel";e.error(d);return o(d)}}.bind(this))};this.addAcceptedOrigin=function(n){if(n){t[n]=true}else{e.error("MessageBroker.addAcceptedOrigin: Missing required parameter sOrigin")}};this.removeAcceptedOrigin=function(e){delete t[e]};this.getAcceptedOrigins=function(){return Promise.resolve(Object.keys(t))};this.getConnectedClients=function(){return this._deepCopy(i)};this._emitEvent=function(e,n,s,t){var r={};for(var a in i){var c=i[a];for(var u in c){var o=c[u];if(o.clientId!==n&&!r[o.clientId]){if(o.isUI5!==false){o.clientConnectionCallback(e,n,s,t)}else{var d={clientId:n,channelId:"sap.ushell.MessageBroker",messageName:e,subscribedChannels:s,data:t},l=this._buildPostMessageObject("event",d);this._sendPostMessageToClient(l,o.iframe,o.origin,false)}r[o.clientId]=true}}}};this._sendMessageToUI5Client=function(e,n,s,t,r,a){return new Promise(function(c,u){e.messageCallback(n,s,r,a).then(function(a){if(a){var u=i[s].find(function(e){return e.clientId===n}),o=this._deepCopy(u);if(o.isUI5!==false){o.messageCallback(e.clientId,s,r,a,t)}else{var d={clientId:e.clientId,channelId:s,messageName:r,subscribedChannels:e.subscribedChannels,data:a,requestId:t},l=this._buildPostMessageObject("response",d);this._sendPostMessageToClient(l,o.iframe,o.origin,false)}}return c()}.bind(this)).catch(function(e){return u(e)})}.bind(this))};this._sendMessageToEmbeddedClient=function(e,n,s){return new Promise(function(t,r){var a=this._buildPostMessageObject(e,s);this._sendPostMessageToClient(a,n.iframe,n.origin,true).then(function(e){if(e){var r=i[s.channelId].find(function(e){return e.clientId===s.clientId}),a=this._deepCopy(r);if(a.isUI5!==false){a.messageCallback(n.clientId,s.channelId,s.messageName,e.body,s.requestId)}else{e.request_id=e.correlationMessageId=s.requestId;this._sendPostMessageToClient(e,a.iframe,a.origin,false)}}return t()}.bind(this)).catch(function(e){return r(e)})}.bind(this))};this._sendMessage=function(e,n,s,t,i,r,a){return new Promise(function(c,u){if(!n.length){return c(n)}for(var o in n){var d=n[o];if(d.clientId!==r){if(d.isUI5!==false){this._sendMessageToUI5Client(d,r,s,t,i,a).then(function(e){return c(e)}).catch(function(e){return u(e)})}else{var l={clientId:r,channelId:s,messageName:i,requestId:t,data:a};this._sendMessageToEmbeddedClient(e,d,l).then(function(e){return c(e)}).catch(function(e){return u(e)})}}}}.bind(this))};this._callApi=function(e,n){return this[e].apply(this,n)};this._handlePostMessageRequest=function(e,n,s){return new Promise(function(t,i){var r,a="accepted",c=false,u=e.clientId,o=e.channelId,d=e.requestId,l=e.messageName,h=e.subscribedChannels,f=e.targetClientIds||[],b=e.data;var g={subscribe:[u,h,b,null,null,n,s],unsubscribe:[u],publish:[o,u,d,l,f,b]};var I={channelId:o,clientId:u,messageName:l,data:b,requestId:d},p=this._buildPostMessageObject("response",I);switch(l){case"connect":r="subscribe";c=true;break;case"disconnect":r="unsubscribe";c=true;break;default:r="publish";break}this._callApi(r,g[r]).then(function(e){if(Array.isArray(e)){p.body.activeClients=e.concat()}return t({_noresponse_:true})}).catch(function(e){c=false;return i(e)}).finally(function(){if(c){if(a){p.body.status=a}this._sendPostMessageToClient(p,n,s,false)}}.bind(this))}.bind(this))};this._sendPostMessageToClient=function(e,n,t,i){return s.postMessageToIframeObject(e,n,t,i)};this._buildPostMessageObject=function(e,n){var t="sap.ushell.services.MessageBroker",i={request:{channelId:n.channelId,clientId:n.clientId,messageName:n.messageName,data:n.data},response:{channelId:n.channelId,clientId:n.clientId,correlationMessageId:n.requestId,messageName:n.messageName,data:n.data},event:{channelId:n.channelId,clientId:n.clientId,messageName:n.messageName,subscribedChannels:n.subscribedChannels,data:n.data}};var r={request:[t,i.request],response:[t,n.requestId,i.response,true],event:[t,i.event]};if(n.activeClients){i[e].activeClients=n.activeClients}var a=this._buildFunctionName("createPostMessage",e==="response"?e:"request");return s[a].apply(this,r[e])};this._buildFunctionName=function(e,n){n=n.charAt(0).toUpperCase()+n.substring(1);return e+n};this._deepCopy=function(e){return n(e)}};return new a},false);
//# sourceMappingURL=MessageBrokerEngine.js.map