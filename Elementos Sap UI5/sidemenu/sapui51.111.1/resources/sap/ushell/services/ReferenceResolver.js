// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/base/util/isEmptyObject","sap/m/DynamicDateUtil","sap/ui/core/CalendarType","sap/ui/core/Configuration","sap/ui/core/format/DateFormat","sap/ui/model/odata/ODataUtils","sap/ui/model/odata/v4/ODataUtils","sap/ui/thirdparty/jquery","sap/ushell/User"],function(e,r,t,a,n,s,i,l,u,jQuery,f){"use strict";var o="sap.ushell.services.ReferenceResolver";function c(){this.getValue=function(e){var r=new jQuery.Deferred;var t;if(e==="User.env.sap-ui-legacy-date-format"){t=s.getFormatSettings().getLegacyDateFormat()}if(e==="User.env.sap-ui-legacy-number-format"){t=s.getFormatSettings().getLegacyNumberFormat()}if(e==="User.env.sap-ui-legacy-time-format"){t=s.getFormatSettings().getLegacyTimeFormat()}if(e==="User.env.sap-language"){t=sap.ushell.Container.getUser().getLanguage()}if(e==="User.env.sap-languagebcp47"){t=sap.ushell.Container.getUser().getLanguageBcp47()}if(e==="User.env.sap-accessibility"){t=sap.ushell.Container.getUser().getAccessibilityMode()?"X":undefined}if(e==="User.env.sap-statistics"){t=s.getStatistics()?"true":undefined}if(e==="User.env.sap-theme"){t=sap.ushell.Container.getUser().getTheme(f.prototype.constants.themeFormat.THEME_NAME_PLUS_URL)}if(e==="User.env.sap-theme-name"){t=sap.ushell.Container.getUser().getTheme()}if(e==="User.env.sap-theme-NWBC"){t=sap.ushell.Container.getUser().getTheme(f.prototype.constants.themeFormat.NWBC)}r.resolve({value:t});return r.promise()}}function d(s,f,d){this._getUserEnvReferenceResolver=function(){if(!this.oUserEnvReferenceResolver){this.oUserEnvReferenceResolver=new c}return this.oUserEnvReferenceResolver};this.resolveReferences=function(r,a){var n=this;var s=new jQuery.Deferred;var i=[];var l=true;var u={};var f={};var c=sap.ushell.Container.getServiceAsync("UserDefaultParameters");var d,v;if(!a){v=sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(e){return e.getSystemContext()})}else{v=Promise.resolve(a)}var m=r.map(function(r){var t;if(r.indexOf("User.env.")===0){t=r;f[t]=1}if(r.indexOf("UserDefault.")===0){t=n._extractAnyUserDefaultReferenceName(r);u[t]=1}if(typeof t!=="string"){l=false;e.error("'"+r+"' is not a legal reference name",null,o)}return{full:r,name:t}});if(!l){return s.reject("One or more references could not be resolved").promise()}Promise.all([v,c]).then(function(e){var r=e[0];var a=e[1];Object.keys(u).forEach(function(e){i.push(a.getValue(e,r))});Object.keys(f).forEach(function(e){d=d||n._getUserEnvReferenceResolver();i.push(d.getValue(e))});jQuery.when.apply(jQuery,i).done(function(){var e={};var r=0,a=arguments;Object.keys(u).forEach(function(e){u[e]=a[r];r=r+1});Object.keys(f).forEach(function(e){f[e]=a[r];r=r+1});m.forEach(function(r){var a;if(r.full.indexOf("UserDefault.extended.")===0){a=n.mergeSimpleAndExtended(u[r.name]);if(!t(a)){e[r.full]=a}else{e[r.full]=undefined}}else if(r.full.indexOf("UserDefault.")===0){e[r.full]=u[r.name].value}else if(r.full.indexOf("User.env.")===0){e[r.full]=f[r.name].value}});s.resolve(e)})});return s.promise()};this._extractAnyUserDefaultReferenceName=function(e){var r=this.extractExtendedUserDefaultReferenceName(e);if(typeof r==="string"){return r}return this.extractUserDefaultReferenceName(e)};this.extractExtendedUserDefaultReferenceName=function(e){if(typeof e!=="string"||e.indexOf("UserDefault.extended.")!==0){return undefined}return e.replace(/^UserDefault[.]extended[.]/,"")};this.extractUserDefaultReferenceName=function(e){if(typeof e!=="string"||e.indexOf("UserDefault.")!==0||e.indexOf("UserDefault.extended.")===0){return undefined}return e.replace(/^UserDefault[.]/,"")};this.mergeSimpleAndExtended=function(e){var t=r({},e.extendedValue);if(typeof e.value==="string"){if(!Array.isArray(t.Ranges)){t.Ranges=[]}t.Ranges.push({Sign:"I",Option:"EQ",Low:e.value,High:null})}return t};function v(e){var r=/{([^}%]*%%[^%]+%%)}?/g,t=/([^%]*)%%/,a=/%%([^%]+)%%/,n,s,i,l=[];n=r.exec(e);while(n){s=t.exec(n[1]);i=a.exec(n[1]);l.push({edmType:s[1],name:i[1]});n=r.exec(e)}return l}this._extractUrlPlaceholders=function(e,r){var t;var a;var n=[];t=/[^(?]*/.exec(e);a=t===null?[]:v(t[0]);a.forEach(function(e){n.push(e.name)});t=/[(?][^]*/.exec(e);a=t===null?[]:v(t[0]);var s=a.filter(function(e){var t=e.name;if(r.test(t)){return true}n.push(t);return false});return{extractedReferences:s,ignoredReferences:n}};this._replaceUrlPlaceholders=function(e,r,t){var a=e;var n=[];var s=t?u.formatLiteral.bind(u):l.formatValue.bind(l);r.forEach(function(e){var r=e.name;var t=null;var i=false;while(t!==a){t=a;if(e.value!==undefined){var l=s(e.value,e.edmType);a=a.replace("{"+e.edmType+"%%"+r+"%%}",window.encodeURIComponent(l))}else{i=true;a=a.replace("{"+e.edmType+"%%"+r+"%%}","")}}if(i){n.push(r)}});return{resolvedUrl:a,placeholdersWithoutValue:n}};this.resolveUserDefaultParameters=function(e,r){var t=new jQuery.Deferred;var a=this._extractUrlPlaceholders(e,/^UserDefault\.(?!extended\.).+/);var n=a.extractedReferences;var s=a.ignoredReferences;if(n.length===0){t.resolve({url:e,defaultsWithoutValue:[],ignoredReferences:s});return t.promise()}var i=n.map(function(e){return e.name});this.resolveReferences(i,r).done(function(r){n.forEach(function(e){e.value=r[e.name]});var a=this._replaceUrlPlaceholders(e,n);t.resolve({url:a.resolvedUrl,defaultsWithoutValue:a.placeholdersWithoutValue,ignoredReferences:s})}.bind(this));return t.promise()};this.resolveSemanticDateRanges=function(r,t){var a=this._extractUrlPlaceholders(r,/^DynamicDate\..+/);var n=a.extractedReferences;var s=a.ignoredReferences;if(n.length===0){return{url:r,semanticDatesWithoutValue:[],ignoredReferences:s}}var i=this._resolveSemanticDateRanges(n,t);var l=this._replaceUrlPlaceholders(r,i,t);if(e.getLevel()>=e.Level.DEBUG){var u=i.filter(function(e){return"value"in e});e.debug("Resolving semantic date ranges \n"+"- URL: "+r+"\n"+"- ignoring references: "+JSON.stringify(s,null,4)+"\n"+"- resolved semantic date ranges: "+JSON.stringify(u,null,4)+"\n"+"- invalid semantic date ranges:"+JSON.stringify(l.placeholdersWithoutValue,null,4)+"\n"+"- final URL: "+l.resolvedUrl,null,o)}return{url:l.resolvedUrl,invalidSemanticDates:l.placeholdersWithoutValue,ignoredReferences:s}};this._resolveSemanticDateRanges=function(e,r){if(e.length<=0){return[]}var t=this._getDateTimeFormatters();return e.map(function(e){var n={name:e.name,edmType:e.edmType};var s=e.name.split(".");var i={operator:s[1],values:[]};var l;if(s.length===3){l=s[2]}else if(s.length===4){i.values.push(s[2]);l=s[3]}else if(s.length===5){i.values=s.slice(2,4);l=s[4]}var u;try{u=a.toDates(i)}catch(e){return n}if(s.length>=3&&l!=="start"&&l!=="end"){return n}var f;if(l==="end"){f=u[1]}else{f=u[0]}if(!f){return n}f=f.getJSDate();switch(e.edmType){case"Edm.String":n.value=t.string.format(f);break;case"Edm.Date":n.value=t.date.format(f);break;case"Edm.DateTime":f.setUTCFullYear(f.getFullYear(),f.getMonth(),f.getDate());f.setUTCHours(0,0,0,0);n.value=f;break;case"Edm.DateTimeOffset":if(r){n.value=t.dateTimeOffsetV4.format(f,true)}else{n.value=f}break;default:break}return n})};this._getDateTimeFormatters=function(){if(!this._oDateTimeFormatters){this._oDateTimeFormatters={string:i.getDateInstance({pattern:"yyyyMMdd",calendarType:n.Gregorian}),date:i.getDateInstance({pattern:"yyyy-MM-dd",calendarType:n.Gregorian}),dateTimeOffsetV4:i.getDateInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss'Z'",calendarType:n.Gregorian})}}return this._oDateTimeFormatters}}d.hasNoAdapter=true;return d},true);
//# sourceMappingURL=ReferenceResolver.js.map