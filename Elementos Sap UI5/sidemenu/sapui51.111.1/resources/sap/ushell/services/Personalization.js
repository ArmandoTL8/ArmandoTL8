// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/base/ManagedObject","sap/ui/base/Object","sap/ui/core/Core","sap/ui/thirdparty/jquery","sap/ushell/utils","sap/ushell/services/_Personalization/utils","sap/ushell/services/_Personalization/constants","sap/ushell/services/_Personalization/ContextContainer","sap/ushell/services/_Personalization/WindowAdapter","sap/ushell/services/_Personalization/TransientPersonalizer","sap/ushell/services/_Personalization/PersonalizationContainer","sap/ushell/services/_Personalization/Personalizer","sap/ushell/services/personalization/VariantSetAdapter","sap/ushell/services/_Personalization/Variant","sap/ushell/services/_Personalization/VariantSet","sap/ushell/services/_Personalization/WindowAdapterContainer"],function(e,t,n,r,jQuery,i,a,o,s,p,d,u,c,l,f,h,_){"use strict";function A(e,t,n,r){this._oConfig=r&&r.config||{};this._oAppVariantAdapterWithBackendAdapter=this._configureAppVariantStorage(this._oConfig.appVariantStorage);this._oAdapterWithBackendAdapter={lazy:false,instance:new p(this,e)};this._oAdapterWindowOnly={lazy:false,instance:new p(this,undefined)};this._oContainerMap=new i.Map;this._oPendingOperationsMap=new i.Map}A.prototype.SAVE_DEFERRED_DROPPED="Deferred save dropped (OK) - Data superseded by subsequent save";A.prototype.constants=o;A.prototype._configureAppVariantStorage=function(e){var t=this,n="sap.ushell.adapters.AppVariantPersonalizationAdapter";if(!e){e={adapter:{module:n}}}if(Object.keys(e).length===0||e.enabled===false){return}var r=e.adapter&&e.adapter.module||n,i=r.split(".").join("/");var a=function(){t._oAppVariantAdapterLoadPromise=t._oAppVariantAdapterLoadPromise||function(){var e=new jQuery.Deferred;try{sap.ui.require([i],n)}catch(t){e.reject(t)}function n(n){try{var r=new n;var i=new p(t,r);e.resolve(i)}catch(t){e.reject(t)}}return e.promise()}();return t._oAppVariantAdapterLoadPromise};return{lazy:true,create:a}};A.prototype.getGeneratedKey=function(){return i.generateRandomKey()};A.prototype.getPersonalizer=function(e,t,n){n=n||this._getApplicationComponent();return new c(this,this._oAdapterWithBackendAdapter.instance,e,t,n)};A.prototype._getApplicationComponent=function(){var e=t._sOwnerId;if(e){var i=r.getComponent(e);if(n.isA(i,"sap.ui.core.UIComponent")){return i}}return undefined};A.prototype.getTransientPersonalizer=function(){return new d};A.prototype.getContainer=function(e,t,n){n=n||this._getApplicationComponent();return this._createContainer(e,t,false,n)};A.prototype.createEmptyContainer=function(e,t,n){n=n||this._getApplicationComponent();return this._createContainer(e,t,true,n)};A.prototype._createContainer=function(e,t,n,r){var o=this,p,d,u,c,l,f,h=new jQuery.Deferred;if(typeof e!=="string"){throw new i.Error("sContainerKey is not a string: sap.ushell.services.Personalization"," ")}f=!!(a.isAppVariant(r)&&(!t||!t.shared)&&this._oAppVariantAdapterWithBackendAdapter);c=a.adjustScope(t);l=a.addContainerPrefix(e);if(f){var _=r.getManifestObject();c.component=r;c.appVarId=_.getEntry("/sap.ui5/appVariantId");c.appVersion=_.getEntry("/sap.app/applicationVersion/version");l+="#"+_.getEntry("/sap.ui5/appVariantId")}d=f?this._oAppVariantAdapterWithBackendAdapter:this._oAdapterWithBackendAdapter;p=o._oAdapterWindowOnly;u=a.pickAdapter(t,p,d);a.loadAdapter(u).then(function(e){var t,i=new s(o,e,l,c,r);var a=e&&e.supportsGetWithoutSubsequentLoad===true;if(n&&a){t=new jQuery.Deferred;t.resolve(i)}else{t=i.load()}t.fail(function(){h.reject()}).done(function(){if(n||i._isExpired()){i.clear()}h.resolve(i)})},function(e){h.reject(e)});return h.promise()};A.prototype.delContainer=function(e,t){var n={},r,i="",o=this;t=o._adjustScope(t);i=a.addContainerPrefix(e);n=new jQuery.Deferred;r=o._pendingContainerOperations_cancelAddNext(e,null);r.always(function(){o.getContainer(e,t).fail(function(){o._pendingContainerOperations_cancelAddNext(e,n);n.reject()}).done(function(){var r;o._pendingContainerOperations_cancelAddNext(e,n);r=t.validity===0?o._oAdapterWindowOnly:o._oAdapterWithBackendAdapter;a.loadAdapter(r).then(function(e){e.delAdapterContainer(i,t).fail(function(){n.reject()}).done(function(){n.resolve()})},function(){n.reject()})})});return n.promise()};A.prototype._pendingContainerOperations_flushAddNext=function(e,t){var n,r;n=this._oPendingOperationsMap.get(e);if(!n){n=new jQuery.Deferred;n.resolve()}if(t!==null){this._oPendingOperationsMap.put(e,t)}if(!n||n.state()!=="pending"){return n}clearTimeout(n._sapTimeoutId);n._sapTimeoutId=undefined;if(typeof n._sapFnSave==="function"){r=n._sapFnSave;n._sapFnSave=undefined;r()}return n};A.prototype._pendingContainerOperations_cancelAddNext=function(e,t){var n;n=this._oPendingOperationsMap.get(e);if(!n){n=new jQuery.Deferred;n.resolve()}if(t!==null){this._oPendingOperationsMap.put(e,t)}if(!n||n.state()!=="pending"){return n}if(n._sapTimeoutId){clearTimeout(n._sapTimeoutId);n._sapTimeoutId=undefined;n.resolve(A.prototype.SAVE_DEFERRED_DROPPED)}return n};A.prototype.getPersonalizationContainer=function(e){var t="",n={},r={};if(typeof e!=="string"){throw new i.Error("sContainerKey is not a string: sap.ushell.services.Personalization"," ")}t=a.addContainerPrefix(e);if(this._oContainerMap.containsKey(t)){return this._oContainerMap.get(t).promise()}r=new jQuery.Deferred;n=new u(this._oAdapterWithBackendAdapter.instance,t);n.done(function(e){r.resolve(e)}).fail(function(e){r.reject(e)});this._oContainerMap.put(t,r);return r.promise()};A.prototype.delPersonalizationContainer=function(e){var t={},n="",r=this;n=a.addContainerPrefix(e);t=new jQuery.Deferred;this.getPersonalizationContainer(e).fail(function(){t.reject()}).done(function(){r._oAdapterWithBackendAdapter.instance.delAdapterContainer(n).fail(function(){t.reject()}).done(function(){r._oContainerMap.remove(n);t.resolve()})});return t.promise()};A.prototype._getBackendAdapter=function(){return this._oAdapterWithBackendAdapter.instance._oBackendAdapter};A.prototype.resetEntirePersonalization=function(){var e=this._getBackendAdapter();return this.isResetEntirePersonalizationSupported().then(function(t){if(t){return e.resetEntirePersonalization()}return Promise.reject()})};A.prototype.isResetEntirePersonalizationSupported=function(){var t=this._getBackendAdapter();if(typeof t.resetEntirePersonalization!=="function"){return Promise.resolve(false)}if(typeof t.isResetEntirePersonalizationSupported==="function"){return t.isResetEntirePersonalizationSupported().then(function(e){return e}).catch(function(t){e.error("isResetEntirePersonalizationSupported failed with error: "+t.toString());return Promise.reject(t)})}return Promise.resolve(true)};A.prototype._adjustScope=a.adjustScope;A.hasNoAdapter=false;A.ContextContainer=s;A.Variant=f;A.VariantSet=h;A.VariantSetAdapter=l;A.WindowAdapter=p;A.WindowAdapterContainer=_;return A},true);
//# sourceMappingURL=Personalization.js.map