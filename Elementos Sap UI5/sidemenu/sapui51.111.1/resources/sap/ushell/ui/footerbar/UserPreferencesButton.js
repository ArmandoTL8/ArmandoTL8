// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/m/Bar","sap/m/Button","sap/m/ButtonRenderer","sap/m/Dialog","sap/m/DisplayListItem","sap/m/library","sap/m/List","sap/m/Text","sap/m/ObjectIdentifier","sap/ui/base/Object","sap/ui/core/Core","sap/ui/core/IconPool","sap/ui/Device","sap/ui/layout/VerticalLayout","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/library","sap/ushell/resources","sap/ushell/ui/launchpad/AccessibilityCustomData","sap/ushell/ui/launchpad/ActionItem","sap/ushell/ui/utils"],function(e,t,r,i,n,o,s,a,l,u,p,d,g,c,f,h,y,v,m,P,b,D,C,E){"use strict";var x=a.ButtonType;var T=C.extend("sap.ushell.ui.footerbar.UserPreferencesButton",{metadata:{library:"sap.ushell"},renderer:n});T.prototype.init=function(){if(C.prototype.init){C.prototype.init.apply(this,arguments)}this.setIcon("sap-icon://person-placeholder");this.setText(b.i18n.getText("userSettings"));this.setTooltip(b.i18n.getText("settings_tooltip"));this.attachPress(this.showUserPreferencesDialog);this.setModel(v.createModel("/core/userPreferences",y))};T.prototype.createDialog=function(){this.oDialog=new o({id:"userPreferencesDialog",title:"{/dialogTitle}",contentWidth:"29.6rem",contentHeight:"17rem",buttons:[new i({id:"saveButton",text:b.i18n.getText("saveBtn"),type:x.Emphasized,press:this._dialogSaveButtonHandler.bind(this),visible:{parts:["/entries"],formatter:function(e){if(!e){return false}return e.some(function(e){return e.editable})}}}),new i({id:"cancelButton",text:{parts:["/entries"],formatter:function(e){if(!e){return""}var t=e.some(function(e){return e.editable});return t>0?b.i18n.getText("cancelBtn"):b.i18n.getText("close")}},press:this._dialogCancelButtonHandler.bind(this),visible:true})],afterClose:function(){this._destroyDialog();this.oUser.resetChangedProperties()}.bind(this),stretch:f.system.phone,customHeader:new r({contentLeft:[new i({id:"userPrefBackBtn",visible:"{/isDetailedEntryMode}",icon:c.getIconURI("nav-back"),press:this._dialogBackButtonHandler.bind(this),tooltip:b.i18n.getText("feedbackGoBackBtn_tooltip")})],contentMiddle:[new u({id:"userPrefTitle",text:"{/dialogTitle}"})]}),customData:[new D({key:"aria-label",value:b.i18n.getText("Settings_Dialog_Main_label"),writeToDom:true})],content:this._getOriginalDialogContent()}).addStyleClass("sapUshellUserPreferencesDialog").addStyleClass("sapContrastPlus");this.oDialog.setModel(this.getModel())};T.prototype._getOriginalDialogContent=function(){if(!this.oInitialContent){var e=this._getUserPrefEntriesTemplate();this.oInitialContent=new h({id:"userPreferencesLayout",content:[new p({title:this.oUser.getFullName(),text:this.oUser.getEmail()}).addStyleClass("sapUshellUserPrefUserIdentifier"),new l({id:"userPrefEnteryList",items:{path:"/entries",template:e},customData:[new D({key:"aria-label",value:b.i18n.getText("Settings_EntryList_label")+this.oUser.getFullName(),writeToDom:true})]}).addEventDelegate({onAfterRendering:function(){g.byId("userPrefEnteryList").getItems().forEach(function(e){var t=e.getBindingContext().getPath();var r=this.getModel();if(!r.getProperty(t+"/valueResult")){this._setEntryValueResult(t)}if(r&&r.getProperty("/enableHelp")){var i=r.getProperty(t+"/entryHelpID");if(i){e.addStyleClass("help-id-"+i)}}}.bind(this))}.bind(this)})],width:"100%"})}return this.oInitialContent};T.prototype._setEntryValueResult=function(e){var t=this.getModel();var r=t.getProperty(e+"/editable");var i=t.getProperty(e+"/valueArgument");if(typeof i==="function"){t.setProperty(e+"/valueResult",b.i18n.getText("genericLoading"));t.setProperty(e+"/editable",false);var n=i();n.done(function(i){t.setProperty(e+"/editable",r);t.setProperty(e+"/visible",typeof i==="object"?!!i.value:true);t.setProperty(e+"/valueResult",typeof i==="object"?i.displayText:i)});n.fail(function(){t.setProperty(e+"/valueResult",b.i18n.getText("loadingErrorMessage"))})}else if(i){t.setProperty(e+"/valueResult",i);t.setProperty(e+"/editable",r)}else{t.setProperty(e+"/valueResult",b.i18n.getText("loadingErrorMessage"))}};T.prototype._emitEntryOpened=function(e){var t=m.last("UserSettingsOpened")||{};var r=e.split("/").pop();t[r]=true;m.emit("UserSettingsOpened",t)};T.prototype._getUserPrefEntriesTemplate=function(){return new s({label:"{title}",value:"{valueResult}",tooltip:{path:"valueResult",formatter:function(e){return typeof e==="string"?e:""}},type:{path:"editable",formatter:function(e){return e===true?"Navigation":"Inactive"}},visible:{path:"visible",formatter:function(e){return e!==undefined?e:true}},press:function(e){var r=t({},e);sap.ui.require(["sap/m/FlexBox","sap/m/FlexAlignItems","sap/m/FlexJustifyContent","sap/m/BusyIndicator"],function(e,t,i,n){var o=r.getSource().getLabel();var s=r.getSource().getBindingContext().getPath();var a=this.getModel();a.setProperty("/activeEntryPath",s);a.setProperty("/isDetailedEntryMode",true);a.setProperty("/dialogTitle",o);var l=a.getProperty(s+"/contentFunc");var p=a.getProperty(s+"/contentResult");this.oDialog.removeAllContent();if(p){var c=g.byId(p);this.oDialog.addContent(c);this._emitEntryOpened(s)}else if(typeof l==="function"){var f=null;var h=true;var y=false;var v=true;this._emitEntryOpened(s);l().done(function(e){h=false;if(y===true){this.oDialog.removeAllContent();f.destroy()}if(d.isA(e,"sap.ui.core.Control")){a.setProperty(s+"/contentResult",e.getId());this.oDialog.addContent(e)}else{v=false}}).fail(function(){h=false;if(y===true){this.oDialog.removeAllContent();f.destroy()}v=false}).always(function(){if(v===false){var r=new e({id:"userPrefErrorFlexBox",height:"5rem",alignItems:t.Center,justifyContent:i.Center,items:[new u({id:"userPrefErrorText",text:b.i18n.getText("loadingErrorMessage")})]});a.setProperty(s+"/contentResult",r.getId());this.oDialog.addContent(r)}});if(h===true){f=new n({id:"userPrefLoadingBusyIndicator",size:"2rem"});this.oDialog.addContent(f);y=true}}}.bind(this))}.bind(this),customData:[new D({key:"aria-label",value:{parts:[{path:"title"},{path:"valueResult"}],formatter:function(e,t){t=t||"";return e+" "+t}},writeToDom:true})]})};T.prototype.showUserPreferencesDialog=function(){this.oUser=sap.ushell.Container.getUser();this.createDialog();this.oDialog.open()};T.prototype._dialogBackButtonHandler=function(){var e=this.getModel();e.setProperty("/isDetailedEntryMode",false);e.setProperty("/dialogTitle",b.i18n.getText("userSettings"));this.oDialog.removeAllContent();this.oDialog.addContent(this._getOriginalDialogContent());this._setEntryValueResult(e.getProperty("/activeEntryPath"));e.setProperty("/activeEntryPath",null)};T.prototype._destroyDialog=function(){this.oInitialContent.destroy();delete this.oInitialContent;var e=this.getModel();e.setProperty("/isDetailedEntryMode",false);e.setProperty("/dialogTitle",b.i18n.getText("userSettings"));this._entriesCleanUp();this.oDialog.destroy();delete this.oDialog};T.prototype._entriesCleanUp=function(){var e=this.getModel();var t=e.getProperty("/entries");t.forEach(function(e){var t=e.contentResult;delete e.contentResult;if(t){var r=g.byId(t);r.destroy();r=null}delete e.valueResult});e.setProperty("/entries",t)};T.prototype._dialogSaveButtonHandler=function(){var t=this.getModel();var r=t.getProperty("/isDetailedEntryMode");if(r){t.setProperty("/activeEntryPath",null)}var i=t.getProperty("/entries");E.saveUserPreferenceEntries(i).done(function(){sap.ui.require(["sap/m/MessageToast"],function(e){var t=b.i18n.getText("savedChanges");e.show(t,{duration:3e3,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"})})}).fail(function(t){var r;var i="";if(t.length===1){r=b.i18n.getText("savingEntryError")+" "}else{r=b.i18n.getText("savingEntriesError")+"\n"}t.forEach(function(e){r+=e.entry+"\n";i+="Entry: "+e.entry+" - Error message: "+e.message+"\n"});sap.ushell.Container.getServiceAsync("Message").then(function(e){e.error(r,b.i18n.getText("Error"))});e.error("Failed to save the following entries",i,"sap.ushell.ui.footerbar.UserPreferencesButton")});this.oDialog.close();this._destroyDialog()};T.prototype._dialogCancelButtonHandler=function(){var e=this.getModel().getProperty("/entries");e.forEach(function(e){if(e&&e.onCancel){e.onCancel()}});this.oDialog.close();this._destroyDialog()};return T});
//# sourceMappingURL=UserPreferencesButton.js.map