// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/assert","sap/base/Log","sap/base/util/deepExtend","sap/base/util/extend","sap/base/util/ObjectPath","sap/base/util/uid","sap/ui/base/EventProvider","sap/ui/core/Control","sap/ui/core/Core","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/performance/Measurement","sap/ui/thirdparty/jquery","sap/ui/thirdparty/URI","sap/ui/util/Mobile","sap/ushell/EventHub","sap/ushell/System","sap/ushell/Ui5NativeServiceFactory","sap/ushell/Ui5ServiceFactory","sap/ushell/utils","sap/ushell/utils/UrlParsing"],function(e,t,n,r,i,o,a,s,u,l,c,jQuery,f,d,g,h,p,v,m,y){"use strict";var S="sap.ushell.services.Container",w="sap.ushell.Container.dirtyState.",C={},D,P,b,E=[];function L(){close()}function A(){document.location="about:blank"}function I(e){if(P&&P[e]){return P[e]}return"sap.ushell.adapters."+e}function R(e){return D.services&&D.services[e]||{}}function F(e,t,n,r,i){var o=R(e).adapter||{},a;function s(e){return new Promise(function(r,i){sap.ui.require([e],function(e){var i=new e(t,n,{config:o.config||{}});r(i)},i)})}if(i===true){a=o.module;if(a===undefined){return r?Promise.resolve():undefined}}else{a=o.module||I(t.getPlatform())+"."+e+"Adapter"}var u=a.replace(/\./g,"/");if(r){return s(u)}return function(){function e(e){var r=sap.ui.requireSync(e);return new r(t,n,{config:o.config||{}})}return e(u)}()}function U(n){var r=new a,i=false,l=[],d={},p="sap.ushell.Container."+n.getSystem().getPlatform()+".remoteSystem.",v={},P,b,I=m.getLocalStorage(),U=new m.Map,N=new m.Map,M="sap.ushell.Container."+n.getSystem().getPlatform()+".sessionTermination",T=this;this.cancelLogon=function(){if(this.oFrameLogonManager){this.oFrameLogonManager.cancelLogon()}};this.createRenderer=function(e,n){if(typeof e==="boolean"){n=e;e=undefined}var i={async:!!n};var o;var a;c.start("FLP:Container.InitLoading","Initial Loading","FLP");m.setPerformanceMark("FLP - renderer created");e=e||D.defaultRenderer;if(!e){throw new Error("Missing renderer name")}a=D.renderers&&D.renderers[e]||{};o=a.module||(e.indexOf(".")<0?"sap.ushell.renderers."+e+".Renderer":e);if(a.componentData&&a.componentData.config){i.config=a.componentData.config}function u(t){var n=sap.ui.requireSync(t);var o=new n({componentData:i});var a;var u=sap.ui.requireSync("sap/ui/core/UIComponent");if(o instanceof u){var l=sap.ui.requireSync("sap/ui/core/ComponentContainer");a=new l({component:o,height:"100%",width:"100%"})}else{a=o}if(!(a instanceof s)){throw new Error("Unsupported renderer type for name "+e)}f(a);d[e]=o;r.fireEvent("rendererCreated",{renderer:o});return a}function l(t){return new Promise(function(n,o){sap.ui.require([t,"sap/ui/core/ComponentContainer","sap/ui/core/UIComponent","sap/ui/core/routing/Router"],function(t,a,u){var l=new t({componentData:i});if(l instanceof u){var c=new a({component:l,height:"100%",width:"100%",async:true});f(c);d[e]=l;l.rootControlLoaded().then(function(){r.fireEvent("rendererCreated",{renderer:l});n(c)})}else if(l instanceof s){f(l);d[e]=l;r.fireEvent("rendererCreated",{renderer:l});n(l)}else{o(new Error("Unsupported renderer type!"))}})})}function f(e){e.placeAt=function(e,t){var n=e,r="canvas",i=document.body;if(e===i.id){n=document.createElement("div");n.setAttribute("id",r);n.classList.add("sapUShellFullHeight");switch(t){case"first":if(i.firstChild){i.insertBefore(n,i.firstChild);break}case"only":i.innerHTML="";default:i.appendChild(n)}e=r;t=""}s.prototype.placeAt.call(this,e,t)}}var g=o.replace(/\./g,"/");if(n){return l(g)}t.error("sap.ushell.Container.createRenderer() should always be called with bAsync:true.");return u(g)};this.getRenderer=function(e){var n,r;e=e||D.defaultRenderer;if(e){n=d[e]}else{r=Object.keys(d);if(r.length===1){n=d[r[0]]}else{t.warning("getRenderer() - cannot determine renderer, because no default renderer is configured and multiple instances exist.",null,S)}}if(n&&n.isA("sap.ui.core.ComponentContainer")){return n.getComponentInstance()}return n};this.DirtyState={CLEAN:"CLEAN",DIRTY:"DIRTY",MAYBE_DIRTY:"MAYBE_DIRTY",PENDING:"PENDING",INITIAL:"INITIAL"};this.getGlobalDirty=function(){var e,n=new jQuery.Deferred,r=o(),i,a=0,s=this.DirtyState.CLEAN;function u(){if(a===0||s===T.DirtyState.DIRTY){n.resolve(s);t.debug("getGlobalDirty() Resolving: "+s,null,"sap.ushell.Container")}}function l(e){if(e.key.indexOf(w)===0&&e.newValue!==T.DirtyState.INITIAL&&e.newValue!==T.DirtyState.PENDING){t.debug("getGlobalDirty() Receiving event key: "+e.key+" value: "+e.newValue,null,"sap.ushell.Container");if(e.newValue===T.DirtyState.DIRTY||e.newValue===T.DirtyState.MAYBE_DIRTY){s=e.newValue}a-=1;u()}}try{I.setItem(r,"CHECK");I.removeItem(r)}catch(e){t.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.Container");return n.resolve(this.DirtyState.MAYBE_DIRTY).promise()}if(P){throw new Error("getGlobalDirty already called!")}P=n;window.addEventListener("storage",l);n.always(function(){window.removeEventListener("storage",l);P=undefined});for(e=I.length-1;e>=0;e-=1){i=I.key(e);if(i.indexOf(w)===0){if(I.getItem(i)==="PENDING"){I.removeItem(i);t.debug("getGlobalDirty() Cleanup of unresolved 'PENDINGS':"+i,null,"sap.ushell.Container")}else{a+=1;m.localStorageSetItem(i,this.DirtyState.PENDING,true);t.debug("getGlobalDirty() Requesting status for: "+i,null,"sap.ushell.Container")}}}u();setTimeout(function(){if(n.state()!=="resolved"){n.resolve("MAYBE_DIRTY");t.debug("getGlobalDirty() Timeout reached, - resolved 'MAYBE_DIRTY'",null,"sap.ushell.Container")}},a*2e3);return n.promise()};this.getLogonSystem=function(){return n.getSystem()};this.getUser=function(){return n.getUser()};this.getDirtyFlag=function(){var e=i;var t=this._oShellNavigationService.getNavigationContext();for(var n=0;n<l.length;n++){e=e||l[n](t)}return e};this.fnAsyncDirtyStateProvider=null;this.getDirtyFlagsAsync=function(){if(!this.fnAsyncDirtyStateProvider){return Promise.resolve(this.getDirtyFlag())}var e=this._oShellNavigationService.getNavigationContext();return this.fnAsyncDirtyStateProvider(e).then(function(e){return e||this.getDirtyFlag()}.bind(this))};this.isAsyncDirtyStateProviderSet=function(){return typeof this.fnAsyncDirtyStateProvider==="function"};this.setAsyncDirtyStateProvider=function(e){this.fnAsyncDirtyStateProvider=e};this.setDirtyFlag=function(e){i=e};this.sessionKeepAlive=function(){if(n.sessionKeepAlive){n.sessionKeepAlive()}};this.extendSession=function(){g.emit("nwbcUserIsActive",Date.now())};this.registerDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function")}l.push(e)};this.deregisterDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function")}var t=-1;for(var n=l.length-1;n>=0;n--){if(l[n]===e){t=n;break}}if(t===-1){return}l.splice(t,1)};this.getService=function(e,t,n){return T._getService.apply(T,arguments)};this.getServiceAsync=function(e,t){return T._getService(e,t,true)};this._getService=function(e,r,i){var o={},a,s,u,l,c,f;function d(t){var n=new jQuery.Deferred;if(!t){throw new Error("Missing system")}n.resolve(F(e,t,r));sap.ushell.Container.addRemoteSystem(t);return n.promise()}if(!e){throw new Error("Missing service name")}if(e.indexOf(".")>=0){throw new Error("Unsupported service name")}c=R(e);a=c.module||"sap.ushell.services."+e;s=a+"/"+(r||"");f={config:c.config||{}};function g(e,t){o.createAdapter=d;return new e(t,o,r,f)}function h(t,i){var a;if(U.containsKey(s)){a=U.get(s)}else if(t.hasNoAdapter){a=new t(o,r,f)}else{l=F(e,n.getSystem(),r,i,t.useConfiguredAdapterOnly);if(i){return l.then(function(e){var n=g(t,e);U.put(s,n);return n})}a=g(t,l)}U.put(s,a);return i?Promise.resolve(a):a}if(!U.containsKey(s)){if(i){if(!N.containsKey(s)){var p=new Promise(function(e,t){sap.ui.require([a.replace(/[.]/g,"/")],function(t){e(h(t,true))},t)});N.put(s,p);return p}return N.get(s)}(function(){t.error("Deprecated API call of 'sap.ushell.Container.getService'. Please use 'getServiceAsync' instead",null,"sap.ushell.services.Container");u=sap.ui.requireSync(a.replace(/[.]/g,"/"));return h(u)})()}if(i){return Promise.resolve(U.get(s))}return U.get(s)};function _(){var e,t,n,r;for(n=I.length-1;n>=0;n-=1){r=I.key(n);if(r.indexOf(p)===0){try{e=r.substring(p.length);t=JSON.parse(I.getItem(r));v[e]=new h(t)}catch(e){I.removeItem(r)}}}return v}function k(){if(typeof OData==="undefined"){return}function e(e,n,r){t.warning(e,null,"sap.ushell.Container");if(r){setTimeout(r.bind(null,e),5e3)}return{abort:function(){return}}}OData.read=function(t,n,r){return e("OData.read('"+(t&&t.Uri?t.requestUri:t)+"') disabled during logout processing",n,r)};OData.request=function(t,n,r){return e("OData.request('"+(t?t.requestUri:"")+"') disabled during logout processing",n,r)}}this.addRemoteSystem=function(e){var n=e.getAlias(),r=v[n];if(this._isLocalSystem(e)){return}if(r){if(r.toString()===e.toString()){return}t.warning("Replacing "+r+" by "+e,null,"sap.ushell.Container")}else{t.debug("Added "+e,null,"sap.ushell.Container")}v[n]=e;m.localStorageSetItem(p+n,e)};this._isLocalSystem=function(e){var t=e.getAlias();if(t&&t.toUpperCase()==="LOCAL"){return true}var n=new f(m.getLocationHref()),r=this.getLogonSystem().getClient()||"";if(e.getBaseUrl()===n.origin()&&e.getClient()===r){return true}return false};this.addRemoteSystemForServiceUrl=function(e){var t,n={baseUrl:";o="};if(!e||e.charAt(0)!=="/"||e.indexOf("//")===0){return}t=/^[^?]*;o=([^/;?]*)/.exec(e);if(t&&t.length>=2){n.alias=t[1]}e=e.replace(/;[^/?]*/g,"");if(/^\/sap\/(bi|hana|hba)\//.test(e)){n.platform="hana";n.alias=n.alias||"hana"}else if(/^\/sap\/opu\//.test(e)){n.platform="abap"}if(n.alias&&n.platform){this.addRemoteSystem(new h(n))}};this.attachLogoutEvent=function(t,n){var i=false;if(n===true){e(typeof t==="function","Container.attachLogoutEvent: fnFunction must be a function");for(var o=0;o<E.length;o++){if(E[o]===t){i=true;break}}if(!i){E.push(t)}}else{r.attachEvent("Logout",t)}};this.detachLogoutEvent=function(e){r.detachEvent("Logout",e);for(var t=0;t<E.length;t++){if(E[t]===e){E.splice(t,1);break}}};this.attachRendererCreatedEvent=function(e){r.attachEvent("rendererCreated",e)};this.detachRendererCreatedEvent=function(e){r.detachEvent("rendererCreated",e)};this.defaultLogout=function(){var e=new jQuery.Deferred;function i(){n.logout(true).always(function(){I.removeItem(M);e.resolve()})}function o(){var e=new jQuery.Deferred,t=e.promise(),n=[];if(E.length>0){for(var o=0;o<E.length;o++){n.push(E[o]())}Promise.all(n).then(e.resolve);setTimeout(e.resolve,4e3)}else{e.resolve()}t.done(function(){if(r.fireEvent("Logout",true)){i()}else{setTimeout(i,1e3)}})}function a(){var e,n=[];if(b){window.removeEventListener("storage",b)}m.localStorageSetItem(M,"pending");T._suppressOData();e=T._getRemoteSystems();Object.keys(e).forEach(function(r){try{n.push(F("Container",e[r]).logout(false))}catch(e){t.warning("Could not create adapter for "+r,e.toString(),"sap.ushell.Container")}I.removeItem(p+r)});jQuery.when.apply(jQuery,n).done(o)}if(typeof n.addFurtherRemoteSystems==="function"){n.addFurtherRemoteSystems().always(a)}else{a()}return e.promise()};this.logout=this.defaultLogout;this.registerLogout=function(e){this.logout=e};this.setLogonFrameProvider=function(e){if(this.oFrameLogonManager){this.oFrameLogonManager.logonFrameProvider=e}};this.setXhrLogonTimeout=function(e,t){if(this.oFrameLogonManager){this.oFrameLogonManager.setTimeout(e,t)}};this.getFLPConfig=function(){var e=new Promise(function(e,t){var n={URL:this.getFLPUrl()};if(C.CDMPromise){C.CDMPromise.then(function(t){t.getSiteWithoutPersonalization().then(function(t){n.scopeId=t.site.identification.id;e(n)})})}else{e(n)}}.bind(this));return e};this.getFLPUrl=function(e){var t=m.getLocationHref(),n=t.indexOf(y.getShellHash(t));if(n===-1||e===true){return t}return t.substr(0,n-1)};this.getFLPUrlAsync=function(e){return(new jQuery.Deferred).resolve(T.getFLPUrl(e)).promise()};this.inAppRuntime=function(){return false};this.runningInIframe=this.inAppRuntime;this._getAdapter=function(){return n};this.getFLPPlatform=function(e){if(e===true){return D.flpPlatform}return Promise.resolve(D.flpPlatform)};this._closeWindow=L;this._redirectWindow=A;this._getRemoteSystems=_;this._suppressOData=k;u.getEventBus().subscribe("sap.ushell.Container","addRemoteSystemForServiceUrl",function(e,t,n){T.addRemoteSystemForServiceUrl(n)});if(typeof n.logoutRedirect==="function"){b=function(e){function t(){T._closeWindow();T._redirectWindow()}if(sap.ushell.Container!==T){return}if(e.key.indexOf(p)===0&&e.newValue&&e.newValue!==I.getItem(e.key)){m.localStorageSetItem(e.key,e.newValue)}if(e.key===M){if(e.newValue==="pending"){T._suppressOData();if(r.fireEvent("Logout",true)){t()}else{setTimeout(t,1e3)}}}};window.addEventListener("storage",b)}this._getFunctionsForUnitTest=function(){return{createAdapter:F}}}function N(e,t){e.forEach(function(e){var n=v.createServiceFactory(e,t);l.register("sap.ushell.ui5service."+e,n)})}function M(e){e.forEach(function(e){var t=p.createServiceFactory(e);l.register("sap.ushell.ui5service."+e,t)})}i.create("sap.ushell");sap.ushell.bootstrap=function(e,i){var o=new jQuery.Deferred;d.init();if(sap.ushell.Container!==undefined){var a=new Error("Unified shell container is already initialized - cannot initialize twice.\nStacktrace of first initialization:"+b);t.error(a,a.stack,S);throw a}b=(new Error).stack;D=r({},window["sap-ushell-config"]);P=i;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"])}N(["Personalization","URLParsing","CrossApplicationNavigation"],true);N(["Configuration"],false);M(["CardNavigation","CardUserRecents","CardUserFrequents"]);var s=new h({alias:"",platform:D.platform||e});F("Container",s,null,true).then(function(e){e.load().then(function(){function n(){var e,t;var n=window["sap-ushell-config"];if(!n||!n.services){return false}e=n.services.PluginManager;t=e&&e.config;return t&&t.loadPluginsFromSite}sap.ushell.Container=new U(e);var a=[sap.ushell.Container.getServiceAsync("PluginManager")];if(n()){C.CDMPromise=sap.ushell.Container.getServiceAsync("CommonDataModel");a.push(C.CDMPromise)}Promise.all(a).then(function(e){r(e)}).then(i);var s=[];if(D.preloadServices!==undefined&&Array.isArray(D.preloadServices)){D.preloadServices.forEach(function(e){s.push(sap.ushell.Container.getServiceAsync(e))});t.error("Ushell Config's preloadServices should not be used!")}var u=sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(e){sap.ushell.Container._oShellNavigationService=e});s.push(u);Promise.all(s).then(function(){o.resolve()})});function r(e){var r=e[0];var i=e[1];var o=i?i.getPlugins():jQuery.when({});o.then(function(e){var i=n({},D.bootstrapPlugins,e);r.registerPlugins(i);try{r.loadPlugins("EarlyLoading").catch(function(){t.error("Error loading S/4's my home plugin")})}catch(e){t.error("Error loading S/4's my home plugin")}})}function i(){a();sap.ui.require(["sap/ushell/Config"],function(e){s(e)})}function a(){if(m.hasFLPReady2NotificationCapability()){sap.ui.require(["sap/ushell/NWBCInterface"],function(e){m.getPrivateEpcm().doEventFlpReady2(e)})}else if(m.hasFLPReadyNotificationCapability()){m.getPrivateEpcm().doEventFlpReady()}}function s(e){if(e.last("/core/darkMode/enabled")){sap.ushell.Container.getServiceAsync("DarkModeSupport").then(function(e){if(e&&e.setup){e.setup()}})}}});return o.promise()}});
//# sourceMappingURL=Container.js.map