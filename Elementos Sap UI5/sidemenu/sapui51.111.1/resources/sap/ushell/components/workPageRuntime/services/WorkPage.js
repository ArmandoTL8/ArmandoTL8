// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/Core","sap/ushell/utils/HttpClient","sap/base/util/ObjectPath","sap/ushell/Config","sap/base/Log"],function(e,t,r,a,s){"use strict";var o=function(){this.httpClient=new t;this._sBaseUrl=a.last("/core/workPages/contentApiUrl")};o.prototype._validateData=function(e){s.debug("cep/editMode: load Page: validate","Work Page service");if(e.errors&&e.errors.length>0){return Promise.reject(e.errors.map(function(e){return e.message}).join(",\n"))}if(!r.get("data.WorkPage",e)){s.debug("cep/editMode: load Page: validate: reject: data is empty","Work Page service");return Promise.reject("Work Page data is empty")}return Promise.resolve(e)};o.prototype.loadWorkPageAndVisualizations=function(e,t){var a="{"+"WorkPage("+'SiteId:"'+e+'",'+'WorkPageId:"'+t+'"'+") {"+"Id,"+"Contents,"+"Editable,"+"UsedVisualizations{"+"nodes{"+"Id,"+"Type,"+"Descriptor,"+"DescriptorResources{"+"BaseUrl,"+"DescriptorPath"+"}"+"}"+"}"+"}"+"}";return this._doRequest(a).then(this._validateData).then(function(e){var t=r.get("data.WorkPage.Contents",e);var a=r.get("data.WorkPage.UsedVisualizations.nodes",e)||[];var s=r.get("data.WorkPage.Editable",e)===true;return{WorkPage:{Contents:t,UsedVisualizations:{nodes:a},Editable:s}}})};o.prototype.updateWorkPage=function(t,a){function s(e){for(var t in e){if(e[t]!==null&&typeof e[t]==="object"){if(e.DescriptorSchemaVersion){return e.DescriptorSchemaVersion}return s(e[t])}}return""}var o=s(a);function n(e,t){if(e&&e.DescriptorSchemaId){delete e.DescriptorSchemaId}for(var r in e){if(e[r]!==null&&typeof e[r]==="object"){n(e[r],!isNaN(r))}}if(e&&t){e.Descriptor=e.Descriptor||{};e.DescriptorSchemaVersion=e.DescriptorSchemaVersion||o}}function i(e){if(e.Rows){e.Rows.forEach(function(e){if(e.Columns){e.Columns.forEach(function(e){if(!e.Cells){e.Cells=[]}})}})}}n(a,true);i(a);var u="mutation updateWorkPage($WorkPageId: String!, $Contents: JSON) {"+"updateWorkPage(WorkPageId: $WorkPageId, Contents: $Contents ) {"+"Id,"+"Contents,"+"Editable,"+"UsedVisualizations{"+"nodes{"+"Id,"+"Type,"+"Descriptor,"+"DescriptorResources{"+"BaseUrl,"+"DescriptorPath"+"}"+"}"+"}"+"}"+"}";var p={query:u,variables:{WorkPageId:t,Contents:a}};return this.httpClient.post(this._sBaseUrl,{data:p,headers:{"Content-Type":"application/json",Accept:"application/json","Accept-Language":e.getConfiguration().getLanguageTag()}}).then(function(e){if(e.status<200||e.status>=300){return Promise.reject({statusText:"HTTP request failed with status: "+e.status,responseText:e.statusText})}var t={};try{t=JSON.parse(e.responseText||"{}")}catch(t){return Promise.reject({statusText:undefined,responseText:e.responseText})}var r;var a;if(t.errors){try{var s=t.errors[0].split("[");r=s[0];var o=JSON.parse("["+s[1]);a=JSON.stringify(o,null,"  ")}catch(e){r=null;a=t.errors}return Promise.reject({statusText:r,responseText:a})}return t}).then(function(e){var t=r.get("data.updateWorkPage.Contents",e);var a=r.get("data.updateWorkPage.UsedVisualizations.nodes",e)||[];var s=r.get("data.updateWorkPage.Editable",e)===true;return{WorkPage:{Contents:t,UsedVisualizations:{nodes:a},Editable:s}}})};o.prototype.loadFilteredVisualizations=function(e,t){var a=t.map(function(e){return'"'+e+'"'}).join(",");var s="{"+"Visualizations("+'SiteId:"'+e+'",'+"QueryInput:{filter:{Type:{in:["+a+"]}}}"+") {"+"nodes{"+"Id,"+"Type,"+"Descriptor,"+"DescriptorResources{"+"BaseUrl,"+"DescriptorPath"+"}"+"}"+"}"+"}";return this._doRequest(s).then(function(e){var t=r.get("data.Visualizations.nodes",e)||[];return{Visualizations:{nodes:t}}})};o.prototype._doRequest=function(t){return this.httpClient.get(this._sBaseUrl+"?query="+t,{headers:{"Content-Type":"application/json",Accept:"application/json","Accept-Language":e.getConfiguration().getLanguageTag()}}).then(function(e){if(e.status<200||e.status>=300){return Promise.reject("HTTP request failed with status: "+e.status+" - "+e.statusText)}return JSON.parse(e.responseText||"{}")})};return o},true);
//# sourceMappingURL=WorkPage.js.map