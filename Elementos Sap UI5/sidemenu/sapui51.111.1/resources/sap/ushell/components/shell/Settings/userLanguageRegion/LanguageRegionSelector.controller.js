// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/UriParameters","sap/ui/core/Configuration","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement"],function(e,t,a,r,n,s,i,o){"use strict";return s.extend("sap.ushell.components.shell.Settings.userLanguageRegion.LanguageRegionSelector",{onInit:function(){this.oUserInfoServicePromise=sap.ushell.Container.getServiceAsync("UserInfo");return this.oUserInfoServicePromise.then(function(e){this.oUser=sap.ushell.Container.getUser();var t=a.getFormatSettings().getFormatLocale();var r=n.getInstance(t);var s,o,g,u;var l=sap.ushell.Container.getRenderer("fiori2").getShellConfig().enableSetLanguage||false;var c=this.oUser.isLanguagePersonalized();var m=e.getUserSettingListEditSupported();var d=[];if(m){var L=a.getFormatSettings();s=L.getLegacyDateFormat();g=L.getLegacyTimeFormat();u=this._getLegacyNumberFormat(L);d.push(this._loadUserSettingList())}else{s=r.getDatePattern("medium");o=r.getTimePattern("medium");g=o.indexOf("H")===-1?"12h":"24h"}var f=new i({languageList:null,DateFormatList:null,TimeFormatList:null,NumberFormatList:null,TimeZoneList:null,selectedLanguage:this.oUser.getLanguage(),selectedLanguageText:this.oUser.getLanguageText(),selectedDatePattern:s,selectedTimeFormat:g,selectedNumberFormat:u,selectedTimeZone:this.oUser.getTimeZone(),isSettingsLoaded:true,isLanguagePersonalized:c,isEnableSetLanguage:l,isEnableUserProfileSetting:m,isTimeZoneIanaAvailable:true});f.setSizeLimit(1e3);var h=sap.ushell.Container.getUser().getTimeZoneIana();if(h===undefined||h!==""&&typeof h==="string"){f.setProperty("/isTimeZoneIanaAvailable",false)}if(l){d.push(this._loadLanguagesList())}if(d.length>0){this.getView().setBusy(true);return Promise.all(d).then(function(e){var t=m?e[0]:null;var a=null;if(l){a=e.length===1?e[0]:e[1]}if(a&&a.length>1){f.setProperty("/languageList",a);var r=a.some(function(e){return e.key==="default"});if(!c&&r){f.setProperty("/selectedLanguage","default")}}if(t&&t.TIME_FORMAT&&t.TIME_FORMAT.length>0){f.setProperty("/TimeFormatList",t.TIME_FORMAT)}if(t&&t.DATE_FORMAT&&t.DATE_FORMAT.length>0){f.setProperty("/DateFormatList",t.DATE_FORMAT)}if(t&&t.TIME_ZONE&&t.TIME_ZONE.length>0){f.setProperty("/TimeZoneList",t.TIME_ZONE)}if(t&&t.NUMBER_FORMAT&&t.NUMBER_FORMAT.length>0){f.setProperty("/NumberFormatList",t.NUMBER_FORMAT)}this.oView.setModel(f);this.getView().setBusy(false)}.bind(this))}this.oView.setModel(f)}.bind(this))},_loadLanguagesList:function(){o.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");return this.oUserInfoServicePromise.then(function(t){return new Promise(function(a){o.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");t.getLanguageList().done(function(e){o.end("FLP:LanguageRegionSelector._getLanguagesList");a(e)}).fail(function(t){o.end("FLP:LanguageRegionSelector._getLanguagesList");e.error("Failed to load language list.",t,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");a(null)})})})},_loadUserSettingList:function(){o.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");return this.oUserInfoServicePromise.then(function(e){return new Promise(function(t){o.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");e.getUserSettingList().then(function(e){o.end("FLP:LanguageRegionSelector._loadUserSettingList");t(e)})})})},onCancel:function(){var e=this.getView().getModel(),t=e.getData(),a=t.languageList,r=t.isEnableSetLanguage;if(r&&a){var n=this.oUser.getLanguage();var s=t.isLanguagePersonalized?n:"default";e.setProperty("/selectedLanguage",s);this._updateTextFields(n)}if(t.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}},onSaveSuccess:function(a,r,n){var s={refresh:true};a.resetChangedProperty("dateFormat");a.resetChangedProperty("timeFormat");a.resetChangedProperty("numberFormat");a.resetChangedProperty("timeZone");if(r){e.debug("[000] onSaveSuccess: oUser.resetChangedPropertyLanguage:","LanguageRegionSelector.controller");a.resetChangedProperty("language");var i=t.fromQuery(window.location.search).get("sap-language");if(i&&n!=="default"){s.urlParams=[{"sap-language":n}]}this._removeLanguageFromUserContextCookie()}return s},onSave:function(t){var r=this.oUser,n=this.getView().getModel().getData(),s=n.selectedLanguage,i=r.getLanguage(),o=s!==(n.isLanguagePersonalized?i:"default"),g=n.isEnableUserProfileSetting,u=n.isEnableSetLanguage&&n.languageList&&o,l=false,c=["DATE_FORMAT","TIME_FORMAT","NUMBER_FORMAT","TIME_ZONE","LANGUAGE"];e.debug("[000] LanguageRegionSelector:onSave:bUpdateLanguage, bIsEnableSetUserProfileSetting:",u,"LanguageRegionSelector.controller");if(u){e.debug("[000] LanguageRegionSelector:onSave:UserInfo: oUser.setLanguage:",s,"LanguageRegionSelector.controller");r.setLanguage(s)}if(g){var m=a.getFormatSettings();if(m.getLegacyDateFormat()!==n.selectedDatePattern){l=true;r.setChangedProperties({propertyName:"dateFormat",name:"DATE_FORMAT"},m.getLegacyDateFormat(),n.selectedDatePattern)}if(m.getLegacyTimeFormat()!==n.selectedTimeFormat){l=true;r.setChangedProperties({propertyName:"timeFormat",name:"TIME_FORMAT"},m.getLegacyTimeFormat(),n.selectedTimeFormat)}if(this._getLegacyNumberFormat(m)!==n.selectedNumberFormat){l=true;r.setChangedProperties({propertyName:"numberFormat",name:"NUMBER_FORMAT"},this._getLegacyNumberFormat(m),n.selectedNumberFormat)}if(this.oUser.getTimeZone()!==n.selectedTimeZone){l=true;r.setChangedProperties({propertyName:"timeZone",name:"TIME_ZONE"},this.oUser.getTimeZone(),n.selectedTimeZone)}}if(u||l){return t().then(function(){e.debug("[000] onSave:fnUpdateUserPreferences","LanguageRegionSelector.controller");return this.onSaveSuccess(r,u,s)}.bind(this)).catch(function(t){e.debug("[000] onSave:catch:errorMessage",t,"LanguageRegionSelector.controller");var a=c.some(function(e){return t.includes(e)});if(!a){return this.onSaveSuccess(r,u,s)}if(u){r.setLanguage(i);r.resetChangedProperty("language");this._updateTextFields(i)}r.resetChangedProperty("dateFormat");r.resetChangedProperty("timeFormat");r.resetChangedProperty("numberFormat");r.resetChangedProperty("timeZone");if(n.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}e.error("Failed to save Language and Region Settings",t,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");throw t}.bind(this))}return Promise.resolve()},_restoreUserSettingPreferenceValues:function(){var e=this.getView().getModel();var t=a.getFormatSettings();e.setProperty("/selectedDatePattern",t.getLegacyDateFormat());e.setProperty("/selectedTimeFormat",t.getLegacyTimeFormat());e.setProperty("/selectedNumberFormat",this._getLegacyNumberFormat(t));e.setProperty("/selectedTimeZone",this.oUser.getTimeZone())},_removeLanguageFromUserContextCookie:function(){var e=document.cookie.split(";").find(function(e){return e.indexOf("sap-usercontext")!==-1});if(!e){return}var t=e.replace("sap-usercontext=","").split("&");t=t.filter(function(e){return e.indexOf("sap-language")===-1});document.cookie="sap-usercontext="+t.join("&")+";path=/"},_handleSelectChange:function(e){var t=e.getParameters().selectedItem.getKey();this._updateTextFields(t)},_updateTextFields:function(e){var t;if(e===this.oUser.getLanguage()){t=a.getFormatSettings().getFormatLocale()}else{t=new r(e)}var s=this.getView().getModel(),i=n.getInstance(t),o=i.getDatePattern("medium"),g=i.getTimePattern("medium"),u=g.indexOf("H")===-1?"12h":"24h";if(!s.getData().isEnableUserProfileSetting){s.setProperty("/selectedDatePattern",o);s.setProperty("/selectedTimeFormat",u)}},_getLegacyNumberFormat:function(e){var t=e.getLegacyNumberFormat();if(t){return t.trim()}}})});
//# sourceMappingURL=LanguageRegionSelector.controller.js.map