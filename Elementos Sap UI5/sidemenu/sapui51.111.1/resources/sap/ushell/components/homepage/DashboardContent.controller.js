// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/Core","sap/ui/core/mvc/Controller","sap/ui/Device","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/thirdparty/jquery","sap/ushell/components/homepage/DashboardUIActions","sap/ushell/components/HomepageManager","sap/ushell/EventHub","sap/ushell/Layout","sap/ushell/resources","sap/ushell/utils"],function(e,t,r,i,o,jQuery,s,n,a,l,u,d){"use strict";return t.extend("sap.ushell.components.homepage.DashboardContent",{onInit:function(){var t=e.getEventBus();this.handleDashboardScroll=function(){window.setTimeout(this._handleDashboardScroll.bind(this),0)}.bind(this);t.subscribe("sap.ushell","appOpened",this._appOpenedHandler,this);t.subscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);t.subscribe("launchpad","actionModeInactive",this._handleGroupVisibilityChanges,this);t.subscribe("launchpad","switchTabBarItem",this._handleTabBarItemPressEventHandler,this);window.document.addEventListener("visibilitychange",d.handleTilesVisibility,false)},onExit:function(){var t=e.getEventBus();t.unsubscribe("launchpad","contentRefresh",this._webkitMobileRenderFix,this);t.unsubscribe("sap.ushell","appOpened",this._appOpenedHandler,this);t.unsubscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);t.unsubscribe("launchpad","switchTabBarItem",this._handleTabBarItemPressEventHandler,this);window.document.removeEventListener("visibilitychange",d.handleTilesVisibility,false);if(this.oDashboardUIActionsModule){this.oDashboardUIActionsModule.destroy();delete this.oDashboardUIActionsModule}window.removeEventListener("resize",this._resizeHandler.bind(this))},onAfterRendering:function(){d.setPerformanceMark("FLP - dashboard after rendering");var t=n.prototype.getInstance();if(!t.getPreparedGroupModel()){t.loadPersonalizedGroups()}else{a.once("firstSegmentCompleteLoaded").do(t.handleFirstSegmentLoaded.bind(t))}var i=e.getEventBus(),o,s,l,u;i.unsubscribe("launchpad","scrollToGroup",this._scrollToGroup,this);i.unsubscribe("launchpad","scrollToGroupByName",this._scrollToGroupByName,this);i.subscribe("launchpad","scrollToGroup",this._scrollToGroup,this);i.subscribe("launchpad","scrollToGroupByName",this._scrollToGroupByName,this);r.orientation.attachHandler(function(){var t=jQuery("#dashboardGroups").find(".sapUshellTileContainer").filter(":visible");if(t.length){o=this.getView().getModel();s=o.getProperty("/topGroupInViewPortIndex");if(t.get(s)){l=e.byId(t.get(s).id);u=o.getProperty("/editTitle");this._publishAsync("launchpad","scrollToGroup",{group:l,isInEditTitle:u})}}},this);window.addEventListener("resize",this._resizeHandler.bind(this));this._updateTopGroupInModel()},_resizeHandler:function(){clearTimeout(this._resizeTimer);this._resizeTimer=setTimeout(this.resizeHandler.bind(this),300)},_dashboardDeleteTileHandler:function(t){var r=t.getSource().getBindingContext().getObject();e.getEventBus().publish("launchpad","deleteTile",{tileId:r.uuid,items:"tiles"},this)},dashboardTilePress:function(t){var r=t.getSource();if(!r){return}e.getEventBus().publish("launchpad","dashboardTileClick",{uuid:r.getUuid()})},_updateTopGroupInModel:function(){var e=this.getView().getModel(),t=this._getIndexOfTopGroupInViewPort();var r=this._getModelGroupFromVisibleIndex(t);e.setProperty("/iSelectedGroup",r);e.setProperty("/topGroupInViewPortIndex",t)},_getIndexOfTopGroupInViewPort:function(){var e=this.getView().getDomRef(),t=e.getElementsByTagName("section")[0],r=jQuery(t).find(".sapUshellTileContainer").not(".sapUshellHidden");if(!r){return 0}for(var i=0;i<r.length;i++){var o=r[i].parentElement;if(t.scrollTop<=o.offsetTop+o.offsetHeight){return i}}return r.length?r.length-1:0},_handleDashboardScroll:function(){var e=this.getView(),t=e.getModel(),i=100;var o=t.getProperty("/homePageGroupDisplay"),s=o!=="tabs",n=t.getProperty("/tileActionModeActive");function a(){d.handleTilesVisibility()}clearTimeout(this.timeoutId);this.timeoutId=setTimeout(a,i);if(!r.system.phone){e.oAnchorNavigationBar.closeOverflowPopup()}if(s||n){this._updateTopGroupInModel()}e.oAnchorNavigationBar.reArrangeNavigationBarElements()},_handleGroupDeletion:function(t){sap.ui.require(["sap/m/MessageBox"],function(r){var i=e.getEventBus(),o=t.getObject(),s=o.removable,n=o.title,a=o.groupId,l=u.i18n,d=r.Action,p=s?d.DELETE:l.getText("ResetGroupBtn");sap.ushell.Container.getServiceAsync("Message").then(function(e){e.confirm(l.getText(s?"delete_group_msg":"reset_group_msg",n),function(e){if(e===p){i.publish("launchpad",s?"deleteGroup":"resetGroup",{groupId:a})}},l.getText(s?"delete_group":"reset_group"),[p,d.CANCEL])})})},_modelLoaded:function(){this.bModelInitialized=true;l.getInitPromise().then(function(){this._initializeUIActions()}.bind(this))},_initializeUIActions:function(){if(!this.oDashboardUIActionsModule){this.oDashboardUIActionsModule=new s}this.oDashboardUIActionsModule.initializeUIActions(this)},resizeHandler:function(){d.recalculateBottomSpace();d.handleTilesVisibility();if(a.last("AppRendered")!==undefined){a.emit("AppRendered",undefined)}if(l&&jQuery("#dashboardGroups").is(":visible")&&this.bModelInitialized){l.reRenderGroupsLayout(null);this._initializeUIActions()}},_appOpenedHandler:function(e,t,r){var i,o,s=this.getView().getModel(),n=r.additionalInformation||"";i=this.getOwnerComponent();o=i.getMetadata().getComponentName();if(n.indexOf(o)===-1){d.setTilesNoVisibility()}var a=sap.ui.require("sap/ushell/components/homepage/ActionMode");if(s.getProperty("/tileActionModeActive")&&a){a.toggleActionMode(s,"Menu Item");if(s.getProperty("/homePageGroupDisplay")==="tabs"){this._deactivateActionModeInTabsState();this.getView().oAnchorNavigationBar.reArrangeNavigationBarElements()}}if(this.oDashboardUIActionsModule){this.oDashboardUIActionsModule.disableAllDashboardUiAction()}},_scrollToGroupByName:function(e,t,r){var i=this.getView().getModel().getProperty("/groups"),o=r.groupName;sap.ushell.Container.getServiceAsync("LaunchPage").then(function(r){i.forEach(function(i){if(r.getGroupTitle(i.object)===o){this._scrollToGroup(e,t,{groupId:i.groupId})}}.bind(this))}.bind(this))},_scrollToGroup:function(e,t,i){var o=i.group?i.group.getGroupId():i.groupId;var s;if(this.oView.oDashboardGroupsBox.getGroups()){s=this.oView.oDashboardGroupsBox.getGroups().reduce(function(e,t){return t&&t.getGroupId()===o?t:e},null)}var n=s&&s.getDomRef();if(!n){return Promise.reject()}var a=n.querySelector(".sapUshellTileContainerContent");if(!a){return Promise.reject()}var l=document.getElementById("dashboardGroups");var u=a.getBoundingClientRect();var p=l.getBoundingClientRect();if(u.top===p.top){l.parentElement.scrollTop=0}else{a.scrollIntoView()}var g=new Promise(function(e){if(r.system.desktop&&(i.restoreLastFocusedTile||i.groupChanged)){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],function(t){t.getInstance().then(function(e){var t=s.$();if(i.restoreLastFocusedTile){var r=false;if(i.restoreLastFocusedTileContainerById){t=jQuery("#"+i.restoreLastFocusedTileContainerById);r=true}e.goToLastVisitedTile(t,r)}else if(i.groupChanged){var o=t.find(".sapUshellTile, .sapMGTLineMode, .sapFCard").filter(":visible").eq(0);if(o.length){e.moveScrollDashboard(o)}}}).then(e)})}else{e()}});g.then(function(){if(i.isInEditTitle){s.setEditMode(true)}d.handleTilesVisibility()});return g},_handleDrop:function(t,r){var i=l.getLayoutEngine(),o=i.layoutEndCallback(),s=!o.dstArea,n=e.getEventBus(),a,u,d,p=jQuery.Deferred(),g=this.getView(),h=g.getModel(),c=h.getProperty("/homePageGroupDisplay")&&h.getProperty("/homePageGroupDisplay")==="tabs",f=h.getProperty("/tileActionModeActive"),b=true,v;if(!o.tile){n.publish("launchpad","sortableStop");return null}l.getLayoutEngine()._toggleAnchorItemHighlighting(false);if(o.dstGroup){var G=o.dstGroup.getBindingContext(),m=G.getProperty(G.sPath).isGroupLocked;b=s&&m}v=o.tile.getBindingContext().getObject().isLinkPersonalizationSupported;if(!o.tileMovedFlag||b||!v&&o.dstArea==="links"){n.publish("launchpad","sortableStop");return null}if(!f&&!c&&o.dstArea==="links"&&!o.dstGroupData.getLinks().length){n.publish("launchpad","sortableStop");return null}a=true;u=true;if(o.srcGroup!==o.dstGroup){a=u=false}else if(o.tile!==o.dstGroup.getTiles()[o.dstTileIndex]){u=false}d=this._getTileUuid(o.tile);if(o.srcGroup&&o.srcGroup.removeAggregation&&o.srcArea){o.srcGroup.removeAggregation("tiles",o.tile,a)}var I=o.dstGroupData&&o.dstGroupData.insertAggregation&&o.dstArea===o.srcArea;if(I){o.tile.sParentAggregationName=o.dstArea;o.dstGroupData.insertAggregation(o.dstArea,o.tile,o.dstTileIndex,u);p=this._handleSameTypeDrop(o,d,I)}else if(s){p=this._handleShortDrop(o,d,I)}else{p=this._handleConvertDrop(o,I,r)}if(this.getView().getModel()){this.getView().getModel().setProperty("/draggedTileLinkPersonalizationSupported",true)}n.publish("launchpad","sortableStop");return p.promise()},_handleSameTypeDrop:function(t,r,i){var o=e.getEventBus(),s=jQuery.Deferred();t.tile._getBindingContext().oModel.setProperty(t.tile._getBindingContext().sPath+"/draggedInTabBarToSourceGroup",false);o.publish("launchpad","movetile",{sTileId:r,sToItems:t.dstArea?t.dstArea:"tiles",sFromItems:t.srcArea?t.srcArea:"tiles",sTileType:t.dstArea?t.dstArea.substr(0,t.dstArea.length-1):undefined,toGroupId:t.dstGroupData.getGroupId?t.dstGroupData.getGroupId():t.dstGroupData.groupId,toIndex:t.dstTileIndex,longDrop:i,callBack:function(){s.resolve()}});return s.promise()},_handleShortDrop:function(t,r,i){var o=e.getEventBus(),s=jQuery.Deferred();o.publish("launchpad","movetile",{sTileId:r,sToItems:t.srcArea||"tiles",sFromItems:t.srcArea||"tiles",sTileType:t.srcArea?t.srcArea.substr(0,t.srcArea.length-1):undefined,toGroupId:t.dstGroupData.getGroupId?t.dstGroupData.getGroupId():t.dstGroupData.groupId,toIndex:t.dstTileIndex,longDrop:i,callBack:function(){s.resolve()}});return s.promise()},_handleConvertDrop:function(t,r,i){var o=e.getEventBus(),s=jQuery.Deferred();o.publish("launchpad","convertTile",{toGroupId:t.dstGroupData.getGroupId?t.dstGroupData.getGroupId():t.dstGroupData.groupId,toIndex:t.dstTileIndex,tile:e.byId(i.id),srcGroupId:t.srcGroup.getGroupId?t.srcGroup.getGroupId():t.srcGroup.groupId,longDrop:r,callBack:function(){s.resolve()}});return s.promise()},_getTileUuid:function(e){if(e.getUuid){return e.getUuid()}var t=e.getBindingContext().getObject();if(t.getParent){return t.getParent().getUuid()}return t.uuid},_handleDrag:function(e,t){var r=l.getLayoutEngine().layoutEndCallback(),i=r.tile.getBindingContext().getObject(),o=this.getView().getModel();if(o){o.setProperty("/draggedTileLinkPersonalizationSupported",i.isLinkPersonalizationSupported)}},_handleTabBarItemPressEventHandler:function(e,t,r){var i=this.getView(),o=i.getModel(),s=o.getProperty("/groups"),n=r.iGroupIndex;for(var a=0;a<s.length;a++){o.setProperty("/groups/"+a+"/isGroupSelected",false)}o.setProperty("/groups/"+n+"/isGroupSelected",true);this._handleTabBarItemPress(e,t,n)},_handleTabBarItemPress:function(t,r,i,o){var s=this.getView(),n,a;if(o){n=o.getParameter("group").getIndex()}else{n=i}e.getEventBus().publish("launchpad","tabSelected",{iSelectedGroup:n});a=this._getVisibleGroupIndex(n);s.oDashboardGroupsBox.removeLinksFromUnselectedGroups();s.oDashboardGroupsBox.getBinding("groups").filter([s.oFilterSelectedGroup]);s.oAnchorNavigationBar.setSelectedItemIndex(a);s.oAnchorNavigationBar.reArrangeNavigationBarElements();setTimeout(function(){d.handleTilesVisibility()},0)},_getVisibleGroupIndex:function(e){var t=this.getView().getModel().getProperty("/groups");var r=0;for(var i=0;i<e;i++){if(!t[i].isGroupVisible||!t[i].visibilityModes[0]){r++}}return e-r},_getModelGroupFromVisibleIndex:function(e){var t=this.getView().getModel().getProperty("/groups"),r=0;for(var i=0;i<t.length;i++){if(t[i].isGroupVisible&&t[i].visibilityModes[0]){r++;if(r>e){return i}}}return 0},_handleAnchorItemPress:function(e){var t=this.getView(),s=t.getModel(),n=s.getProperty("/groups");if(r.system.phone&&e.getParameter("manualPress")){e.oSource.openOverflowPopup()}for(var a=0;a<n.length;a++){if(s.getProperty("/groups/"+a+"/isGroupSelected")===true){s.setProperty("/groups/"+a+"/isGroupSelected",false)}}s.setProperty("/groups/"+e.getParameter("group").getIndex()+"/isGroupSelected",true);s.setProperty("/iSelectedGroup",e.getParameter("group").getIndex());if(s.getProperty("/homePageGroupDisplay")&&s.getProperty("/homePageGroupDisplay")==="tabs"&&!s.getProperty("/tileActionModeActive")){this._handleTabBarItemPress(undefined,undefined,undefined,e)}else{if(!s.getProperty("/tileActionModeActive")){t.oDashboardGroupsBox.getBinding("groups").filter([new i("isGroupVisible",o.EQ,true)])}else{t.oDashboardGroupsBox.getBinding("groups").filter([])}this._scrollToGroup("launchpad","scrollToGroup",{group:e.getParameter("group"),groupChanged:true,focus:e.getParameter("action")==="sapenter"})}},_addGroupHandler:function(t){var r=t.getSource().getBindingContext().getPath();var i=r.split("/");var o=window.parseInt(i[i.length-1],10);if(t.getSource().sParentAggregationName==="afterContent"){o++}e.getEventBus().publish("launchpad","createGroupAt",{title:"",location:o,isRendered:true})},_publishAsync:function(t,r,i){var o=e.getEventBus();window.setTimeout(jQuery.proxy(o.publish,o,t,r,i),1)},_changeGroupVisibility:function(e){var t=e.getPath(),r=e.getModel(),i=r.getProperty(t+"/isGroupVisible");if(r.getProperty(t+"/isDefaultGroup")||r.getProperty(t+"/isGroupLocked")){return}r.setProperty(t+"/isGroupVisible",!i)},_handleGroupVisibilityChanges:function(e,t,r){var i=this.getView().getModel(),o=n.prototype.getInstance(),s=o.getCurrentHiddenGroupIds(i),a=s.length===r.length,l=a,p;s.some(function(e,t){if(!l){return true}l=r&&Array.prototype.indexOf.call(r,e)!==-1;return!l});if(!l){sap.ushell.Container.getServiceAsync("LaunchPage").then(function(e){p=e.hideGroups(s);p.done(function(){i.updateBindings("groups")});p.fail(function(){sap.ushell.Container.getServiceAsync("Message").then(function(e){e.error(u.i18n.getText("hideGroups_error"))})})})}window.setTimeout(function(){d.recalculateBottomSpace()},0)},_updateShellHeader:function(){if(!this.oShellUIService){this._initializeShellUIService()}else{this.oShellUIService.setTitle();this.oShellUIService.setHierarchy()}},_initializeShellUIService:function(){return sap.ui.require(["sap/ushell/ui5service/ShellUIService"],function(e){this.oShellUIService=new e({scopeObject:this.getOwnerComponent(),scopeType:"component"});this.oShellUIService.setTitle();this.oShellUIService.setHierarchy();return this.oShellUIService}.bind(this))},_deactivateActionModeInTabsState:function(){var e=this.getView(),t=e.getModel(),r;var i=t.getProperty("/groups");for(r=0;r<i.length;r++){t.setProperty("/groups/"+r+"/isGroupSelected",false)}var o=e.oAnchorNavigationBar.getSelectedItemIndex();var s=0;if(!this._isGroupVisible(o)){for(r=0;r<i.length;r++){if(!this._isGroupVisible(r)){s++}else{o=r;break}}}else{for(r=0;r<o;r++){if(!this._isGroupVisible(r)){s++}}}var n=o-s;e.oAnchorNavigationBar.setSelectedItemIndex(n);e.oAnchorNavigationBar.adjustItemSelection();t.setProperty("/groups/"+o+"/isGroupSelected",true);e.oDashboardGroupsBox.removeLinksFromAllGroups();var a=t.getProperty("/homePageGroupDisplay");if(a&&a==="tabs"){e.oDashboardGroupsBox.getBinding("groups").filter([e.oFilterSelectedGroup]);var l=e.oDashboardGroupsBox.getGroups&&e.oDashboardGroupsBox.getGroups();var u=Array.isArray(l)&&l[0];if(u&&u.updateLinks){u.updateLinks()}}},_isGroupVisible:function(e){var t=this.getView().getModel().getProperty("/groups");return t[e].isGroupVisible&&t[e].visibilityModes[0]}})});
//# sourceMappingURL=DashboardContent.controller.js.map