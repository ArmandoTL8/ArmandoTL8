//Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/Core","sap/ui/core/mvc/Controller","sap/base/util/uid","sap/ui/integration/widgets/Card","sap/ui/core/Fragment","sap/ui/integration/Host","sap/base/util/ObjectPath","sap/ui/model/json/JSONModel","sap/f/GridContainerItemLayoutData","sap/ushell/EventHub","sap/ushell/Config","sap/ui/core/theming/Parameters","sap/m/library","sap/ushell/services/_VisualizationInstantiation/VizInstanceCdm","sap/ushell/adapters/cdm/v3/utilsCdm","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/ushell/services/VisualizationInstantiation","sap/ui/core/InvisibleMessage","sap/ui/core/library"],function(e,t,i,r,o,n,a,s,d,l,g,u,h,c,p,v,m,f,C,P,w){"use strict";var _=4;var D=24;var y=2;var W=6;var S=c.LoadState;var z=w.InvisibleMessageMode;return i.extend("sap.ushell.components.workPageBuilder.controller.WorkPageBuilder",{onInit:function(){this._fnDeleteRowHandler=this.deleteRow.bind(this);this.oModel=new d({editMode:false,loaded:false,navigationDisabled:false,showFooter:false,data:{WorkPage:null,Visualizations:[],UsedVisualizations:[]}});this.oModel.setSizeLimit(Infinity);this._saveHost();this._oViewSettingsModel=new d({gridContainerGap:{},gridContainerRowSize:{}});this.getView().setModel(this._oViewSettingsModel,"viewSettings");var e=this._setGridContainerSizes.bind(this);u.on("/core/home/sizeBehavior").do(e);g.on("themeChanged").do(e);this._setGridContainerSizes();this.getView().setModel(this.oModel);this.byId("sapCepWorkPage").bindElement({path:"/data/WorkPage"});this._oVizInstantiationService=new C},onAddColumn:function(e){var t=this.getView().getModel();var i=e.getSource();var r=i.getParent();var o=r.indexOfAggregation("columns",i);var n=r.getBindingContext().getPath();var a=n+"/Columns/";var s=i.getBindingContext().getPath()+"/Descriptor/columnWidth";var d=t.getProperty(a);var l=d.length;var g=e.getParameter("left");if(l>=W){return}var u=i.getProperty("columnWidth");var h=Math.floor(u/2)>=_?Math.floor(u/2):_;var c=h%2;t.setProperty(s,h+c);var p=r.indexOfAggregation("columns",i)+(g===true?0:1);var v=this._createEmptyColumn(h-c);var m=[d.slice(0,p),v,d.slice(p)].flat();var f=m.reduce(function(e,t){return e+this._getColumnWidth(t)}.bind(this),0);if(f>D){this._calculateColWidths(m,o,f)}t.setProperty(a,m);this.getOwnerComponent().fireEvent("workPageEdited")},setEditMode:function(e){this.oModel.setProperty("/editMode",!!e)},getEditMode:function(){return this.oModel.getProperty("/editMode")},setShowFooter:function(e){this.oModel.setProperty("/showFooter",!!e)},setPageData:function(e){var t={};var i=s.get("WorkPage.UsedVisualizations.nodes",e);var r=s.get("WorkPage.Contents",e);if(i&&i.length>0){t=i.reduce(function(e,t){e[t.Id]=t;return e},{})}this.oModel.setProperty("/data/UsedVisualizations",t);this.oModel.setProperty("/data/WorkPage",r);this.oModel.setProperty("/loaded",true)},getPageData:function(){var e=this.oModel.getProperty("/data/UsedVisualizations")||{};return{WorkPage:{Contents:this.oModel.getProperty("/data/WorkPage"),UsedVisualizations:{nodes:Object.values(e)}}}},setVisualizationData:function(e){var t=s.get("Visualizations.nodes",e);this.oModel.setProperty("/data/Visualizations",t);this.oModel.firePropertyChange({type:"Visualizations"})},onGridColumnsChange:function(e){var t=e.getParameter("columns");var i=e.getSource();i.getWidgets().filter(function(e){return e.isA("sap.ui.integration.widgets.Card")}).forEach(function(e){e.setLayoutData(new l({columns:t,minRows:1}))})},onDeleteColumn:function(e){var t=this.getView().getModel();var i=e.getSource();var r=i.getColumnWidth();var o=i.getParent();var n=o.indexOfAggregation("columns",i);var a=o.getBindingContext().getPath();var s=a+"/Columns/";var d=t.getProperty(s);var l=d.filter(function(e,t){return t!==n});var g=r/2;var u=n-1<0?n:n-1;while(g>0){var h=l[u];this._setColumnWidth(h,this._getColumnWidth(h)+y);u=++u>=l.length?0:u++;g--}t.setProperty(s,l);this.getOwnerComponent().fireEvent("workPageEdited")},onAddFirstRow:function(){var e="/data/WorkPage/Rows/";this.getView().getModel().setProperty(e,[this._createEmptyRow()]);this.getOwnerComponent().fireEvent("workPageEdited")},onAddRow:function(e){var t=this.getView().getModel();var i=e.getSource();var r=this.byId("sapCepWorkPage");var o="/data/WorkPage/Rows/";var n=t.getProperty(o);var a=this._createEmptyRow();var s=r.indexOfAggregation("rows",i)+(e.getParameter("bottom")===true?1:0);var d=[n.slice(0,s),a,n.slice(s)].flat();t.setProperty(o,d);this.getOwnerComponent().fireEvent("workPageEdited")},onResize:function(e){var t=e.getParameter("posXDiff");var i=e.getSource();var r=i.getParent();var o=r.getSingleColumnWidth();var n,a,s,d,l,g,u,h;if(o===0){return}n=t/o;if(n>-1&&n<1){return}a=n<0?Math.floor(t/o):Math.ceil(t/o);s=a>=0?"right":"left";d=r.indexOfAggregation("columns",i);l=d-1;g=this._getCurrentColumnWidth(r,l);u=this._getCurrentColumnWidth(r,d);h=this._doColumnResizeStep(r,l,d,g,u,s);if(h){this._updateModelWithColumnWidths(r,l,d,h.newLeftColumnWidth,h.newRightColumnWidth)}},onResizeCompleted:function(){this.getOwnerComponent().fireEvent("workPageEdited")},_deleteCell:function(e){var t=this.getView().getModel();var i=e.getParent();var r=i.indexOfAggregation("cells",e);var o=i.getBindingContext().getPath()+"/Cells";var n=t.getProperty(o);var a=n.filter(function(e,t){return t!==r});t.setProperty(o,a);this.getOwnerComponent().fireEvent("workPageEdited")},onDeleteCell:function(e){this._deleteCell(e.getSource())},_deleteVisualization:function(e){var t=e.getParent().getParent();var i=e.getBindingContext();var r=i.getPath();var o=this.getView().getModel();var n=r.substring(0,r.lastIndexOf("/"));var a=t.indexOfAggregation("widgets",e);var s=o.getProperty(n);var d=s.filter(function(e,t){return t!==a});o.setProperty(n,d);this.getOwnerComponent().fireEvent("workPageEdited")},onEditTitle:function(){this.getOwnerComponent().fireEvent("workPageEdited")},onWidgetAdded:function(){this.getOwnerComponent().fireEvent("workPageEdited")},onAddWidget:function(e){this._oColumn=e.getSource();if(!this._oPromise){this._oPromise=this._loadContentFinderDialog()}return this._oPromise.then(function(e){this.oContentFinderDialog=e;var t={oWorkPageBuilderView:this.getView(),sUsedVizRootPath:"/data/UsedVisualizations",oColumn:this._oColumn,fnOnWidgetAdded:this.onWidgetAdded.bind(this)};this.oContentFinderDialogController.connect(this.sFragmentId,e,t,{iCurrentPageIndex:0});this.oContentFinderDialog.open()}.bind(this))},onAddApplications:function(e){var t=e.getSource();if(!this._oPromise){this._oPromise=this._loadContentFinderDialog()}return this._oPromise.then(function(e){this.oContentFinderDialog=e;var i={oWorkPageBuilderView:this.getView(),sUsedVizRootPath:"/data/UsedVisualizations",oCell:t,fnOnWidgetAdded:this.onWidgetAdded.bind(this)};this.oContentFinderDialogController.connect(this.sFragmentId,e,i,{iCurrentPageIndex:1,bRestrictedMode:true,sWidgetType:"widgets-tiles"});this.oContentFinderDialog.open()}.bind(this))},_loadContentFinderDialog:function(){return new Promise(function(e,t){sap.ui.require(["sap/ushell/components/workPageBuilder/controller/ContentFinderDialog.controller"],function(i){this.oContentFinderDialogController=new i;this.sFragmentId=this.createId("ContentFinderDialog");this.oContentFinderDialogController.init();n.load({id:this.sFragmentId,fragmentName:"sap.ushell.components.workPageBuilder.view.ContentFinderDialog",controller:this.oContentFinderDialogController}).then(function(t){this.getView().addDependent(t);e(t)}.bind(this)).catch(t)}.bind(this),t)}.bind(this))},onDeleteRow:function(e){var t=this.getOwnerComponent().getRootControl();var i=e.getSource().getBindingContext();if(!this.oLoadDeleteDialog){this.oLoadDeleteDialog=n.load({id:t.createId("rowDeleteDialog"),name:"sap.ushell.components.workPageBuilder.view.WorkPageRowDeleteDialog",controller:this}).then(function(e){e.setModel(this.getView().getModel("i18n"),"i18n");return e}.bind(this))}return this.oLoadDeleteDialog.then(function(e){e.getBeginButton().detachEvent("press",this._fnDeleteRowHandler);e.getBeginButton().attachEvent("press",{rowContext:i},this._fnDeleteRowHandler);e.open()}.bind(this))},deleteRow:function(e,t){var i=this.getView().getModel();var r=t.rowContext;var o=i.getProperty("/data/WorkPage/Rows");var n=r.getObject();var a=o.filter(function(e){return e.Id!==n.Id});i.setProperty("/data/WorkPage/Rows",a);this.getOwnerComponent().fireEvent("workPageEdited");return this.oLoadDeleteDialog.then(function(e){e.close()})},onRowDeleteCancel:function(){return this.oLoadDeleteDialog.then(function(e){e.close()})},_createErrorTile:function(){return new p({state:S.Failed}).attachPress(this.onVisualizationPress,this).bindEditable("/editMode").setLayoutData(new l({columns:2,rows:2}))},widgetFactory:function(t,i){var r=i.getProperty("Visualization/Id");if(!r){e.error("No vizId found in widget context.");return this._createErrorTile()}var o=this.getView().getModel().getProperty("/data/UsedVisualizations/"+r);if(!o||!o.Type){e.error("No viz or vizType found for vizId "+r);return this._createErrorTile()}switch(o.Type){case"sap.card":return this._createCard(o);case"sap.ushell.StaticAppLauncher":case"sap.ushell.DynamicAppLauncher":return this._createVizInstance(o);default:e.error("Unknown type for widget "+o.Type);return this._createErrorTile()}},_createVizInstance:function(t){var i=s.get(["Descriptor","sap.flp","indicatorDataSource"],t);var r=s.get(["Descriptor","sap.app","dataSources"],t);var o=s.get(["Descriptor","sap.flp","target","appId"],t);var n=this.getOwnerComponent().getSiteApplication(o);var a=this.getOwnerComponent().getSiteVizType(t.Type);var d={};d[o]=n;var g={id:t.Id,title:s.get(["Descriptor","sap.app","title"],t),subtitle:s.get(["Descriptor","sap.app","subTitle"],t),info:s.get(["Descriptor","sap.app","info"],t),icon:s.get(["Descriptor","sap.ui","icons","icon"],t),keywords:s.get(["Descriptor","sap.app","tags","keywords"],t)||[],_instantiationData:{platform:"CDM",vizType:a},indicatorDataSource:i,vizType:s.get("Type",t),dataSource:this._getDataSource(r,i),contentProviderId:s.get(["sap.app","contentProviderId"],n),vizConfig:s.get(["Descriptor"],t),supportedDisplayFormats:s.get(["Descriptor","sap.flp","vizOptions","displayFormats","supported"],t),displayFormatHint:s.get(["Descriptor","sap.flp","vizOptions","displayFormats","default"],t),numberUnit:s.get(["Descriptor","sap.flp","numberUnit"],t),vizId:t.Id,preview:false};g.target=m.harmonizeTarget(f.getTarget(g)||{});g.targetURL=v.toHashFromVizData(g,d);var u=this._oVizInstantiationService.instantiateVisualization(g);if(!u){e.error("No VizInstance was created.");return this._createErrorTile()}return u.attachPress(this.onVisualizationPress,this).bindEditable("/editMode").bindClickable({path:"/navigationDisabled",formatter:function(e){return!e}}).setLayoutData(new l(u.getLayout()))},_getDataSource:function(e,t){if(!t||!e){return}return e[t.dataSource]},onVisualizationPress:function(e){var t=e.getParameter("scope");var i=e.getParameter("action");if(t==="Actions"&&i==="Remove"){this._deleteVisualization(e.getSource())}},_createCard:function(t){var i={};var r=t.Descriptor&&t.Descriptor["sap.card"];var n=t.DescriptorResources&&(t.DescriptorResources.BaseUrl||t.DescriptorResources.DescriptorPath);if(!r&&!n){e.error("No Descriptor or DescriptorResources for Card");return(new o).setLayoutData(new l({columns:2,rows:2}))}if(r){i.manifest=t.Descriptor;if(n){i.baseUrl=t.DescriptorResources.BaseUrl+t.DescriptorResources.DescriptorPath}}else if(n){i.manifest=t.DescriptorResources.BaseUrl+t.DescriptorResources.DescriptorPath+"/manifest.json"}if(i.baseUrl&&i.baseUrl.substr(-1)!=="/"){i.baseUrl+="/"}return new o(i).addStyleClass("sapCepWidget").attachAction(this.executeNavigation.bind(this)).setHost(this.oHost).setLayoutData(new l({columns:16,minRows:1}))},executeNavigation:function(e){var t=e.getParameter("parameters");if(e.getParameter("type")!=="Navigation"||this.oModel.getProperty("/navigationDisabled")){return Promise.resolve()}return sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(e){return e.toExternal({target:{semanticObject:t.ibnTarget.semanticObject,action:t.ibnTarget.action},params:t.ibnParams})})},saveEditChanges:function(){this.getOwnerComponent().fireEvent("closeEditMode",{saveChanges:true})},cancelEditChanges:function(){this.getOwnerComponent().fireEvent("closeEditMode",{saveChanges:false})},onCellDrop:function(e){var t=e.getParameter("draggedControl");var i=t.getParent().getParent();var r=e.getParameter("droppedControl");var o=i.indexOfAggregation("widgets",t);var n=r.getBindingContext().getProperty("Widgets").length;this._moveVisualization(i,r,o,n)},onCellDragEnter:function(e){var t=e.getParameter("target");if(!this.tileEditMode(true,t.getBindingContext().getProperty("Widgets"))){e.preventDefault()}},onGridDrop:function(e){var t=e.getSource();var i=e.getParameter("draggedControl");var r=e.getParameter("droppedControl");var o=e.getParameter("dropPosition");var n=i.getParent().getParent();var a=n.indexOfAggregation("widgets",i);var s=t.indexOfAggregation("widgets",r);var d=t.getId()===n.getId();if(o==="After"){s++}if(d){if(a<s){s--}if(a===s){return}}this._moveVisualization(n,t,a,s)},_moveVisualization:function(e,t,i,r){var o=this.getView().getModel();var n=e.getBindingContext().getPath()+"/Widgets";var a=t.getBindingContext().getPath()+"/Widgets";var s=n===a;var d=o.getProperty(n);var l=o.getProperty(a);var g=d[i];var u=d.filter(function(e,t){return t!==i});if(s){l=u}var h=[l.slice(0,r),g,l.slice(r)].flat();o.setProperty(n,u);o.setProperty(a,h);P.getInstance().announce(this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Message.WidgetMoved"),z.Assertive);this.getOwnerComponent().fireEvent("workPageEdited")},tileEditMode:function(e,t){var i=this.getView().getModel();var r;return e&&!!t&&t.every(function(e){r=i.getProperty("/data/UsedVisualizations/"+s.get("Visualization.Id",e));return["sap.ushell.DynamicAppLauncher","sap.ushell.StaticAppLauncher"].indexOf(s.get("Type",r))>-1})},_updateModelWithColumnWidths:function(e,t,i,r,o){var n=this.getView().getModel();var a=e.getBindingContext();var s=a.getPath();var d=s+"/Columns/"+t+"/Descriptor/columnWidth";var l=s+"/Columns/"+i+"/Descriptor/columnWidth";n.setProperty(d,r);n.setProperty(l,o)},_updateColumnWidthClass:function(e,t,i){e.$().find(".sapCepWorkPageColumn").eq(t).removeClass(function(e,t){return(t.match(/sapCepColumnWidth.*/g)||[]).join(" ")}).addClass("sapCepColumnWidth"+i)},_doColumnResizeStep:function(i,r,o,n,a,s){var d=t.getConfiguration().getRTL();var l;if(!d){l=s==="right"?y:-y}else{l=s==="right"?-y:y}var g=n+l;var u=a-l;if(g<_||u<_){e.debug("new column value too small",g,u);return null}this._updateColumnWidthClass(i,r,g);this._updateColumnWidthClass(i,o,u);return{newLeftColumnWidth:g,newRightColumnWidth:u}},_getCurrentColumnWidth:function(e,t){var i=e.getBindingContext().getPath();var r=i+"/Columns/"+t+"/Descriptor/columnWidth";return this.getView().getModel().getProperty(r)},_getColumnWidth:function(e){return s.get("Descriptor.columnWidth",e)||D},_setColumnWidth:function(e,t){return s.set("Descriptor.columnWidth",t,e)},_calculateColWidths:function(e,t,i){var r=e[t];if(this._getColumnWidth(r)-y>=_){this._setColumnWidth(r,this._getColumnWidth(r)-y);i=i-y}if(i>D){var o=t-1>=0?t-1:e.length-1;this._calculateColWidths(e,o,i)}return e},_createEmptyColumn:function(e){return{Id:r(),DescriptorSchemaVersion:"3.2.0",Descriptor:{columnWidth:e},Configurations:[],Cells:[]}},_createEmptyRow:function(){return{Id:r(),DescriptorSchemaVersion:"3.2.0",Descriptor:{title:this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Row.OverflowToolbar.RowTitleLabel"),description:"this is not yet rendered",fillRowHeight:false,fullWidth:false},Columns:[this._createEmptyColumn(D)]}},_saveHost:function(){this.oHost=t.byId("sap.shell.host.environment");if(!this.oHost){this.oHost=new a("sap.shell.host.environment",{resolveDestination:function(e){if(!e){return Promise.reject()}return Promise.resolve("/dynamic_dest/"+e)}})}},getNavigationDisabled:function(){return this.oModel.getProperty("/navigationDisabled")},setNavigationDisabled:function(e){this.oModel.setProperty("/navigationDisabled",e)},_setGridContainerSizes:function(){var e=u.last("/core/home/sizeBehavior");var t=this.getView().getModel("viewSettings");var i=e==="Small"?"_sap_ushell_Tile_SpacingXS":"_sap_ushell_Tile_Spacing";var r=e==="Small"?"_sap_ushell_Tile_SpacingXS":"_sap_ushell_Tile_SpacingS";t.setProperty("/gridContainerGap/gridContainerGap",this._getNumericThemeParam(i));t.setProperty("/gridContainerGap/gridContainerGapXS",this._getNumericThemeParam("_sap_ushell_Tile_SpacingXS"));t.setProperty("/gridContainerGap/gridContainerGapS",this._getNumericThemeParam(r));t.setProperty("/gridContainerGap/gridContainerGapM",this._getNumericThemeParam(i));t.setProperty("/gridContainerGap/gridContainerGapL",this._getNumericThemeParam(i));t.setProperty("/gridContainerGap/gridContainerGapXL",this._getNumericThemeParam(i));var o=e==="Small"?"_sap_ushell_Tile_WidthXS":"_sap_ushell_Tile_Width";var n=e==="Small"?"_sap_ushell_Tile_WidthXS":"_sap_ushell_Tile_WidthS";t.setProperty("/gridContainerRowSize/gridContainerRowSize",this._getNumericThemeParam(o));t.setProperty("/gridContainerRowSize/gridContainerRowSizeXS",this._getNumericThemeParam("_sap_ushell_Tile_WidthXS"));t.setProperty("/gridContainerRowSize/gridContainerRowSizeS",this._getNumericThemeParam(n));t.setProperty("/gridContainerRowSize/gridContainerRowSizeM",this._getNumericThemeParam(o));t.setProperty("/gridContainerRowSize/gridContainerRowSizeL",this._getNumericThemeParam(o));t.setProperty("/gridContainerRowSize/gridContainerRowSizeXL",this._getNumericThemeParam(o))},_getNumericThemeParam:function(e){var t=h.get(e);if(t&&t.indexOf(".")===0){t="0"+t}return t}})});
//# sourceMappingURL=WorkPageBuilder.controller.js.map