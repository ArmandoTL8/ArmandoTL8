/*
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/olap/MultiDimModel",["sap/base/Log","sap/ui/model/Model","sap/ui/model/Context","sap/sac/df/types/ValueType","sap/sac/df/olap/SystemLandscape","sap/sac/df/utils/SyncActionHelper","sap/sac/df/utils/ResultSetHelper","sap/sac/df/utils/ListHelper","sap/sac/df/DFKernel","sap/sac/df/olap/OlapListBinding","sap/sac/df/olap/OlapListGridBinding","sap/sac/df/olap/OlapPropertyBinding","sap/sac/df/olap/MultiDimDataProvider","sap/sac/df/utils/ResourceBundle","sap/sac/df/fa/AdvancedStylingProvider","sap/sac/df/thirdparty/lodash","sap/sac/df/firefly/library","sap/sac/df/fa/FinStyle"],function(e,a,t,r,n,i,o,s,c,l,u,d,f,p,v,g,m,y){"use strict";var h=new RegExp("/","g");var S=c.extend("sap.sac.df.olap.MultiDimModel",{constructor:function(a){this.stylingProvider=new v;this.stylingProvider.registerAdvancedStylingTemplate("fin",y);var r=this;var o=a||{};o.systemLandscape=o.systemLandscape||n;o.systemType=o.systemType||"BW";o.masterSystem=o.masterSystem||"local"+o.systemType;c.apply(r,[o]);var s=null;var S={};var P={};var D=r.init(o).then(function(){var e=r.getSession();e.setXVersion(m.XVersion.V190_METADATA_CUBE_RESPONSE_SUPPRESS_PROPERTIES);e.deactivateFeatureToggle(m.FeatureToggleOlap.FUSION_SERVICE);m.XStream.of(m.FeatureToggleOlap.getAllFeatureToggles()).forEach(function(a){var t=a.getXVersion();if(t>m.FeatureToggleOlap.FUSION_SERVICE.getXVersion()&&t<=m.XVersion.MAX){e.activateFeatureToggle(a)}});e.activateFeatureToggle(m.FeatureToggleOlap.METADATA_CACHING);m.UiLocalizationCenter.setExternalLocalizationProvider(p);m.UiLocalizationCenter.getCenter().setProductive(true)}).then(function(){s={ColLimit:50,RowLimit:150,DataProvider:{},VariableGroups:{},SemanticStyles:{},Messages:[]};r.checkUpdate()});r.setDataAccessLanguage=function(e){var a=r.getApplication().getSystemLandscape();var t=a.getSystemNames();for(var n=0;n<t.size();n++){a.getSystemDescription(t.get(n)).setLanguage(e)}};r.getLimit=function(){return{RowLimit:s.RowLimit,ColLimit:s.ColLimit}};r.addVariableGroup=function(e,a,t){s.VariableGroups[e]={Name:e,Rule:a,MergedVariable:null};Object.assign(s.VariableGroups[e],t);E(e)};r.addQuery=function(e,a,t,n,o,c){var l=t||this.masterSystemName;var u=s.DataProvider[e];s.DataProvider[e]=null;return b(l).then(function(){if(!u)return;return u.logoff()}).then(function(){var e=m.QueryServiceConfig.createWithDataSourceName(r.getApplication(),null,a);e.setMode(m.QueryManagerMode.DEFAULT);e.setProviderType(m.ProviderType.ANALYTICS);e.setSupportsDimensionLazyLoad(true);var t=["$[][][MY_DATA_AREA]/",c||"query",":","[",o?o:"","]","[",o||n?n:"","]","[",a,"]"].join("");e.setDataSourceByName(t);e.setSystemName(l);return i.syncActionToPromise(e.processQueryManagerCreation,e,[])}).then(function(a){s.DataProvider[e]=new f(r,r.getApplication(),a,e);E();r.fireEvent("queryAdded",{dataProviderName:e});return s.DataProvider[e]}).catch(function(e){r.addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})};r.setVariableGroupValue=function(e,a){var t=s.VariableGroups[e];var n=t.MergedVariable.DataProviderName;return s.DataProvider[n].setVariableValue(t.MergedVariable.Name,a).then(function(){E(e);return r.checkUpdate()})};r.deserialize=function(e){s.DataProvider=s.DataProvider||{};s.SemanticStyles=e.SemanticStyles||[];return D.then(function(){var a=[];g.forEach(e.DataProvider,function(e,t){var n=s.DataProvider[t];if(!n){var o=m.QueryServiceConfig.createByDefinition(r.getApplication(),null,m.XContent.createStringContent(m.QModelFormat.INA_REPOSITORY,e));a.push(i.syncActionToPromise(o.processQueryManagerCreation,o,[]).then(function(e){s.DataProvider[t]=new f(r,r.getApplication(),e,t)}))}else{a.push(n.deserialize(e))}});return Promise.all(a)}).then(function(){E();return r.checkUpdate()})};r.serialize=function(){return{DataProvider:g.reduce(s.DataProvider,function(e,a){e[a.Name]=a.serialize();return e},{}),SemanticStyles:r.getSemanticStyles()}};r.openVariableSelector=function(e){return Promise.resolve(null).then(function(){var a=s.VariableGroups[e];if(!a){throw new Error("Invalid VariableGroup: "+e)}if(!a.MergedVariable){return false}var t=s.DataProvider[a.MergedVariable.DataProviderName];return t.openVariableSelector(a.MergedVariable.Name).then(function(a){if(!a){return false}E(e);r.checkUpdate();return true})})};r.searchVariableValues=function(e,a,t){return Promise.resolve(null).then(function(){var r=s.VariableGroups[e];if(!r){throw new Error("Invalid VariableGroup: "+e)}if(!r.MergedVariable){return false}var n=s.DataProvider[r.MergedVariable.DataProviderName];return n.searchVariableValues(r.MergedVariable.Name,a,t)})};r.logoff=function(){return Promise.all(g.invokeMap(s.DataProvider,"logoff"))};r.synchronize=function(e){var a=e?g.filter(s.DataProvider,function(a){return e.includes(a.Name)}):s.DataProvider;var t=g.invokeMap(a,"getResultSet");return Promise.all(t).then(function(){return r.checkUpdate()})};r.resetModel=function(){var e=[];g.forEach(s.DataProvider,function(a){e.push(a.resetToDefault())});return Promise.all(e).then(function(){E()})};r.getDataProvider=function(e){return s.DataProvider[e]};r.clearMessages=function(e){s.Messages=[];return e?r.checkUpdate():r};r.propagateVariableGroupValues=function(e){var a=[];var t=s.DataProvider[e];g.forEach(s.VariableGroups,function(r){var n=P[r.Name];g.forEach(n,function(n){if(n.DataProviderName===e&&!g.isEqual(r.MergedVariable.MemberFilter,n.MemberFilter)){a.push(t.setVariableValue(n.Name,r.MergedVariable.MemberFilter))}})});return Promise.all(a)};r.getProperty=function(e,a){return M(e,a)};r.setProperty=function(a,t){var n=false;var i=g.filter(a.split("/"),g.identity);try{var o=i.pop();var c=i.join(".");var l=g.get(s,c);if(o!=="vizProperties"||t){if(l){l[o]=t}else{e.warning("Failed to set "+t+" on: "+a)}}r.checkUpdate();n=true}catch(a){e.error(a)}return n};r.setSemanticStyles=function(e){s.SemanticStyles=g.clone(e)};r.getSemanticStyles=function(){return s.SemanticStyles};r.addMessages=function(e){s.Messages=g.map(g.groupBy(g.concat(s.Messages,e),"Text"),function(e){return e[0]});return r.checkUpdate()};r.bindProperty=function(e,a,t){var n=new d(r,e,a,t);S[n.getId()]=n;return n};r.bindList=function(e,a,t,n,i){if(e.match(/^(\/)?dataProvider\/(.)*\/Grid\/renderGrid/)){return new u(r,e,a,t,n,i)}else{return new l(r,e,a,t,n,i)}};function M(e,a){var r=a instanceof t?M(a.getPath()):s;if(e){var n=e.replace(h,".");if(n.startsWith(".")){n=n.replace(".","")}return g.get(r,n)}else{return r}}r.isList=function(e,a){return Array.isArray(M(r.resolve(e,a)))};r.checkUpdate=function(e){g.forEach(S,function(a,t){if(a){a.checkUpdate(e)}else{delete S[t]}},false);return r};r.checkMessages=function(){g.forEach(S,function(e){return e.checkDataState?e.checkDataState():null})};r.addBinding=function(e){S[e.getId()]=e;return r};r.removeBinding=function(e){delete S[e.getId()]};var V;function b(e,a){return D.then(function(){if(V){return V}if(e){return null}var t=m.QDataSource.create();t.setDataArea(a||"MY_DATA_AREA");var n=m.OlapApiModule.SERVICE_TYPE_PLANNING.createServiceConfig(r.getApplication());n.setDataSource(t);n.setSystemName(e||o.masterSystem);return i.syncActionToPromise(n.processServiceCreation,n,[]).then(function(e){V=e.getData();return V})})}r.getPlanningService=function(){return V};var A=D.then(function(){if(o&&o.SemanticStyles){r.setSemanticStyles(o.SemanticStyles)}var e=[];g.forEach(o.DataProvider||[],function(a,t){var n=r.addQuery(t,a.dataSourceName,a.systemName,a.packageName,a.schemaName,a.dataSourceType);e.push(a.synchronize?n.then(function(){return r.getDataProvider(t).synchronize()}):n)});return Promise.all(e)});r.dataLoaded=g.constant(A);r.loaded=r.dataLoaded;r.metadataLoaded=r.dataLoaded;r.annotationsLoaded=r.dataLoaded;r.getMetaModel=g.constant(r);r.attachMetadataFailed=g.constant(null);r.fireMetadataFailed=g.constant(null);r.getODataEntityContainer=g.constant(null);r.getODataEntityType=g.constant(r);r.createBindingContext=g.constant(null);r.getODataEntitySet=g.constant(r);r.attachRequestCompleted(function(e){var a=e.mParameters?e.mParameters.infoObject:undefined;var t=s.DataProvider[a];if(t){t.callUpdateDimensionData();r.checkUpdate()}});function E(e){if(!e){g.forEach(s.VariableGroups,function(e){E(e.Name)})}else{P[e]=[];g.forEach(s.DataProvider,function(t){g.forEach(t.Variables,function(r){var n=s.VariableGroups[e];if(n){a(n,r,t.Name)}else{console.error("Group "+e+" not found")}})})}function a(e,a,t){if(e.Rule(a,t)){if(e.MergedVariable&&e.MergedVariable.DataProviderName!==t){if(e.MergedVariable.type!==a.type){throw new Error("Could not add variable '"+a.Name+"' for DataProvider='"+t+"'."+" The type="+a.type+" doesn't match type="+e.MergedVariable.type+" of previously added variables ")}}else{e.MergedVariable=a}P[e.Name].push(a)}}}},getStylingProvider:function(){return this.stylingProvider}});return S});
//# sourceMappingURL=MultiDimModel.js.map