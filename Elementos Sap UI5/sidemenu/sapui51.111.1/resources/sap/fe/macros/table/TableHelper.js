/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/converters/controls/Common/DataVisualization","sap/fe/core/converters/ManifestSettings","sap/fe/core/converters/MetaModelConverter","sap/fe/core/formatters/TableFormatter","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/StableIdHelper","sap/fe/core/library","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/PropertyHelper","sap/fe/core/templating/UIFormatters","sap/fe/macros/CommonHelper","sap/fe/macros/field/FieldTemplating","sap/fe/macros/internal/helpers/ActionHelper","sap/fe/macros/table/TableSizeHelper","sap/ui/mdc/enum/EditMode"],function(e,t,n,i,a,o,r,l,s,c,u,d,g,f,v,p){"use strict";var b=g.formatValueRecursively;var m=u.getEditMode;var h=c.isImageURL;var $=c.hasText;var A=s.getTargetObjectPath;var F=s.getContextRelativeTargetObjectPath;var y=r.generate;var O=o.pathInModel;var C=o.isPathInModelExpression;var I=o.isConstant;var T=o.ifElse;var S=o.getExpressionFromAnnotation;var D=o.formatResult;var x=o.constant;var P=o.compileExpression;var j=i.getInvolvedDataModelObjects;var N=n.TemplateType;var E=t.getUiControl;const U=l.CreationMode;const M={_isStaticAction:function(e,t){let n;if(e){if(Array.isArray(e)){const i=this._getActionOverloadEntityType(t);if(i){n=e.find(function(e){return e.$IsBound&&e.$Parameter[0].$Type===i})}else{n=e[0]}}else{n=e}}return!!n&&n.$IsBound&&n.$Parameter[0].$isCollection},_getActionOverloadEntityType:function(e){if(e&&e.indexOf("(")>-1){const t=e.split("(");return t[t.length-1].replaceAll(")","")}return undefined},_isActionOverloadOnDifferentType:function(e,t){const n=this._getActionOverloadEntityType(e);return!!n&&t!==n},getMessageForDraftValidation:function(e){var t,n;const i=e.collection.getObject("./@");const a=(t=i["@com.sap.vocabularies.Common.v1.Messages"])===null||t===void 0?void 0:t.$Path;if(a&&((n=e.tableDefinition)===null||n===void 0?void 0:n.getProperty("/template"))===N.ObjectPage&&!!Object.keys(i).find(e=>{var t;const n=i[e];return n&&n.$Type==="com.sap.vocabularies.Common.v1.SideEffectsType"&&!n.SourceProperties&&!n.SourceEntities&&((t=n.TargetProperties)===null||t===void 0?void 0:t.indexOf(a))>-1})){return a}return""},getFieldsRequestedByPresentationVariant:function(e){var t;return((t=e.RequestAtLeast)===null||t===void 0?void 0:t.map(e=>e.value))||[]},getNavigationAvailableFieldsFromLineItem:function(e){const t=[];(e.getObject()||[]).forEach(function(e){var n;if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"&&!e.Inline&&!e.Determining&&(n=e.NavigationAvailable)!==null&&n!==void 0&&n.$Path){t.push(e.NavigationAvailable.$Path)}});return t},getNavigationAvailableMap:function(e){const t={};e.forEach(function(e){const n=`${e.SemanticObject}-${e.Action}`;if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"&&!e.Inline&&e.RequiresContext){if(e.NavigationAvailable!==undefined){t[n]=e.NavigationAvailable.$Path?e.NavigationAvailable.$Path:e.NavigationAvailable}}});return JSON.stringify(t)},getUiLineItem:function(e){return E(e,"@com.sap.vocabularies.UI.v1.LineItem")},create$Select:function(e){const t=e.collection;const n=[];const i=M.getUiLineItem(e.metaPath);const a=d.getTargetCollection(t);function o(e){if(e&&!n.includes(e)&&e.indexOf("/")!==0){n.push(e)}}function r(e){if(e!==null&&e!==void 0&&e.length){e.forEach(o)}}const l=e.tableDefinition.getObject("columns");const s=this.getPropertiesFromCustomColumns(l);if(s!==null&&s!==void 0&&s.length){r(s)}if(i.getPath().indexOf("@com.sap.vocabularies.UI.v1.LineItem")>-1){var c,u,g,f;const n=j(e.metaPath).targetObject;const l=(e.tableDefinition.getObject("operationAvailableProperties")||"").split(",");const s=M._filterNonApplicableProperties(l,t);const d=(t.getObject(`${a}/@com.sap.vocabularies.Common.v1.SemanticKey`)||[]).map(e=>e.$PropertyPath);if((n===null||n===void 0?void 0:n.$Type)==="com.sap.vocabularies.UI.v1.PresentationVariantType"){r(M.getFieldsRequestedByPresentationVariant(n))}r(M.getNavigationAvailableFieldsFromLineItem(i));r(s);r(d);o(M.getMessageForDraftValidation(e));o((c=t.getObject(`${a}@Org.OData.Capabilities.V1.DeleteRestrictions`))===null||c===void 0?void 0:(u=c.Deletable)===null||u===void 0?void 0:u.$Path);o((g=t.getObject(`${a}@Org.OData.Capabilities.V1.UpdateRestrictions`))===null||g===void 0?void 0:(f=g.Updatable)===null||f===void 0?void 0:f.$Path)}return n.join(",")},getColumnWidth:function(e,t,n,i,o,r,l){if(t.width){return t.width}if(e.enableAutoColumnWidth===true){let s;s=this.getColumnWidthForImage(o)||this.getColumnWidthForDataField(e,t,n,i,o,l)||undefined;if(s){return r?`${s}rem`:s}s=P(D([O("/editMode","ui"),O("tablePropertiesAvailable","internal"),t.name,r],a.getColumnWidth));return s}return undefined},getColumnWidthForImage:function(e){var t,n,i,a,o,r,l,s,c,u,d,g;let f=null;const v=(t=e.targetObject)===null||t===void 0?void 0:(n=t.Value)===null||n===void 0?void 0:(i=n.$target)===null||i===void 0?void 0:i.annotations;const b=(a=e.targetObject)===null||a===void 0?void 0:(o=a.Value)===null||o===void 0?void 0:(r=o.$target)===null||r===void 0?void 0:r.type;if((l=e.targetObject)!==null&&l!==void 0&&l.Value&&m((s=e.targetObject.Value)===null||s===void 0?void 0:s.$target,e,false,false,e.targetObject)===p.Display){var A,F;const t=$(e.targetObject.Value.$target);if(b==="Edm.Stream"&&!t&&v!==null&&v!==void 0&&(A=v.Core)!==null&&A!==void 0&&(F=A.MediaType)!==null&&F!==void 0&&F.includes("image/")){f=6.2}}else if(v&&(h((c=e.targetObject)===null||c===void 0?void 0:(u=c.Value)===null||u===void 0?void 0:u.$target)||v!==null&&v!==void 0&&(d=v.Core)!==null&&d!==void 0&&(g=d.MediaType)!==null&&g!==void 0&&g.includes("image/"))){f=6.2}return f},getColumnWidthForDataField:function(e,t,n,i,a,o){var r,l;const s=(r=a.targetObject)===null||r===void 0?void 0:r.annotations;const c=(l=a.targetObject)===null||l===void 0?void 0:l.$Type;let u=null;if(c==="com.sap.vocabularies.UI.v1.DataFieldForAction"||c==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||c==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"&&n.Target.$AnnotationPath.indexOf(`@${"com.sap.vocabularies.UI.v1.FieldGroup"}`)===-1){var d;let r;r=v.getButtonWidth(i)||v.getButtonWidth(n===null||n===void 0?void 0:(d=n.Label)===null||d===void 0?void 0:d.toString())||v.getButtonWidth(s===null||s===void 0?void 0:s.Label);const l=v.getWidthForDataFieldForAnnotation(a.targetObject).propertyWidth;if(l>r){u=l}else if(i||s&&(s.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||s.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction")){r+=1.8;u=r}u=u||this.getColumnWidthForChart(e,t,n,r,o)}return u},getColumnWidthForChart(e,t,n,i,a){var o,r;let l,s=null;if(((o=n.Target)===null||o===void 0?void 0:(r=o.$AnnotationPath)===null||r===void 0?void 0:r.indexOf("@com.sap.vocabularies.UI.v1.Chart"))!==-1){switch(this.getChartSize(e,t)){case"XS":l=4.4;break;case"S":l=4.6;break;case"M":l=5.5;break;case"L":l=6.9;break;default:l=5.3}i+=1.8;if(!this.getShowOnlyChart(e,t)&&a&&(a.Title.length||a.Description.length)){const e=a.Title.length>a.Description.length?a.Title:a.Description;const t=v.getButtonWidth(e)+7;const n=t>i?t:i;s=n}else if(i>l){s=i}else{s=l}}return s},getMarginClass:function(e,t,n,i){let a,o="";if(JSON.stringify(e[e.length-1])==JSON.stringify(t)){if(n=="com.sap.vocabularies.UI.v1.VisualizationType/Rating"){o="sapUiNoMarginBottom sapUiNoMarginTop"}}else if(n==="com.sap.vocabularies.UI.v1.VisualizationType/Rating"){o="sapUiNoMarginTop"}else{o="sapUiTinyMarginBottom"}if(i&&i!=="true"&&i!=="false"){const e=i.substring(i.indexOf("{=")+2,i.lastIndexOf("}"));a="{= "+e+" ? '"+o+"' : "+"''"+" }";return a}else{return o}},getVBoxVisibility:function(e,t,n){let i=true;const o=[];if(n["@com.sap.vocabularies.UI.v1.Hidden"]){return t}for(const n of e){const e=n["@com.sap.vocabularies.UI.v1.Hidden"];if(e===undefined||e===false){o.push(false);continue}if(e===true){o.push(true);continue}if(e.$Path){o.push(O(e.$Path));i=false;continue}if(typeof e==="object"){return t}}const r=x(o.length>0&&i!==true);const l=x(o.length>0&&o.indexOf(false)===-1&&i);return P(T(r,D(o,a.getVBoxVisibility),T(l,x(false),x(true))))},formatHiddenFilters:function(e){if(e){try{return JSON.stringify(e)}catch(e){return undefined}}return undefined},getElementStableId:function(e,t,n){var i;if(!e){return undefined}const a=n.targetObject;let o;switch(a.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":o=a.Target.value;break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":case"com.sap.vocabularies.UI.v1.DataFieldForAction":o=a;break;default:o=((i=a.Value)===null||i===void 0?void 0:i.path)??"";break}return y([e,t,o])},getColumnStableId:function(e,t){return M.getElementStableId(e,"C",t)},getFieldGroupLabelStableId:function(e,t){return M.getElementStableId(e,"FGLabel",t)},_filterNonApplicableProperties:function(e,t){return e&&e.filter(function(e){return t.getObject(`./${e}`)})},getPropertiesFromCustomColumns:function(e){if(!(e!==null&&e!==void 0&&e.length)){return}const t=[];for(const i of e){var n;if("properties"in i&&(n=i.properties)!==null&&n!==void 0&&n.length){for(const e of i.properties){if(t.indexOf(e)===-1){t.push(e)}}}}return t},getRowsBindingInfo:function(e){const t=j(e.collection,e.contextPath);const n=F(t)||A(t);const i={ui5object:true,suspended:false,path:d.addSingleQuotes(n),parameters:{$count:true},events:{}};if(e.tableDefinition.getObject("enable$select")){const t=M.create$Select(e);if(t){i.parameters.$select=`'${t}'`}}if(e.tableDefinition.getObject("enable$$getKeepAliveContext")){i.parameters.$$getKeepAliveContext=true}i.parameters.$$groupId=d.addSingleQuotes("$auto.Workers");i.parameters.$$updateGroupId=d.addSingleQuotes("$auto");i.parameters.$$ownRequest=true;i.parameters.$$patchWithoutSideEffects=true;i.events.patchSent=d.addSingleQuotes(".editFlow.handlePatchSent");i.events.dataReceived=d.addSingleQuotes("API.onInternalDataReceived");i.events.dataRequested=d.addSingleQuotes("API.onInternalDataRequested");i.events.createActivate=d.addSingleQuotes(".editFlow.handleCreateActivate");if(e.onContextChange!==undefined&&e.onContextChange!==null){i.events.change=d.addSingleQuotes(e.onContextChange)}return d.objectToString(i)},validateCreationRowFields:function(e){if(!e){return false}return Object.keys(e).length>0&&Object.keys(e).every(function(t){return e[t]["validity"]})},pressEventDataFieldForActionButton:function(e,t,n,i,a,o,r,l){const s=t.Action,c=e&&e.collection.getObject("$Type"),u=this._isStaticAction(a,s)||this._isActionOverloadOnDifferentType(s,c),g={contexts:!u?"${internal>selectedContexts}":null,bStaticAction:u?u:undefined,entitySetName:d.addSingleQuotes(n),applicableContext:!u?"${internal>dynamicActions/"+t.Action+"/aApplicable/}":null,notApplicableContext:!u?"${internal>dynamicActions/"+t.Action+"/aNotApplicable/}":null,isNavigable:o,enableAutoScroll:r,defaultValuesExtensionFunction:l?"'"+l+"'":undefined};return f.getPressEventDataFieldForActionButton(e.id,t,g,i)},isDataFieldForActionEnabled:function(t,n,i,a,o,r){const l=n.Action,s=t&&t.collection.getObject("$Type"),c=t&&t.tableDefinition&&t.tableDefinition.getObject(),u=this._isStaticAction(o,l),d=c&&c.enableAnalytics;if(!a&&this._isActionOverloadOnDifferentType(l,s)){const e=c&&JSON.parse(c.operationAvailableMap);if(e&&e.hasOwnProperty(l)){return"{= ${internal>dynamicActions/"+l+"/bEnabled} }"}return true}if(!i||u){if(a){const i=t.collection.getPath();const a=t.collection.getModel();if(r==="false"&&!d){e.warning("NavigationAvailable as false is incorrect usage");return false}else if(!d&&n&&n.NavigationAvailable&&n.NavigationAvailable.$Path&&a.getObject(i+"/$Partner")===n.NavigationAvailable.$Path.split("/")[0]){return"{= ${"+r.substr(r.indexOf("/")+1,r.length)+"}"}else{return true}}return true}let g="",v,p;if(a){if(r==="true"||d){g="%{internal>numberOfSelectedContexts} >= 1"}else if(r==="false"){e.warning("NavigationAvailable as false is incorrect usage");return false}else{v="%{internal>numberOfSelectedContexts} >= 1";p="${internal>ibn/"+n.SemanticObject+"-"+n.Action+"/bEnabled"+"}";g=v+" && "+p}}else{v=f.getNumberOfContextsExpression(r);p="${internal>dynamicActions/"+n.Action+"/bEnabled"+"}";g=v+" && "+p}return"{= "+g+"}"},pressEventForCreateButton:function(e,t){const n=e.creationMode;let i;const a=t?"${$source>}.getParent()":"${$source>}.getParent().getParent().getParent()";let o=a+".getRowBinding() || "+a+".data('rowsBindingInfo').path";switch(n){case U.External:i={creationMode:d.addSingleQuotes(U.External),outbound:d.addSingleQuotes(e.createOutbound)};break;case U.CreationRow:i={creationMode:d.addSingleQuotes(U.CreationRow),creationRow:"${$source>}",createAtEnd:e.createAtEnd!==undefined?e.createAtEnd:false};o="${$source>}.getParent()._getRowBinding()";break;case U.NewPage:case U.Inline:i={creationMode:d.addSingleQuotes(n),createAtEnd:e.createAtEnd!==undefined?e.createAtEnd:false,tableId:d.addSingleQuotes(e.id)};if(e.createNewAction){i.newAction=d.addSingleQuotes(e.createNewAction)}break;case U.InlineCreationRows:return d.generateFunction("._editFlow.createEmptyRowsAndFocus",a);default:return undefined}return d.generateFunction(".editFlow.createDocument",o,d.objectToString(i))},getIBNData:function(e){const t=e.createOutboundDetail;if(t){const e={semanticObject:d.addSingleQuotes(t.semanticObject),action:d.addSingleQuotes(t.action)};return d.objectToString(e)}},_getExpressionForDeleteButton:function(e,t){if(typeof e==="string"){return d.addSingleQuotes(e,true)}else{const n=S(e);if(I(n)||C(n)){const e=b(n,t);return P(e)}}},pressEventForDeleteButton:function(e,t,n,i){const a="${internal>deletableContexts}";let o,r;if(n!==null&&n!==void 0&&n.Title){o=this._getExpressionForDeleteButton(n.Title.Value,i)}if(n!==null&&n!==void 0&&n.Description){r=this._getExpressionForDeleteButton(n.Description.Value,i)}const l={id:d.addSingleQuotes(e.id),entitySetName:d.addSingleQuotes(t),numberOfSelectedContexts:"${internal>selectedContexts}.length",unSavedContexts:"${internal>unSavedContexts}",lockedContexts:"${internal>lockedContexts}",createModeContexts:"${internal>createModeContexts}",draftsWithDeletableActive:"${internal>draftsWithDeletableActive}",draftsWithNonDeletableActive:"${internal>draftsWithNonDeletableActive}",controlId:"${internal>controlId}",title:o,description:r,selectedContexts:"${internal>selectedContexts}"};return d.generateFunction(".editFlow.deleteMultipleDocuments",a,d.objectToString(l))},setHeaderLabelVisibility:function(e,t){if(!t){if(e.$Type.indexOf("DataFieldForAction")>-1&&e.Inline){return false}if(e.$Type.indexOf("DataFieldForIntentBasedNavigation")>-1&&e.Inline){return false}return true}return t.some(function(e){if((e.$Type==="com.sap.vocabularies.UI.v1.DataField"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation")&&e["@com.sap.vocabularies.UI.v1.Hidden"]!==true){return true}})},getTextOnActionField:function(e,t){if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){return e.Label}if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"&&t.context.getObject("Target/$AnnotationPath").indexOf("@"+"com.sap.vocabularies.UI.v1.FieldGroup")>-1){const e="Target/$AnnotationPath/Data/";const n=[];for(const i in t.context.getObject(e)){if(t.context.getObject(`${e+i}/$Type`)==="com.sap.vocabularies.UI.v1.DataFieldForAction"||t.context.getObject(`${e+i}/$Type`)==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){n.push(t.context.getObject(`${e+i}/Label`))}}if(n.length>1){return n.reduce(function(e,t){return e.length>t.length?e:t})}else{return n.length===0?undefined:n.toString()}}return undefined},_getResponsiveTableColumnSettings:function(e,t){if(e.tableType==="ResponsiveTable"){return t.settings}return null},getChartSize:function(e,t){const n=this._getResponsiveTableColumnSettings(e,t);if(n&&n.microChartSize){return n.microChartSize}return"XS"},getShowOnlyChart:function(e,t){const n=this._getResponsiveTableColumnSettings(e,t);if(n&&n.showMicroChartLabel){return!n.showMicroChartLabel}return true},getDelegate:function(e,t,n){let i;if(t==="true"){if(e.control.type==="TreeTable"){throw new Error("TreeTable not supported in Analytical ListPage")}i={name:"sap/fe/macros/table/delegates/ALPTableDelegate",payload:{collectionName:n}}}else if(e.control.type==="TreeTable"){i={name:"sap/fe/macros/table/delegates/TreeTableDelegate",payload:{hierarchyQualifier:e.control.hierarchyQualifier,initialExpansionLevel:e.annotation.initialExpansionLevel}}}else{i={name:"sap/fe/macros/table/delegates/TableDelegate"}}return JSON.stringify(i)},setIBNEnablement:function(e,t,n){for(const i in t){e.setProperty(`ibn/${i}`,{bEnabled:false,aApplicable:[],aNotApplicable:[]});const a=[],o=[];const r=t[i];for(let t=0;t<n.length;t++){const l=n[t];if(l.getObject(r)){e.getModel().setProperty(`${e.getPath()}/ibn/${i}/bEnabled`,true);a.push(l)}else{o.push(l)}}e.getModel().setProperty(`${e.getPath()}/ibn/${i}/aApplicable`,a);e.getModel().setProperty(`${e.getPath()}/ibn/${i}/aNotApplicable`,o)}}};M.getNavigationAvailableMap.requiresIContext=true;M.getTextOnActionField.requiresIContext=true;return M},false);
//# sourceMappingURL=TableHelper.js.map