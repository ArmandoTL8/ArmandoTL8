/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/StableIdHelper","sap/fe/macros/chart/ChartUtils","sap/fe/macros/DelegateUtil","sap/fe/macros/table/Utils","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/m/Select","sap/ui/core/Control","sap/ui/core/Core","sap/ui/core/Item","sap/ui/model/json/JSONModel"],function(e,t,i,n,o,r,a,s,l,c,u,h,f,d){"use strict";var g,p,b,C,y,_,m,v,w,S,T,I,E;var P=n.generate;var F=i.property;var O=i.defineUI5Class;var D=i.aggregation;function A(e,t,i,n){if(!i)return;Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function j(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function z(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;M(e,t)}function M(e,t){M=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,i){t.__proto__=i;return t};return M(e,t)}function V(e,t,i,n,o){var r={};Object.keys(n).forEach(function(e){r[e]=n[e]});r.enumerable=!!r.enumerable;r.configurable=!!r.configurable;if("value"in r||r.initializer){r.writable=true}r=i.slice().reverse().reduce(function(i,n){return n(e,t,i)||i},r);if(o&&r.initializer!==void 0){r.value=r.initializer?r.initializer.call(o):void 0;r.initializer=undefined}if(r.initializer===void 0){Object.defineProperty(e,t,r);r=null}return r}function $(e,t){throw new Error("Decorating class property failed. Please ensure that "+"proposal-class-properties is enabled and runs after the decorators transform.")}const x="quickFilterKey";const K="filters";let R=(g=O("sap.fe.macros.table.QuickFilterContainer",{interfaces:["sap.m.IOverflowToolbarContent"]}),p=F({type:"boolean"}),b=F({type:"string"}),C=F({type:"string"}),y=F({type:"string",defaultValue:"$auto"}),_=D({type:"sap.ui.core.Control",multiple:false,isDefault:true}),g(m=(v=function(i){z(n,i);function n(){var e;for(var t=arguments.length,n=new Array(t),o=0;o<t;o++){n[o]=arguments[o]}e=i.call(this,...n)||this;A(e,"showCounts",w,j(e));A(e,"entitySet",S,j(e));A(e,"parentEntityType",T,j(e));A(e,"batchGroupId",I,j(e));A(e,"selector",E,j(e));e._attachedToView=false;return e}n.render=function e(t,i){const n=h.getLibraryResourceBundle("sap.fe.macros");t.renderControl(i.selector);t.attr("aria-label",n.getText("M_TABLE_QUICKFILTER_ARIA"))};var u=n.prototype;u.init=function e(){i.prototype.init.call(this);this._attachedToView=false;this.attachEvent("modelContextChange",this._initControl);const t={onBeforeRendering:()=>{this._createControlSideEffects();this._attachedToView=true;this.removeEventDelegate(t)}};this.addEventDelegate(t,this)};u._initControl=function e(t){if(this.getModel()){this.detachEvent(t.getId(),this._initControl);this._manageTable();this._createContent()}};u._manageTable=function e(){var t,i;let n=this.getParent();const o=this._getFilterModel(),a=o.getObject("/paths"),s=Array.isArray(a)&&a.length>0?a[0].annotationPath:undefined;while(n&&!n.isA("sap.ui.mdc.Table")){n=n.getParent()}this._oTable=n;const l=h.byId(this._oTable.getFilter());if(l&&l.isA("sap.ui.mdc.FilterBar")){l.attachFiltersChanged(this._onFiltersChanged.bind(this))}(t=this._oTable)===null||t===void 0?void 0:(i=t.getParent())===null||i===void 0?void 0:i.attachEvent("internalDataRequested",this._onTableDataRequested.bind(this));r.setCustomData(n,x,s)};u._onFiltersChanged=function e(t){if(t.getParameter("conditionsBased")){this.selector.setProperty("enabled",false)}};u._onTableDataRequested=function e(){this.selector.setProperty("enabled",true);if(this.showCounts){this._updateCounts()}};u.setSelectorKey=function e(t){const i=this.selector;if(i&&i.getSelectedKey()!==t){i.setSelectedKey(t);r.setCustomData(this._oTable,x,t);const e=this._oTable.getFilter&&this._oTable.getFilter();const n=e&&h.byId(e);const o=n&&n.getSuspendSelection&&n.getSuspendSelection();if(!o){this._oTable.rebind()}}};u.getSelectorKey=function e(){const t=this.selector;return t?t.getSelectedKey():null};u.getDomRef=function e(t){const i=this.selector;return i?i.getDomRef(t):null};u._getFilterModel=function e(){let t=this.getModel(K);if(!t){const e=r.getCustomData(this,K);t=new d(e);this.setModel(t,K)}return t};u._createContent=function e(){const t=this._getFilterModel(),i=t.getObject("/paths"),n=i.length>3,o={id:P([this._oTable.getId(),"QuickFilter"]),enabled:t.getObject("/enabled"),items:{path:`${K}>/paths`,factory:(e,t)=>{const i={key:t.getObject().annotationPath,text:this._getSelectorItemText(t)};return n?new f(i):new l(i)}}};if(n){o.autoAdjustWidth=true}o[n?"change":"selectionChange"]=this._onSelectionChange.bind(this);this.selector=n?new c(o):new s(o)};u.getOverflowToolbarConfig=function e(){return{canOverflow:true}};u._createControlSideEffects=function e(){const t=this.selector,i=t.getItems(),n=r.getCustomData(this._oTable,"navigationPath");if(n){var o;const e=[];for(const t in i){const o=i[t].getKey(),r=a.getFiltersInfoForSV(this._oTable,o);r.properties.forEach(function(t){const i=`${n}/${t}`;if(!e.includes(i)){e.push(i)}})}(o=this._getSideEffectController())===null||o===void 0?void 0:o.addControlSideEffects(this.parentEntityType,{SourceProperties:e,TargetEntities:[{$NavigationPropertyPath:n}],sourceControlId:this.getId()})}};u._getSelectorItemText=function e(t){const i=t.getObject().annotationPath,n=t.getPath(),o=this.getModel().getMetaModel(),r=o.getObject(`${this.entitySet}/${i}`);return r.Text+(this.showCounts?` ({${K}>${n}/count})`:"")};u._getSideEffectController=function e(){const t=this._getViewController();return t?t._sideEffects:undefined};u._getViewController=function e(){const i=t.getTargetView(this);return i&&i.getController()};u._updateCounts=function t(){const i=this._oTable,n=this._getViewController(),s=this.selector,l=s.getItems(),c=this._getFilterModel(),u=[],h=[];let f=[];let d=[];const g=r.getCustomData(i,x);if(n&&n.getChartControl){const e=n.getChartControl();if(e){const t=o.getAllFilterInfo(e);if(t&&t.filters.length){d=t.filters}}}f=f.concat(a.getHiddenFilters(i)).concat(d);for(const e in l){const t=l[e].getKey(),n=a.getFiltersInfoForSV(i,t);h.push(n.text);c.setProperty(`/paths/${e}/count`,"...");u.push(a.getListBindingForCount(i,i.getBindingContext(),{batchGroupId:t===g?this.batchGroupId:"$auto",additionalFilters:f.concat(n.filters)}))}Promise.all(u).then(function(e){for(const t in e){c.setProperty(`/paths/${t}/count`,a.getCountFormatted(e[t]))}}).catch(function(t){e.error("Error while retrieving the binding promises",t)})};u._onSelectionChange=function e(t){const i=t.getSource();r.setCustomData(this._oTable,x,i.getSelectedKey());this._oTable.rebind();const n=this._getViewController();if(n&&n.getExtensionAPI&&n.getExtensionAPI().updateAppState){n.getExtensionAPI().updateAppState()}};u.destroy=function e(t){if(this._attachedToView){const e=this._getSideEffectController();if(e){e.removeControlSideEffects(this)}}delete this._oTable;i.prototype.destroy.call(this,t)};return n}(u),w=V(v.prototype,"showCounts",[p],{configurable:true,enumerable:true,writable:true,initializer:null}),S=V(v.prototype,"entitySet",[b],{configurable:true,enumerable:true,writable:true,initializer:null}),T=V(v.prototype,"parentEntityType",[C],{configurable:true,enumerable:true,writable:true,initializer:null}),I=V(v.prototype,"batchGroupId",[y],{configurable:true,enumerable:true,writable:true,initializer:null}),E=V(v.prototype,"selector",[_],{configurable:true,enumerable:true,writable:true,initializer:null}),v))||m);return R},false);
//# sourceMappingURL=QuickFilterContainer.js.map