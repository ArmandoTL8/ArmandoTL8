/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/TemplateModel","sap/fe/core/templating/PropertyFormatters","sap/fe/core/type/EDM","sap/fe/core/type/TypeUtil","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/filter/FilterUtils","sap/fe/macros/ResourceModel","sap/ui/mdc/FilterBarDelegate","sap/ui/model/json/JSONModel"],function(e,t,n,o,i,r,a,l,s,c,u,f,d,p,g,m){"use strict";var h=s.getModelType;var P=l.hasValueHelp;var v=r.generate;var y=o.processSelectionFields;const F=Object.assign({},g);const C="$editState",b="$search",x="FilterFieldValueHelp",M="sap_fe_FilterBarDelegate_propertyInfoMap",I=/[+*]/g;function w(e,t,n){const o=new m({id:e,isDraftCollaborative:i.isCollaborationDraftSupported(t)}),r={bindingContexts:{this:o.createBindingContext("/")},models:{"this.i18n":p.getModel(),this:o}};return f.templateControlFragment("sap.fe.macros.filter.DraftEditState",r,undefined,n).finally(function(){o.destroy()})}F._templateCustomFilter=async function(e,t,o,i,r){const l=await f.getCustomData(e,"entityType",r);const s=new m({id:t}),c=new a(o,i),u={bindingContexts:{contextPath:i.createBindingContext(l),this:s.createBindingContext("/"),item:c.createBindingContext("/")},models:{contextPath:i,this:s,item:c}},d=n.getTargetView(e),p=d?d.getController():undefined,g={controller:p?p:undefined,view:d};return f.templateControlFragment("sap.fe.macros.filter.CustomFilter",u,g,r).finally(function(){s.destroy();c.destroy()})};function T(e){return e.replace(I,"")}F._findSelectionField=function(e,t){return e.find(function(e){return(e.conditionPath===t||e.conditionPath.replaceAll(/\*/g,"")===t)&&e.availability!=="Hidden"})};function D(e,t,n){return n?v([e,t,n]):v([e,t])}function S(n,o){const i=new m({idPrefix:o.sVhIdPrefix,conditionModel:"$filters",navigationPrefix:o.sNavigationPrefix?`/${o.sNavigationPrefix}`:"",filterFieldValueHelp:true,useSemanticDateRange:o.bUseSemanticDateRange});const r=t({},n,{bindingContexts:{this:i.createBindingContext("/")},models:{this:i}});return Promise.resolve(f.templateControlFragment("sap.fe.macros.internal.valuehelp.ValueHelp",r,{isXML:n.isXML})).then(function(e){if(e){const t="dependents";if(e.length){e.forEach(function(e){if(o.oModifier){o.oModifier.insertAggregation(o.oControl,t,e,0)}else{o.oControl.insertAggregation(t,e,0,false)}})}else if(o.oModifier){o.oModifier.insertAggregation(o.oControl,t,e,0)}else{o.oControl.insertAggregation(t,e,0,false)}}}).catch(function(t){e.error("Error while evaluating DelegateUtil.isValueHelpRequired",t)}).finally(function(){i.destroy()})}async function L(t,n,o){try{const e=await Promise.resolve(n.getAggregation(t,"dependents"));let i;if(e&&e.length>1){for(i=0;i<=e.length;i++){const t=e[i];if(t&&t.isA("sap.ui.mdc.FilterField")){const e=t.getFieldPath(),n=t.getId();if(o===e&&n.indexOf("CustomFilterField")){return Promise.resolve(t)}}}}}catch(t){e.error("Filter Cannot be added",t)}}function E(e,n,o){const i=new m({idPrefix:n.sIdPrefix,vhIdPrefix:n.sVhIdPrefix,propertyPath:n.sPropertyName,navigationPrefix:n.sNavigationPrefix?`/${n.sNavigationPrefix}`:"",useSemanticDateRange:n.bUseSemanticDateRange,settings:n.oSettings,visualFilter:n.visualFilter});const r=n.oMetaModel;const l=new a(n.visualFilter,r);const s=t({},e,{bindingContexts:{this:i.createBindingContext("/"),visualFilter:l.createBindingContext("/")},models:{this:i,visualFilter:l,metaModel:r,converterContext:o}});return f.templateControlFragment("sap.fe.macros.internal.filterField.FilterFieldTemplate",s,{isXML:e.isXML}).finally(function(){i.destroy()})}async function A(t,n,o,i){try{i=i.replace("*","");const e=v([i]);if(n&&!n.modifier){throw"FilterBar Delegate method called without modifier."}const r=await n.modifier.getProperty(t,"delegate");const a=await n.modifier.getProperty(t,"propertyInfo");if(a){const l=a.some(function(t){return t.key===e||t.name===e});if(!l){const e=r.payload.entityTypePath;const l=d.createConverterContext(t,e,o,n.appComponent);const s=l.getEntityType();let c=d.getFilterField(i,l,s);c=d.buildProperyInfo(c,l);a.push(c);n.modifier.setProperty(t,"propertyInfo",a)}}}catch(n){e.warning(`${t.getId()} : ${n}`)}}F.addItem=async function(e,t,n){if(!n){return F._addP13nItem(e,t)}const o=n.modifier;const i=n&&n.appComponent&&n.appComponent.getModel();const r=i&&i.getMetaModel();if(!r){return Promise.resolve(null)}const a=o&&o.targets==="xmlTree";if(a){await A(t,n,r,e)}return F._addFlexItem(e,t,r,o,n.appComponent)};F.removeItem=async function(e,t,n){let o=true;const i=n.modifier;const r=i&&i.targets==="xmlTree";if(r&&!t.data("sap_fe_FilterBarDelegate_propertyInfoMap")){const o=n&&n.appComponent&&n.appComponent.getModel();const i=o&&o.getMetaModel();if(!i){return Promise.resolve(null)}if(typeof e!=="string"&&e.getFieldPath()){await A(t,n,i,e.getFieldPath())}else{await A(t,n,i,e)}}if(typeof e!=="string"&&e.isA&&e.isA("sap.ui.mdc.FilterField")){if(e.data("isSlot")==="true"&&n){i.insertAggregation(t,"dependents",e);o=false}}return Promise.resolve(o)};F.addCondition=async function(e,t,n){const o=n.modifier;const i=o&&o.targets==="xmlTree";if(i){const o=n&&n.appComponent&&n.appComponent.getModel();const i=o&&o.getMetaModel();if(!i){return Promise.resolve(null)}await A(t,n,i,e)}return Promise.resolve()};F.removeCondition=async function(e,t,n){if(!t.data("sap_fe_FilterBarDelegate_propertyInfoMap")){const o=n.modifier;const i=o&&o.targets==="xmlTree";if(i){const o=n&&n.appComponent&&n.appComponent.getModel();const i=o&&o.getMetaModel();if(!i){return Promise.resolve(null)}await A(t,n,i,e)}}return Promise.resolve()};F.clearFilters=async function(e){return d.clearFilterValues(e)};F._addP13nItem=function(t,n){return f.fetchModel(n).then(function(e){return F._addFlexItem(t,n,e.getMetaModel(),undefined)}).catch(function(t){e.error("Model could not be resolved",t);return null})};F.fetchPropertiesForEntity=function(e,t,o){const r=t.getObject(e);const a=o.isA("sap.ui.mdc.filterbar.vh.FilterBar")?true:undefined;if(!o||!r){return[]}const l=d.createConverterContext(o,e);const s=i.getEntitySetPath(e);const g=d.getConvertedFilterFields(o,e,a);let m=[];g.forEach(function(e){if(e.annotationPath){const o=u.getLocationForPropertyPath(t,e.annotationPath);const i=e.annotationPath.replace(`${o}/`,"");if(n.isPropertyFilterable(t,o,T(i),true)){m.push(e)}}else{m.push(e)}});const v=[];const F=y(m,l);const C=[];F.forEach(function(e){if(e.key){C.push(e.key)}});m=m.filter(function(e){return C.includes(e.key)});const b=n.getFilterRestrictionsByPath(s,t),x=b.FilterAllowedExpressions;Object.keys(F).forEach(function(e){let o=F[e];const i=m[e];if(!i||!i.conditionPath){return}const r=T(i.conditionPath);o=Object.assign(o,{group:i.group,groupLabel:i.groupLabel,path:i.conditionPath,tooltip:null,removeFromAppState:false,hasValueHelp:false});if(i.annotationPath){const e=i.annotationPath;const r=t.getObject(e),a=t.getObject(`${e}@`),l=t.createBindingContext(e);const s=a["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||a["@com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]||a["@com.sap.vocabularies.Analytics.v1.Measure"];const c=u.getLocationForPropertyPath(t,i.annotationPath);const f=e.replace(`${c}/`,"");let d;let p;if(n.isPropertyFilterable(t,c,T(f),true)){d=a["@com.sap.vocabularies.Common.v1.FilterDefaultValue"];if(d){p=d[`$${h(r.$Type)}`]}o=Object.assign(o,{tooltip:a["@com.sap.vocabularies.Common.v1.QuickInfo"]||undefined,removeFromAppState:s,hasValueHelp:P(l.getObject(),{context:l}),defaultFilterConditions:p?[{fieldPath:i.conditionPath,operator:"EQ",values:[p]}]:undefined})}}if(o){if(x[r]&&x[r].length>0){o.filterExpression=n.getSpecificAllowedExpression(x[r])}else{o.filterExpression="auto"}o=Object.assign(o,{visible:i.availability==="Default"})}F[e]=o});F.forEach(function(e){if(e.path==="$editState"){e.label=p.getText("FILTERBAR_EDITING_STATUS")}e.typeConfig=c.getTypeConfig(e.dataType,e.formatOptions,e.constraints);e.label=f.getLocalizedText(e.label,o)||"";if(e.isParameter){v.push(e.name)}});m=F;f.setCustomData(o,"parameters",v);return m};function $(e,t){var n;if(e.isA("sap.fe.macros.table.TableAPI")){const o=e.getMetaPath().split("#")[0].split("/");switch(o[o.length-1]){case`@${"com.sap.vocabularies.UI.v1.SelectionPresentationVariant"}`:case`@${"com.sap.vocabularies.UI.v1.PresentationVariant"}`:return(n=t.getObject(e.getMetaPath()).Visualizations)===null||n===void 0?void 0:n.find(e=>e.$AnnotationPath.includes(`@${"com.sap.vocabularies.UI.v1.LineItem"}`)).$AnnotationPath;case`@${"com.sap.vocabularies.UI.v1.LineItem"}`:const o=e.getMetaPath().split("/");return o[o.length-1]}}return undefined}F._addFlexItem=function(e,t,o,r,a){const l=r?r.getId(t):t.getId(),s=r?"":"Adaptation",c=d.getConvertedFilterFields(t,null,undefined,o,a,r,r?undefined:$(t.getParent(),o)),p=F._findSelectionField(c,e),g=T(e),m=!!r&&r.targets==="xmlTree";if(e===C){return w(l,o,r)}else if(e===b){return Promise.resolve(null)}else if(p&&p.template){return F._templateCustomFilter(t,D(l,`${s}FilterField`),p,o,r)}if(p.type==="Slot"&&r){return L(t,r,g)}const h=u.getNavigationPath(g);const P=p.annotationPath;let v;let y;let M;let I;let A;return Promise.resolve().then(function(){if(p.isParameter){return P.substr(0,P.lastIndexOf("/")+1)}return f.getCustomData(t,"entityType",r)}).then(function(e){v=e;return f.getCustomData(t,"useSemanticDateRange",r)}).then(function(e){y=e;const n=o.createBindingContext(v+g);const a=r?r.getId(t):t.getId();M={bindingContexts:{contextPath:o.createBindingContext(v),property:n},models:{contextPath:o,property:o},isXML:m};I=`/${i.getEntitySetPath(v).split("/").filter(i.filterOutNavPropBinding).join("/")}`;A={sPropertyName:g,sBindingPath:I,sValueHelpType:s+x,oControl:t,oMetaModel:o,oModifier:r,sIdPrefix:D(a,`${s}FilterField`,h),sVhIdPrefix:D(a,s+x),sNavigationPrefix:h,bUseSemanticDateRange:y,oSettings:p?p.settings:{},visualFilter:p?p.visualFilter:undefined};return f.doesValueHelpExist(A)}).then(function(e){if(!e){return S(M,A)}return Promise.resolve()}).then(function(){let e;if(A.visualFilter){e=n.getTargetView(t).getController()._getPageModel()}return E(M,A,e)})};function B(e){if(e instanceof window.Element){return null}return f.getCustomData(e,M)}function _(e,t){if(e instanceof window.Element){return}f.setCustomData(e,M,t)}function V(e,t,n){let o=B(n);let i;if(!o){o=F.fetchPropertiesForEntity(e,t,n);o.forEach(function(e){i=null;if(e.groupLabel){i=f.getLocalizedText(e.groupLabel,n);e.groupLabel=i===null?e.groupLabel:i}});o.sort(function(e,t){if(e.groupLabel===undefined||e.groupLabel===null){return-1}if(t.groupLabel===undefined||t.groupLabel===null){return 1}return e.groupLabel.localeCompare(t.groupLabel)});_(n,o)}return o}F.fetchProperties=function(e){const t=f.getCustomData(e,"entityType");return f.fetchModel(e).then(function(n){if(!n){return[]}return V(t,n.getMetaModel(),e)})};F.getTypeUtil=function(){return c};return F},false);
//# sourceMappingURL=FilterBarDelegate.js.map