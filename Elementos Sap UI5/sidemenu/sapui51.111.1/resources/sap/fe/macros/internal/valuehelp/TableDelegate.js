/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/fe/core/CommonUtils","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/core/templating/PropertyHelper","sap/fe/core/type/EDM","sap/fe/core/type/TypeUtil","sap/fe/macros/DelegateUtil","sap/fe/macros/ODataMetaModelUtil","sap/ui/core/Core","sap/ui/mdc/odata/v4/TableDelegate","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter"],function(e,t,n,o,r,i,a,s,l,c,p,f,d,g,u,h,y,m,v,b){"use strict";var C=c.isTypeFilterable;var P=l.getLabel;var M=l.getAssociatedUnitPropertyPath;var I=l.getAssociatedTimezonePropertyPath;var D=l.getAssociatedTextPropertyPath;var T=l.getAssociatedCurrencyPropertyPath;var O=s.getDisplayMode;var x=a.getTargetObjectPath;var $=a.enhanceDataModelPath;var B=r.getInvolvedDataModelObjects;var F=o.fetchTypeConfig;const j=Object.assign({},u);j.fetchProperties=function(e){const t=this._getModel(e);let n;if(!t){n=new Promise(t=>{e.attachModelContextChange({resolver:t},U,this)}).then(t=>this._createPropertyInfos(e,t))}else{n=this._createPropertyInfos(e,t)}return n.then(function(t){f.setCachedProperties(e,t);e.getBindingContext("internal").setProperty("tablePropertiesAvailable",true);return t})};j.createInternalBindingContext=function(e){let t=e;while(t&&!t.isA("sap.ui.mdc.valuehelp.Dialog")){t=t.getParent()}if(t){const n=e.getModel("internal");const o=t.getBindingContext("internal").getPath()+`::VHDialog::${t.getId()}::table`;const r=n.bindContext(o).getBoundContext();e.setBindingContext(r,"internal")}};function U(e,t){const n=e.getSource();j.createInternalBindingContext(n);const o=this._getModel(n);if(o){n.detachModelContextChange(U);t.resolver(o)}}function E(e){const t=R(e);const n={};if(t!==null&&t!==void 0&&t.targetObject){var o,r,i,a,s;const l=t.targetObject;const c=x(t,true);const p=e.targetObject;const f=x(e,true);const d=(o=p.annotations)===null||o===void 0?void 0:(r=o.Common)===null||r===void 0?void 0:r.Text,g=d===null||d===void 0?void 0:(i=d.annotations)===null||i===void 0?void 0:(a=i.UI)===null||a===void 0?void 0:(s=a.TextArrangement)===null||s===void 0?void 0:s.toString(),u=d&&g&&O(p);if(u==="Description"){n[c]=l}else if(u&&u!=="Value"||!d){n[f]=p;n[c]=l}}return n}j._createPropertyInfos=function(e,t){const n=e.getDelegate().payload;const o=[];const r=`/${n.collectionName}`;const i=t.getMetaModel();return i.requestObject(`${r}@`).then(function(t){const n=d.getSortRestrictionsInfo(t);const i=t["@Org.OData.Capabilities.V1.FilterRestrictions"];const a=d.getFilterRestrictionsInfo(i);const s=f.getCustomData(e,"columns");const l={};const c=B(e.getModel().getMetaModel().getContext(r));s.customData.forEach(function(t){const r={name:t.path,label:t.label,sortable:_(n,t),filterable:A(a,t),maxConditions:w(a,t),typeConfig:C(t.$Type)?e.getTypeUtil().getTypeConfig(t.$Type):undefined};const i=$(c,t.path);const s=i.targetObject;if(s){const n=x(i,true);let o;if(C(s.type)){const n=F(s);o=p.getTypeConfig(n.type,n.formatOptions,n.constraints)??e.getTypeUtil().getTypeConfig(t.$Type)}const a=E(i);const c=Object.keys(a);if(c.length){r.propertyInfos=c;r.sortable=false;r.filterable=false;c.forEach(e=>{l[e]=a[e]});if(!c.find(e=>a[e]===s)){l[n]=s}}else{r.path=t.path}r.typeConfig=r.typeConfig?o:undefined}else{r.path=t.path}o.push(r)});const g=S(l,o,n,a);return o.concat(g)})};j.updateBindingInfo=function(e,t){u.updateBindingInfo.apply(this,[e,t]);if(!e){return}const o=e.getDelegate().payload;if(o&&t){t.path=t.path||o.collectionPath||`/${o.collectionName}`;t.model=t.model||o.model}if(!t){t={}}const r=g.byId(e.getFilter()),a=e.isFilteringEnabled();let s;let l,c;const p=[];const d=f.getCachedProperties(e);if(a){s=e.getConditions();l=y.getFilterInfo(e,s,d,[]);if(l.filters){p.push(l.filters)}}if(r){s=r.getConditions();if(s){const n=h.getParameterNames(r);j._updatePropertyInfo(d,e,s,o);c=y.getFilterInfo(r,s,d,n);if(c.filters){p.push(c.filters)}const i=h.getParametersInfo(r,s);if(i){t.path=i}}t.parameters.$search=n.normalizeSearchTerm(r.getSearch())||undefined}this._applyDefaultSorting(t,e.getDelegate().payload);t.parameters.$select=d===null||d===void 0?void 0:d.reduce(function(e,t){if(t.path&&t.path.indexOf("/")===-1){e=e?`${e},${t.path}`:t.path}return e},"");t.parameters.$count=true;if(i.isDraftSupported(e.getModel().getMetaModel(),t.path)){p.push(new m("IsActiveEntity",v.EQ,true))}t.filters=new m(p,true)};j.getTypeUtil=function(){return p};j._getModel=function(e){const t=e.getDelegate().payload;return e.getModel(t.model)};j._applyDefaultSorting=function(e,t){if(e.parameters&&e.parameters.$search==undefined&&e.sorter&&e.sorter.length==0){const n=t?t.defaultSortPropertyName:undefined;if(n){e.sorter.push(new b(n,false))}}};j._updatePropertyInfo=function(e,t,n,o){const r=Object.keys(n),i=t.getModel().getMetaModel();r.forEach(function(n){if(e.findIndex(function(e){return e.path===n})===-1){const r={path:n,typeConfig:t.getTypeUtil().getTypeConfig(i.getObject(`/${o.collectionName}/${n}`).$Type)};e.push(r)}})};j.updateBinding=function(n,o,r){let i=false;const a=n.getBindingContext("internal");const s="pendingManualBindingUpdate";const l=a===null||a===void 0?void 0:a.getProperty(s);let c=n.getRowBinding();u.updateBinding.apply(j,[n,o,r]);if(!c){c=n.getRowBinding()}if(c){const e=c.getFilters("Application");i=t(o.filters,e[0])&&c.getQueryOptionsFromParameters().$search===o.parameters.$search&&!l}if(i&&n.getFilter()){a===null||a===void 0?void 0:a.setProperty(s,true);c.requestRefresh(c.getGroupId()).finally(function(){a===null||a===void 0?void 0:a.setProperty(s,false)}).catch(function(t){e.error("Error while refreshing a filterBar VH table",t)})}n.fireEvent("bindingUpdated")};function S(e,t,n,o){const r={},i=[];Object.keys(e).forEach(a=>{const s=e[a],l=t.find(e=>e.path===a);if(!l){const e=`Property::${a}`;r[a]=e;const t={name:e,label:P(s),path:a,sortable:_(n,s),filterable:A(o,s)};t.maxConditions=w(o,t);if(C(s.type)){const e=F(s);t.typeConfig=p.getTypeConfig(e.type,e.formatOptions,e.constraints)}i.push(t)}});t.forEach(e=>{if(e.propertyInfos){var t;e.propertyInfos=(t=e.propertyInfos)===null||t===void 0?void 0:t.map(e=>r[e]??e)}});return i}function _(e,t){return t.path&&e.propertyInfo[t.path]?e.propertyInfo[t.path].sortable:t.sortable}function A(e,t){return t.path&&e[t.path]?e[t.path].filterable:t.filterable}function w(e,t){return t.path&&d.isMultiValueFilterExpression(e.propertyInfo[t.path])?-1:1}function R(e){const t=e.targetObject;const n=D(t)||T(t)||M(t)||I(t);if(!n){return undefined}const o=$(e,n);const r=o.targetObject;if(!r){return undefined}return o}return j},false);
//# sourceMappingURL=TableDelegate.js.map