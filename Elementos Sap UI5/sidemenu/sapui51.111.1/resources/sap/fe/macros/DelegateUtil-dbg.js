/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log", "sap/fe/core/CommonUtils", "sap/fe/core/helpers/StableIdHelper", "sap/fe/core/templating/PropertyFormatters", "sap/fe/macros/field/FieldHelper", "sap/fe/macros/internal/valuehelp/ValueHelpTemplating"], function (Log, CommonUtils, StableIdHelper, PropertyFormatters, FieldHelper, ValueHelpTemplating) {
  "use strict";

  var generateID = ValueHelpTemplating.generateID;
  var getRelativePropertyPath = PropertyFormatters.getRelativePropertyPath;
  var generate = StableIdHelper.generate;
  const NS_MACRODATA = "http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1";
  function _retrieveModel() {
    this.control.detachModelContextChange(_retrieveModel, this);
    const sModelName = this.modelName,
      oModel = this.control.getModel(sModelName);
    if (oModel) {
      this.resolve(oModel);
    } else {
      this.control.attachModelContextChange(_retrieveModel, this);
    }
  }
  async function getCustomDataWithModifier(oControl, sProperty, oModifier) {
    const aCustomData = [];
    const aRetrievedCustomData = await Promise.resolve().then(oModifier.getAggregation.bind(oModifier, oControl, "customData"));
    const oPromise = aRetrievedCustomData.reduce((oPreviousPromise, oCustomData) => {
      return oPreviousPromise.then(oModifier.getProperty.bind(oModifier, oCustomData, "key")).then(function (sKey) {
        if (sKey === sProperty) {
          aCustomData.push(oCustomData);
        }
      });
    }, Promise.resolve());
    await oPromise;
    if (aCustomData.length === 1) {
      return oModifier.getProperty(aCustomData[0], "value");
    } else {
      return undefined;
    }
  }
  const FETCHED_PROPERTIES_DATA_KEY = "sap_fe_TableDelegate_propertyInfoMap";
  const DelegateUtil = {
    getLocalizedText(sTextOrToken, oControl) {
      const aMatch = /{([A-Za-z0-9_.|@]+)>([A-Za-z0-9_.|]+)}/.exec(sTextOrToken);
      if (aMatch) {
        try {
          const oResourceBundle = oControl.getModel(aMatch[1]).getResourceBundle();
          return oResourceBundle.getText(aMatch[2]);
        } catch (e) {
          Log.info(`Unable to retrieve localized text ${sTextOrToken}`);
        }
      }
      return sTextOrToken;
    },
    setCachedProperties(table, fetchedProperties) {
      // do not cache during templating, else it becomes part of the cached view
      if (table instanceof window.Element) {
        return;
      }
      const key = FETCHED_PROPERTIES_DATA_KEY;
      DelegateUtil.setCustomData(table, key, fetchedProperties);
    },
    getCachedProperties(table) {
      // properties are not cached during templating
      if (table instanceof window.Element) {
        return null;
      }
      const key = FETCHED_PROPERTIES_DATA_KEY;
      return DelegateUtil.getCustomData(table, key);
    },
    getCustomData(oControl, sProperty, oModifier) {
      // If Modifier is given, the method must execute asynchronously and return a Promise
      if (oModifier) {
        return getCustomDataWithModifier(oControl, sProperty, oModifier);
      } else {
        // Delegate invoked from a non-flex change - FilterBarDelegate._addP13nItem for OP table filtering, FilterBarDelegate.fetchProperties etc.
        if (oControl && sProperty) {
          if (oControl instanceof window.Element) {
            return oControl.getAttributeNS(NS_MACRODATA, sProperty);
          }
          if (oControl.data instanceof Function) {
            return oControl.data(sProperty);
          }
        }
        return undefined;
      }
    },
    setCustomData(oControl, sProperty, vValue) {
      if (oControl && sProperty) {
        if (oControl instanceof window.Element) {
          return oControl.setAttributeNS(NS_MACRODATA, `customData:${sProperty}`, vValue);
        }
        if (oControl.data instanceof Function) {
          return oControl.data(sProperty, vValue);
        }
      }
    },
    fetchPropertiesForEntity(sEntitySet, oMetaModel) {
      return oMetaModel.requestObject(`${sEntitySet}/`);
    },
    fetchAnnotationsForEntity(sEntitySet, oMetaModel) {
      return oMetaModel.requestObject(`${sEntitySet}@`);
    },
    fetchModel(oControl) {
      return new Promise(resolve => {
        const sModelName = oControl.getDelegate().payload && oControl.getDelegate().payload.modelName,
          oContext = {
            modelName: sModelName,
            control: oControl,
            resolve: resolve
          };
        _retrieveModel.call(oContext);
      });
    },
    loadMacroLibrary() {
      return new Promise(resolve => {
        sap.ui.require(["sap/fe/macros/macroLibrary"], function /*macroLibrary*/
        () {
          resolve();
        });
      });
    },
    templateControlFragment(sFragmentName, oPreprocessorSettings, oOptions, oModifier) {
      return CommonUtils.templateControlFragment(sFragmentName, oPreprocessorSettings, oOptions, oModifier);
    },
    doesValueHelpExist(mParameters) {
      const sPropertyName = mParameters.sPropertyName || "";
      const sValueHelpType = mParameters.sValueHelpType || "";
      const oMetaModel = mParameters.oMetaModel;
      const oModifier = mParameters.oModifier;
      const sOriginalProperty = `${mParameters.sBindingPath}/${sPropertyName}`;
      const oPropertyContext = oMetaModel.createBindingContext(sOriginalProperty);
      let sValueHelpProperty = FieldHelper.valueHelpProperty(oPropertyContext);
      const bIsAbsolute = mParameters.sBindingPath && mParameters.sBindingPath.indexOf("/") === 0;

      // unit/currency
      if (sValueHelpProperty.indexOf("$Path") > -1) {
        sValueHelpProperty = oMetaModel.getObject(sValueHelpProperty);
      }
      if (bIsAbsolute && sValueHelpProperty.indexOf("/") !== 0) {
        sValueHelpProperty = `${mParameters.sBindingPath}/${sValueHelpProperty}`;
      }
      const sGeneratedId = generateID(mParameters.flexId, generate([oModifier ? oModifier.getId(mParameters.oControl) : mParameters.oControl.getId(), sValueHelpType]), getRelativePropertyPath(oPropertyContext.getProperty(sOriginalProperty), {
        context: {
          getModel: () => {
            return mParameters.oMetaModel;
          },
          getPath: () => {
            return sOriginalProperty;
          }
        }
      }), getRelativePropertyPath(oPropertyContext.getProperty(sValueHelpProperty), {
        context: {
          getModel: () => {
            return mParameters.oMetaModel;
          },
          getPath: () => {
            return sValueHelpProperty;
          }
        }
      }));
      return Promise.resolve().then(function () {
        if (oModifier) {
          return oModifier.getAggregation(mParameters.oControl, "dependents");
        }
        return mParameters.oControl.getAggregation("dependents");
      }).then(function (aDependents) {
        return Promise.resolve(aDependents && aDependents.some(function (oDependent) {
          return oModifier ? oModifier.getId(oDependent) === sGeneratedId : oDependent.getId() === sGeneratedId;
        }));
      });
    },
    isValueHelpRequired(mParameters, bInFilterField) {
      const sPropertyName = mParameters.sPropertyName || "",
        oMetaModel = mParameters.oMetaModel,
        sProperty = `${mParameters.sBindingPath}/${sPropertyName}`,
        oPropertyContext = oMetaModel.createBindingContext(sProperty),
        sValueHelpProperty = FieldHelper.valueHelpProperty(oPropertyContext, bInFilterField);
      return this.getCustomData(mParameters.oControl, "displayModePropertyBinding", mParameters.oModifier).then(function (bReadOnly) {
        // Check whether the control is read-only. If yes, no need of a value help.
        bReadOnly = typeof bReadOnly === "boolean" ? bReadOnly : bReadOnly === "true";
        if (bReadOnly) {
          return false;
        }
        // Else, check whether Value Help relevant annotation exists for the property.
        // TODO use PropertyFormatter.hasValueHelp () => if doing so, QUnit tests fail due to mocked model implementation
        return Promise.all([oMetaModel.requestObject(`${sValueHelpProperty}@com.sap.vocabularies.Common.v1.ValueListWithFixedValues`), oMetaModel.requestObject(`${sValueHelpProperty}@com.sap.vocabularies.Common.v1.ValueListReferences`), oMetaModel.requestObject(`${sValueHelpProperty}@com.sap.vocabularies.Common.v1.ValueListMapping`), oMetaModel.requestObject(`${sValueHelpProperty}@com.sap.vocabularies.Common.v1.ValueList`)]);
      }).then(function (aResults) {
        return !!aResults[0] || !!aResults[1] || !!aResults[2] || !!aResults[3];
      }).catch(function (oError) {
        Log.warning("Error while retrieving custom data / value list annotation values", oError);
      });
    },
    isMultiValue(oProperty) {
      let bIsMultiValue = true;
      //SingleValue | MultiValue | SingleRange | MultiRange | SearchExpression | MultiRangeOrSearchExpression
      switch (oProperty.filterExpression) {
        case "SearchExpression":
        case "SingleRange":
        case "SingleValue":
          bIsMultiValue = false;
          break;
        default:
          break;
      }
      if (oProperty.type && oProperty.type.indexOf("Boolean") > 0) {
        bIsMultiValue = false;
      }
      return bIsMultiValue;
    }
  };
  return DelegateUtil;
}, false);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJOU19NQUNST0RBVEEiLCJfcmV0cmlldmVNb2RlbCIsImNvbnRyb2wiLCJkZXRhY2hNb2RlbENvbnRleHRDaGFuZ2UiLCJzTW9kZWxOYW1lIiwibW9kZWxOYW1lIiwib01vZGVsIiwiZ2V0TW9kZWwiLCJyZXNvbHZlIiwiYXR0YWNoTW9kZWxDb250ZXh0Q2hhbmdlIiwiZ2V0Q3VzdG9tRGF0YVdpdGhNb2RpZmllciIsIm9Db250cm9sIiwic1Byb3BlcnR5Iiwib01vZGlmaWVyIiwiYUN1c3RvbURhdGEiLCJhUmV0cmlldmVkQ3VzdG9tRGF0YSIsIlByb21pc2UiLCJ0aGVuIiwiZ2V0QWdncmVnYXRpb24iLCJiaW5kIiwib1Byb21pc2UiLCJyZWR1Y2UiLCJvUHJldmlvdXNQcm9taXNlIiwib0N1c3RvbURhdGEiLCJnZXRQcm9wZXJ0eSIsInNLZXkiLCJwdXNoIiwibGVuZ3RoIiwidW5kZWZpbmVkIiwiRkVUQ0hFRF9QUk9QRVJUSUVTX0RBVEFfS0VZIiwiRGVsZWdhdGVVdGlsIiwiZ2V0TG9jYWxpemVkVGV4dCIsInNUZXh0T3JUb2tlbiIsImFNYXRjaCIsImV4ZWMiLCJvUmVzb3VyY2VCdW5kbGUiLCJnZXRSZXNvdXJjZUJ1bmRsZSIsImdldFRleHQiLCJlIiwiTG9nIiwiaW5mbyIsInNldENhY2hlZFByb3BlcnRpZXMiLCJ0YWJsZSIsImZldGNoZWRQcm9wZXJ0aWVzIiwid2luZG93IiwiRWxlbWVudCIsImtleSIsInNldEN1c3RvbURhdGEiLCJnZXRDYWNoZWRQcm9wZXJ0aWVzIiwiZ2V0Q3VzdG9tRGF0YSIsImdldEF0dHJpYnV0ZU5TIiwiZGF0YSIsIkZ1bmN0aW9uIiwidlZhbHVlIiwic2V0QXR0cmlidXRlTlMiLCJmZXRjaFByb3BlcnRpZXNGb3JFbnRpdHkiLCJzRW50aXR5U2V0Iiwib01ldGFNb2RlbCIsInJlcXVlc3RPYmplY3QiLCJmZXRjaEFubm90YXRpb25zRm9yRW50aXR5IiwiZmV0Y2hNb2RlbCIsImdldERlbGVnYXRlIiwicGF5bG9hZCIsIm9Db250ZXh0IiwiY2FsbCIsImxvYWRNYWNyb0xpYnJhcnkiLCJzYXAiLCJ1aSIsInJlcXVpcmUiLCJ0ZW1wbGF0ZUNvbnRyb2xGcmFnbWVudCIsInNGcmFnbWVudE5hbWUiLCJvUHJlcHJvY2Vzc29yU2V0dGluZ3MiLCJvT3B0aW9ucyIsIkNvbW1vblV0aWxzIiwiZG9lc1ZhbHVlSGVscEV4aXN0IiwibVBhcmFtZXRlcnMiLCJzUHJvcGVydHlOYW1lIiwic1ZhbHVlSGVscFR5cGUiLCJzT3JpZ2luYWxQcm9wZXJ0eSIsInNCaW5kaW5nUGF0aCIsIm9Qcm9wZXJ0eUNvbnRleHQiLCJjcmVhdGVCaW5kaW5nQ29udGV4dCIsInNWYWx1ZUhlbHBQcm9wZXJ0eSIsIkZpZWxkSGVscGVyIiwidmFsdWVIZWxwUHJvcGVydHkiLCJiSXNBYnNvbHV0ZSIsImluZGV4T2YiLCJnZXRPYmplY3QiLCJzR2VuZXJhdGVkSWQiLCJnZW5lcmF0ZUlEIiwiZmxleElkIiwiZ2VuZXJhdGUiLCJnZXRJZCIsImdldFJlbGF0aXZlUHJvcGVydHlQYXRoIiwiY29udGV4dCIsImdldFBhdGgiLCJhRGVwZW5kZW50cyIsInNvbWUiLCJvRGVwZW5kZW50IiwiaXNWYWx1ZUhlbHBSZXF1aXJlZCIsImJJbkZpbHRlckZpZWxkIiwiYlJlYWRPbmx5IiwiYWxsIiwiYVJlc3VsdHMiLCJjYXRjaCIsIm9FcnJvciIsIndhcm5pbmciLCJpc011bHRpVmFsdWUiLCJvUHJvcGVydHkiLCJiSXNNdWx0aVZhbHVlIiwiZmlsdGVyRXhwcmVzc2lvbiIsInR5cGUiXSwic291cmNlUm9vdCI6Ii4iLCJzb3VyY2VzIjpbIkRlbGVnYXRlVXRpbC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSBSZXNvdXJjZUJ1bmRsZSBmcm9tIFwic2FwL2Jhc2UvaTE4bi9SZXNvdXJjZUJ1bmRsZVwiO1xuaW1wb3J0IExvZyBmcm9tIFwic2FwL2Jhc2UvTG9nXCI7XG5pbXBvcnQgQXBwQ29tcG9uZW50IGZyb20gXCJzYXAvZmUvY29yZS9BcHBDb21wb25lbnRcIjtcbmltcG9ydCBDb21tb25VdGlscyBmcm9tIFwic2FwL2ZlL2NvcmUvQ29tbW9uVXRpbHNcIjtcbmltcG9ydCB7XG5cdGNvbmZpZ1R5cGUsXG5cdEN1c3RvbUJhc2VkVGFibGVDb2x1bW4sXG5cdGV4cG9ydFNldHRpbmdzLFxuXHRFeHRlbnNpb25Gb3JBbmFseXRpY3MsXG5cdFZpc3VhbFNldHRpbmdzXG59IGZyb20gXCJzYXAvZmUvY29yZS9jb252ZXJ0ZXJzL2NvbnRyb2xzL0NvbW1vbi9UYWJsZVwiO1xuaW1wb3J0IHsgQ3VzdG9tRWxlbWVudCB9IGZyb20gXCJzYXAvZmUvY29yZS9jb252ZXJ0ZXJzL2hlbHBlcnMvQ29uZmlndXJhYmxlT2JqZWN0XCI7XG5pbXBvcnQgeyBnZW5lcmF0ZSB9IGZyb20gXCJzYXAvZmUvY29yZS9oZWxwZXJzL1N0YWJsZUlkSGVscGVyXCI7XG5pbXBvcnQgdHlwZSBQYWdlQ29udHJvbGxlciBmcm9tIFwic2FwL2ZlL2NvcmUvUGFnZUNvbnRyb2xsZXJcIjtcbmltcG9ydCB7IERpc3BsYXlNb2RlIH0gZnJvbSBcInNhcC9mZS9jb3JlL3RlbXBsYXRpbmcvRGlzcGxheU1vZGVGb3JtYXR0ZXJcIjtcbmltcG9ydCB7IGdldFJlbGF0aXZlUHJvcGVydHlQYXRoIH0gZnJvbSBcInNhcC9mZS9jb3JlL3RlbXBsYXRpbmcvUHJvcGVydHlGb3JtYXR0ZXJzXCI7XG5pbXBvcnQgRmllbGRIZWxwZXIgZnJvbSBcInNhcC9mZS9tYWNyb3MvZmllbGQvRmllbGRIZWxwZXJcIjtcbmltcG9ydCB7IGdlbmVyYXRlSUQgfSBmcm9tIFwic2FwL2ZlL21hY3Jvcy9pbnRlcm5hbC92YWx1ZWhlbHAvVmFsdWVIZWxwVGVtcGxhdGluZ1wiO1xuaW1wb3J0IHR5cGUgQ29udHJvbCBmcm9tIFwic2FwL3VpL2NvcmUvQ29udHJvbFwiO1xuaW1wb3J0IFRhYmxlIGZyb20gXCJzYXAvdWkvbWRjL1RhYmxlXCI7XG5pbXBvcnQgTW9kZWwgZnJvbSBcInNhcC91aS9tb2RlbC9Nb2RlbFwiO1xuaW1wb3J0IHR5cGUgUmVzb3VyY2VNb2RlbCBmcm9tIFwic2FwL3VpL21vZGVsL3Jlc291cmNlL1Jlc291cmNlTW9kZWxcIjtcblxuY29uc3QgTlNfTUFDUk9EQVRBID0gXCJodHRwOi8vc2NoZW1hcy5zYXAuY29tL3NhcHVpNS9leHRlbnNpb24vc2FwLnVpLmNvcmUuQ3VzdG9tRGF0YS8xXCI7XG5cbmV4cG9ydCB0eXBlIHRhYmxlRGVsZWdhdGVNb2RlbCA9IHtcblx0ZW5hYmxlQXV0b0NvbHVtbldpZHRoOiBib29sZWFuO1xuXHRpc09wdGltaXplZEZvclNtYWxsRGV2aWNlOiBib29sZWFuO1xuXHRyZWFkT25seTogYm9vbGVhbjtcblx0Y29sdW1uRWRpdE1vZGU6IHN0cmluZztcblx0dGFibGVUeXBlOiBzdHJpbmc7XG5cdG9uQ2hhbmdlOiBGdW5jdGlvbjtcblx0aWQ6IHN0cmluZztcblx0bmF2aWdhdGlvblByb3BlcnR5UGF0aDogc3RyaW5nO1xuXHRjb2x1bW5JbmZvOiBDdXN0b21FbGVtZW50PEN1c3RvbUJhc2VkVGFibGVDb2x1bW4+O1xuXHRjb2xsZWN0aW9uOiB7XG5cdFx0c1BhdGg6IHN0cmluZztcblx0XHRvTW9kZWw6IHN0cmluZztcblx0fTtcbn07XG5cbmV4cG9ydCB0eXBlIFByb3BlcnR5SW5mbyA9IHtcblx0YWRkaXRpb25hbExhYmVscz86IHN0cmluZ1tdO1xuXHRjYXNlU2Vuc2l0aXZlPzogYm9vbGVhbjtcblx0ZGVzY3JpcHRpb24/OiBzdHJpbmc7XG5cdGRlc2NyaXB0aW9uUHJvcGVydHk/OiBzdHJpbmc7XG5cdGV4cG9ydFNldHRpbmdzPzogZXhwb3J0U2V0dGluZ3MgfCBudWxsO1xuXHRmaWx0ZXJhYmxlPzogYm9vbGVhbjtcblx0Z3JvdXA/OiBzdHJpbmc7XG5cdGdyb3VwYWJsZT86IGJvb2xlYW47XG5cdGdyb3VwTGFiZWw/OiBzdHJpbmc7XG5cdGtleT86IGJvb2xlYW47XG5cdGxhYmVsPzogc3RyaW5nO1xuXHRtYXhDb25kaXRpb25zPzogbnVtYmVyO1xuXHRtZXRhZGF0YVBhdGg6IHN0cmluZztcblx0bW9kZT86IERpc3BsYXlNb2RlO1xuXHRuYW1lOiBzdHJpbmc7XG5cdHBhdGg/OiBzdHJpbmc7XG5cdHByb3BlcnR5SW5mb3M/OiBzdHJpbmdbXTtcblx0cmVsYXRpdmVQYXRoPzogc3RyaW5nO1xuXHRzb3J0YWJsZT86IGJvb2xlYW47XG5cdHNvcnREaXJlY3Rpb24/OiBzdHJpbmc7XG5cdHRleHQ/OiBzdHJpbmc7XG5cdHRvb2x0aXA/OiBzdHJpbmc7XG5cdHR5cGVDb25maWc6IGNvbmZpZ1R5cGU7XG5cdHVuaXQ/OiBzdHJpbmc7XG5cdHZhbHVlUHJvcGVydHk/OiBzdHJpbmc7XG5cdHZpc2libGU6IGJvb2xlYW47XG5cdHZpc3VhbFNldHRpbmdzPzogVmlzdWFsU2V0dGluZ3M7XG5cdGV4cG9ydERhdGFQb2ludFRhcmdldFZhbHVlPzogc3RyaW5nO1xuXHRpc1BhcmFtZXRlcj86IGJvb2xlYW47XG5cdGFnZ3JlZ2F0YWJsZT86IGJvb2xlYW47XG5cdGV4dGVuc2lvbj86IEV4dGVuc2lvbkZvckFuYWx5dGljcztcbn07XG5cbmZ1bmN0aW9uIF9yZXRyaWV2ZU1vZGVsKHRoaXM6IHsgbW9kZWxOYW1lOiBzdHJpbmc7IGNvbnRyb2w6IGFueTsgcmVzb2x2ZTogRnVuY3Rpb24gfSkge1xuXHR0aGlzLmNvbnRyb2wuZGV0YWNoTW9kZWxDb250ZXh0Q2hhbmdlKF9yZXRyaWV2ZU1vZGVsLCB0aGlzKTtcblx0Y29uc3Qgc01vZGVsTmFtZSA9IHRoaXMubW9kZWxOYW1lLFxuXHRcdG9Nb2RlbCA9IHRoaXMuY29udHJvbC5nZXRNb2RlbChzTW9kZWxOYW1lKTtcblxuXHRpZiAob01vZGVsKSB7XG5cdFx0dGhpcy5yZXNvbHZlKG9Nb2RlbCk7XG5cdH0gZWxzZSB7XG5cdFx0dGhpcy5jb250cm9sLmF0dGFjaE1vZGVsQ29udGV4dENoYW5nZShfcmV0cmlldmVNb2RlbCwgdGhpcyk7XG5cdH1cbn1cbmFzeW5jIGZ1bmN0aW9uIGdldEN1c3RvbURhdGFXaXRoTW9kaWZpZXIob0NvbnRyb2w6IGFueSwgc1Byb3BlcnR5OiBhbnksIG9Nb2RpZmllcjogYW55KSB7XG5cdGNvbnN0IGFDdXN0b21EYXRhOiBhbnlbXSA9IFtdO1xuXG5cdGNvbnN0IGFSZXRyaWV2ZWRDdXN0b21EYXRhID0gYXdhaXQgUHJvbWlzZS5yZXNvbHZlKCkudGhlbihcblx0XHRvTW9kaWZpZXIuZ2V0QWdncmVnYXRpb24uYmluZChvTW9kaWZpZXIsIG9Db250cm9sLCBcImN1c3RvbURhdGFcIikgYXMgKCkgPT4gYW55W11cblx0KTtcblxuXHRjb25zdCBvUHJvbWlzZSA9IGFSZXRyaWV2ZWRDdXN0b21EYXRhLnJlZHVjZSgob1ByZXZpb3VzUHJvbWlzZTogUHJvbWlzZTx2b2lkPiwgb0N1c3RvbURhdGEpID0+IHtcblx0XHRyZXR1cm4gb1ByZXZpb3VzUHJvbWlzZS50aGVuKG9Nb2RpZmllci5nZXRQcm9wZXJ0eS5iaW5kKG9Nb2RpZmllciwgb0N1c3RvbURhdGEsIFwia2V5XCIpKS50aGVuKGZ1bmN0aW9uIChzS2V5OiBhbnkpIHtcblx0XHRcdGlmIChzS2V5ID09PSBzUHJvcGVydHkpIHtcblx0XHRcdFx0YUN1c3RvbURhdGEucHVzaChvQ3VzdG9tRGF0YSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH0sIFByb21pc2UucmVzb2x2ZSgpKTtcblx0YXdhaXQgb1Byb21pc2U7XG5cblx0aWYgKGFDdXN0b21EYXRhLmxlbmd0aCA9PT0gMSkge1xuXHRcdHJldHVybiBvTW9kaWZpZXIuZ2V0UHJvcGVydHkoYUN1c3RvbURhdGFbMF0sIFwidmFsdWVcIik7XG5cdH0gZWxzZSB7XG5cdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0fVxufVxuY29uc3QgRkVUQ0hFRF9QUk9QRVJUSUVTX0RBVEFfS0VZID0gXCJzYXBfZmVfVGFibGVEZWxlZ2F0ZV9wcm9wZXJ0eUluZm9NYXBcIjtcblxuY29uc3QgRGVsZWdhdGVVdGlsID0ge1xuXHRnZXRMb2NhbGl6ZWRUZXh0KHNUZXh0T3JUb2tlbjogc3RyaW5nLCBvQ29udHJvbDogQ29udHJvbCB8IEFwcENvbXBvbmVudCB8IFBhZ2VDb250cm9sbGVyKSB7XG5cdFx0Y29uc3QgYU1hdGNoID0gL3soW0EtWmEtejAtOV8ufEBdKyk+KFtBLVphLXowLTlfLnxdKyl9Ly5leGVjKHNUZXh0T3JUb2tlbik7XG5cdFx0aWYgKGFNYXRjaCkge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0Y29uc3Qgb1Jlc291cmNlQnVuZGxlID0gKG9Db250cm9sLmdldE1vZGVsKGFNYXRjaFsxXSkgYXMgUmVzb3VyY2VNb2RlbCkuZ2V0UmVzb3VyY2VCdW5kbGUoKSBhcyBSZXNvdXJjZUJ1bmRsZTtcblx0XHRcdFx0cmV0dXJuIG9SZXNvdXJjZUJ1bmRsZS5nZXRUZXh0KGFNYXRjaFsyXSk7XG5cdFx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRcdExvZy5pbmZvKGBVbmFibGUgdG8gcmV0cmlldmUgbG9jYWxpemVkIHRleHQgJHtzVGV4dE9yVG9rZW59YCk7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdHJldHVybiBzVGV4dE9yVG9rZW47XG5cdH0sXG5cblx0c2V0Q2FjaGVkUHJvcGVydGllcyh0YWJsZTogVGFibGUsIGZldGNoZWRQcm9wZXJ0aWVzOiBQcm9wZXJ0eUluZm9bXSkge1xuXHRcdC8vIGRvIG5vdCBjYWNoZSBkdXJpbmcgdGVtcGxhdGluZywgZWxzZSBpdCBiZWNvbWVzIHBhcnQgb2YgdGhlIGNhY2hlZCB2aWV3XG5cdFx0aWYgKHRhYmxlIGluc3RhbmNlb2Ygd2luZG93LkVsZW1lbnQpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0Y29uc3Qga2V5ID0gRkVUQ0hFRF9QUk9QRVJUSUVTX0RBVEFfS0VZO1xuXHRcdERlbGVnYXRlVXRpbC5zZXRDdXN0b21EYXRhKHRhYmxlLCBrZXksIGZldGNoZWRQcm9wZXJ0aWVzKTtcblx0fSxcblx0Z2V0Q2FjaGVkUHJvcGVydGllcyh0YWJsZTogVGFibGUpOiBQcm9wZXJ0eUluZm9bXSB8IG51bGwge1xuXHRcdC8vIHByb3BlcnRpZXMgYXJlIG5vdCBjYWNoZWQgZHVyaW5nIHRlbXBsYXRpbmdcblx0XHRpZiAodGFibGUgaW5zdGFuY2VvZiB3aW5kb3cuRWxlbWVudCkge1xuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fVxuXHRcdGNvbnN0IGtleSA9IEZFVENIRURfUFJPUEVSVElFU19EQVRBX0tFWTtcblx0XHRyZXR1cm4gRGVsZWdhdGVVdGlsLmdldEN1c3RvbURhdGEodGFibGUsIGtleSk7XG5cdH0sXG5cblx0Z2V0Q3VzdG9tRGF0YShvQ29udHJvbDogYW55LCBzUHJvcGVydHk6IGFueSwgb01vZGlmaWVyPzogYW55KSB7XG5cdFx0Ly8gSWYgTW9kaWZpZXIgaXMgZ2l2ZW4sIHRoZSBtZXRob2QgbXVzdCBleGVjdXRlIGFzeW5jaHJvbm91c2x5IGFuZCByZXR1cm4gYSBQcm9taXNlXG5cdFx0aWYgKG9Nb2RpZmllcikge1xuXHRcdFx0cmV0dXJuIGdldEN1c3RvbURhdGFXaXRoTW9kaWZpZXIob0NvbnRyb2wsIHNQcm9wZXJ0eSwgb01vZGlmaWVyKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Ly8gRGVsZWdhdGUgaW52b2tlZCBmcm9tIGEgbm9uLWZsZXggY2hhbmdlIC0gRmlsdGVyQmFyRGVsZWdhdGUuX2FkZFAxM25JdGVtIGZvciBPUCB0YWJsZSBmaWx0ZXJpbmcsIEZpbHRlckJhckRlbGVnYXRlLmZldGNoUHJvcGVydGllcyBldGMuXG5cdFx0XHRpZiAob0NvbnRyb2wgJiYgc1Byb3BlcnR5KSB7XG5cdFx0XHRcdGlmIChvQ29udHJvbCBpbnN0YW5jZW9mIHdpbmRvdy5FbGVtZW50KSB7XG5cdFx0XHRcdFx0cmV0dXJuIG9Db250cm9sLmdldEF0dHJpYnV0ZU5TKE5TX01BQ1JPREFUQSwgc1Byb3BlcnR5KTtcblx0XHRcdFx0fVxuXHRcdFx0XHRpZiAob0NvbnRyb2wuZGF0YSBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7XG5cdFx0XHRcdFx0cmV0dXJuIG9Db250cm9sLmRhdGEoc1Byb3BlcnR5KTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0XHR9XG5cdH0sXG5cdHNldEN1c3RvbURhdGEob0NvbnRyb2w6IGFueSwgc1Byb3BlcnR5OiBhbnksIHZWYWx1ZTogYW55KSB7XG5cdFx0aWYgKG9Db250cm9sICYmIHNQcm9wZXJ0eSkge1xuXHRcdFx0aWYgKG9Db250cm9sIGluc3RhbmNlb2Ygd2luZG93LkVsZW1lbnQpIHtcblx0XHRcdFx0cmV0dXJuIG9Db250cm9sLnNldEF0dHJpYnV0ZU5TKE5TX01BQ1JPREFUQSwgYGN1c3RvbURhdGE6JHtzUHJvcGVydHl9YCwgdlZhbHVlKTtcblx0XHRcdH1cblx0XHRcdGlmIChvQ29udHJvbC5kYXRhIGluc3RhbmNlb2YgRnVuY3Rpb24pIHtcblx0XHRcdFx0cmV0dXJuIG9Db250cm9sLmRhdGEoc1Byb3BlcnR5LCB2VmFsdWUpO1xuXHRcdFx0fVxuXHRcdH1cblx0fSxcblx0ZmV0Y2hQcm9wZXJ0aWVzRm9yRW50aXR5KHNFbnRpdHlTZXQ6IGFueSwgb01ldGFNb2RlbDogYW55KSB7XG5cdFx0cmV0dXJuIG9NZXRhTW9kZWwucmVxdWVzdE9iamVjdChgJHtzRW50aXR5U2V0fS9gKTtcblx0fSxcblx0ZmV0Y2hBbm5vdGF0aW9uc0ZvckVudGl0eShzRW50aXR5U2V0OiBhbnksIG9NZXRhTW9kZWw6IGFueSkge1xuXHRcdHJldHVybiBvTWV0YU1vZGVsLnJlcXVlc3RPYmplY3QoYCR7c0VudGl0eVNldH1AYCk7XG5cdH0sXG5cdGZldGNoTW9kZWwob0NvbnRyb2w6IGFueSk6IFByb21pc2U8TW9kZWw+IHtcblx0XHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcblx0XHRcdGNvbnN0IHNNb2RlbE5hbWUgPSBvQ29udHJvbC5nZXREZWxlZ2F0ZSgpLnBheWxvYWQgJiYgb0NvbnRyb2wuZ2V0RGVsZWdhdGUoKS5wYXlsb2FkLm1vZGVsTmFtZSxcblx0XHRcdFx0b0NvbnRleHQgPSB7IG1vZGVsTmFtZTogc01vZGVsTmFtZSwgY29udHJvbDogb0NvbnRyb2wsIHJlc29sdmU6IHJlc29sdmUgfTtcblx0XHRcdF9yZXRyaWV2ZU1vZGVsLmNhbGwob0NvbnRleHQpO1xuXHRcdH0pO1xuXHR9LFxuXHRsb2FkTWFjcm9MaWJyYXJ5KCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuXHRcdFx0c2FwLnVpLnJlcXVpcmUoW1wic2FwL2ZlL21hY3Jvcy9tYWNyb0xpYnJhcnlcIl0sIGZ1bmN0aW9uICgvKm1hY3JvTGlicmFyeSovKSB7XG5cdFx0XHRcdHJlc29sdmUoKTtcblx0XHRcdH0pO1xuXHRcdH0pO1xuXHR9LFxuXHR0ZW1wbGF0ZUNvbnRyb2xGcmFnbWVudChzRnJhZ21lbnROYW1lOiBhbnksIG9QcmVwcm9jZXNzb3JTZXR0aW5nczogYW55LCBvT3B0aW9uczogYW55LCBvTW9kaWZpZXI/OiBhbnkpIHtcblx0XHRyZXR1cm4gQ29tbW9uVXRpbHMudGVtcGxhdGVDb250cm9sRnJhZ21lbnQoc0ZyYWdtZW50TmFtZSwgb1ByZXByb2Nlc3NvclNldHRpbmdzLCBvT3B0aW9ucywgb01vZGlmaWVyKTtcblx0fSxcblx0ZG9lc1ZhbHVlSGVscEV4aXN0KG1QYXJhbWV0ZXJzOiBhbnkpIHtcblx0XHRjb25zdCBzUHJvcGVydHlOYW1lID0gbVBhcmFtZXRlcnMuc1Byb3BlcnR5TmFtZSB8fCBcIlwiO1xuXHRcdGNvbnN0IHNWYWx1ZUhlbHBUeXBlID0gbVBhcmFtZXRlcnMuc1ZhbHVlSGVscFR5cGUgfHwgXCJcIjtcblx0XHRjb25zdCBvTWV0YU1vZGVsID0gbVBhcmFtZXRlcnMub01ldGFNb2RlbDtcblx0XHRjb25zdCBvTW9kaWZpZXIgPSBtUGFyYW1ldGVycy5vTW9kaWZpZXI7XG5cdFx0Y29uc3Qgc09yaWdpbmFsUHJvcGVydHkgPSBgJHttUGFyYW1ldGVycy5zQmluZGluZ1BhdGh9LyR7c1Byb3BlcnR5TmFtZX1gO1xuXHRcdGNvbnN0IG9Qcm9wZXJ0eUNvbnRleHQgPSBvTWV0YU1vZGVsLmNyZWF0ZUJpbmRpbmdDb250ZXh0KHNPcmlnaW5hbFByb3BlcnR5KTtcblx0XHRsZXQgc1ZhbHVlSGVscFByb3BlcnR5ID0gRmllbGRIZWxwZXIudmFsdWVIZWxwUHJvcGVydHkob1Byb3BlcnR5Q29udGV4dCk7XG5cdFx0Y29uc3QgYklzQWJzb2x1dGUgPSBtUGFyYW1ldGVycy5zQmluZGluZ1BhdGggJiYgbVBhcmFtZXRlcnMuc0JpbmRpbmdQYXRoLmluZGV4T2YoXCIvXCIpID09PSAwO1xuXG5cdFx0Ly8gdW5pdC9jdXJyZW5jeVxuXHRcdGlmIChzVmFsdWVIZWxwUHJvcGVydHkuaW5kZXhPZihcIiRQYXRoXCIpID4gLTEpIHtcblx0XHRcdHNWYWx1ZUhlbHBQcm9wZXJ0eSA9IG9NZXRhTW9kZWwuZ2V0T2JqZWN0KHNWYWx1ZUhlbHBQcm9wZXJ0eSk7XG5cdFx0fVxuXHRcdGlmIChiSXNBYnNvbHV0ZSAmJiBzVmFsdWVIZWxwUHJvcGVydHkuaW5kZXhPZihcIi9cIikgIT09IDApIHtcblx0XHRcdHNWYWx1ZUhlbHBQcm9wZXJ0eSA9IGAke21QYXJhbWV0ZXJzLnNCaW5kaW5nUGF0aH0vJHtzVmFsdWVIZWxwUHJvcGVydHl9YDtcblx0XHR9XG5cblx0XHRjb25zdCBzR2VuZXJhdGVkSWQgPSBnZW5lcmF0ZUlEKFxuXHRcdFx0bVBhcmFtZXRlcnMuZmxleElkLFxuXHRcdFx0Z2VuZXJhdGUoW29Nb2RpZmllciA/IG9Nb2RpZmllci5nZXRJZChtUGFyYW1ldGVycy5vQ29udHJvbCkgOiBtUGFyYW1ldGVycy5vQ29udHJvbC5nZXRJZCgpLCBzVmFsdWVIZWxwVHlwZV0pLFxuXHRcdFx0Z2V0UmVsYXRpdmVQcm9wZXJ0eVBhdGgob1Byb3BlcnR5Q29udGV4dC5nZXRQcm9wZXJ0eShzT3JpZ2luYWxQcm9wZXJ0eSksIHtcblx0XHRcdFx0Y29udGV4dDoge1xuXHRcdFx0XHRcdGdldE1vZGVsOiAoKSA9PiB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gbVBhcmFtZXRlcnMub01ldGFNb2RlbDtcblx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdGdldFBhdGg6ICgpID0+IHtcblx0XHRcdFx0XHRcdHJldHVybiBzT3JpZ2luYWxQcm9wZXJ0eTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0gYXMgYW55XG5cdFx0XHR9KSxcblx0XHRcdGdldFJlbGF0aXZlUHJvcGVydHlQYXRoKG9Qcm9wZXJ0eUNvbnRleHQuZ2V0UHJvcGVydHkoc1ZhbHVlSGVscFByb3BlcnR5KSwge1xuXHRcdFx0XHRjb250ZXh0OiB7XG5cdFx0XHRcdFx0Z2V0TW9kZWw6ICgpID0+IHtcblx0XHRcdFx0XHRcdHJldHVybiBtUGFyYW1ldGVycy5vTWV0YU1vZGVsO1xuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0Z2V0UGF0aDogKCkgPT4ge1xuXHRcdFx0XHRcdFx0cmV0dXJuIHNWYWx1ZUhlbHBQcm9wZXJ0eTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0gYXMgYW55XG5cdFx0XHR9KVxuXHRcdCk7XG5cblx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcblx0XHRcdC50aGVuKGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0aWYgKG9Nb2RpZmllcikge1xuXHRcdFx0XHRcdHJldHVybiBvTW9kaWZpZXIuZ2V0QWdncmVnYXRpb24obVBhcmFtZXRlcnMub0NvbnRyb2wsIFwiZGVwZW5kZW50c1wiKTtcblx0XHRcdFx0fVxuXHRcdFx0XHRyZXR1cm4gbVBhcmFtZXRlcnMub0NvbnRyb2wuZ2V0QWdncmVnYXRpb24oXCJkZXBlbmRlbnRzXCIpO1xuXHRcdFx0fSlcblx0XHRcdC50aGVuKGZ1bmN0aW9uIChhRGVwZW5kZW50czogYW55KSB7XG5cdFx0XHRcdHJldHVybiBQcm9taXNlLnJlc29sdmUoXG5cdFx0XHRcdFx0YURlcGVuZGVudHMgJiZcblx0XHRcdFx0XHRcdGFEZXBlbmRlbnRzLnNvbWUoZnVuY3Rpb24gKG9EZXBlbmRlbnQ6IGFueSkge1xuXHRcdFx0XHRcdFx0XHRyZXR1cm4gb01vZGlmaWVyID8gb01vZGlmaWVyLmdldElkKG9EZXBlbmRlbnQpID09PSBzR2VuZXJhdGVkSWQgOiBvRGVwZW5kZW50LmdldElkKCkgPT09IHNHZW5lcmF0ZWRJZDtcblx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdCk7XG5cdFx0XHR9KTtcblx0fSxcblx0aXNWYWx1ZUhlbHBSZXF1aXJlZChtUGFyYW1ldGVyczogYW55LCBiSW5GaWx0ZXJGaWVsZD86IGJvb2xlYW4pIHtcblx0XHRjb25zdCBzUHJvcGVydHlOYW1lID0gbVBhcmFtZXRlcnMuc1Byb3BlcnR5TmFtZSB8fCBcIlwiLFxuXHRcdFx0b01ldGFNb2RlbCA9IG1QYXJhbWV0ZXJzLm9NZXRhTW9kZWwsXG5cdFx0XHRzUHJvcGVydHkgPSBgJHttUGFyYW1ldGVycy5zQmluZGluZ1BhdGh9LyR7c1Byb3BlcnR5TmFtZX1gLFxuXHRcdFx0b1Byb3BlcnR5Q29udGV4dCA9IG9NZXRhTW9kZWwuY3JlYXRlQmluZGluZ0NvbnRleHQoc1Byb3BlcnR5KSxcblx0XHRcdHNWYWx1ZUhlbHBQcm9wZXJ0eSA9IEZpZWxkSGVscGVyLnZhbHVlSGVscFByb3BlcnR5KG9Qcm9wZXJ0eUNvbnRleHQsIGJJbkZpbHRlckZpZWxkKTtcblxuXHRcdHJldHVybiB0aGlzLmdldEN1c3RvbURhdGEobVBhcmFtZXRlcnMub0NvbnRyb2wsIFwiZGlzcGxheU1vZGVQcm9wZXJ0eUJpbmRpbmdcIiwgbVBhcmFtZXRlcnMub01vZGlmaWVyKVxuXHRcdFx0LnRoZW4oZnVuY3Rpb24gKGJSZWFkT25seTogYW55KSB7XG5cdFx0XHRcdC8vIENoZWNrIHdoZXRoZXIgdGhlIGNvbnRyb2wgaXMgcmVhZC1vbmx5LiBJZiB5ZXMsIG5vIG5lZWQgb2YgYSB2YWx1ZSBoZWxwLlxuXHRcdFx0XHRiUmVhZE9ubHkgPSB0eXBlb2YgYlJlYWRPbmx5ID09PSBcImJvb2xlYW5cIiA/IGJSZWFkT25seSA6IGJSZWFkT25seSA9PT0gXCJ0cnVlXCI7XG5cdFx0XHRcdGlmIChiUmVhZE9ubHkpIHtcblx0XHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHRcdH1cblx0XHRcdFx0Ly8gRWxzZSwgY2hlY2sgd2hldGhlciBWYWx1ZSBIZWxwIHJlbGV2YW50IGFubm90YXRpb24gZXhpc3RzIGZvciB0aGUgcHJvcGVydHkuXG5cdFx0XHRcdC8vIFRPRE8gdXNlIFByb3BlcnR5Rm9ybWF0dGVyLmhhc1ZhbHVlSGVscCAoKSA9PiBpZiBkb2luZyBzbywgUVVuaXQgdGVzdHMgZmFpbCBkdWUgdG8gbW9ja2VkIG1vZGVsIGltcGxlbWVudGF0aW9uXG5cdFx0XHRcdHJldHVybiBQcm9taXNlLmFsbChbXG5cdFx0XHRcdFx0b01ldGFNb2RlbC5yZXF1ZXN0T2JqZWN0KGAke3NWYWx1ZUhlbHBQcm9wZXJ0eX1AY29tLnNhcC52b2NhYnVsYXJpZXMuQ29tbW9uLnYxLlZhbHVlTGlzdFdpdGhGaXhlZFZhbHVlc2ApLFxuXHRcdFx0XHRcdG9NZXRhTW9kZWwucmVxdWVzdE9iamVjdChgJHtzVmFsdWVIZWxwUHJvcGVydHl9QGNvbS5zYXAudm9jYWJ1bGFyaWVzLkNvbW1vbi52MS5WYWx1ZUxpc3RSZWZlcmVuY2VzYCksXG5cdFx0XHRcdFx0b01ldGFNb2RlbC5yZXF1ZXN0T2JqZWN0KGAke3NWYWx1ZUhlbHBQcm9wZXJ0eX1AY29tLnNhcC52b2NhYnVsYXJpZXMuQ29tbW9uLnYxLlZhbHVlTGlzdE1hcHBpbmdgKSxcblx0XHRcdFx0XHRvTWV0YU1vZGVsLnJlcXVlc3RPYmplY3QoYCR7c1ZhbHVlSGVscFByb3BlcnR5fUBjb20uc2FwLnZvY2FidWxhcmllcy5Db21tb24udjEuVmFsdWVMaXN0YClcblx0XHRcdFx0XSk7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oZnVuY3Rpb24gKGFSZXN1bHRzOiBhbnlbXSkge1xuXHRcdFx0XHRyZXR1cm4gISFhUmVzdWx0c1swXSB8fCAhIWFSZXN1bHRzWzFdIHx8ICEhYVJlc3VsdHNbMl0gfHwgISFhUmVzdWx0c1szXTtcblx0XHRcdH0pXG5cdFx0XHQuY2F0Y2goZnVuY3Rpb24gKG9FcnJvcjogYW55KSB7XG5cdFx0XHRcdExvZy53YXJuaW5nKFwiRXJyb3Igd2hpbGUgcmV0cmlldmluZyBjdXN0b20gZGF0YSAvIHZhbHVlIGxpc3QgYW5ub3RhdGlvbiB2YWx1ZXNcIiwgb0Vycm9yKTtcblx0XHRcdH0pO1xuXHR9LFxuXHRpc011bHRpVmFsdWUob1Byb3BlcnR5OiBhbnkpIHtcblx0XHRsZXQgYklzTXVsdGlWYWx1ZSA9IHRydWU7XG5cdFx0Ly9TaW5nbGVWYWx1ZSB8IE11bHRpVmFsdWUgfCBTaW5nbGVSYW5nZSB8IE11bHRpUmFuZ2UgfCBTZWFyY2hFeHByZXNzaW9uIHwgTXVsdGlSYW5nZU9yU2VhcmNoRXhwcmVzc2lvblxuXHRcdHN3aXRjaCAob1Byb3BlcnR5LmZpbHRlckV4cHJlc3Npb24pIHtcblx0XHRcdGNhc2UgXCJTZWFyY2hFeHByZXNzaW9uXCI6XG5cdFx0XHRjYXNlIFwiU2luZ2xlUmFuZ2VcIjpcblx0XHRcdGNhc2UgXCJTaW5nbGVWYWx1ZVwiOlxuXHRcdFx0XHRiSXNNdWx0aVZhbHVlID0gZmFsc2U7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0YnJlYWs7XG5cdFx0fVxuXHRcdGlmIChvUHJvcGVydHkudHlwZSAmJiBvUHJvcGVydHkudHlwZS5pbmRleE9mKFwiQm9vbGVhblwiKSA+IDApIHtcblx0XHRcdGJJc011bHRpVmFsdWUgPSBmYWxzZTtcblx0XHR9XG5cdFx0cmV0dXJuIGJJc011bHRpVmFsdWU7XG5cdH1cbn07XG5leHBvcnQgZGVmYXVsdCBEZWxlZ2F0ZVV0aWw7XG4iXSwibWFwcGluZ3MiOiI7QUFBQTtBQUFBO0FBQUE7Ozs7Ozs7RUF1QkEsTUFBTUEsWUFBWSxHQUFHLGtFQUFrRTtFQW9EdkYsU0FBU0MsY0FBYyxHQUErRDtJQUNyRixJQUFJLENBQUNDLE9BQU8sQ0FBQ0Msd0JBQXdCLENBQUNGLGNBQWMsRUFBRSxJQUFJLENBQUM7SUFDM0QsTUFBTUcsVUFBVSxHQUFHLElBQUksQ0FBQ0MsU0FBUztNQUNoQ0MsTUFBTSxHQUFHLElBQUksQ0FBQ0osT0FBTyxDQUFDSyxRQUFRLENBQUNILFVBQVUsQ0FB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