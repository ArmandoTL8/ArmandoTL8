/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/helpers/Aggregation","sap/fe/core/converters/helpers/IssueManager","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/FilterTemplating"],function(e,t,o,i,n,l){"use strict";var a={};var r=l.isPropertyFilterable;var v=l.getIsRequired;var s=n.checkFilterExpressionRestrictions;var d=o.compileExpression;var u=t.IssueType;var g=t.IssueSeverity;var c=t.IssueCategory;var f=e.AggregationHelper;const p=function(e,t,o){var i,n,l,a;let r,v,s;let d;const u=o.getCustomAggregateDefinitions();let g=o.getTransAggregations();let c=[];if(t!==null&&t!==void 0&&(i=t.$target)!==null&&i!==void 0&&i.Measures){var f,p,P;c=u.filter(function(e){var o,i,n;return e.qualifier===(t===null||t===void 0?void 0:(o=t.$target)===null||o===void 0?void 0:(i=o.Measures)===null||i===void 0?void 0:(n=i[0])===null||n===void 0?void 0:n.value)});d=c.length>0?c[0].qualifier:t===null||t===void 0?void 0:(f=t.$target)===null||f===void 0?void 0:(p=f.Measures)===null||p===void 0?void 0:(P=p[0])===null||P===void 0?void 0:P.value}if(!c[0]&&t!==null&&t!==void 0&&(n=t.$target)!==null&&n!==void 0&&n.DynamicMeasures){var y,h;d=e.getConverterContextFor(e.getAbsoluteAnnotationPath((y=t.$target.DynamicMeasures)===null||y===void 0?void 0:(h=y[0])===null||h===void 0?void 0:h.value)).getDataModelObjectPath().targetObject.Name;g=o.getAggregatedProperties("AggregatedProperty")}else{g=o.getAggregatedProperties("AggregatedProperties")[0]}const m=t===null||t===void 0?void 0:(l=t.$target)===null||l===void 0?void 0:(a=l.Dimensions[0])===null||a===void 0?void 0:a.value;if(u.some(function(e){return e.qualifier===d})){r=d}else if(g&&g[0]){g.some(function(e){if(e.Name===d){r=e===null||e===void 0?void 0:e.AggregatableProperty.value}})}const A=o.getAggregatableProperties();const E=o.getGroupableProperties();if(A&&A.length){for(const e of A){var C;if((e===null||e===void 0?void 0:(C=e.Property)===null||C===void 0?void 0:C.value)===r){s=true}}}if(E&&E.length){for(const e of E){if((e===null||e===void 0?void 0:e.value)===m){v=true}}}return s&&v};function P(e,t,o,n){var l;let a;const P=n[o];if(P!==null&&P!==void 0&&(l=P.visualFilter)!==null&&l!==void 0&&l.valueList){var y,h;const n=P===null||P===void 0?void 0:(y=P.visualFilter)===null||y===void 0?void 0:y.valueList;const l=n.split("#");const ae=l.length>1?`ValueList#${l[1]}`:l[0];const re=e.resolvePath(o);const ve=re===null||re===void 0?void 0:(h=re.annotations)===null||h===void 0?void 0:h.Common[ae];if(ve){var m,A;const e=ve===null||ve===void 0?void 0:ve.CollectionPath;const n=t.getConverterContextFor(`/${e||((m=t.getEntitySet())===null||m===void 0?void 0:m.name)}`);const l=ve===null||ve===void 0?void 0:ve.Parameters;let P;const y=[];let h=[];const ae=n.getParameterEntityType();h=ae?ae.keys.map(function(e){return e.name}):[];if(t.getContextPath()===n.getContextPath()){h.forEach(function(e){y.push({localDataProperty:e,valueListProperty:e})})}if(l){for(const e of l){var E;const t=(E=e.LocalDataProperty)===null||E===void 0?void 0:E.value;const i=e.ValueListProperty;if(((e===null||e===void 0?void 0:e.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterInOut"||(e===null||e===void 0?void 0:e.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterOut")&&o===t){P=e}if(((e===null||e===void 0?void 0:e.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterInOut"||(e===null||e===void 0?void 0:e.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterIn")&&o!==t){const e=r(n,i);if(!e){y.push({localDataProperty:t,valueListProperty:i})}}}}if(y&&y.length){y.forEach(function(e){const i=d(s(t.getConverterContextFor(t.getAbsoluteAnnotationPath(e===null||e===void 0?void 0:e.localDataProperty)).getDataModelObjectPath(),["SingleValue"]));const l=d(s(n.getConverterContextFor(n.getAbsoluteAnnotationPath(e===null||e===void 0?void 0:e.valueListProperty)).getDataModelObjectPath(),["SingleValue"]));if(l==="true"&&i==="false"){throw new Error(`FilterRestrictions of ${o} in MainEntitySet and ValueListEntitySet are different`)}})}const re=ve===null||ve===void 0?void 0:ve.PresentationVariantQualifier;const se=ve===null||ve===void 0?void 0:ve.SelectionVariantQualifier;const de=n===null||n===void 0?void 0:(A=n.getEntityTypeAnnotation(`@UI.PresentationVariant#${re}`))===null||A===void 0?void 0:A.annotation;const ue=new f(n.getEntityType(),n);if(!ue.isAnalyticsSupported()){return undefined}if(de){var C;const l=de===null||de===void 0?void 0:de.Visualizations;const r=`/${ve===null||ve===void 0?void 0:ve.CollectionPath}`||`/${n===null||n===void 0?void 0:(C=n.getEntitySet())===null||C===void 0?void 0:C.name}`;a={};a.contextPath=r;let f;for(const e of l){var I;if(((I=e.$target)===null||I===void 0?void 0:I.term)==="com.sap.vocabularies.UI.v1.Chart"){f=e;break}}if(f){var L,D,$,S,T,V,b,F,M,O,R,x,N,U;const r=p(n,f,ue);if(!r){return}const u=(L=f)===null||L===void 0?void 0:(D=L.$target)===null||D===void 0?void 0:($=D.Dimensions[0])===null||$===void 0?void 0:(S=$.$target)===null||S===void 0?void 0:(T=S.annotations)===null||T===void 0?void 0:(V=T.UI)===null||V===void 0?void 0:(b=V.Hidden)===null||b===void 0?void 0:b.valueOf();const g=(F=f)===null||F===void 0?void 0:(M=F.$target)===null||M===void 0?void 0:(O=M.Dimensions[0])===null||O===void 0?void 0:(R=O.$target)===null||R===void 0?void 0:(x=R.annotations)===null||x===void 0?void 0:(N=x.UI)===null||N===void 0?void 0:(U=N.HiddenFilter)===null||U===void 0?void 0:U.valueOf();if(u===true||g===true){return}else if(l&&l.length){var w,H,q,j,Q,k,_,z,B;a.chartAnnotation=f?n===null||n===void 0?void 0:n.getAbsoluteAnnotationPath(`${f.fullyQualifiedName}/$AnnotationPath/`):undefined;const l=n.getEntityType().name;let r;const u=n===null||n===void 0?void 0:n.getRelativeAnnotationPath(`${de.fullyQualifiedName}/`,n.getEntityType());if(ae){r=n.getContextPath()+"/"+u}else{r="/"+l+"/"+u}a.presentationAnnotation=de?r:undefined;a.outParameter=(w=P)===null||w===void 0?void 0:(H=w.LocalDataProperty)===null||H===void 0?void 0:H.value;a.inParameters=y;a.valuelistProperty=(q=P)===null||q===void 0?void 0:q.ValueListProperty;const g=s(t.getConverterContextFor(t.getAbsoluteAnnotationPath(o)).getDataModelObjectPath(),["SingleRange","MultiRange"]);if(d(g)==="true"){throw new Error("Range AllowedExpression is not supported for visual filters")}const c=s(t.getConverterContextFor(t.getAbsoluteAnnotationPath(o)).getDataModelObjectPath(),["SingleValue"]);a.multipleSelectionAllowed=d(!c.value);a.required=v(t,o);let p;if(se){var G;p=n===null||n===void 0?void 0:(G=n.getEntityTypeAnnotation(`@UI.SelectionVariant#${se}`))===null||G===void 0?void 0:G.annotation;let e;const t=n===null||n===void 0?void 0:n.getRelativeAnnotationPath(`${p.fullyQualifiedName}/`,n.getEntityType());if(ae){e=n.getContextPath()+"/"+t}else{e="/"+l+"/"+t}a.selectionVariantAnnotation=p?e:undefined}let m=[];if(ae){var J,K,W,X,Y;const o=e.split("/")[0];const i=e.split("/")[1];const n=t.getConverterContextFor(`/${o}`);const l=n===null||n===void 0?void 0:(J=n.getDataModelObjectPath().startingEntitySet)===null||J===void 0?void 0:(K=J.annotations)===null||K===void 0?void 0:(W=K.Capabilities)===null||W===void 0?void 0:(X=W.NavigationRestrictions)===null||X===void 0?void 0:X.RestrictedProperties;const a=l===null||l===void 0?void 0:l.find(e=>{var t;if(((t=e.NavigationProperty)===null||t===void 0?void 0:t.type)==="NavigationPropertyPath"){return e.NavigationProperty.value===i}});m=a===null||a===void 0?void 0:(Y=a.FilterRestrictions)===null||Y===void 0?void 0:Y.RequiredProperties}else{var Z;const e=(Z=n.getEntitySet())===null||Z===void 0?void 0:Z.annotations;if(!i.isSingleton(n.getEntitySet())){var ee,te;m=e===null||e===void 0?void 0:(ee=e.Capabilities)===null||ee===void 0?void 0:(te=ee.FilterRestrictions)===null||te===void 0?void 0:te.RequiredProperties}}let A=[];if((j=m)!==null&&j!==void 0&&j.length){m.forEach(function(e){A.push(e.value)})}A=A.concat(h);a.requiredProperties=A;if((Q=a.requiredProperties)!==null&&Q!==void 0&&Q.length){if(!a.inParameters||!a.inParameters.length){if(!a.selectionVariantAnnotation){a.showOverlayInitially=true}else{var oe,ie,ne,le;let e=((oe=p)===null||oe===void 0?void 0:(ie=oe.SelectOptions)===null||ie===void 0?void 0:ie.map(e=>e.PropertyName.value))||[];const t=((ne=p)===null||ne===void 0?void 0:(le=ne.Parameters)===null||le===void 0?void 0:le.map(e=>e.PropertyName.value))||[];e=e.concat(t);A=A.sort();e=e.sort();a.showOverlayInitially=A.some(function(t){return e.indexOf(t)===-1})}}else{a.showOverlayInitially=false}}else{a.showOverlayInitially=false}const E=(k=f)===null||k===void 0?void 0:(_=k.$target)===null||_===void 0?void 0:(z=_.Dimensions[0])===null||z===void 0?void 0:(B=z.$target)===null||B===void 0?void 0:B.type;if(!(E==="Edm.DateTimeOffset"||E==="Edm.Date"||E==="Edm.TimeOfDay")&&f.$target.ChartType==="UI.ChartType/Line"){a.renderLineChart=false}else{a.renderLineChart=true}}}else{t.getDiagnostics().addIssue(c.Annotation,g.High,u.MALFORMED_VISUALFILTERS.CHART)}}else{t.getDiagnostics().addIssue(c.Annotation,g.High,u.MALFORMED_VISUALFILTERS.PRESENTATIONVARIANT)}}else{t.getDiagnostics().addIssue(c.Annotation,g.High,u.MALFORMED_VISUALFILTERS.VALUELIST)}}else{t.getDiagnostics().addIssue(c.Manifest,g.High,u.MALFORMED_VISUALFILTERS.VALUELIST)}return a}a.getVisualFilters=P;return a},false);
//# sourceMappingURL=VisualFilters.js.map