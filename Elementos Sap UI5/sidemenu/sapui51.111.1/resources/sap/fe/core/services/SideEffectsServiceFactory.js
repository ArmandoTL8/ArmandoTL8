/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/converters/MetaModelConverter","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","../templating/PropertyHelper"],function(t,e,i,r,o){"use strict";var n={};var s=o.isPathExpression;var a=e.convertTypes;function c(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;f(t,e)}function f(t,e){f=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,i){e.__proto__=i;return e};return f(t,e)}let u=function(e){c(i,e);function i(){return e.apply(this,arguments)||this}n.SideEffectsService=i;var r=i.prototype;r.init=function t(){this._oSideEffectsType={oData:{entities:{},actions:{}},control:{}};this._bInitialized=false;this.initPromise=Promise.resolve(this)};r.addControlSideEffects=function t(e,i){if(i.sourceControlId){const t={...i,fullyQualifiedName:`${e}/SideEffectsForControl/${i.sourceControlId}`};const r=this._oSideEffectsType.control[e]||{};r[t.sourceControlId]=t;this._oSideEffectsType.control[e]=r}};r.executeAction=function t(e,i,r){const o=i.getModel().bindContext(`${e}(...)`,i);return o.execute(r||i.getBinding().getUpdateGroupId())};r.getConvertedMetaModel=function t(){const e=this.getContext();const i=e.scopeObject;const r=i.getModel().getMetaModel();return a(r,this._oCapabilities)};r.getEntityTypeFromContext=function t(e){const i=e.getModel().getMetaModel(),r=i.getMetaPath(e.getPath()),o=i.getObject(r)["$Type"];return o};r.getODataEntitySideEffects=function t(e){return this._oSideEffectsType.oData.entities[e]||{}};r.getGlobalODataEntitySideEffects=function t(e){const i=this.getODataEntitySideEffects(e);const r=[];for(const t in i){const e=i[t];if(!e.SourceEntities&&!e.SourceProperties){r.push(e)}}return r};r.getODataActionSideEffects=function t(e,i){if(i){const t=this.getEntityTypeFromContext(i);if(t){var r;return(r=this._oSideEffectsType.oData.actions[t])===null||r===void 0?void 0:r[e]}}return undefined};r.initializeSideEffects=function t(e){this._oCapabilities=e;if(!this._bInitialized){const t=this.getConvertedMetaModel();t.entityTypes.forEach(t=>{this._oSideEffectsType.oData.entities[t.fullyQualifiedName]=this._retrieveODataEntitySideEffects(t);this._oSideEffectsType.oData.actions[t.fullyQualifiedName]=this._retrieveODataActionsSideEffects(t)});this._bInitialized=true}};r.removeControlSideEffects=function t(e){Object.keys(this._oSideEffectsType.control).forEach(t=>{if(this._oSideEffectsType.control[t][e]){delete this._oSideEffectsType.control[t][e]}})};r.requestSideEffects=async function t(e,i,r){this._logRequest(e,i);return i.requestSideEffects(e,r)};r.requestSideEffectsForODataAction=function t(e,i){var r,o;let n;if((r=e.triggerActions)!==null&&r!==void 0&&r.length){n=e.triggerActions.map(t=>this.executeAction(t,i))}else{n=[]}if((o=e.pathExpressions)!==null&&o!==void 0&&o.length){n.push(this.requestSideEffects(e.pathExpressions,i))}return n.length?Promise.all(n):Promise.resolve()};r.requestSideEffectsForNavigationProperty=function e(i,r){const o=this.getEntityTypeFromContext(r);if(o){const e=`${i}/`;const n=this.getODataEntitySideEffects(o);let s=[];let a=[];let c=[];Object.keys(n).filter(t=>{const r=n[t];return(r.SourceProperties||[]).some(t=>{const i=t.value;return i.startsWith(e)&&i.replace(e,"").indexOf("/")===-1})||(r.SourceEntities||[]).some(t=>t.value===i)}).forEach(t=>{const e=n[t];if(e.TriggerAction){this.executeAction(e.TriggerAction,r)}s=s.concat(e.TargetProperties);a=a.concat(e.TargetEntities)});const f=this._removeDuplicateTargets(s,a);c=[...f.TargetProperties,...f.TargetEntities];if(c.length>0){return this.requestSideEffects(c,r).catch(e=>t.error(`SideEffects - Error while processing SideEffects for Navigation Property ${i}`,e))}}return Promise.resolve()};r.getControlEntitySideEffects=function t(e){return this._oSideEffectsType.control[e]||{}};r._addRequiredTextProperties=function e(i,r){const o=i.TargetProperties,n=i.TargetEntities.map(t=>t.$NavigationPropertyPath);let a=[];o.forEach(e=>{var i;const o=e.endsWith("*"),s=e.substring(0,e.lastIndexOf("/")),c=s?`${s}/`:"",f=r.resolvePath(s)||r;const u=f.entityProperties||((i=f.targetType)===null||i===void 0?void 0:i.properties)||f.targetType.entityProperties;if(u){if(o){n.push(s);a=a.concat(u.map(t=>({navigationPath:c,property:t})))}else{a.push({property:u.find(t=>t.name===e.split("/").pop()),navigationPath:c})}}else{t.info(`SideEffects - The entity type associated to property path ${e} cannot be resolved`)}});a.forEach(t=>{var e,a,c;const f=(e=t.property)===null||e===void 0?void 0:(a=e.annotations)===null||a===void 0?void 0:(c=a.Common)===null||c===void 0?void 0:c.Text;if(f&&s(f)){const e=f.path,s=t.navigationPath+e,a=s.substring(0,s.lastIndexOf("/"));if(e&&n.indexOf(a)===-1&&o.indexOf(s)===-1){var u;if(e.lastIndexOf("/")>-1&&((u=r.resolvePath(a))===null||u===void 0?void 0:u._type)==="NavigationProperty"){i.TargetEntities.push({$NavigationPropertyPath:a});n.push(a)}else{i.TargetProperties.push(s)}}}});return i};r._convertSideEffects=function t(e,i,r){const o=this._removeBindingParameter(this._convertTargetsFormat(e),r);return this._addRequiredTextProperties(o,i)};r._convertTargetsFormat=function e(i){const r=(i.TargetProperties||[]).reduce((e,r)=>{const o=r.type&&r.value||r;if(o){e.push(o)}else{t.error(`SideEffects - Error while processing TargetProperties for SideEffects${i.fullyQualifiedName}`)}return e},[]),o=(i.TargetEntities||[]).map(t=>({$NavigationPropertyPath:t.value||""}));return{...i,...{TargetProperties:r,TargetEntities:o}}};r._getSideEffectsFromSource=function t(e){const i=[];const r=e._type==="EntityType"?e:e.sourceEntityType;if(r){var o;const t=((o=e.annotations)===null||o===void 0?void 0:o.Common)||{};const n=(e.parameters||[]).find(t=>t.type===r.fullyQualifiedName);const s=n?n.fullyQualifiedName.split("/")[1]:"";Object.keys(t).filter(e=>t[e].$Type==="com.sap.vocabularies.Common.v1.SideEffectsType").forEach(e=>{i.push(this._convertSideEffects(t[e],r,s))})}return i};r._logRequest=function e(i,r){const o=i.reduce(function(t,e){return`${t}\n\t\t${e.$NavigationPropertyPath||e||""}`},"");t.debug(`SideEffects - Request:\n\tContext path : ${r.getPath()}\n\tProperty paths :${o}`)};r._removeBindingParameter=function t(e,i){if(i){const t=function(t){return t.replace(new RegExp(`^${i}/?`),"")};e.TargetProperties=e.TargetProperties.map(e=>t(e));e.TargetEntities=e.TargetEntities.map(e=>({$NavigationPropertyPath:t(e.$NavigationPropertyPath)}))}return e};r._removeDuplicateTargets=function t(e,i){const r=new Set([]);const o=new Set(e);const n=i.filter(t=>{const e=t.$NavigationPropertyPath;if(!r.has(e)){r.add(e);return true}return false});return{TargetProperties:Array.from(o),TargetEntities:n}};r._retrieveODataActionsSideEffects=function t(e){const i={};const r=e.actions;if(r){Object.keys(r).forEach(t=>{const r=e.actions[t];const o=new Set;let n=[];let s=[];this._getSideEffectsFromSource(r).forEach(t=>{const e=t.TriggerAction;n=n.concat(t.TargetProperties);s=s.concat(t.TargetEntities);if(e){o.add(e)}});const a=this._removeDuplicateTargets(n,s);i[t]={pathExpressions:[...a.TargetProperties,...a.TargetEntities],triggerActions:Array.from(o)}})}return i};r._retrieveODataEntitySideEffects=function t(e){const i={};this._getSideEffectsFromSource(e).forEach(t=>{i[t.fullyQualifiedName]=t});return i};r.getInterface=function t(){return this};return i}(i);n.SideEffectsService=u;let p=function(t){c(e,t);function e(){return t.apply(this,arguments)||this}var i=e.prototype;i.createInstance=function t(e){const i=new u(e);return i.initPromise};return e}(r);return p},false);
//# sourceMappingURL=SideEffectsServiceFactory.js.map