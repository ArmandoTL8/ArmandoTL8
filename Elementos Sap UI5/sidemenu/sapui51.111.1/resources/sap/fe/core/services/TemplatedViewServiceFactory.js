/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/UriParameters","sap/fe/core/helpers/LoaderUtils","sap/fe/core/TemplateModel","sap/ui/core/Component","sap/ui/core/mvc/View","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/Device","sap/ui/model/base/ManagedObjectModel","sap/ui/model/json/JSONModel","sap/ui/VersionInfo","../helpers/DynamicAnnotationPathHelper"],function(e,t,n,o,i,r,s,a,c,l,u,p,g,d){"use strict";var f=d.resolveDynamicExpression;var h=n.requireDependencies;function v(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;m(e,t)}function m(e,t){m=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,n){t.__proto__=n;return t};return m(e,t)}let w=function(n){v(s,n);function s(){return n.apply(this,arguments)||this}var a=s.prototype;a.init=function e(){const t=[];const n=this.getContext();const o=n.scopeObject;const r=i.getOwnerComponentFor(o);const s=r.getMetaModel();const a=`${r.getMetadata().getComponentName()}::${r.getLocalId(o.getId())}`;const l=o.getEnhanceI18n()||[];let u;this.oFactory=n.factory;if(l){u=r.getMetadata().getComponentName();for(let e=0;e<l.length;e++){const t=r.getModel(l[e]);if(t&&t.isA("sap.ui.model.resource.ResourceModel")){l[e]=t}else{l[e]=`${u}.${l[e].replace(".properties","")}`}}}const p=`${r.getMetadata().getName()}_${a}_${sap.ui.getCore().getConfiguration().getLanguageTag()}`;t.push(c.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:o,settings:{bundles:["sap.fe.core.messagebundle","sap.fe.macros.messagebundle","sap.fe.templates.messagebundle"],enhanceI18n:l,modelName:"sap.fe.i18n"}}).then(e=>{this.oResourceModelService=e;return e.getResourceModel()}));t.push(c.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:s,appComponent:r,component:o}}).then(e=>{this.oCacheHandlerService=e;return e.validateCacheKey(p,o)}));t.push(g.load().then(function(e){let t="";if(!e.libraries){t=sap.ui.buildinfo.buildtime}else{e.libraries.forEach(function(e){t+=e.buildTimestamp})}return t}).catch(function(){return"<NOVALUE>"}));this.initPromise=Promise.all(t).then(async e=>{const t=e[0];const n=e[1];const o=r.getSideEffectsService();o.initializeSideEffects(r.getEnvironmentCapabilities().getCapabilities());const[i,s]=await h(["sap/fe/core/converters/TemplateConverter","sap/fe/core/converters/MetaModelConverter"]);return this.createView(t,a,n,i,s)}).then(function(e){const t=c.get("sap.fe.core.services.CacheHandlerService").getInstance(s);t.invalidateIfNeeded(e,p,o)})};a.refreshView=function t(n){const o=n.getRootControl();if(o){o.destroy()}else if(this.oView){this.oView.destroy()}return this.createView(this.resourceModel,this.stableId,"",this.TemplateConverter,this.MetaModelConverter).then(function(){n.oContainer.invalidate()}).catch(function(t){n.oContainer.invalidate();e.error(t)})};a.createView=async function n(s,a,c,g,d){this.resourceModel=s;this.stableId=a;this.TemplateConverter=g;this.MetaModelConverter=d;const h=this.getContext();const v=h.settings;const m=v.converterType;const w=h.scopeObject;const C=i.getOwnerComponentFor(w);const b=C.getRoutingService().getTargetInformationFor(w).options.settings.fullContextPath;const y=C.getMetaModel();const M=C.getManifest();const V=new p(l).setDefaultBindingMode("OneWay");const O=new p(M);const x=false;let S,D,I,N;function j(){const e=b.split("/");const t=e.reduce(function(e,t){if(t===""){return e}if(e===""){e=`/${t}`}else{const n=y.getObject(`${e}/$NavigationPropertyBinding/${t}`);if(n&&Object.keys(n).length>0){e+="/$NavigationPropertyBinding"}e+=`/${t}`}return e},"");let n=v.viewType||w.getViewType()||"XML";if(n!=="XML"){n=undefined}return{type:n,preprocessors:{xml:{bindingContexts:{entitySet:t?y.createBindingContext(t):null,fullContextPath:b?y.createBindingContext(b):null,contextPath:b?y.createBindingContext(b):null,converterContext:S.createBindingContext("/",undefined,{noResolve:true}),viewData:N?D.createBindingContext("/"):null},models:{entitySet:y,fullContextPath:y,contextPath:y,"sap.fe.i18n":s,metaModel:y,device:V,manifest:O,converterContext:S,viewData:D},appComponent:C}},id:a,viewName:v.viewName||w.getViewName(),viewData:N,cache:{keys:[c],additionalData:{getAdditionalCacheData:()=>S.getData(),setAdditionalCacheData:e=>{S.setData(e)}}},models:{"sap.fe.i18n":s},height:"100%"}}const P=t=>{e.error(t.message,t);I.viewName=v.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage";I.preprocessors.xml.models["error"]=new p(t);return w.runAsOwner(()=>r.create(I).then(e=>{this.oView=e;this.oView.setModel(new u(this.oView),"$view");w.setAggregation("rootControl",this.oView);return c}))};try{var T;const n=await C.getService("routingService");const i=n.getTargetInformationFor(w);const h=M["sap.app"]&&M["sap.app"].crossNavigation&&M["sap.app"].crossNavigation.outbounds||{};const v=w.getNavigation()||{};Object.keys(v).forEach(function(e){const t=v[e];let n;if(t.detail&&t.detail.outbound&&h[t.detail.outbound]){n=h[t.detail.outbound];t.detail.outboundDetail={semanticObject:n.semanticObject,action:n.action,parameters:n.parameters}}if(t.create&&t.create.outbound&&h[t.create.outbound]){n=h[t.create.outbound];t.create.outboundDetail={semanticObject:n.semanticObject,action:n.action,parameters:n.parameters}}});N={navigation:v,viewLevel:i.viewLevel,stableId:a,contentDensities:(T=M["sap.ui5"])===null||T===void 0?void 0:T.contentDensities,resourceBundle:s.__bundle,fullContextPath:b,isDesktop:l.system.desktop,isPhone:l.system.phone};if(w.getViewData){Object.assign(N,w.getViewData())}const V=C.getShellServices();N.converterType=m;N.shellContentDensity=V.getContentDensity();N.useNewLazyLoading=t.fromQuery(window.location.search).get("sap-fe-xx-lazyloadingtest")==="true";N.retrieveTextFromValueList=M["sap.fe"]&&M["sap.fe"].form?M["sap.fe"].form.retrieveTextFromValueList:undefined;D=new p(N);if(N.controlConfiguration){for(const e in N.controlConfiguration){if(e.indexOf("[")!==-1){const t=f(e,y);N.controlConfiguration[t]=N.controlConfiguration[e]}}}d.convertTypes(y,C.getEnvironmentCapabilities().getCapabilities());S=new o(()=>{try{const t=C.getDiagnostics();const n=t.getIssues().length;const o=g.convertPage(m,y,N,t,b,C.getEnvironmentCapabilities().getCapabilities(),w);const i=t.getIssues();const r=i.slice(n);if(r.length>0){e.warning("Some issues have been detected in your project, please check the UI5 support assistant rule for sap.fe.core")}return o}catch(t){e.error(t,t);return{}}},y);if(!x){I=j();w.setModel(S,"_pageModel");return w.runAsOwner(()=>r.create(I).catch(P).then(e=>{this.oView=e;this.oView.setModel(new u(this.oView),"$view");this.oView.setModel(D,"viewData");w.setAggregation("rootControl",this.oView);return c}).catch(t=>e.error(t.message,t)))}}catch(t){e.error(t.message,t);throw new Error(`Error while creating view : ${t}`)}};a.getView=function e(){return this.oView};a.getInterface=function e(){return this};a.exit=function e(){if(this.oResourceModelService){this.oResourceModelService.destroy()}if(this.oCacheHandlerService){this.oCacheHandlerService.destroy()}this.oFactory.removeGlobalInstance()};return s}(s);let C=function(e){v(t,e);function t(){var t;for(var n=arguments.length,o=new Array(n),i=0;i<n;i++){o[i]=arguments[i]}t=e.call(this,...o)||this;t._oInstanceRegistry={};return t}var n=t.prototype;n.createInstance=function e(n){t.iCreatingViews++;const o=new w(Object.assign({factory:this},n));return o.initPromise.then(function(){t.iCreatingViews--;return o})};n.removeGlobalInstance=function e(){this._oInstanceRegistry={}};t.getNumberOfViewsInCreationState=function e(){return t.iCreatingViews};return t}(a);return C},false);
//# sourceMappingURL=TemplatedViewServiceFactory.js.map