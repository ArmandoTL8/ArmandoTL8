/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/controllerextensions/editFlow/operations","sap/fe/core/controllerextensions/editFlow/sticky","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/helpers/DeleteHelper","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/m/MessageToast","sap/m/Popover","sap/m/Text","sap/m/VBox","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/library","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/model/json/JSONModel","../../helpers/ToES6Promise"],function(e,t,n,o,a,s,r,i,l,c,d,u,g,f,p,C,h,m,b,y,w,x,A,E,T,D){"use strict";var P=d.generate;const M=u.CreationMode;const v=u.ProgrammingModel;const O=x.ValueState;function _(e){if(e&&e.getMetadata&&e.getMetadata().getName()==="sap.ui.base.Event"){e={}}return e||{}}let I=function(){function d(){}var I=d.prototype;I.busyLock=function e(t,o){n.lock(t.getModel("ui"),o)};I.busyUnlock=function e(t,o){n.unlock(t.getModel("ui"),o)};I.getProgrammingModel=function e(t){let n;if(t.isA("sap.ui.model.odata.v4.Context")){n=t.getPath()}else{n=(t.isRelative()?t.getResolvedPath():t.getPath())??""}const o=t.getModel().getMetaModel();if(c.isDraftSupported(o,n)){return v.Draft}else if(c.isStickySessionSupported(o)){return v.Sticky}else{return v.NonDraft}};I.validateDocument=function e(t,n,o){const a=n&&n.customValidationFunction;if(a){const e=a.substring(0,a.lastIndexOf(".")||-1).replace(/\./gi,"/"),s=a.substring(a.lastIndexOf(".")+1,a.length),r=n.data;delete r["@$ui5.context.isTransient"];return l.validationWrapper(e,s,r,o,t)}return Promise.resolve([])};I.createDocument=async function n(o,s,r,i,l,d){const g=o.getModel(),f=g.getMetaModel(),p=f.getMetaPath(o.getHeaderContext().getPath()),C=r.getRouterProxy().getHash(),h=r.getComponentData(),m=h&&h.startupParameters||{},b=!o.isRelative()?this._getNewAction(m,C,f,p):undefined;const w={$$patchWithoutSideEffects:true};const x=f.getObject(`${p}/@com.sap.vocabularies.Common.v1.Messages/$Path`);let A="/busy";let E=f.getObject(`${p}@com.sap.vocabularies.Common.v1.DefaultValuesFunction`)||f.getObject(`${c.getTargetEntitySet(f.getContext(p))}@com.sap.vocabularies.Common.v1.DefaultValuesFunction`);let T;let P;if(E){if(f.getObject(`${p}@com.sap.vocabularies.Common.v1.DefaultValuesFunction`)&&c.getTargetEntitySet(f.getContext(p))!==p){T=true}else{T=false}}if(x){w["$select"]=x}const O=_(s);if(!o){throw new Error("Binding required for new document creation")}const I=this.getProgrammingModel(o);if(I!==v.Draft&&I!==v.Sticky){throw new Error("Create document only allowed for draft or sticky session supported services")}if(O.busyMode==="Local"){A=`/busyLocal/${O.busyId}`}O.beforeCreateCallBack=l?null:O.beforeCreateCallBack;this.busyLock(r,A);const S=y.getLibraryResourceBundle("sap.fe.core");let B;try{if(b){B=await this.callAction(b,{contexts:o.getHeaderContext(),showActionParameterDialog:true,label:this._getSpecificCreateActionDialogLabel(f,p,b,S),bindingParameters:w,parentControl:O.parentControl,bIsCreateAction:true,skipParameterDialog:O.skipParameterDialog},null,r,i)}else{const n=O.creationMode!==M.CreationRow&&O.creationMode!==M.Inline;const s=n?t.getNonComputedVisibleFields(f,p,d):[];E=l?null:E;let c,u;if(E){if(T){c=o.getContext()&&`${f.getMetaPath(o.getContext().getPath())}/${E}`;u=o.getContext()}else{c=o.getHeaderContext()&&`${f.getMetaPath(o.getHeaderContext().getPath())}/${E}`;u=o.getHeaderContext()}}const C=c&&f.createBindingContext(c);try{let t;try{const e=C&&C.getObject()&&C.getObject()[0].$IsBound?await a.callBoundFunction(E,u,g):await a.callFunctionImport(E,g);if(e){t=e.getObject()}}catch(t){e.error(`Error while executing the function ${E}`,t);throw t}O.data=t?Object.assign({},t,O.data):O.data;if(O.data){delete O.data["@odata.context"]}if(s.length>0){B=await this._launchDialogWithKeyFields(o,s,g,O,r,i);P=B.newContext}else{if(O.beforeCreateCallBack){await D(O.beforeCreateCallBack({contextPath:o&&o.getPath()}))}P=o.create(O.data,true,O.createAtEnd,O.inactive);if(!O.inactive){B=await this.onAfterCreateCompletion(o,P,O)}}}catch(t){e.error("Error while creating the new document",t);throw t}}P=P||B;await i.showMessageDialog({control:O.parentControl});return P}catch(e){var N;await i.showMessageDialog({control:O.parentControl});if((e===u.Constants.ActionExecutionFailed||e===u.Constants.CancelActionDialog)&&(N=P)!==null&&N!==void 0&&N.isTransient()){P.delete("$direct")}throw e}finally{this.busyUnlock(r,A)}};I._isDraftEnabled=function e(t){const n=t[0];const o=this.getProgrammingModel(n);return o===v.Draft};I.deleteDocument=function e(n,o,a,s,l){const c=y.getLibraryResourceBundle("sap.fe.core");let d;this.busyLock(a);const u=Array.isArray(n)?[...n]:[n];return new Promise((e,n)=>{try{const C=this._isDraftEnabled(o.selectedContexts||u);const h=[];const m=[];if(o){if(!o.numberOfSelectedContexts){if(C){const e=u.find(e=>{const t=e.getObject();return t.IsActiveEntity===true&&t.HasDraftEntity===true&&t.DraftAdministrativeData&&t.DraftAdministrativeData.InProcessByUser&&!t.DraftAdministrativeData.DraftIsCreatedByMe});if(e){const o=e.getObject().DraftAdministrativeData.InProcessByUser;p.show(t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_SINGLE_OBJECT_LOCKED",s,[o]),{title:c.getText("C_COMMON_DELETE"),onClose:n});return}}o=_(o);let e="";if(o.title){if(o.description){d=[o.title+" ",o.description]}else{d=[o.title,""]}e=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO",s,d,o.entitySetName)}else{e=t.getTranslatedText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",s,undefined,o.entitySetName)}m.push({type:"deletableContexts",contexts:u,text:e,selected:true,control:"text"})}else{let e=u.length;if(C){e+=o.draftsWithNonDeletableActive.length+o.draftsWithDeletableActive.length+o.unSavedContexts.length+o.createModeContexts.length;i.updateDraftOptionsForDeletableTexts(o,u,e,s,h,m)}i.updateOptionsForDeletableTexts(o,u,s,m)}}i.updateContentForDeleteDialog(m,h);const y=new b({items:h});const w=c.getText("C_COMMON_DELETE");const x=async()=>{this.busyLock(a);try{await i.deleteConfirmHandler(m,o,l,s,a,C);e()}catch(e){n()}finally{this.busyUnlock(a)}};let A=false;const E=new f({title:w,state:"Warning",content:[y],ariaLabelledBy:h,beginButton:new g({text:c.getText("C_COMMON_DELETE"),type:"Emphasized",press:function(){r.removeBoundTransitionMessages();A=true;E.close();x()}}),endButton:new g({text:t.getTranslatedText("C_COMMON_DIALOG_CANCEL",s),press:function(){E.close()}}),afterClose:function(){E.destroy();if(!A){n()}}});if(o.noDialog){x()}else{E.addStyleClass("sapUiContentPadding");E.open()}}finally{this.busyUnlock(a)}})};I.editDocument=async function e(t,n,a,r){const i=this.getProgrammingModel(t);if(!t){throw new Error("Binding context to active document is required")}if(i!==v.Draft&&i!==v.Sticky){throw new Error("Edit is only allowed for draft or sticky session supported services")}this.busyLock(a);r.removeTransitionMessages();try{const e=i===v.Draft?await o.createDraftFromActiveDocument(t,a,{bPreserveChanges:true,oView:n}):await s.editDocumentInStickySession(t,a);await r.showMessageDialog();return e}catch(e){await r.showMessages({concurrentEditFlag:true});throw e}finally{this.busyUnlock(a)}};I.cancelDocument=async function e(t,n,a,r,i,l,c){if(!t){throw new Error("No context exists. Pass a meaningful context")}this.busyLock(a);const d=_(n);const u=t.getModel();const g=this.getProgrammingModel(t);if(g!==v.Draft&&g!==v.Sticky){throw new Error("Cancel document only allowed for draft or sticky session supported services")}try{let e=false;if(g===v.Draft&&!c){const e=u.bindContext(`${t.getPath()}/DraftAdministrativeData`).getBoundContext();const n=await e.requestObject();if(n){c=n.CreationDateTime!==n.LastChangeDateTime}}if(!d.skipDiscardPopover){await this._confirmDiscard(d.cancelButton,c,r)}if(t.isKeepAlive()){t.setKeepAlive(false)}if(d.beforeCancelCallBack){await d.beforeCancelCallBack({context:t})}if(g===v.Draft){if(l){if(t.hasPendingChanges()){t.getBinding().resetChanges()}e=await o.deleteDraft(t,a)}else{const n=u.bindContext(`${t.getPath()}/SiblingEntity`).getBoundContext();try{const s=await n.requestCanonicalPath();if(t.hasPendingChanges()){t.getBinding().resetChanges()}e=u.bindContext(s).getBoundContext()}finally{await o.deleteDraft(t,a)}}}else{const n=await s.discardDocument(t);if(n){if(n.hasPendingChanges()){n.getBinding().resetChanges()}if(!l){n.refresh();e=n}}}i.removeTransitionMessages();await i.showMessages();return e}catch(e){await i.showMessages();throw e}finally{this.busyUnlock(a)}};I.saveDocument=async function e(n,a,i,l,c,d,u){const g=this.getProgrammingModel(n);if(g!==v.Sticky&&g!==v.Draft){throw new Error("Save is only allowed for draft or sticky session supported services")}d.removeTransitionMessages();try{this.busyLock(a);const e=g===v.Draft?await o.activateDocument(n,a,{},d):await s.activateDocument(n,a);const l=r.getMessages().concat(r.getMessages(true,true));if(!(l.length===1&&l[0].type===x.MessageType.Success)){C.show(u?t.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_CREATED",i):t.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_SAVED",i))}return e}catch(e){if(l&&(c===null||c===void 0?void 0:c.length)>0){c.forEach(e=>{if(!t.hasTransientContext(e)){a.getSideEffectsService().requestSideEffectsForNavigationProperty(e.getPath(),n)}})}await d.showMessages();throw e}finally{this.busyUnlock(a)}};I.callAction=async function e(t,n,o,s,r){n=_(n);let i,l;const c=n.bindingParameters;if(!t){throw new Error("Provide name of action to be executed")}const d=t.split("/")[1];t=d||t;i=d?undefined:n.contexts;if(i&&(Array.isArray(i)&&i.length||!Array.isArray(i))){i=Array.isArray(i)?i[0]:i;l=i.getModel()}if(n.model){l=n.model}if(!l){throw new Error("Pass a context for a bound action or pass the model for an unbound action")}const u=s.getSideEffectsService().getODataActionSideEffects(t,i)||{};const g=()=>{if(!n.notApplicableContext||n.notApplicableContext.length===0){return Promise.resolve(n.contexts)}return new Promise(async(e,t)=>{const o=function(e){let t;const o=n.notApplicableContext.length,a=[];for(let e=0;e<n.notApplicableContext.length;e++){t=n.notApplicableContext[e].getObject();a.push(t)}const s=new T(a);const r=new T({total:o,label:n.label});e.setModel(s,"notApplicable");e.setModel(r,"totals");e.open()};const a="sap.fe.core.controls.ActionPartial";const s=E.loadTemplate(a,"fragment");const r=l.getMetaModel();const i=n.contexts[0].getCanonicalPath();const c=`${i.substr(0,i.indexOf("("))}/`;const d=new T({title:n.label});try{const t=await A.process(s,{name:a},{bindingContexts:{entityType:r.createBindingContext(c),label:d.createBindingContext("/")},models:{entityType:r,metaModel:r,label:d}});let i;const l={onClose:function(){i.close();e()},onContinue:function(){i.close();e(n.applicableContext)}};i=await w.load({definition:t,controller:l});l.onClose=function(){i.close();e()};l.onContinue=function(){i.close();e(n.applicableContext)};n.parentControl.addDependent(i);o(i)}catch(e){t(e)}})};try{let e;if(i&&l){const o=await g();if(o){e=await a.callBoundAction(t,o,l,s,{parameterValues:n.parameterValues,invocationGrouping:n.invocationGrouping,label:n.label,skipParameterDialog:n.skipParameterDialog,mBindingParameters:c,entitySetName:n.entitySetName,additionalSideEffect:u,onSubmitted:()=>{r.removeTransitionMessages();this.busyLock(s)},onResponse:()=>{this.busyUnlock(s)},parentControl:n.parentControl,controlId:n.controlId,internalModelContext:n.internalModelContext,operationAvailableMap:n.operationAvailableMap,bIsCreateAction:n.bIsCreateAction,bGetBoundContext:n.bGetBoundContext,bObjectPage:n.bObjectPage,messageHandler:r,defaultValuesExtensionFunction:n.defaultValuesExtensionFunction,selectedItems:n.contexts})}else{e=null}}else{e=await a.callActionImport(t,l,s,{parameterValues:n.parameterValues,label:n.label,skipParameterDialog:n.skipParameterDialog,bindingParameters:c,entitySetName:n.entitySetName,onSubmitted:()=>{this.busyLock(s)},onResponse:()=>{this.busyUnlock(s)},parentControl:n.parentControl,internalModelContext:n.internalModelContext,operationAvailableMap:n.operationAvailableMap,messageHandler:r,bObjectPage:n.bObjectPage})}await this._handleActionResponse(r,n,t);return e}catch(e){await this._handleActionResponse(r,n,t);throw e}};I._handleActionResponse=function e(t,n,o){const a=r.getMessages(true,true);const s=n.label?n.label:o;if(a.length>0&&n&&n.internalModelContext){n.internalModelContext.setProperty("sActionName",n.label?n.label:o)}let i;if(n.controlId){i=n.parentControl.byId(n.controlId)}else{i=n.parentControl}return t.showMessages({sActionName:s,control:i})};I.handleValidationError=function e(){const t=y.getMessageManager(),n=t.getMessageModel().getData().filter(function(e){if(e.validation){return e}});t.removeMessages(n)};I._createPopover=function e(t){return new h(t)};I._confirmDiscard=function e(n,o,a){if(!o){this.handleValidationError();return Promise.resolve()}n.setEnabled(false);return new Promise((e,o)=>{const s=this._createPopover({showHeader:false,placement:"Top"});s.addStyleClass("sapUiContentPadding");const r=new m({text:t.getTranslatedText("C_TRANSACTION_HELPER_DRAFT_DISCARD_MESSAGE",a)});const i=new g({text:t.getTranslatedText("C_TRANSACTION_HELPER_DRAFT_DISCARD_BUTTON",a),width:"100%",press:()=>{this.handleValidationError();s.data("continueDiscard",true);s.close()},ariaLabelledBy:[r]});s.addContent(new b({items:[r,i]}));s.attachBeforeOpen(()=>{s.setInitialFocus(i)});s.attachAfterClose(()=>{n.setEnabled(true);if(s.data("continueDiscard")){e()}else{o()}});s.openBy(n,false)})};I._onFieldChange=function e(t,n,o,a){o.removeTransitionMessages();const s=t.getSource();const r=t.getParameter("promise");if(r){return r.then(function(e){s.setValue(e);a();return s.getValue()}).catch(function(e){if(e!==""){n.setEnabled(false)}else{s.setValue(e);a()}})}};I._launchDialogWithKeyFields=function e(o,a,s,r,i,l){let c;const d=r.parentControl;const g=s.bindList(o.getPath(),o.getContext(),[],[],{$$updateGroupId:"submitLater"});g.refreshInternal=function(){};const p=g.create(r.data,true);return new Promise(async(e,C)=>{const h="sap/fe/core/controls/NonComputedVisibleKeyFieldsDialog";const m=E.loadTemplate(h,"fragment"),b=d.getController().oResourceBundle,y=s.getMetaModel(),x=[],M=o.isRelative()?o.getResolvedPath():o.getPath(),v=y.createBindingContext(M),_=y.getMetaPath(M);for(const e in a){x.push(y.createBindingContext(`${_}/${a[e]}`))}const I=new T(x);const S=I.createBindingContext("/");const B=t.getRequiredPropertiesFromInsertRestrictions(_,y);const N=new T(B);const R=N.createBindingContext("/");const k=await A.process(m,{name:h},{bindingContexts:{entitySet:v,fields:S,requiredProperties:R},models:{entitySet:v.getModel(),fields:S.getModel(),metaModel:y,requiredProperties:N}});let L=[];const F={};let H;const $=async function(){let e=false;try{const t=await Promise.all(L.map(function(e){return e.getFields()[0]}).filter(function(e){return e.getRequired()||e.getValueState()===O.Error}).map(async function(e){const t=e.getId();if(t in F){try{const n=await F[t];return e.getValue()===""?undefined:n}catch(e){return undefined}}return e.getValue()===""?undefined:e.getValue()}));e=t.every(function(e){if(Array.isArray(e)){e=e[0]}return e!==undefined&&e!==null&&e!==""})}catch(t){e=false}H.setEnabled(e)};const j={handleChange:e=>{const t=e.getParameter("id");F[t]=this._onFieldChange(e,H,l,$)},handleLiveChange:e=>{const t=e.getParameter("id");const n=e.getParameter("value");F[t]=n;$()}};const U=await w.load({definition:k,controller:j});let V;const W=function(){if(V.error){C(V.error)}else{e(V.response)}c.close()};c=new f(P(["CreateDialog",_]),{title:t.getTranslatedText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE",b),content:[U],beginButton:{text:t.getTranslatedText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE_BUTTON",b),type:"Emphasized",press:async e=>{const t=e.getSource();t.setEnabled(false);n.lock(c);r.bIsCreateDialog=true;try{const e=await Promise.all(Object.keys(F).map(async function(e){const t=await F[e];const n={};n[e]=t;return n}));if(r.beforeCreateCallBack){await D(r.beforeCreateCallBack({contextPath:o&&o.getPath(),createParameters:e}))}const t=p.getObject();const a={};Object.keys(t).forEach(function(e){const n=y.getObject(`${_}/${e}`);if(n&&n.$kind==="NavigationProperty"){return}a[e]=t[e]});const s=o.create(a,true,r.createAtEnd,r.inactive);const i=this.onAfterCreateCompletion(o,s,r);let d=await i;if(!d||d&&d.bKeepDialogOpen!==true){d=d??{};c.setBindingContext(null);d.newContext=s;V={response:d};W()}}catch(e){if(e!==u.Constants.CreationFailed){V={error:e};W()}else{t.setEnabled(true)}}finally{n.unlock(c);l.showMessages()}}},endButton:{text:t.getTranslatedText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL",b),press:function(){V={error:u.Constants.CancelActionDialog};W()}},afterClose:function(){var e;(e=c.getBindingContext("internal"))===null||e===void 0?void 0:e.setProperty("isCreateDialogOpen",false);c.destroy();g.destroy()}});L=U===null||U===void 0?void 0:U.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");if(d&&d.addDependent){d.addDependent(c)}H=c.getBeginButton();c.setBindingContext(p);try{await t.setUserDefaults(i,x,p,false,r.createAction,r.data);$();c.getBindingContext("internal").setProperty("isCreateDialogOpen",true);c.open()}catch(e){await l.showMessages();throw e}})};I.onAfterCreateCompletion=function t(n,o,a){let s;const r=new Promise(e=>{s=e});const i=e=>{const t=e.getParameter("context"),a=e.getParameter("success");if(t===o){n.detachCreateCompleted(i,this);s(a)}};const l=()=>{o.created().then(undefined,function(){e.trace("transient creation context deleted")}).catch(function(t){e.trace("transient creation context deletion error",t)})};n.attachCreateCompleted(i,this);return r.then(e=>{if(!e){if(!a.keepTransientContextOnFailed){l();n.resetChanges();n.getModel().resetChanges(n.getUpdateGroupId());throw u.Constants.CreationFailed}return{bKeepDialogOpen:true}}else{return o.created()}})};I._getNewAction=function e(t,n,o,a){let s;if(t&&t.preferredMode&&n.toUpperCase().indexOf("I-ACTION=CREATEWITH")>-1){const e=t.preferredMode[0];s=e.toUpperCase().indexOf("CREATEWITH:")>-1?e.substr(e.lastIndexOf(":")+1):undefined}else if(t&&t.preferredMode&&n.toUpperCase().indexOf("I-ACTION=AUTOCREATEWITH")>-1){const e=t.preferredMode[0];s=e.toUpperCase().indexOf("AUTOCREATEWITH:")>-1?e.substr(e.lastIndexOf(":")+1):undefined}else{s=o&&o.getObject!==undefined?o.getObject(`${a}@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction`)||o.getObject(`${a}@com.sap.vocabularies.Common.v1.DraftRoot/NewAction`):undefined}return s};I._getSpecificCreateActionDialogLabel=function e(t,n,o,a){const s=function(){if(t&&t.getObject(`${n}/@com.sap.vocabularies.UI.v1.LineItem`)){const e=t.getObject(`${n}/@com.sap.vocabularies.UI.v1.LineItem`).findIndex(function(e){const t=e.Action?e.Action.split("("):undefined;return t?t[0]===o:false});return e>-1?t.getObject(`${n}/@com.sap.vocabularies.UI.v1.LineItem`)[e].Label:undefined}else{return undefined}};return s()||t&&t.getObject(`${n}/${o}@com.sap.vocabularies.Common.v1.Label`)||a&&a.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE")};return d}();const S=new I;return S},false);
//# sourceMappingURL=TransactionHelper.js.map