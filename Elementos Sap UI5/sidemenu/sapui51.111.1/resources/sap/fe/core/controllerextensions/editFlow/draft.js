/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/m/Text","sap/ui/core/Core","../../operationsHelper","./draftDataLossPopup"],function(e,t,n,o,r,a,i,s,c,u){"use strict";const d={EDIT:"EditAction",ACTIVATION:"ActivationAction",DISCARD:"DiscardAction",PREPARE:"PreparationAction"};function l(e,t){const n=e.getModel(),o=n.getMetaModel(),r=o.getMetaPath(e.getPath());return o.getObject(`${r}@com.sap.vocabularies.Common.v1.DraftRoot/${t}`)}function f(e,t,n){const o=l(e,t);return e.getModel().bindContext(`${o}(...)`,e,n)}function g(e,t){const n=e.getModel(),o=n.getMetaModel(),r=o.getMetaPath(e.getPath());return o.getObject(`${r}@com.sap.vocabularies.Common.v1.DraftRoot/${t}/$ReturnType`)}function h(e){return!!l(e,d.PREPARE)}async function E(e,n,o){if(e.getProperty("IsActiveEntity")){const r={$$inheritExpandSelect:true};const a=f(e,d.EDIT,r);a.setParameter("PreserveChanges",n);const i="direct";const s=await o.getModel("sap.fe.i18n").getResourceBundle();const u=t.getTranslatedText("C_COMMON_OBJECT_PAGE_EDIT",s);const l=a.execute(i,undefined,c.fnOnStrictHandlingFailed.bind(y,i,{label:u,model:e.getModel()},s,null,null,null,undefined,undefined),e.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding"));a.getModel().submitBatch(i);return await l}else{throw new Error("You cannot edit this draft document")}}async function m(t,n,o){if(y.getMessagesPath(t)&&y.hasPrepareAction(t)){try{const e=await y.executeDraftPreparationAction(t,t.getUpdateGroupId(),true,o);if(e&&!g(t,d.PREPARE)){D(t,n.getSideEffectsService())}return e}catch(t){e.error("Error while requesting messages",t)}}return undefined}async function p(n,o,r){const a=h(n);const i=a;if(!n.getProperty("IsActiveEntity")){const s=f(n,d.ACTIVATION,{$$inheritExpandSelect:true});const u=await o.getModel("sap.fe.i18n").getResourceBundle();const g=t.getTranslatedText("C_OP_OBJECT_PAGE_SAVE",u);try{return await s.execute(r,i,r?c.fnOnStrictHandlingFailed.bind(y,r,{label:g,model:n.getModel()},u,null,null,null,undefined,undefined):undefined,n.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding"))}catch(t){if(a){const t=l(n,d.PREPARE),r=o.getSideEffectsService(),a=r.getODataActionSideEffects(t,n),i=a&&a.pathExpressions;if(i&&i.length>0){try{await r.requestSideEffects(i,n)}catch(t){e.error("Error while requesting side effects",t)}}else{try{await D(n,r)}catch(t){e.error("Error while requesting messages",t)}}}throw t}}else{throw new Error("The activation action cannot be executed on an active document")}}function A(e){const t=e.getModel().getMetaModel();const n=t.getMetaPath(e.getPath());const o=g(e,d.PREPARE);return!!o?t.getObject(`${n}/@${"com.sap.vocabularies.Common.v1.Messages"}/$Path`):null}function P(t,n,o,r){if(!t.getProperty("IsActiveEntity")){const a=o?A(t):null;const i=f(t,d.PREPARE,a?{$select:a}:null);i.setParameter("SideEffectsQualifier","");const s=n||i.getGroupId();return i.execute(s,r).then(function(){return i}).catch(function(t){e.error("Error while executing the operation",t)})}else{throw new Error("The preparation action cannot be executed on an active document")}}function w(e){const t=e.getModel(),n=t.getMetaModel(),o=n.getMetaPath(e.getPath());return n.getObject(`${o}/@com.sap.vocabularies.Common.v1.Messages/$Path`)}function D(e,t){const n=y.getMessagesPath(e);if(n){return t.requestSideEffects([{$PropertyPath:n}],e)}return Promise.resolve()}async function C(e,n,o){if(!e.getProperty("IsActiveEntity")){const r=y.createOperation(e,d.DISCARD);const a=n&&await n.getModel("sap.fe.i18n").getResourceBundle()||null;const i="direct";const s=t.getTranslatedText("C_TRANSACTION_HELPER_DRAFT_DISCARD_BUTTON",a);const u=!o?r.execute(i):r.execute(i,undefined,c.fnOnStrictHandlingFailed.bind(y,i,{label:s,model:e.getModel()},a,null,null,null,undefined,undefined),false);e.getModel().submitBatch(i);return u}else{throw new Error("The discard action cannot be executed on an active document")}}async function x(t,n){if(!n.getPath().startsWith(t.getPath())){e.error("Cannot compute rightmost sibling context");throw new Error("Cannot compute rightmost sibling context")}const o=t.getModel();try{const e=n.getPath().replace(t.getPath(),"");const r=e?e.substring(1).split("/"):[];r.unshift(t.getPath().substring(1));const a=[];const i=[];let s="";const c=r.map(e=>{s+=`/${e}`;a.unshift(s);if(s.endsWith(")")){const e=o.bindContext(`${s}/SiblingEntity`).getBoundContext();return e.requestCanonicalPath()}else{return Promise.resolve(undefined)}});const u=await Promise.all(c);let d="";u.forEach((e,t)=>{if(t!==0){if(r[t].endsWith(")")){const n=r[t].replace(/\(.*$/,"");const o=e.replace(/.*\(/,"(");d+=`/${n}${o}`}else{d+=`/${r[t]}`}}else{d=e}i.unshift(d)});return{targetContext:o.bindContext(d).getBoundContext(),pathMapping:a.map((e,t)=>({oldPath:e,newPath:i[t]}))}}catch(e){return undefined}}async function v(e,o,r){const i=r||{},s=typeof i.bPreserveChanges==="undefined"||typeof i.bPreserveChanges==="boolean"&&i.bPreserveChanges;async function c(){const o=e.getModel();const i=o.bindContext(`${e.getPath()}/DraftAdministrativeData`).getBoundContext();const s=await r.oView.getModel("sap.fe.i18n").getResourceBundle();const c=await i.requestObject();if(c){n.removeUnboundTransitionMessages();let o=c.InProcessByUserDescription||c.InProcessByUser;const i=r.oView.getViewData().entitySet;if(o){const e=t.getTranslatedText("C_DRAFT_OBJECT_PAGE_DRAFT_LOCKED_BY_USER",s,o,i);a.error(e);throw new Error(e)}else{o=c.CreatedByUserDescription||c.CreatedByUser;const n=t.getTranslatedText("C_DRAFT_OBJECT_PAGE_DRAFT_UNSAVED_CHANGES",s,o,i);await y.showEditConfirmationMessageBox(n,e);return y.executeDraftEditAction(e,false,r.oView)}}throw new Error(`Draft creation aborted for document: ${e.getPath()}`)}if(!e){throw new Error("Binding context to active document is required")}try{let a;try{a=await y.executeDraftEditAction(e,s,r.oView)}catch(o){if(o.status===409||o.status===412||o.status===423){n.removeBoundTransitionMessages();n.removeUnboundTransitionMessages();const o=await y.computeSiblingInformation(e,e);if(o!==null&&o!==void 0&&o.targetContext){await t.waitForContextRequested(o.targetContext);return o.targetContext}else{a=await c()}}else if(!(o&&o.canceled)){throw new Error(o)}}if(a){var u;const e=y.getActionName(a,d.EDIT);const t=o.getSideEffectsService().getODataActionSideEffects(e,a);if(t!==null&&t!==void 0&&(u=t.triggerActions)!==null&&u!==void 0&&u.length){await o.getSideEffectsService().requestSideEffectsForODataAction(t,a);return a}else{return a}}else{return undefined}}catch(e){throw e}}async function M(e,t,n,o){const r=n||{};if(!e){throw new Error("Binding context to draft document is required")}const a=r.fnBeforeActivateDocument?await r.fnBeforeActivateDocument(e):true;if(!a){throw new Error(`Activation of the document was aborted by extension for document: ${e.getPath()}`)}let i;if(!h(e)){i=await p(e,t)}else{const n="draft";let r=y.executeDraftPreparationAction(e,n,false);e.getModel().submitBatch(n);const a=y.executeDraftActivationAction(e,t,n);try{const e=await Promise.all([r,a]);i=e[1]}catch(t){const a=A(e);if(a){r=y.executeDraftPreparationAction(e,n,true);e.getModel().submitBatch(n);await r;const t=await e.requestObject();if(t[a].length>0){o===null||o===void 0?void 0:o.removeTransitionMessages(false,false,e.getPath())}}throw t}}return r.fnAfterActivateDocument?r.fnAfterActivateDocument(e,i):i}function T(e,t){const n=s.getLibraryResourceBundle("sap.fe.core");return new Promise(function(a,s){const c=new r({title:n.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE_WARNING"),state:"Warning",content:new i({text:e}),beginButton:new o({text:n.getText("C_COMMON_OBJECT_PAGE_EDIT"),type:"Emphasized",press:function(){c.close();a(true)}}),endButton:new o({text:n.getText("C_COMMON_OBJECT_PAGE_CANCEL"),press:function(){c.close();s(`Draft creation aborted for document: ${t.getPath()}`)}}),afterClose:function(){c.destroy()}});c.addStyleClass("sapUiContentPadding");c.open()})}function b(e,t,n){const o=l(e,d.DISCARD),r=e.getObject().IsActiveEntity;if(r||!r&&!o){if(e.hasPendingChanges()){return e.getBinding().resetChanges().then(function(){return e.delete()}).catch(function(e){return Promise.reject(e)})}else{return e.delete()}}else{return C(e,t,n)}}const y={createDraftFromActiveDocument:v,activateDocument:M,deleteDraft:b,executeDraftEditAction:E,executeDraftValidation:m,executeDraftPreparationAction:P,executeDraftActivationAction:p,hasPrepareAction:h,getMessagesPath:w,computeSiblingInformation:x,processDataLossOrDraftDiscardConfirmation:u.processDataLossOrDraftDiscardConfirmation,silentlyKeepDraftOnForwardNavigation:u.silentlyKeepDraftOnForwardNavigation,createOperation:f,executeDraftDiscardAction:C,NavigationType:u.NavigationType,getActionName:l,showEditConfirmationMessageBox:T};return y},false);
//# sourceMappingURL=draft.js.map