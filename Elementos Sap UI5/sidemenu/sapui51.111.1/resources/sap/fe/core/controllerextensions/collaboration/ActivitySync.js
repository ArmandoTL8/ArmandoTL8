/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/ActivityBase","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/m/MessageBox"],function(t,e,n,o,i){"use strict";var r={};var s=o.CollaborationUtils;var c=o.Activity;var a=n.isCollaborationConnected;var l=n.initializeCollaboration;var d=n.endCollaboration;var g=n.broadcastCollaborationMessage;const f="/collaboration/myActivity";const u="/collaboration/activeUsers";const C="/collaboration/activities";const p="$auto.sync";const v=function(t){const e=t.getModel("internal");return a(e)};r.isConnected=v;const y=function(t,e,n,o){if(v(t)){const i=t.getModel("internal");const r=Array.isArray(n)?n.join("|"):n;const s=i.getProperty(f);if(e===c.LiveChange){if(s===r){return}else{i.setProperty(f,r)}}else{if(e===c.Undo&&s===null){return}i.setProperty(f,null)}g(e,r,i,o)}};r.send=y;const b=function(t){return t.getModel().getMetaModel().getObject("/@com.sap.vocabularies.Common.v1.WebSocketBaseURL")};const A=function(t){const e=(t===null||t===void 0?void 0:t.getBindingContext)&&t.getBindingContext();return!!(e&&b(e))};r.isCollaborationEnabled=A;const P=async function(t){const e=t.getModel("internal");const n=s.getMe(t);if(!n){return}const o=t.getBindingContext();const i=b(o);const r=o.getModel().getServiceUrl();if(!i){return}const c=await o.requestProperty("DraftAdministrativeData/DraftUUID");if(!c){return}l(n,i,c,r,e,e=>{m(e,t)})};r.connect=P;const h=function(t){const e=t.getModel("internal");d(e)};r.disconnect=h;function m(t,e){var n,o;const i=e.getModel("internal");let r=i.getProperty(u);let a;let l;const d=B(e,t.clientContent);t.userAction=t.userAction||t.clientAction;const p={id:t.userID,name:t.userDescription,initials:s.formatInitials(t.userDescription),color:s.getUserColor(t.userID,r,[])};let v=p;switch(t.userAction){case c.Join:case c.JoinEcho:if(r.findIndex(t=>t.id===p.id)===-1){r.unshift(p);i.setProperty(u,r)}if(t.userAction===c.Join){g(c.JoinEcho,i.getProperty(f),i)}if(t.userAction===c.JoinEcho){if(t.clientContent){t.userAction=c.LiveChange;m(t,e)}}break;case c.Leave:r=r.filter(t=>t.id!==p.id||t.me);i.setProperty(u,r);const y=i.getProperty(C)||{};const b=function(t){if(Array.isArray(t)){return t.filter(t=>t.id!==p.id)}else{for(const e in t){t[e]=b(t[e])}return t}};b(y);i.setProperty(C,y);break;case c.Change:const A=t===null||t===void 0?void 0:(n=t.clientContent)===null||n===void 0?void 0:n.split("|").map(t=>e.getModel().getMetaModel().getMetaPath(t));A.forEach((n,o)=>{var r,s;const a={...t,clientContent:t===null||t===void 0?void 0:(r=t.clientContent)===null||r===void 0?void 0:r.split("|")[o]};let d=i.getProperty(C+n)||[];l=k(a.clientContent);d=((s=d)===null||s===void 0?void 0:s.filter)&&d.filter(t=>t.key!==l);if(d){i.setProperty(C+n,d);x(e,a,n,c.Change)}});break;case c.Create:x(e,t,d,c.Create);break;case c.Delete:x(e,t,d,c.Delete);break;case c.Activate:M(e,t,s.getText("C_COLLABORATIONDRAFT_ACTIVATE",p.name));break;case c.Discard:M(e,t,s.getText("C_COLLABORATIONDRAFT_DISCARD",p.name));break;case c.Action:x(e,t,d,c.Action);break;case c.LiveChange:v=p;v.key=k(t.clientContent);let P="";const h=d.split("/");for(let t=1;t<h.length-1;t++){P+=`/${h[t]}`;if(!i.getProperty(C+P)){i.setProperty(C+P,{})}}a=i.getProperty(C+d);a=(o=a)!==null&&o!==void 0&&o.slice?a.slice():[];a.push(v);i.setProperty(C+d,a);break;case c.Undo:a=i.getProperty(C+d);l=k(t.clientContent);i.setProperty(C+d,a.filter(t=>t.key!==l));break}}function M(e,n,o){h(e);i.information(o);e.getBindingContext().getBinding().resetChanges().then(function(){D(n.clientContent,e)}).catch(function(){t.error("Pending Changes could not be reset - still navigating to active instance");D(n.clientContent,e)})}function x(t,e,n,o){const r=s.getAppComponent(t);const a=t.getModel().getMetaModel();const l=E(t);const d=r.getSideEffectsService();const g=l.getBindingContext();const f=g.getPath();const u=a.getMetaPath(f);let C=e.clientContent;if(o===c.Delete){const n=e.clientContent.split("|");const o=n.findIndex(t=>f.startsWith(t));if(o>-1){i.information(s.getText("C_COLLABORATIONDRAFT_DELETE",e.userDescription),{onClose:function(){const e=t.getModel().bindContext(n[o]).getBoundContext();l.getController()._routing.navigateBackFromContext(e)}})}C=n[0]}if(o===c.Action){const t=e.clientTriggeredActionName,n=d.getODataActionSideEffects(t,g),o=n===null||n===void 0?void 0:n.pathExpressions;if(o&&o.length>0){d.requestSideEffects(o,g,p)}}if(C.startsWith(f)){const t=n.replace(u,"").slice(1);if(t){const e=[{$PropertyPath:t}];const n=d.getEntityTypeFromContext(g);const o=d.getODataEntitySideEffects(n);const i=Object;const r=i.fromEntries(i.entries(o).filter(e=>{var n;return((n=e[1].SourceProperties)===null||n===void 0?void 0:n.findIndex(e=>e.value===t))>-1}));for(const t in r){r[t].TargetProperties.forEach(function(t){e.push({$PropertyPath:t})})}d.requestSideEffects(e,g,p)}}l.getController().editFlow.updateDocument(g,Promise.resolve())}function D(t,e){const n=E(e);const o=e.getModel().bindContext(t).getBoundContext();n.getController().routing.navigate(o)}function E(t){const n=s.getAppComponent(t);return e.getCurrentPageView(n)}function k(t){return t.substring(t.lastIndexOf("(")+1,t.lastIndexOf(")"))}function B(t,e){let n="";if(e){const o=e.split("|")[0];n=t.getModel().getMetaModel().getMetaPath(o)}return n}return{connect:P,disconnect:h,isConnected:v,isCollaborationEnabled:A,send:y}},false);
//# sourceMappingURL=ActivitySync.js.map