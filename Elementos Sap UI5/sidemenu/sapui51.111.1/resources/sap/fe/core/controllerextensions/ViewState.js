/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/navigation/library","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/p13n/StateUtil"],function(t,e,r,n,i,o,a,p,s,l,c){"use strict";var f,d,u,y,g,S,h,v,b,w,C,O,A,m,I,P,R,j,_,B,V,E,x,D,K,H,M,k,N,F,T,$,U,z,L,q,G,Q,J,W,X,Y,Z,tt,et,rt,nt,it,ot;var at=n.publicExtension;var pt=n.privateExtension;var st=n.finalExtension;var lt=n.extensible;var ct=n.defineUI5Class;function ft(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;dt(t,e)}function dt(t,e){dt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){e.__proto__=r;return e};return dt(t,e)}function ut(t,e,r,n,i){var o={};Object.keys(n).forEach(function(t){o[t]=n[t]});o.enumerable=!!o.enumerable;o.configurable=!!o.configurable;if("value"in o||o.initializer){o.writable=true}o=r.slice().reverse().reduce(function(r,n){return n(t,e,r)||r},o);if(i&&o.initializer!==void 0){o.value=o.initializer?o.initializer.call(i):void 0;o.initializer=undefined}if(o.initializer===void 0){Object.defineProperty(t,e,o);o=null}return o}const yt="#additionalStates",gt=a.NavType;const St={"sap.ui.fl.variants.VariantManagement":{retrieve:function(t){return{variantId:t.getCurrentVariantKey()}},apply:async function(e,r){try{if(r&&r.variantId!==undefined&&r.variantId!==e.getCurrentVariantKey()){const n=this._checkIfVariantIdIsAvailable(e,r.variantId);let i;if(n){i=r.variantId}else{i=e.getStandardVariantKey();this.controlsVariantIdUnavailable.push(...e.getFor())}try{await l.activateVariant({element:e,variantReference:i});await this._setInitialStatesForDeltaCompute(e)}catch(e){t.error(e)}}else{this._setInitialStatesForDeltaCompute(e)}}catch(e){t.error(e)}}},"sap.m.IconTabBar":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e&&e.selectedKey){const r=t.getItems().find(function(t){return t.getKey()===e.selectedKey});if(r){t.setSelectedItem(r)}}}},"sap.ui.mdc.FilterBar":{retrieve:async function(t){const e=this.getStateKey(t);const r=await c.retrieveExternalState(t);const n=t.getPropertyInfoSet();const i=r.filter||{};n.filter(function(t){return Object.keys(i).length>0&&t.path&&i[t.path]&&(t.removeFromAppState||i[t.path].length===0)}).forEach(function(t){if(t.path){delete i[t.path]}});return this._getControlState(e,r)},apply:async function(e,r){try{if(r){if(r!==null&&r!==void 0&&r.initialState&&this.controlsVariantIdUnavailable.indexOf(e.getId())===-1){const t=await c.diffState(e,r.initialState,r.fullState);return c.applyExternalState(e,t)}else{return c.applyExternalState(e,(r===null||r===void 0?void 0:r.fullState)??r)}}}catch(e){t.error(e)}}},"sap.ui.mdc.Table":{retrieve:async function(t){const e=this.getStateKey(t);const r=await c.retrieveExternalState(t);return this._getControlState(e,r)},apply:async function(e,r){try{if(r){if(r!==null&&r!==void 0&&r.initialState&&this.controlsVariantIdUnavailable.indexOf(e.getId())===-1){var n;if(!((n=r.initialState)!==null&&n!==void 0&&n.supplementaryConfig)){r.initialState.supplementaryConfig={}}const t=await c.diffState(e,r.initialState,r.fullState);return c.applyExternalState(e,t)}else{if(!r.supplementaryConfig){r.supplementaryConfig={}}return c.applyExternalState(e,(r===null||r===void 0?void 0:r.fullState)??r)}}}catch(e){t.error(e)}},refreshBinding:function(e){const r=e.getRowBinding();if(r){const t=r.getRootBinding();if(t===r){r.refresh()}else{const t=r.getHeaderContext();const e=r.getGroupId();if(t){t.requestSideEffects([{$NavigationPropertyPath:""}],e)}}}else{t.info(`Table: ${e.getId()} was not refreshed. No binding found!`)}}},"sap.ui.mdc.Chart":{retrieve:function(t){return c.retrieveExternalState(t)},apply:function(t,e){if(e){return c.applyExternalState(t,e)}}},"sap.uxap.ObjectPageLayout":{retrieve:function(t){return{selectedSection:t.getSelectedSection()}},apply:function(t,e){if(e){t.setSelectedSection(e.selectedSection)}},refreshBinding:function(e){const n=e.getBindingContext();const a=n&&n.getBinding();if(a){const t=o.getMetaPathForContext(n);const p=i.getControlRefreshStrategyForContextPath(e,t);if(p==="self"){const e=n.getModel(),i=e.getMetaModel(),o=r.getContextPathProperties(i,t,{$kind:"NavigationProperty"})||{},p=Object.keys(o).reduce(function(t,e){if(o[e].$isCollection!==true){t.push({$NavigationPropertyPath:e})}return t},[]),s=[{$PropertyPath:"*"}],l=a.getGroupId();n.requestSideEffects(s.concat(p),l)}else if(p==="includingDependents"){a.refresh()}}else{t.info(`ObjectPage: ${e.getId()} was not refreshed. No binding found!`)}}},"sap.fe.macros.table.QuickFilterContainer":{retrieve:function(t){return{selectedKey:t.getSelectorKey()}},apply:function(t,e){if(e){t.setSelectorKey(e.selectedKey)}}},"sap.m.SegmentedButton":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e){t.setSelectedKey(e.selectedKey)}}},"sap.m.Select":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e){t.setSelectedKey(e.selectedKey)}}},"sap.f.DynamicPage":{retrieve:function(t){return{headerExpanded:t.getHeaderExpanded()}},apply:function(t,e){if(e){t.setHeaderExpanded(e.headerExpanded)}}},"sap.ui.core.mvc.View":{retrieve:function(t){const e=t.getController();if(e&&e.viewState){return e.viewState.retrieveViewState(e.viewState)}return{}},apply:function(t,e,r){const n=t.getController();if(n&&n.viewState){return n.viewState.applyViewState(e,r)}},refreshBinding:function(t){const e=t.getController();if(e&&e.viewState){return e.viewState.refreshViewBindings()}}},"sap.ui.core.ComponentContainer":{retrieve:function(t){const e=t.getComponentInstance();if(e){return this.retrieveControlState(e.getRootControl())}return{}},apply:function(t,e,r){const n=t.getComponentInstance();if(n){return this.applyControlState(n.getRootControl(),e,r)}}}};let ht=(f=ct("sap.fe.core.controllerextensions.ViewState"),d=at(),u=st(),y=at(),g=lt(s.After),S=pt(),h=st(),v=pt(),b=st(),w=at(),C=lt(s.After),O=at(),A=lt(s.After),m=at(),I=lt(s.After),P=pt(),R=st(),j=at(),_=lt(s.After),B=pt(),V=st(),E=at(),x=lt(s.After),D=at(),K=st(),H=at(),M=st(),k=at(),N=lt(s.After),F=pt(),T=st(),$=at(),U=lt(s.Instead),z=at(),L=st(),q=pt(),G=at(),Q=lt(s.After),J=at(),W=lt(s.After),X=at(),Y=lt(s.After),Z=pt(),tt=at(),et=lt(s.After),rt=pt(),nt=st(),f(it=(ot=function(r){ft(n,r);function n(){var e;e=r.call(this)||this;e.initialControlStatesMapper={};e.controlsVariantIdUnavailable=[];e.viewStateControls=[];e._setInitialStatesForDeltaCompute=async r=>{try{const t=e.viewStateControls;const n=[];const i=[];let o=[];const a=(r===null||r===void 0?void 0:r.getFor())??[];t.filter(function(t){return t&&(!r||a.indexOf(t.getId())>-1)&&(t.isA("sap.ui.mdc.Table")||t.isA("sap.ui.mdc.FilterBar")||t.isA("sap.ui.mdc.Chart"))}).forEach(t=>{if(r){e._addEventListenersToVariantManagement(r,a)}const o=c.retrieveExternalState(t);n.push(o);i.push(e.getStateKey(t))});o=await Promise.all(n);o.forEach((t,r)=>{e.initialControlStatesMapper[i[r]]=t})}catch(e){t.error(e)}};e._iRetrievingStateCounter=0;e._pInitialStateApplied=new Promise(t=>{e._pInitialStateAppliedResolve=t});return e}var i=n.prototype;i.refreshViewBindings=async function t(){const e=await this.collectResults(this.base.viewState.adaptBindingRefreshControls);let r=Promise.resolve();e.filter(t=>t&&t.isA&&t.isA("sap.ui.base.ManagedObject")).forEach(t=>{r=r.then(this.refreshControlBinding.bind(this,t))});return r};i.adaptBindingRefreshControls=function t(e){};i.refreshControlBinding=function e(r){const n=this.getControlRefreshBindingHandler(r);let i=Promise.resolve();if(typeof n.refreshBinding!=="function"){t.info(`refreshBinding handler for control: ${r.getMetadata().getName()} is not provided`)}else{i=i.then(n.refreshBinding.bind(this,r))}return i};i.getControlRefreshBindingHandler=function t(e){const r={};if(e){for(const t in St){if(e.isA(t)){r["refreshBinding"]=St[t].refreshBinding||{};break}}}this.base.viewState.adaptBindingRefreshHandler(e,r);return r};i.adaptBindingRefreshHandler=function t(e,r){};i.onSuspend=function t(){};i.onRestore=function t(){};i.destroy=function t(){delete this._pInitialStateAppliedResolve;r.prototype.destroy.call(this)};i.collectResults=function t(e){const r=[];for(var n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++){i[o-1]=arguments[o]}i.push(r);e.apply(this,i);return Promise.all(r)};i.adaptControlStateHandler=function t(e,r){};i.getControlStateHandler=function t(e){const r=[],n=[];if(e){for(const t in St){if(e.isA(t)){r.push(Object.assign({},St[t]));break}}}this.base.viewState.adaptControlStateHandler(e,n);return r.concat(n)};i.adaptStateControls=function t(e){};i.getStateKey=function t(e){return this.getView().getLocalId(e.getId())||e.getId()};i.retrieveViewState=async function t(){++this._iRetrievingStateCounter;let r;try{await this._pInitialStateApplied;const t=await this.collectResults(this.base.viewState.adaptStateControls);const n=await Promise.all(t.filter(function(t){return t&&t.isA&&t.isA("sap.ui.base.ManagedObject")}).map(t=>this.retrieveControlState(t).then(e=>({key:this.getStateKey(t),value:e}))));r=n.reduce(function(t,r){const n={};n[r.key]=r.value;return e(t,n)},{});const i=await Promise.resolve(this._retrieveAdditionalStates());if(i&&Object.keys(i).length){r[yt]=i}}finally{--this._iRetrievingStateCounter}return this._iRetrievingStateCounter===0?r:undefined};i.retrieveAdditionalStates=function t(e){};i._retrieveAdditionalStates=function t(){const e={};this.base.viewState.retrieveAdditionalStates(e);return e};i.retrieveControlState=function t(r){const n=this.getControlStateHandler(r);return Promise.all(n.map(t=>{if(typeof t.retrieve!=="function"){throw new Error(`controlStateHandler.retrieve is not a function for control: ${r.getMetadata().getName()}`)}return t.retrieve.call(this,r)})).then(t=>t.reduce(function(t,r){return e(t,r)},{}))};i.applyInitialStateOnly=function t(){return true};i.applyViewState=async function e(r,n){if(this.base.viewState.applyInitialStateOnly()&&this._getInitialStateApplied()){return}try{await this.collectResults(this.base.viewState.onBeforeStateApplied);const e=await this.collectResults(this.base.viewState.adaptStateControls);this.viewStateControls=e;let i=Promise.resolve();let o=false;const a=e.reduce((t,e)=>{if(!e){return t}const r=e.isA("sap.ui.fl.variants.VariantManagement");if(!o){o=r}t=r?[e,...t]:[...t,e];return t},[]);if(!o){this._setInitialStatesForDeltaCompute()}a.filter(function(t){return t.isA("sap.ui.base.ManagedObject")}).forEach(t=>{const e=this.getStateKey(t);i=i.then(this.applyControlState.bind(this,t,r?r[e]:undefined,n))});await i;if(n.navigationType===gt.iAppState){await this.collectResults(this.base.viewState.applyAdditionalStates,r?r[yt]:undefined)}else{await this.collectResults(this.base.viewState.applyNavigationParameters,n);await this.collectResults(this.base.viewState._applyNavigationParametersToFilterbar,n)}}finally{try{await this.collectResults(this.base.viewState.onAfterStateApplied);this._setInitialStateApplied()}catch(e){t.error(e)}}};i._checkIfVariantIdIsAvailable=function t(e,r){const n=e.getVariants();let i=false;n.forEach(function(t){if(t.key===r){i=true}});return i};i._setInitialStateApplied=function t(){if(this._pInitialStateAppliedResolve){const t=this._pInitialStateAppliedResolve;delete this._pInitialStateAppliedResolve;t()}};i._getInitialStateApplied=function t(){return!this._pInitialStateAppliedResolve};i.onBeforeStateApplied=function t(e){};i.onAfterStateApplied=function t(e){};i.applyAdditionalStates=function t(e,r){};i._applyNavigationParametersToFilterbar=function t(e,r){};i.applyNavigationParameters=function t(e,r){};i.applyControlState=function t(e,r,n){const i=this.getControlStateHandler(e);let o=Promise.resolve();i.forEach(t=>{if(typeof t.apply!=="function"){throw new Error(`controlStateHandler.apply is not a function for control: ${e.getMetadata().getName()}`)}o=o.then(t.apply.bind(this,e,r,n))});return o};i.getInterface=function t(){return this};i._getControlState=function t(e,r){const n=this.initialControlStatesMapper;if(Object.keys(n).length>0&&n[e]){if(Object.keys(n[e]).length===0){n[e]={...r}}return{fullState:r,initialState:n[e]}}return r};i._addEventListenersToVariantManagement=function t(e,r){const n={variantManagedControls:r};const i=()=>{this._updateInitialStatesOnVariantChange(r)};e.attachSave(n,i,{});e.attachSelect(n,i,{})};i._updateInitialStatesOnVariantChange=function t(e){const r=this.initialControlStatesMapper;Object.keys(r).forEach(t=>{for(const n of e){if(n.indexOf(t)>-1){r[t]={}}}})};return n}(p),ut(ot.prototype,"refreshViewBindings",[d,u],Object.getOwnPropertyDescriptor(ot.prototype,"refreshViewBindings"),ot.prototype),ut(ot.prototype,"adaptBindingRefreshControls",[y,g],Object.getOwnPropertyDescriptor(ot.prototype,"adaptBindingRefreshControls"),ot.prototype),ut(ot.prototype,"refreshControlBinding",[S,h],Object.getOwnPropertyDescriptor(ot.prototype,"refreshControlBinding"),ot.prototype),ut(ot.prototype,"getControlRefreshBindingHandler",[v,b],Object.getOwnPropertyDescriptor(ot.prototype,"getControlRefreshBindingHandler"),ot.prototype),ut(ot.prototype,"adaptBindingRefreshHandler",[w,C],Object.getOwnPropertyDescriptor(ot.prototype,"adaptBindingRefreshHandler"),ot.prototype),ut(ot.prototype,"onSuspend",[O,A],Object.getOwnPropertyDescriptor(ot.prototype,"onSuspend"),ot.prototype),ut(ot.prototype,"onRestore",[m,I],Object.getOwnPropertyDescriptor(ot.prototype,"onRestore"),ot.prototype),ut(ot.prototype,"collectResults",[P,R],Object.getOwnPropertyDescriptor(ot.prototype,"collectResults"),ot.prototype),ut(ot.prototype,"adaptControlStateHandler",[j,_],Object.getOwnPropertyDescriptor(ot.prototype,"adaptControlStateHandler"),ot.prototype),ut(ot.prototype,"getControlStateHandler",[B,V],Object.getOwnPropertyDescriptor(ot.prototype,"getControlStateHandler"),ot.prototype),ut(ot.prototype,"adaptStateControls",[E,x],Object.getOwnPropertyDescriptor(ot.prototype,"adaptStateControls"),ot.prototype),ut(ot.prototype,"getStateKey",[D,K],Object.getOwnPropertyDescriptor(ot.prototype,"getStateKey"),ot.prototype),ut(ot.prototype,"retrieveViewState",[H,M],Object.getOwnPropertyDescriptor(ot.prototype,"retrieveViewState"),ot.prototype),ut(ot.prototype,"retrieveAdditionalStates",[k,N],Object.getOwnPropertyDescriptor(ot.prototype,"retrieveAdditionalStates"),ot.prototype),ut(ot.prototype,"retrieveControlState",[F,T],Object.getOwnPropertyDescriptor(ot.prototype,"retrieveControlState"),ot.prototype),ut(ot.prototype,"applyInitialStateOnly",[$,U],Object.getOwnPropertyDescriptor(ot.prototype,"applyInitialStateOnly"),ot.prototype),ut(ot.prototype,"applyViewState",[z,L],Object.getOwnPropertyDescriptor(ot.prototype,"applyViewState"),ot.prototype),ut(ot.prototype,"_checkIfVariantIdIsAvailable",[q],Object.getOwnPropertyDescriptor(ot.prototype,"_checkIfVariantIdIsAvailable"),ot.prototype),ut(ot.prototype,"onBeforeStateApplied",[G,Q],Object.getOwnPropertyDescriptor(ot.prototype,"onBeforeStateApplied"),ot.prototype),ut(ot.prototype,"onAfterStateApplied",[J,W],Object.getOwnPropertyDescriptor(ot.prototype,"onAfterStateApplied"),ot.prototype),ut(ot.prototype,"applyAdditionalStates",[X,Y],Object.getOwnPropertyDescriptor(ot.prototype,"applyAdditionalStates"),ot.prototype),ut(ot.prototype,"_applyNavigationParametersToFilterbar",[Z],Object.getOwnPropertyDescriptor(ot.prototype,"_applyNavigationParametersToFilterbar"),ot.prototype),ut(ot.prototype,"applyNavigationParameters",[tt,et],Object.getOwnPropertyDescriptor(ot.prototype,"applyNavigationParameters"),ot.prototype),ut(ot.prototype,"applyControlState",[rt,nt],Object.getOwnPropertyDescriptor(ot.prototype,"applyControlState"),ot.prototype),ot))||it);return ht},false);
//# sourceMappingURL=ViewState.js.map