/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/Synchronization","sap/ui/base/Object","sap/ui/core/Core","sap/ui/thirdparty/URI"],function(t,e,s,i,n,a){"use strict";var o,r;var h=e.defineUI5Class;function u(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;c(t,e)}function c(t,e){c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,s){e.__proto__=s;return e};return c(t,e)}const l={EQUAL:0,COMPATIBLE:1,ANCESTOR:2,DIFFERENT:3};const f={LAYOUTPARAM:"layout",IAPPSTATEPARAM:"sap-iapp-state"};function d(t){return{_guardHash:t.replace(/\?[^\?]*$/,""),check:function(t){return t.indexOf(this._guardHash)===0}}}function g(t){const e=t.match(new RegExp(`\\?.*${f.IAPPSTATEPARAM}=([^&]*)`));return e&&e.length>1?e[1]:null}function p(t){return t.replace(new RegExp(`[&?]*${f.IAPPSTATEPARAM}=[^&]*`),"")}function y(t,e){let s;if(t.indexOf(f.IAPPSTATEPARAM)>=0){s=t.replace(new RegExp(`${f.IAPPSTATEPARAM}=[^&]*`),`${f.IAPPSTATEPARAM}=${e}`)}else{if(t.indexOf("?")<0){s=`${t}?`}else{s=`${t}&`}s+=`${f.IAPPSTATEPARAM}=${e}`}return s}let _=(o=h("sap.fe.core.RouterProxy"),o(r=function(e){u(i,e);function i(){var t;for(var s=arguments.length,i=new Array(s),n=0;n<s;n++){i[n]=arguments[n]}t=e.call(this,...i)||this;t.bIsRebuildHistoryRunning=false;t.bIsComputingTitleHierachy=false;t.bIsGuardCrossAllowed=false;t.sIAppStateKey=null;t._bActivateRouteMatchSynchro=false;t._bApplyRestore=false;t._bDelayedRebuild=false;t._pathMappings=[];return t}var o=i.prototype;o.init=function e(s,i){s.getService("shellServices").then(()=>{this._oShellServices=s.getShellServices();this.initRaw(s.getRouter());this.waitForRouteMatchBeforeNavigation();history.replaceState(Object.assign({feLevel:0},history.state),"",window.location);this.fclEnabled=i;this._fnBlockingNavFilter=this._blockingNavigationFilter.bind(this);this._oShellServices.registerNavigationFilter(this._fnBlockingNavFilter)}).catch(function(e){t.error("Cannot retrieve the shell services",e)});this._fnHashGuard=this.hashGuard.bind(this);window.addEventListener("popstate",this._fnHashGuard);this._bDisableOnHashChange=false;this._bIgnoreRestore=false;this._bForceFocus=true};o.destroy=function t(){if(this._oShellServices){this._oShellServices.unregisterNavigationFilter(this._fnBlockingNavFilter)}window.removeEventListener("popstate",this._fnHashGuard)};o.initRaw=function t(e){this._oRouter=e;this._oManagedHistory=[];this._oNavigationGuard=null;const s=this.getHash();this._oManagedHistory.push(this._extractStateFromHash(s));this.sIAppStateKey=g(s)};o.getHash=function t(){return this._oRouter.getHashChanger().getHash()};o.isFocusForced=function t(){return this._bForceFocus};o.setFocusForced=function t(e){this._bForceFocus=e};o.removeIAppStateKey=function t(){this.sIAppStateKey=null};o.navToHash=function t(e,s,i,n,a){if(a!==false){this._oShellServices.setBackNavigation()}if(this._oRouteMatchSynchronization){return this._oRouteMatchSynchronization.waitFor().then(()=>{this._oRouteMatchSynchronization=undefined;return this._internalNavToHash(e,s,i,n)})}else{if(this._bActivateRouteMatchSynchro){this.waitForRouteMatchBeforeNavigation()}return this._internalNavToHash(e,s,i,n)}};o._internalNavToHash=function t(e,s,i,a){if(this.fclEnabled&&this.sIAppStateKey&&!g(e)){e=y(e,this.sIAppStateKey)}if(!this.checkHashWithGuard(e)){if(!this.oResourceBundle){this.oResourceBundle=n.getLibraryResourceBundle("sap.fe.core")}if(!confirm(this.oResourceBundle.getText("C_ROUTER_PROXY_SAPFE_EXIT_NOTSAVED_MESSAGE"))){return Promise.resolve(false)}this.bIsGuardCrossAllowed=true}const o=this._extractStateFromHash(e);if(!this._bForceFocus){const t=this._extractEntitySetsFromHash(this.getHash());this._bForceFocus=a||t.length<o.keys.length&&t.every(function(t,e){return t===o.keys[e]})}const r=this._pushNewState(o,false,s,i);return this._rebuildBrowserHistory(r,false)};o.restoreHistory=function t(){if(this._bApplyRestore){this._bApplyRestore=false;let t=this.getHash();t=t.replace(/(\?|&)restoreHistory=true/,"");const e=this._extractStateFromHash(t);const s=this._pushNewState(e,true,false,true);return this._rebuildBrowserHistory(s,true)}else{return Promise.resolve()}};o.navBack=function t(){const e=this.getHash();let s;for(let t=this._oManagedHistory.length-1;t>0;t--){if(this._oManagedHistory[t].hash===e){s=this._oManagedHistory[t-1].hash;break}}if(s){return this.navToHash(s)}else{window.history.back();return Promise.resolve()}};o.navTo=function t(e,s){const i=this._oRouter.getURL(e,s);return this.navToHash(i,false,s.noPreservationCache,false,!s.bIsStickyMode)};o.exitFromApp=function t(){return this._oShellServices.backToPreviousApp()};o.isCurrentStateImpactedBy=function t(e){if(e[0]==="/"){e=e.substring(1)}const s=d(e);return s.check(this.getHash())};o.isNavigationFinalized=function t(){return!this.bIsRebuildHistoryRunning&&!this._bDelayedRebuild};o.setNavigationGuard=function t(e){this._oNavigationGuard=d(e);this.bIsGuardCrossAllowed=false};o.discardNavigationGuard=function t(){this._oNavigationGuard=null};o.hasNavigationGuard=function t(){return this._oNavigationGuard!==null};o.checkHashWithGuard=function t(e){return this._oNavigationGuard===null||this._oNavigationGuard.check(e)};o.isGuardCrossAllowedByUser=function t(){return this.bIsGuardCrossAllowed};o.activateRouteMatchSynchronization=function t(){this._bActivateRouteMatchSynchro=true};o.resolveRouteMatch=function t(){if(this._oRouteMatchSynchronization){this._oRouteMatchSynchronization.resolve()}};o.waitForRouteMatchBeforeNavigation=function t(){this._oRouteMatchSynchronization=new s;this._bActivateRouteMatchSynchro=false};o._extractEntitySetsFromHash=function t(e){if(e===undefined){e=""}const s=e.split("?")[0];const i=s.split("/");const n=[];i.forEach(t=>{if(t.length){n.push(t.split("(")[0])}});return n};o._extractStateFromHash=function t(e){if(e===undefined){e=""}const s={keys:this._extractEntitySetsFromHash(e)};const i=e.match(new RegExp(`\\?.*${f.LAYOUTPARAM}=([^&]*)`));s.sLayout=i&&i.length>1?i[1]:null;if(s.sLayout==="MidColumnFullScreen"){s.screenMode=1}else if(s.sLayout==="EndColumnFullScreen"){s.screenMode=2}else{s.screenMode=0}s.hash=e;return s};o._pushNewState=function t(e,s,i,n){const a=this.getHash();let o=this._oManagedHistory.length-1;let r=s?1:0;if(!s){while(o>=0&&this._oManagedHistory[o].hash!==a){this._oManagedHistory.pop();o--}if(this._oManagedHistory.length===0){this._oManagedHistory.push(this._extractStateFromHash(a));history.replaceState(Object.assign({feLevel:0},history.state),"")}}if(i&&!n){this._oManagedHistory[this._oManagedHistory.length-1].preserved=true}let h;while(this._oManagedHistory.length>0){const t=this._oManagedHistory[this._oManagedHistory.length-1];if((n||!t.preserved)&&this._compareCacheStates(t,e)!==l.ANCESTOR){h=this._oManagedHistory.pop();r++}else if(t.preserved&&p(t.hash)===p(e.hash)){h=this._oManagedHistory.pop();r++;e.preserved=true;break}else{break}}this.sIAppStateKey=g(e.hash);if(!this.fclEnabled&&h){const t=g(h.hash);const s=this._compareCacheStates(h,e);if(!this.sIAppStateKey&&t&&(s===l.EQUAL||s===l.COMPATIBLE)){e.hash=y(e.hash,t)}}const u=h&&e.hash===h.hash;if(this._oManagedHistory.length===0||this._oManagedHistory[this._oManagedHistory.length-1].hash!==e.hash){this._oManagedHistory.push(e)}if(r===0){return{type:"append"}}else if(r===1){return u?{type:"none"}:{type:"replace"}}else{return u?{type:"back",steps:r-1}:{type:"back-replace",steps:r-1}}};o._blockingNavigationFilter=function t(){return this._bDisableOnHashChange?"Custom":"Continue"};o._disableEventOnHashChange=function t(){this._bDisableOnHashChange=true;this._oRouter.stop()};o._enableEventOnHashChange=function t(e){this._bDisableOnHashChange=false;this._oRouter.initialize(e)};o._rebuildBrowserHistory=function t(e,s){const i=this;return new Promise(t=>{this.bIsRebuildHistoryRunning=true;const n=this._oManagedHistory[this._oManagedHistory.length-1],a=this._oManagedHistory.length-1;function o(){if(!s){i._enableEventOnHashChange(true)}i._oRouter.getHashChanger().replaceHash(n.hash);history.replaceState(Object.assign({feLevel:a},history.state),"");if(s){setTimeout(function(){i._enableEventOnHashChange(true)},0)}i.bIsRebuildHistoryRunning=false;t(true)}function r(){window.removeEventListener("popstate",r);setTimeout(function(){o()},0)}function h(){window.removeEventListener("popstate",h);i.bIsRebuildHistoryRunning=false;t(true)}i._bIgnoreRestore=true;switch(e.type){case"replace":i._oRouter.getHashChanger().replaceHash(n.hash);history.replaceState(Object.assign({feLevel:a},history.state),"");i.bIsRebuildHistoryRunning=false;t(true);break;case"append":i._oRouter.getHashChanger().setHash(n.hash);history.replaceState(Object.assign({feLevel:a},history.state),"");i.bIsRebuildHistoryRunning=false;t(true);break;case"back":window.addEventListener("popstate",h);history.go(-e.steps);break;case"back-replace":this._disableEventOnHashChange();window.addEventListener("popstate",r);history.go(-e.steps);break;default:this.bIsRebuildHistoryRunning=false;t(false)}})};o.getLastHistoryEntry=function t(){return this._oManagedHistory[this._oManagedHistory.length-1]};o.setPathMapping=function t(e){this._pathMappings=e.filter(t=>t.oldPath!==t.newPath)};o.hashGuard=function t(){let e=window.location.hash;if(e.indexOf("restoreHistory=true")!==-1){this._bApplyRestore=true}else if(!this.bIsRebuildHistoryRunning){const t=this._pathMappings.find(t=>e.indexOf(t.oldPath)>=0);if(t){e=e.replace(t.oldPath,t.newPath);history.replaceState(Object.assign({},history.state),"",e)}else{const t=e.split("&/");const s=t[1]?t[1]:"";if(this.checkHashWithGuard(s)){this._bDelayedRebuild=true;const t=this._extractStateFromHash(s);this._pushNewState(t,false,false,true);setTimeout(()=>{this._bDelayedRebuild=false},0)}}}};o._compareCacheStates=function t(e,s){if(e.keys.length>s.keys.length){return l.DIFFERENT}let i=true;let n;for(n=0;i&&n<e.keys.length;n++){if(e.keys[n]!==s.keys[n]){i=false}}if(!i){return l.DIFFERENT}if(e.keys.length<s.keys.length||e.screenMode<s.screenMode){return l.ANCESTOR}if(e.screenMode>s.screenMode){return l.DIFFERENT}return e.sLayout===s.sLayout?l.EQUAL:l.COMPATIBLE};o.checkIfBackIsOutOfGuard=function t(e){let s;let i;if(e===undefined){const t=this._oShellServices.splitHash(window.location.hash);if(t&&t.appSpecificRoute){i=t.appSpecificRoute;if(i.indexOf("&/")===0){i=i.substring(2)}}else{i=window.location.hash.substring(1);if(i[0]==="/"){i=i.substring(1)}}}else{i=e}e=a.decode(i);if(this._oNavigationGuard){for(let t=this._oManagedHistory.length-1;t>0;t--){if(this._oManagedHistory[t].hash===e){s=this._oManagedHistory[t-1].hash;break}}return!s||!this.checkHashWithGuard(s)}return false};o.checkIfBackHasSameContext=function t(){if(this._oManagedHistory.length<2){return false}const e=this._oManagedHistory[this._oManagedHistory.length-1];const s=this._oManagedHistory[this._oManagedHistory.length-2];return e.hash.split("?")[0]===s.hash.split("?")[0]};return i}(i))||r);return _},false);
//# sourceMappingURL=RouterProxy.js.map