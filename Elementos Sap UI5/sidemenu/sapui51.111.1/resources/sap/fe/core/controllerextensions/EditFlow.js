/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/collaboration/ActivitySync","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/controllerextensions/Feedback","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/EditState","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/SemanticKeyHelper","sap/fe/core/library","sap/ui/core/Core","sap/ui/core/library","sap/ui/core/message/Message","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/ui/model/odata/v4/ODataListBinding","../ActionRuntime"],function(t,e,n,i,o,r,a,s,c,l,g,d,u,h,f,p,y,w,v,m){"use strict";var C,_,b,M,P,D,E,x,S,A,I,F,k,O,B,R,T,V,j,H,N,L,$,q,K,U,G,z,W,J,Q,X,Y,Z,tt,et;var nt=c.publicExtension;var it=c.finalExtension;var ot=c.extensible;var rt=c.defineUI5Class;var at=s.getInvolvedDataModelObjects;var st=a.TriggerType;var ct=a.triggerConfiguredSurvey;var lt=a.StandardActions;var gt=o.shareObject;var dt=o.Activity;var ut=i.send;var ht=i.isConnected;function ft(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;pt(t,e)}function pt(t,e){pt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,n){e.__proto__=n;return e};return pt(t,e)}function yt(t,e,n,i,o){var r={};Object.keys(i).forEach(function(t){r[t]=i[t]});r.enumerable=!!r.enumerable;r.configurable=!!r.configurable;if("value"in r||r.initializer){r.writable=true}r=n.slice().reverse().reduce(function(n,i){return i(t,e,n)||n},r);if(o&&r.initializer!==void 0){r.value=r.initializer?r.initializer.call(o):void 0;r.initializer=undefined}if(r.initializer===void 0){Object.defineProperty(t,e,r);r=null}return r}const wt=u.CreationMode,vt=u.ProgrammingModel,mt=u.Constants,Ct=u.DraftStatus,_t=u.EditMode,bt=u.StartupMode,Mt=f.MessageType;let Pt=(C=rt("sap.fe.core.controllerextensions.EditFlow"),_=nt(),b=it(),M=nt(),P=it(),D=nt(),E=it(),x=nt(),S=it(),A=nt(),I=ot(w.After),F=nt(),k=ot(w.After),O=nt(),B=ot(w.After),R=nt(),T=ot(w.After),V=nt(),j=ot(w.After),H=nt(),N=it(),L=nt(),$=it(),q=nt(),K=it(),U=nt(),G=it(),z=nt(),W=it(),J=nt(),Q=it(),X=nt(),Y=it(),Z=nt(),C(tt=(et=function(i){ft(o,i);function o(){return i.apply(this,arguments)||this}var a=o.prototype;a.getAppComponent=function t(){return this.base.getAppComponent()};a.getInternalEditFlow=function t(){return this.base.getView().getController()._editFlow};a.editDocument=async function e(n){const i=true;const o=this._getTransactionHelper();const r=this._getRootViewController();const a=n.getModel();let s,c;const l=this.getView().getViewData();const d=this._getProgrammingModel(n);let u=n;const h=this.getView();try{if((l===null||l===void 0?void 0:l.viewLevel)>1){if(d===vt.Draft){const t=g.getDraftRootPath(n);u=h.getModel().bindContext(t).getBoundContext();await u.requestObject(t)}else if(d===vt.Sticky){const t=g.getStickyRootPath(n);u=h.getModel().bindContext(t).getBoundContext();await u.requestObject(t)}}await this.base.editFlow.onBeforeEdit({context:u});const t=await o.editDocument(u,this.getView(),this.getAppComponent(),this._getMessageHandler());this._setStickySessionInternalProperties(d,a);if(t){this._setEditMode(_t.Editable,false);this._setDocumentModified(false);this._getMessageHandler().showMessageDialog();if(t!==u){let e=t;if(this._isFclEnabled()){s=r.getRightmostContext();c=await this._computeSiblingInformation(u,s,d,true);c=c??this._createSiblingInfo(n,t);this._updatePathsInHistory(c.pathMapping);if(c.targetContext.getPath()!=t.getPath()){e=c.targetContext}}else if((l===null||l===void 0?void 0:l.viewLevel)>1){c=await this._computeSiblingInformation(u,n,d,true);e=this._getNavigationTargetForEdit(n,t,c)}await this._handleNewContext(e,true,false,i,true);if(d===vt.Sticky){let e;if(this._isFclEnabled()){e=t.getModel().getKeepAliveContext(t.getPath())}else{e=t}this._handleStickyOn(e)}else if(g.isCollaborationDraftSupported(a.getMetaModel())){await gt(t)}}}}catch(e){t.error("Error while editing the document",e)}};a.deleteMultipleDocuments=function t(e,n){if(n){n.beforeDeleteCallBack=this.base.editFlow.onBeforeDelete}else{n={beforeDeleteCallBack:this.base.editFlow.onBeforeDelete}}return this.getInternalEditFlow().deleteMultipleDocuments(e,n)};a.updateDocument=function e(n,i){const o=this.getView().getBindingContext();const r=this._getProgrammingModel(n)===vt.Draft;this._getMessageHandler().removeTransitionMessages();return this._syncTask(async()=>{if(o){this._setDocumentModified(true);if(!this._isFclEnabled()){l.setEditStateDirty()}if(r){this._setDraftStatus(Ct.Saving)}}try{await i;const t=this.getView().getBindingContext();if(!r||!t||t!==o){return}const e=t.getModel().getMetaModel();const n=e.getMetaContext(t.getPath()).getObject("@sapui.name");const a=d.getSemanticKeys(e,n);if(a!==null&&a!==void 0&&a.length){const e=this._getSemanticMapping();const n=e===null||e===void 0?void 0:e.semanticPath,i=d.getSemanticPath(t,true);if(n&&n!==i){await this._handleNewContext(t,true,false,true)}}this._setDraftStatus(Ct.Saved)}catch(e){t.error("Error while updating the document",e);if(r&&o){this._setDraftStatus(Ct.Clear)}}finally{await this._getMessageHandler().showMessages()}})};a.createDocument=async function i(o,r){const a=this._getTransactionHelper(),s=this._getGlobalUIModel();let c;let d=r;const u=!d||d.creationMode!==wt.Inline&&d.creationMode!==wt.CreationRow&&d.creationMode!==wt.External;let f=Promise.resolve([]);const y=e.getAppComponent(this.getView());y.getRouterProxy().removeIAppStateKey();if(d.creationMode===wt.External){await this._syncTask();const t=this.getView().getController();const e=g.getAbsoluteMetaPathForListBinding(this.getView(),o);t.handlers.onChevronPressNavigateOutBound(t,d.outbound,undefined,e);return}if(d.creationMode===wt.CreationRow&&d.creationRow){const t=d.creationRow.getBindingContext().getObject();delete t["@$ui5.context.isTransient"];c=d.creationRow.getParent();f=a.validateDocument(c.getBindingContext(),{data:t,customValidationFunction:c.getCreationRow().data("customValidationFunction")},this.base.getView());if(c.getCreationRow().data("disableAddRowButtonForEmptyData")==="true"){const t=c.getBindingContext("internal");t.setProperty("creationRowFieldValidity",{})}}if(d.creationMode===wt.Inline&&d.tableId){c=this.getView().byId(d.tableId)}if(c&&c.isA("sap.ui.mdc.Table")){const t=d.creationMode===wt.Inline?c.focusRow.bind(c):c.scrollToIndex.bind(c);c.getRowBinding().attachEventOnce("change",function(){t(d.createAtEnd?c.getRowBinding().getLength():0,true)})}const w=async(n,i)=>{try{const t=await i;await t.created();const o=this.getView().getBindingContext();if(!e.hasTransientContext(n)){const t=e.getAppComponent(this.getView());t.getSideEffectsService().requestSideEffectsForNavigationProperty(n.getPath(),o)}}catch(e){t.error("Error while creating the document",e)}};const m=t=>{var e;const n=c&&c.getCreationRow().data("customValidationFunction");const i=c&&((e=c.getBindingContext("internal"))===null||e===void 0?void 0:e.getProperty("creationRowCustomValidity"));const o=h.getMessageManager();const r=[];let a;let s;o.getMessageModel().getData().forEach(function(t){if(t.code===n){o.removeMessages(t)}});t.forEach(t=>{if(t.messageTarget){var e;a=h.getControl(i[t.messageTarget].fieldId);s=`${(e=a.getBindingContext())===null||e===void 0?void 0:e.getPath()}/${a.getBindingPath("value")}`;if(o.getMessageModel().getData().filter(function(t){return t.target===s}).length===0){o.addMessages(new p({message:t.messageText,processor:this.getView().getModel(),type:Mt.Error,code:n,technical:false,persistent:false,target:s}))}const r=o.getMessageModel().getData().filter(function(t){return t.target===s});r[0].addControlId(i[t.messageTarget].fieldId)}else{r.push({code:n,text:t.messageText,persistent:true,type:Mt.Error})}});if(r.length>0){this._getMessageHandler().showMessageDialog({customMessages:r})}};const C=(t,n,i,o)=>{if(t&&t!==wt.NewPage){return t}else{if(!i.isRelative()){const t=i.getPath(),e=n===vt.Draft?o.getObject(`${t}@com.sap.vocabularies.Common.v1.DraftRoot/NewAction`):o.getObject(`${t}@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction`);if(e){const t=o.getObject(`/${e}/@$ui5.overload/0/$Parameter`)||[];if(t.length>1){return wt.Deferred}}}const t=o.getMetaPath(i===null||i===void 0?void 0:i.getHeaderContext().getPath());const r=e.getNonComputedVisibleFields(o,t,this.getView());if(r.length>0){return wt.Deferred}return wt.Async}};if(u){n.lock(s)}try{const e=await this._syncTask(f);if(e.length>0){m(e);t.error("Custom Validation failed");return}let i;d=d||{};if(o&&typeof o==="object"){i=o}else if(typeof o==="string"){i=new v(this.getView().getModel(),o);d.creationMode=wt.Sync;delete d.createAtEnd}else{throw new Error("Binding object or path expected")}const r=i.getModel();const p=this._getProgrammingModel(i);const E=C(d.creationMode,p,i,r.getMetaModel());let x;let S;const A=d.creationRow;let I;let F;let k;const O=r.getMetaModel();const B=this._getRoutingListener();if(E!==wt.Deferred){if(E===wt.CreationRow){I=A.getBindingContext();k=O.getMetaPath(I.getPath());F=I.getObject();d.data={};Object.keys(F).forEach(function(t){const e=O.getObject(`${k}/${t}`);if(e&&e.$kind==="NavigationProperty"){return}d.data[t]=F[t]});await this._checkForValidationErrors()}if(E===wt.CreationRow||E===wt.Inline){var _,b,M;d.keepTransientContextOnFailed=false;d.busyMode="Local";d.busyId=(_=c)===null||_===void 0?void 0:(b=_.getParent())===null||b===void 0?void 0:(M=b.getTableDefinition())===null||M===void 0?void 0:M.annotation.id;this._handleCreateEvents(i)}if(!d.parentControl){d.parentControl=this.getView()}d.beforeCreateCallBack=this.base.editFlow.onBeforeCreate;d.skipParameterDialog=y.getStartupMode()===bt.AutoCreate;x=a.createDocument(i,d,this.getAppComponent(),this._getMessageHandler(),false,this.getView())}let R;switch(E){case wt.Deferred:R=B.navigateForwardToContext(i,{bDeferredContext:true,editable:true,bForceFocus:true});break;case wt.Async:R=B.navigateForwardToContext(i,{asyncContext:x,editable:true,bForceFocus:true});break;case wt.Sync:S={editable:true,bForceFocus:true};if(p==vt.Sticky||d.createAction){S.transient=true}R=x.then(function(t){if(!t){const t=h.getLibraryResourceBundle("sap.fe.core");return B.navigateToMessagePage(t.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:t.getText("C_COMMON_SAPFE_ERROR"),description:t.getText("C_EDITFLOW_SAPFE_CREATION_FAILED_DESCRIPTION")})}else{return d.bFromDeferred?B.navigateToContext(t,S):B.navigateForwardToContext(t,S)}});break;case wt.Inline:w(i,x);this._syncTask(x);break;case wt.CreationRow:try{const e=I.getBinding();if(!d.bSkipSideEffects){w(i,x)}const n=e.create();A.setBindingContext(n);n.created().catch(function(){t.trace("transient fast creation context deleted")});R=I.delete("$direct")}catch(e){if(n.isLocked(this.getView().getModel("ui"))){n.unlock(this.getView().getModel("ui"))}t.error("CreationRow navigation error: ",e)}break;default:R=Promise.reject(`Unhandled creationMode ${E}`);break}if(x){try{const t=await Promise.all([x,R]);this._setStickySessionInternalProperties(p,r);this._setEditMode(_t.Editable);if(!i.isRelative()&&p===vt.Sticky){var P,D;const t=i.getModel().getMetaModel();const e=t.bindContext(t.getMetaPath(i.getPath()));const n=at(e).startingEntitySet;const o=n===null||n===void 0?void 0:(P=n.annotations.Session)===null||P===void 0?void 0:(D=P.StickySessionSupported)===null||D===void 0?void 0:D.NewAction;this._getInternalModel().setProperty("/lastInvokedAction",o)}const e=t[0];if(e){this._setDocumentModifiedOnCreate(i);if(!this._isFclEnabled()){l.setEditStateDirty()}this._sendActivity(dt.Create,e);if(g.isCollaborationDraftSupported(r.getMetaModel())){await gt(e)}}}catch(t){if(t===mt.CancelActionDialog||t===mt.ActionExecutionFailed||t===mt.CreationFailed){if(E===wt.Sync||E===wt.Deferred||E===wt.Async){B.navigateBackFromTransientState()}}throw t}}}finally{if(u){n.unlock(s)}}};a.onBeforeSave=function t(e){return Promise.resolve()};a.onBeforeCreate=function t(e){return Promise.resolve()};a.onBeforeEdit=function t(e){return Promise.resolve()};a.onBeforeDiscard=function t(e){return Promise.resolve()};a.onBeforeDelete=function t(e){return Promise.resolve()};a.saveDocument=async function e(n,i){i=i||{};const o=i.bExecuteSideEffectsOnError||undefined;const r=true;const a=this._getTransactionHelper();const s=this._getResourceBundle();const c=i.bindings;try{await this._syncTask();await this._submitOpenChanges(n);await this._checkForValidationErrors();await this.base.editFlow.onBeforeSave({context:n});const t=this._getProgrammingModel(n);const e=this._getRootViewController();let i;if((t===vt.Sticky||n.getProperty("HasActiveEntity"))&&e.isFclEnabled()){i=await this._computeSiblingInformation(n,e.getRightmostContext(),t,true)}const l=await a.saveDocument(n,this.getAppComponent(),s,o,c,this._getMessageHandler(),this._getCreationMode());this._removeStickySessionInternalProperties(t);this._sendActivity(dt.Activate,l);this._triggerConfiguredSurvey(lt.save,st.standardAction);this._setDocumentModified(false);this._setEditMode(_t.Display,false);this._getMessageHandler().showMessageDialog();if(l!==n){let t=l;if(e.isFclEnabled()){i=i??this._createSiblingInfo(n,l);this._updatePathsInHistory(i.pathMapping);if(i.targetContext.getPath()!==l.getPath()){t=i.targetContext}}await this._handleNewContext(t,false,false,r,true)}}catch(e){if(!(e&&e.canceled)){t.error("Error while saving the document",e)}throw e}};a.toggleDraftActive=async function t(e){const n=e.getObject();let i;const o=e&&this._getProgrammingModel(e)===vt.Draft;if(!o||!(!n.IsActiveEntity&&n.HasActiveEntity||n.IsActiveEntity&&n.HasDraftEntity)){return}if(!n.IsActiveEntity&&n.HasActiveEntity){i=false}else{i=true}try{const t=this._getRootViewController();const n=t.isFclEnabled()?t.getRightmostContext():e;const o=await this._computeSiblingInformation(e,n,vt.Draft,false);if(o){this._setEditMode(i?_t.Editable:_t.Display,false);if(t.isFclEnabled()){const t=this._getSemanticMapping();if((t===null||t===void 0?void 0:t.technicalPath)===e.getPath()){const e=o.pathMapping[o.pathMapping.length-1].newPath;o.pathMapping.push({oldPath:t.semanticPath,newPath:e})}this._updatePathsInHistory(o.pathMapping)}await this._handleNewContext(o.targetContext,i,true,true,true)}else{return Promise.reject("Error in EditFlow.toggleDraftActive - Cannot find sibling")}}catch(t){return Promise.reject(`Error in EditFlow.toggleDraftActive:${t}`)}};a.cancelDocument=async function e(n,i){const o=this._getTransactionHelper();const r=this._getResourceBundle();const a=i;let s;a.cancelButton=i.control||a.cancelButton;a.beforeCancelCallBack=this.base.editFlow.onBeforeDiscard;try{await this._syncTask();const t=this._getProgrammingModel(n);if((t===vt.Sticky||n.getProperty("HasActiveEntity"))&&this._isFclEnabled()){const e=this._getRootViewController();s=await this._computeSiblingInformation(n,e.getRightmostContext(),t,true)}const e=await o.cancelDocument(n,a,this.getAppComponent(),r,this._getMessageHandler(),this._getCreationMode(),this._isDocumentModified());const i=true;this._removeStickySessionInternalProperties(t);this._setEditMode(_t.Display,false);this._setDocumentModified(false);this._setDraftStatus(Ct.Clear);l.setEditStateDirty();if(!e){this._sendActivity(dt.Discard,undefined);if(!a.skipBackNavigation){await this._getRoutingListener().navigateBackFromContext(n)}}else{const o=e;this._sendActivity(dt.Discard,o);let r=o;if(this._isFclEnabled()){s=s??this._createSiblingInfo(n,o);this._updatePathsInHistory(s.pathMapping);if(s.targetContext.getPath()!==o.getPath()){r=s.targetContext}}if(t===vt.Draft){await this._fetchSemanticKeyValues(o);if(!a.skipBindingToView){await this._handleNewContext(r,false,true,i,true)}else{return o}}else{await this._handleNewContext(r,false,false,i,true)}}}catch(e){t.error("Error while discarding the document",e)}};a.isDraftRoot=function t(e){const n=e.getModel().getMetaModel();const i=n.getMetaContext(e.getPath());return g.isDraftRoot(at(i).targetEntitySet)};a.deleteDocument=async function n(i,o){const r=e.getAppComponent(this.getView());let a=o;if(!a){a={bFindActiveContexts:false}}else{a.bFindActiveContexts=false}a.beforeDeleteCallBack=this.base.editFlow.onBeforeDelete;try{if(this._isFclEnabled()&&this.isDraftRoot(i)&&i.getIndex()===undefined&&i.getProperty("IsActiveEntity")===true&&i.getProperty("HasDraftEntity")===true){a.beforeDeleteCallBack=async e=>{await this.base.editFlow.onBeforeDelete(e);try{const t=i.getModel();const e=t.bindContext(`${i.getPath()}/SiblingEntity`).getBoundContext();const n=await e.requestCanonicalPath();const o=t.getKeepAliveContext(n);o.replaceWith(i)}catch(e){t.error("Error while replacing the draft instance in the LR ODLB",e)}}}await this._deleteDocumentTransaction(i,a);if(!this._isFclEnabled()){l.setEditStateDirty()}this._sendActivity(dt.Delete,i);if(r){r.getShellServices().setBackNavigation()}if((r===null||r===void 0?void 0:r.getStartupMode())===bt.Deeplink&&!this._isFclEnabled()){r.getRouterProxy().exitFromApp()}else{this._getRoutingListener().navigateBackFromContext(i)}}catch(e){t.error("Error while deleting the document",e)}};a.applyDocument=async function t(e){const i=this._getGlobalUIModel();n.lock(i);try{await this._syncTask();await this._submitOpenChanges(e);await this._checkForValidationErrors();await this._getMessageHandler().showMessageDialog();await this._getRoutingListener().navigateBackFromContext(e)}finally{if(n.isLocked(i)){n.unlock(i)}}};a.invokeAction=async function e(n,i,o){var r;let a;const s=this._getTransactionHelper();let c;let g;let d;const u=this.getView();let h=i||{};if(h.isA&&h.isA("sap.ui.model.odata.v4.Context")||Array.isArray(h)||o!==undefined){const t=h;h=o||{};if(t){h.contexts=t}else{h.model=this.getView().getModel()}}h.isNavigable=h.requiresNavigation||h.isNavigable;const f=this.getView().getModel();const p=f===null||f===void 0?void 0:(r=f.getMetaModel())===null||r===void 0?void 0:r.getObject("/"+n.split("(")[0]);if(p){if(!Array.isArray(p)){h.isBound=p.$IsBound?p.$IsBound:false}else if(p[0].$kind==="Action"&&p[0].$IsBound===true){h.isBound=true}}else{throw new Error("Error in EditFlow.invokeAction: The specified action could not be found")}if(!h.parentControl){h.parentControl=this.getView()}if(h.controlId){a=this.getView().byId(h.controlId);if(a){h.internalModelContext=a.getBindingContext("internal")}}else{h.internalModelContext=u.getBindingContext("internal")}if(n&&n.indexOf("(")>-1){c=n.split("(");n=c[0];g=c[c.length-1].replaceAll(")","")}if(h.bStaticAction){if(a.isTableBound()){h.contexts=a.getRowBinding().getHeaderContext()}else{const t=a.data("rowsBindingInfo").path,e=new v(this.getView().getModel(),t);h.contexts=e.getHeaderContext()}if(g&&a.getBindingContext()){h.contexts=this._getActionOverloadContextFromMetadataPath(a.getBindingContext(),a.getRowBinding(),g)}if(h.enableAutoScroll){d=this._createActionPromise(n,a.sId)}}h.bGetBoundContext=this._getBoundContext(u,h);h.bObjectPage=u.getViewData().converterType==="ObjectPage";try{await this._syncTask();const e=await s.callAction(n,h,this.getView(),this.getAppComponent(),this._getMessageHandler());if(h.contexts&&h.isBound===true){await this._refreshListIfRequired(this._getActionResponseDataAndKeys(n,e),h.contexts[0])}this._sendActivity(dt.Action,h.contexts,n);this._triggerConfiguredSurvey(n,st.action);if(d){d.fResolver(e)}if(h.contexts){if(!this._isFclEnabled()){l.setEditStateDirty()}this._getInternalModel().setProperty("/lastInvokedAction",n)}if(h.isNavigable){let n=e;if(Array.isArray(n)&&n.length===1){n=n[0].value}if(n&&!Array.isArray(n)){const e=u.getModel().getMetaModel();const i=e.getMetaPath(n.getPath());const o=(t,e)=>t.filter(t=>{if(e){return e.indexOf(t)>-1}return true});const r=Array.isArray(h.contexts)?o(h.contexts,h.applicableContext)[0]:h.contexts;const a=r&&e.getMetaPath(r.getPath());if(i!=undefined&&i===a){if(r.getPath()!==n.getPath()){this._getRoutingListener().navigateForwardToContext(n,{checkNoHashChange:true,noHistoryEntry:false})}else{t.info("Navigation to the same context is not allowed")}}}}return e}catch(t){if(d){d.fRejector()}if(t===mt.CancelActionDialog){throw new Error("Dialog cancelled")}else if(!(t&&(t.canceled||t.rejectedItems&&t.rejectedItems[0].canceled))){throw new Error(`Error in EditFlow.invokeAction:${t}`)}}};a.securedExecution=function t(e,i){const o=i&&i.busy&&i.busy.set!==undefined?i.busy.set:true,r=i&&i.busy&&i.busy.check!==undefined?i.busy.check:true,a=i&&i.updatesDocument||false,s=this._getGlobalUIModel(),c=this.base.getView().getBindingContext(),g=c&&this._getProgrammingModel(c)===vt.Draft;if(r&&n.isLocked(s)){return Promise.reject("Application already busy therefore execution rejected")}if(o){n.lock(s)}if(a&&g){this._setDraftStatus(Ct.Saving)}this._getMessageHandler().removeTransitionMessages();return this._syncTask(e).then(()=>{if(a){this._setDocumentModified(true);if(!this._isFclEnabled()){l.setEditStateDirty()}if(g){this._setDraftStatus(Ct.Saved)}}}).catch(t=>{if(a&&g){this._setDraftStatus(Ct.Clear)}return Promise.reject(t)}).finally(()=>{if(o){n.unlock(s)}this._getMessageHandler().showMessageDialog()})};a.handlePatchSent=function t(e){var n,i;const o=ht(this.getView());if(o){e.getSource().getModel().setIgnoreETag(true)}if(!((n=this.getView())!==null&&n!==void 0&&(i=n.getBindingContext("internal"))!==null&&i!==void 0&&i.getProperty("skipPatchHandlers"))){const t=new Promise((t,n)=>{e.getSource().attachEventOnce("patchCompleted",i=>{if(o){e.getSource().getModel().setIgnoreETag(false)}if(e.getSource().isA("sap.ui.model.odata.v4.ODataListBinding")){var r;m.setActionEnablementAfterPatch(this.getView(),e.getSource(),(r=this.getView())===null||r===void 0?void 0:r.getBindingContext("internal"))}const a=i.getParameter("success");if(a){t()}else{n()}})});this.updateDocument(e.getSource(),t)}};a.handleCreateActivate=async function e(n){const i=n.getSource();const o=this._getTransactionHelper();const r=true;const a=true;const s={creationMode:wt.Inline,createAtEnd:r,inactive:a,keepTransientContextOnFailed:false,busyMode:"None"};try{var c;const e=n.getParameter("context");(c=e.created())===null||c===void 0?void 0:c.then(()=>{this._sendActivity(dt.Create,e)}).catch(()=>{t.warning(`Failed to activate context ${e.getPath()}`)});const r=await o.createDocument(i,s,this.getAppComponent(),this._getMessageHandler(),false,this.getView());if(r){if(!this._isFclEnabled()){l.setEditStateDirty()}}}catch(e){t.error("Failed to activate new row -",e)}};a._setEditMode=function t(e,n){this.getInternalEditFlow().setEditMode(e,n)};a._getCreationMode=function t(){return this.getInternalEditFlow().getCreationMode()};a._isDocumentModified=function t(){return this.getInternalEditFlow().isDocumentModified()};a._setDocumentModified=function t(e){this.getInternalEditFlow().setDocumentModified(e)};a._setDocumentModifiedOnCreate=function t(e){this.getInternalEditFlow().setDocumentModifiedOnCreate(e)};a._setDraftStatus=function t(e){this.getInternalEditFlow().setDraftStatus(e)};a._getRoutingListener=function t(){return this.getInternalEditFlow().getRoutingListener()};a._getGlobalUIModel=function t(){return this.getInternalEditFlow().getGlobalUIModel()};a._syncTask=function t(e){return this.getInternalEditFlow().syncTask(e)};a._getProgrammingModel=function t(e){return this.getInternalEditFlow().getProgrammingModel(e)};a._deleteDocumentTransaction=function t(e,n){return this.getInternalEditFlow().deleteDocumentTransaction(e,n)};a._handleCreateEvents=function t(e){this.getInternalEditFlow().handleCreateEvents(e)};a._getTransactionHelper=function t(){return this.getInternalEditFlow().getTransactionHelper()};a._getInternalModel=function t(){return this.getInternalEditFlow().getInternalModel()};a._getRootViewController=function t(){return this.getAppComponent().getRootViewController()};a._getResourceBundle=function t(){return this.getView().getController().oResourceBundle};a._getSemanticMapping=function t(){return this.getAppComponent().getRoutingService().getLastSemanticMapping()};a._createActionPromise=function t(e,n){return this.getInternalEditFlow().createActionPromise(e,n)};a._getCurrentActionPromise=function t(){return this.getInternalEditFlow().getCurrentActionPromise()};a._deleteCurrentActionPromise=function t(){return this.getInternalEditFlow().deleteCurrentActionPromise()};a._getMessageHandler=function t(){return this.getInternalEditFlow().getMessageHandler()};a._sendActivity=function t(e,n,i){const o=Array.isArray(n)?n.map(t=>t.getPath()):n===null||n===void 0?void 0:n.getPath();ut(this.getView(),e,o,i)};a._triggerConfiguredSurvey=function t(e,n){ct(this.getView(),e,n)};a._getActionResponseDataAndKeys=function t(e,n){return this.getInternalEditFlow().getActionResponseDataAndKeys(e,n)};a._submitOpenChanges=async function t(e){const i=e.getModel(),o=this._getGlobalUIModel();try{await i.submitBatch("$auto");await i.oRequestor.waitForRunningChangeRequests("$auto");if(i.hasPendingChanges("$auto")){throw new Error("submit of open changes failed")}}finally{if(n.isLocked(o)){n.unlock(o)}}};a._handleStickyOn=function t(e){return this.getInternalEditFlow().handleStickyOn(e)};a._handleStickyOff=function t(){return this.getInternalEditFlow().handleStickyOff()};a._onBackNavigationInSession=function t(){return this.getInternalEditFlow().onBackNavigationInSession()};a._setStickySessionInternalProperties=function t(e,n){if(e===vt.Sticky){const t=this._getInternalModel();t.setProperty("/sessionOn",true);t.setProperty("/stickySessionToken",n.getHttpHeaders(true)["SAP-ContextId"])}};a._removeStickySessionInternalProperties=function t(e){if(e===vt.Sticky){const t=this._getInternalModel();t.setProperty("/sessionOn",false);t.setProperty("/stickySessionToken",undefined);this._handleStickyOff()}};a._handleNewContext=async function t(e,n,i,o){let r=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;if(!this._isFclEnabled()){l.setEditStateDirty()}await this._getRoutingListener().navigateToContext(e,{checkNoHashChange:true,editable:n,bPersistOPScroll:true,bRecreateContext:i,bDraftNavigation:o,showPlaceholder:false,bForceFocus:r,keepCurrentLayout:true})};a._getBoundContext=function t(e,n){const i=e.getViewData().viewLevel;const o=i>1||i===1&&n.controlId;return!n.isNavigable||!!o};a._checkForValidationErrors=function t(){return this._syncTask().then(()=>{const t=this.base.getView().getId();const e=sap.ui.getCore().getMessageManager().getMessageModel().getData();let n;let i;if(!e.length){return Promise.resolve("No validation errors found")}for(let o=0;o<e.length;o++){i=e[o];if(i.validation){n=h.byId(i.getControlId());while(n){if(n.getId()===t){return Promise.reject("validation errors exist")}n=n.getParent()}}}})};a._refreshListIfRequired=function n(i,o){if(!o||!i||!i.oData){return Promise.resolve()}const r=o.getBinding();if(r&&r.isA("sap.ui.model.odata.v4.ODataListBinding")){const n=i.oData;const a=i.keys;const s=o.getObject();let c=true;if(Object.keys(n).length){c=a.every(function(t){return s[t]===n[t]});if(!c){return new Promise(n=>{if(r.isRoot()){r.attachEventOnce("dataReceived",function(){n()});r.refresh()}else{const i=e.getAppComponent(this.getView());i.getSideEffectsService().requestSideEffects([{$NavigationPropertyPath:r.getPath()}],r.getContext()).then(function(){n()},function(){t.error("Error while refreshing the table");n()}).catch(function(e){t.error("Error while refreshing the table",e)})}})}}}return Promise.resolve()};a._fetchSemanticKeyValues=function t(e){const n=e.getModel().getMetaModel(),i=n.getMetaContext(e.getPath()).getObject("@sapui.name"),o=d.getSemanticKeys(n,i);if(o&&o.length){const t=o.map(function(t){return e.requestObject(t.$PropertyPath)});return Promise.all(t)}else{return Promise.resolve()}};a._getActionOverloadContextFromMetadataPath=function t(e,n,i){const o=e.getModel();const r=o.getMetaModel();let a=n.getPath().split("/");let s=e;a.pop();if(a.length===0){a=[""]}if(a[0]!==""){a.unshift("")}const c=a.map(t=>{if(t!==""){s=o.bindContext(t,s).getBoundContext()}else{s=e}return s}).reverse();const l=c.find(t=>r.getMetaContext(t.getPath()).getObject("$Type")===i);return l||n.getHeaderContext()};a._createSiblingInfo=function t(e,n){return{targetContext:n,pathMapping:[{oldPath:e.getPath(),newPath:n.getPath()}]}};a._updatePathsInHistory=function t(e){const n=this.getAppComponent();n.getRouterProxy().setPathMapping(e);const i=this._getSemanticMapping();if(e.length&&(i===null||i===void 0?void 0:i.technicalPath)===e[e.length-1].oldPath){i.technicalPath=e[e.length-1].newPath}};a._getNavigationTargetForEdit=function t(e,n,i){let o;i=i??this._createSiblingInfo(e,n);this._updatePathsInHistory(i.pathMapping);if(i.targetContext.getPath()!=n.getPath()){o=i.targetContext}return o};a._computeSiblingInformation=async function e(n,i,o,a){i=i??n;if(!i.getPath().startsWith(n.getPath())){t.error("Cannot compute rightmost sibling context");throw new Error("Cannot compute rightmost sibling context")}if(a&&i.getPath()===n.getPath()){return Promise.resolve(undefined)}const s=n.getModel();if(o===vt.Draft){return r.computeSiblingInformation(n,i)}else{return{targetContext:s.bindContext(i.getPath()).getBoundContext(),pathMapping:[]}}};a._isFclEnabled=function t(){return e.getAppComponent(this.getView())._isFclEnabled()};return o}(y),yt(et.prototype,"editDocument",[_,b],Object.getOwnPropertyDescriptor(et.prototype,"editDocument"),et.prototype),yt(et.prototype,"deleteMultipleDocuments",[M,P],Object.getOwnPropertyDescriptor(et.prototype,"deleteMultipleDocuments"),et.prototype),yt(et.prototype,"updateDocument",[D,E],Object.getOwnPropertyDescriptor(et.prototype,"updateDocument"),et.prototype),yt(et.prototype,"createDocument",[x,S],Object.getOwnPropertyDescriptor(et.prototype,"createDocument"),et.prototype),yt(et.prototype,"onBeforeSave",[A,I],Object.getOwnPropertyDescriptor(et.prototype,"onBeforeSave"),et.prototype),yt(et.prototype,"onBeforeCreate",[F,k],Object.getOwnPropertyDescriptor(et.prototype,"onBeforeCreate"),et.prototype),yt(et.prototype,"onBeforeEdit",[O,B],Object.getOwnPropertyDescriptor(et.prototype,"onBeforeEdit"),et.prototype),yt(et.prototype,"onBeforeDiscard",[R,T],Object.getOwnPropertyDescriptor(et.prototype,"onBeforeDiscard"),et.prototype),yt(et.prototype,"onBeforeDelete",[V,j],Object.getOwnPropertyDescriptor(et.prototype,"onBeforeDelete"),et.prototype),yt(et.prototype,"saveDocument",[H,N],Object.getOwnPropertyDescriptor(et.prototype,"saveDocument"),et.prototype),yt(et.prototype,"toggleDraftActive",[L,$],Object.getOwnPropertyDescriptor(et.prototype,"toggleDraftActive"),et.prototype),yt(et.prototype,"cancelDocument",[q,K],Object.getOwnPropertyDescriptor(et.prototype,"cancelDocument"),et.prototype),yt(et.prototype,"deleteDocument",[U,G],Object.getOwnPropertyDescriptor(et.prototype,"deleteDocument"),et.prototype),yt(et.prototype,"applyDocument",[z,W],Object.getOwnPropertyDescriptor(et.prototype,"applyDocument"),et.prototype),yt(et.prototype,"invokeAction",[J,Q],Object.getOwnPropertyDescriptor(et.prototype,"invokeAction"),et.prototype),yt(et.prototype,"securedExecution",[X,Y],Object.getOwnPropertyDescriptor(et.prototype,"securedExecution"),et.prototype),yt(et.prototype,"handlePatchSent",[Z],Object.getOwnPropertyDescriptor(et.prototype,"handlePatchSent"),et.prototype),et))||tt);return Pt},false);
//# sourceMappingURL=EditFlow.js.map