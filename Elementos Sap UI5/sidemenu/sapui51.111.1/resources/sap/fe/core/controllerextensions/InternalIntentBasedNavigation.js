/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/navigation/SelectionVariant","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/model/json/JSONModel","../converters/helpers/Aggregation"],function(t,e,o,n,i,r,a,s,l,c,p,g,u,f,d,v,h){"use strict";var m,y,b,O,C,P,A,x,S,M,_,j,w,N,E,$,D,F,V,I,B,R,T;var L=h.AggregationHelper;var k=r.publicExtension;var W=r.privateExtension;var z=r.methodOverride;var U=r.finalExtension;var H=r.extensible;var J=r.defineUI5Class;function q(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;G(t,e)}function G(t,e){G=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,o){e.__proto__=o;return e};return G(t,e)}function X(t,e,o,n,i){var r={};Object.keys(n).forEach(function(t){r[t]=n[t]});r.enumerable=!!r.enumerable;r.configurable=!!r.configurable;if("value"in r||r.initializer){r.writable=true}r=o.slice().reverse().reduce(function(o,n){return n(t,e,o)||o},r);if(i&&r.initializer!==void 0){r.value=r.initializer?r.initializer.call(i):void 0;r.initializer=undefined}if(r.initializer===void 0){Object.defineProperty(t,e,r);r=null}return r}let K=(m=J("sap.fe.core.controllerextensions.InternalInternalBasedNavigation"),y=z(),b=k(),O=U(),C=k(),P=U(),A=k(),x=U(),S=k(),M=H(u.Instead),_=k(),j=U(),w=W(),N=k(),E=U(),$=k(),D=U(),F=k(),V=U(),I=k(),B=U(),m(R=(T=function(r){q(g,r);function g(){return r.apply(this,arguments)||this}var u=g.prototype;u.onInit=function t(){this._oAppComponent=this.base.getAppComponent();this._oMetaModel=this._oAppComponent.getModel().getMetaModel();this._oNavigationService=this._oAppComponent.getNavigationService();this._oView=this.base.getView()};u.navigate=function t(o,i,r){const p=t=>{const n=r&&r.navigationContexts,s=n&&!Array.isArray(n)?[n]:n,p=r&&r.semanticObjectMapping,g=r&&r.additionalNavigationParameters,u={semanticObject:o,action:i},f=this.base.getView(),d=f.getController();if(t){this._oView.setBindingContext(t)}if(o&&i){let t=[],n=new l;if(s&&s.length){s.forEach(e=>{if(e.isA&&e.isA("sap.ui.model.odata.v4.Context")){let o=e.getObject();const n=this._oMetaModel.getMetaPath(e.getPath());o=this.removeSensitiveData(o,n);const i=this.prepareContextForExternalNavigation(o,e);u["propertiesWithoutConflict"]=i.propertiesWithoutConflict;t.push(i.semanticAttributes)}else if(!(e&&Array.isArray(e.data))&&typeof e==="object"){t.push(this.removeSensitiveData(e.data,e.metaPath))}else if(e&&Array.isArray(e.data)){t=this.removeSensitiveData(e.data,e.metaPath)}})}if(t&&t.length){n=this._oNavigationService.mixAttributesAndSelectionVariant(t,n.toJSONString())}const v=this._oView.getModel(),h=this.getEntitySet(),m=h?this._oNavigationService.constructContextUrl(h,v):undefined;if(m){n.setFilterContextUrl(m)}if(g){this._applyOutboundParams(n,g)}d.intentBasedNavigation.adaptNavigationContext(n,u);if(p){this._applySemanticObjectMappings(n,p)}this._removeTechnicalParameters(n);const y=d._intentBasedNavigation.getNavigationMode();const b=r&&r.refreshStrategies||{},O=f.getModel("internal");if(O){if((f&&f.getViewData()).refreshStrategyOnAppRestore){const t=f.getViewData().refreshStrategyOnAppRestore||{};e(b,t)}const t=a.getRefreshStrategyForIntent(b,o,i);if(t){O.setProperty("/refreshStrategyOnAppRestore",t)}}const C=function(){sap.ui.require(["sap/m/MessageBox"],function(t){const e=c.getLibraryResourceBundle("sap.fe.core");t.error(e.getText("C_COMMON_HELPER_NAVIGATION_ERROR_MESSAGE"),{title:e.getText("C_COMMON_SAPFE_ERROR")})})};this._oNavigationService.navigate(o,i,n.toJSONString(),undefined,C,undefined,y)}else{throw new Error("Semantic Object/action is not provided")}};const g=this.base.getView().getBindingContext();const u=g&&g.getModel().getMetaModel();if(this.getView().getViewData().converterType==="ObjectPage"&&u&&!s.isStickySessionSupported(u)){n.processDataLossOrDraftDiscardConfirmation(p.bind(this),Function.prototype,this.base.getView().getBindingContext(),this.base.getView().getController(),true,n.NavigationType.ForwardNavigation)}else{p()}};u.prepareContextForExternalNavigation=function t(e,o){const n={},i=o.getPath(),r=o.getModel().getMetaModel(),a=r.getMetaPath(i),s=a.split("/").filter(Boolean);function l(t,e){for(const o in t){if(t[o]===null||typeof t[o]!=="object"){if(!n[o]){n[o]=[]}n[o].push(e)}else{const n=t[o];l(n,`${e}/${o}`)}}}l(e,a);const c=s[0],p=r.getObject(`/${c}/@sapui.name`),g={};let u,f,d;for(const t in n){const i=n[t];let s;if(i.length>1){for(let n=0;n<=i.length-1;n++){const s=i[n];let l=s.replace(s===a?a:`${a}/`,"");l=(l===""?l:`${l}/`)+t;const c=r.getObject(`${s}/@sapui.name`);if(c===p){u=l}if(s===a){f=l}d=l;e[`${a}/${l}`.split("/").filter(function(t){return t!=""}).join(".")]=o.getProperty(l)}s=u||f||d;e[t]=o.getProperty(s);u=undefined;f=undefined;d=undefined}else{const n=i[0];let r=n.replace(n===a?a:`${a}/`,"");r=(r===""?r:`${r}/`)+t;e[t]=o.getProperty(r);g[t]=`${a}/${r}`.split("/").filter(function(t){return t!=""}).join(".")}}for(const t in e){if(e[t]!==null&&typeof e[t]==="object"){delete e[t]}}return{semanticAttributes:e,propertiesWithoutConflict:g}};u.prepareFiltersForExternalNavigation=function t(e,o,n){let i;const r={};const a={};let s,l,c,p,g;function u(t){let e;for(let n in t){if(t[n]){if(n.includes("/")){e=n;const t=n.split("/");n=t[t.length-1]}else{e=o}if(!r[n]){r[n]=[]}r[n].push(e)}}}u(e);for(const t in r){const u=r[t];if(u.length>1){for(let r=0;r<=u.length-1;r++){i=u[r];if(i===o){c=`${o}/${t}`;g=t;s=t;if(n&&n.includes(t)){e[`$Parameter.${t}`]=e[t]}}else{g=i;c=`${o}/${i}`.replaceAll(/\*/g,"");l=i}e[c.split("/").filter(function(t){return t!=""}).join(".")]=e[g];delete e[i]}p=s||l;e[t]=e[p]}else{i=u[0];c=i===o?`${o}/${t}`:`${o}/${i}`.replaceAll("*","");a[t]=c.split("/").filter(function(t){return t!=""}).join(".");if(n&&n.includes(t)){e[`$Parameter.${t}`]=e[t]}}}return{filterConditions:e,filterConditionsWithoutConflict:a}};u.getNavigationMode=function t(){return undefined};u.navigateWithConfirmationDialog=function e(o,n,i){var r;if(i!==null&&i!==void 0&&i.notApplicableContexts&&((r=i.notApplicableContexts)===null||r===void 0?void 0:r.length)>=1){let e;const r={onClose:function(){e.close()},onContinue:()=>{i.navigationContexts=i.applicableContexts;e.close();this.navigate(o,n,i)}};const a=function(){let t;const o=i.notApplicableContexts.length,n=[];for(let e=0;e<i.notApplicableContexts.length;e++){t=i.notApplicableContexts[e].getObject();n.push(t)}const r=new v(n);const a=new v({total:o,label:i.label});e.setModel(r,"notApplicable");e.setModel(a,"totals");e.open()};const s="sap.fe.core.controls.ActionPartial";const l=d.loadTemplate(s,"fragment");const c=this._oView.getModel();const g=c.getMetaModel();const u=i.notApplicableContexts[0].getCanonicalPath();const h=`${u.substr(0,u.indexOf("("))}/`;Promise.resolve(f.process(l,{name:s},{bindingContexts:{entityType:g.createBindingContext(h)},models:{entityType:g,metaModel:g}})).then(function(t){return p.load({definition:t,controller:r})}).then(t=>{e=t;this.getView().addDependent(t);a()}).catch(function(){t.error("Error")})}else{this.navigate(o,n,i)}};u._removeTechnicalParameters=function t(e){e.removeSelectOption("@odata.context");e.removeSelectOption("@odata.metadataEtag");e.removeSelectOption("SAP__Messages")};u.getEntitySet=function t(){return this._oView.getViewData().entitySet};u.removeSensitiveData=function t(e,o){if(e){const{transAggregations:t,customAggregates:n}=this._getAggregates(o,this.base.getView(),this.base.getAppComponent().getDiagnostics());const i=Object.keys(e);if(i.length){delete e["@odata.context"];delete e["@odata.metadataEtag"];delete e["SAP__Messages"];for(let r=0;r<i.length;r++){if(e[i[r]]&&typeof e[i[r]]==="object"){this.removeSensitiveData(e[i[r]],`${o}/${i[r]}`)}const a=i[r];if(a.indexOf("@odata.type")>-1){delete e[i[r]];continue}this._deleteAggregates([...t,...n],i[r],e);const s=this._getPropertyAnnotations(a,o,e,this._oMetaModel);if(s){if(s["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||s["com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]||s["com.sap.vocabularies.Analytics.v1.Measure"]){delete e[a]}else if(s["com.sap.vocabularies.Common.v1.FieldControl"]){const t=s["com.sap.vocabularies.Common.v1.FieldControl"];if(t["$EnumMember"]&&t["$EnumMember"].split("/")[1]==="Inapplicable"){delete e[a]}else if(t["$Path"]&&this._isFieldControlPathInapplicable(t["$Path"],e)){delete e[a]}}}}}}return e};u._deleteAggregates=function t(e,o,n){if(e&&e.indexOf(o)>-1){delete n[o]}};u._getPropertyAnnotations=function t(e,o,n,r){if(n[e]&&o&&!o.includes("undefined")){var a,s;const t=r.createBindingContext(`${o}/${e}`);const n=i.getInvolvedDataModelObjects(t);return n===null||n===void 0?void 0:(a=n.targetObject)===null||a===void 0?void 0:(s=a.annotations)===null||s===void 0?void 0:s._annotations}return null};u._getAggregates=function t(e,o,n){const i=this._getConverterContext(e,o,n);const r=new L(i.getEntityType(),i);const a=r.isAnalyticsSupported();let s=[],l=[];if(a){s=r.getTransAggregations();if(s.length){s=s.map(t=>t.Name||t.Value)}l=r.getCustomAggregateDefinitions();if(l.length){l=l.map(t=>t.qualifier)}}return{transAggregations:s,customAggregates:l}};u._getConverterContext=function t(e,n,i){const r=n.getViewData();let a=r.entitySet;const s=r.contextPath;if(s&&(!a||a.includes("/"))){a=r===null||r===void 0?void 0:r.fullContextPath.split("/")[1]}return o.getConverterContextForPath(e,n.getModel().getMetaModel(),a,i)};u._isFieldControlPathInapplicable=function t(e,o){let n=false;const i=e.split("/");if(i.length>1){n=o[i[0]]&&o[i[0]].hasOwnProperty(i[1])&&o[i[0]][i[1]]===0}else{n=o[e]===0}return n};u._applySemanticObjectMappings=function t(e,o){const n=typeof o==="string"?JSON.parse(o):o;for(let t=0;t<n.length;t++){const o=n[t]["LocalProperty"]&&n[t]["LocalProperty"]["$PropertyPath"]||n[t]["@com.sap.vocabularies.Common.v1.LocalProperty"]&&n[t]["@com.sap.vocabularies.Common.v1.LocalProperty"]["$Path"];const i=n[t]["SemanticObjectProperty"]||n[t]["@com.sap.vocabularies.Common.v1.SemanticObjectProperty"];const r=e.getSelectOption(o);if(r){e.removeSelectOption(o);e.massAddSelectOption(i,r)}}return e};u.navigateOutbound=function e(o,n){var i,r;let a;const s=this.base.getAppComponent().getManifestEntry("sap.app"),l=(i=s.crossNavigation)===null||i===void 0?void 0:(r=i.outbounds)===null||r===void 0?void 0:r[o];if(!l){t.error("Outbound is not defined in manifest!!");return}const c=l.semanticObject,p=l.action,g=l.parameters&&this.getOutboundParams(l.parameters);if(n){a=[];Object.keys(n).forEach(function(t){let e;if(Array.isArray(n[t])){const i=n[t];for(let n=0;n<i.length;n++){var o;e={};e[t]=i[n];(o=a)===null||o===void 0?void 0:o.push(e)}}else{var i;e={};e[t]=n[t];(i=a)===null||i===void 0?void 0:i.push(e)}})}if(a||g){n={navigationContexts:{data:a||g}}}this.base._intentBasedNavigation.navigate(c,p,n)};u._applyOutboundParams=function t(e,o){const n=Object.keys(o);const i=e.getSelectOptionsPropertyNames();n.forEach(function(t){if(!i.includes(t)){e.addSelectOption(t,"I","EQ",o[t])}});return e};u.getOutboundParams=function t(e){const o={};if(e){const t=Object.keys(e)||[];if(t.length>0){t.forEach(function(t){const n=e[t];if(n.value&&n.value.value&&n.value.format==="plain"){if(!o[t]){o[t]=n.value.value}}})}}return o};u.onChevronPressNavigateOutBound=function t(e,o,n,i){const r=e.getAppComponent().getRoutingService().getOutbounds();const a=r[o];let l;if(a&&a.semanticObject&&a.action){const t={intents:{}};const o={};let r;if(n){if(n.isA&&n.isA("sap.ui.model.odata.v4.Context")){r=s.getMetaPathForContext(n);n=[n]}else{r=s.getMetaPathForContext(n[0])}o[r]="self";t["_feDefault"]=o}if(i){const e=`${a.semanticObject}-${a.action}`;t.intents[e]={};t.intents[e][i]="self"}if(a&&a.parameters){const t=a.parameters&&this.getOutboundParams(a.parameters);if(Object.keys(t).length>0){l=t}}e._intentBasedNavigation.navigate(a.semanticObject,a.action,{navigationContexts:n,refreshStrategies:t,additionalNavigationParameters:l});return Promise.resolve()}else{throw new Error(`outbound target ${o} not found in cross navigation definition of manifest`)}};return g}(g),X(T.prototype,"onInit",[y],Object.getOwnPropertyDescriptor(T.prototype,"onInit"),T.prototype),X(T.prototype,"navigate",[b,O],Object.getOwnPropertyDescriptor(T.prototype,"navigate"),T.prototype),X(T.prototype,"prepareContextForExternalNavigation",[C,P],Object.getOwnPropertyDescriptor(T.prototype,"prepareContextForExternalNavigation"),T.prototype),X(T.prototype,"prepareFiltersForExternalNavigation",[A,x],Object.getOwnPropertyDescriptor(T.prototype,"prepareFiltersForExternalNavigation"),T.prototype),X(T.prototype,"getNavigationMode",[S,M],Object.getOwnPropertyDescriptor(T.prototype,"getNavigationMode"),T.prototype),X(T.prototype,"navigateWithConfirmationDialog",[_,j],Object.getOwnPropertyDescriptor(T.prototype,"navigateWithConfirmationDialog"),T.prototype),X(T.prototype,"getEntitySet",[w],Object.getOwnPropertyDescriptor(T.prototype,"getEntitySet"),T.prototype),X(T.prototype,"removeSensitiveData",[N,E],Object.getOwnPropertyDescriptor(T.prototype,"removeSensitiveData"),T.prototype),X(T.prototype,"navigateOutbound",[$,D],Object.getOwnPropertyDescriptor(T.prototype,"navigateOutbound"),T.prototype),X(T.prototype,"getOutboundParams",[F,V],Object.getOwnPropertyDescriptor(T.prototype,"getOutboundParams"),T.prototype),X(T.prototype,"onChevronPressNavigateOutBound",[I,B],Object.getOwnPropertyDescriptor(T.prototype,"onChevronPressNavigateOutBound"),T.prototype),T))||R);return K},false);
//# sourceMappingURL=InternalIntentBasedNavigation.js.map