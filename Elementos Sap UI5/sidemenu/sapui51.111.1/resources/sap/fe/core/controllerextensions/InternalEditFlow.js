/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/collaboration/ActivitySync","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/sticky","sap/fe/core/controllerextensions/editFlow/TransactionHelper","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/EditState","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/Text","sap/ui/core/mvc/ControllerExtension"],function(t,e,o,n,i,r,s,a,c,l,d,p,u,g){"use strict";var f,h,y,m,P,w,S,v,M,b,D,O,C,E,A,k,I,T,R,x,_,j,B,N,H,G,F,V,U,L,$,z,K,W,q,J,X,Q,Y,Z,tt,et,ot,nt,it,rt,st;var at=a.publicExtension;var ct=a.finalExtension;var lt=a.defineUI5Class;var dt=i.Activity;var pt=n.send;function ut(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;gt(t,e)}function gt(t,e){gt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,o){e.__proto__=o;return e};return gt(t,e)}function ft(t,e,o,n,i){var r={};Object.keys(n).forEach(function(t){r[t]=n[t]});r.enumerable=!!r.enumerable;r.configurable=!!r.configurable;if("value"in r||r.initializer){r.writable=true}r=o.slice().reverse().reduce(function(o,n){return n(t,e,o)||o},r);if(i&&r.initializer!==void 0){r.value=r.initializer?r.initializer.call(i):void 0;r.initializer=undefined}if(r.initializer===void 0){Object.defineProperty(t,e,r);r=null}return r}const ht=l.ProgrammingModel,yt=l.DraftStatus,mt=l.EditMode,Pt=l.CreationMode;let wt=(f=lt("sap.fe.core.controllerextensions.InternalEditFlow"),h=at(),y=ct(),m=at(),P=ct(),w=at(),S=ct(),v=at(),M=ct(),b=at(),D=ct(),O=at(),C=ct(),E=at(),A=ct(),k=at(),I=ct(),T=at(),R=ct(),x=at(),_=ct(),j=at(),B=ct(),N=at(),H=ct(),G=at(),F=ct(),V=at(),U=ct(),L=at(),$=ct(),z=at(),K=ct(),W=at(),q=ct(),J=at(),X=ct(),Q=at(),Y=ct(),Z=at(),tt=ct(),et=at(),ot=ct(),nt=at(),it=ct(),f(rt=(st=function(n){ut(i,n);function i(){return n.apply(this,arguments)||this}var a=i.prototype;a.getAppComponent=function t(){return this.base.getAppComponent()};a.setCreationMode=function t(e){const o=this.base.getView().getBindingContext("ui");this.getGlobalUIModel().setProperty("createMode",e,o,true)};a.getCreationMode=function t(){const e=this.base.getView().getBindingContext("ui");return!!this.getGlobalUIModel().getProperty("createMode",e)};a.isDocumentModified=function t(){return!!this.getGlobalUIModel().getProperty("/isDocumentModified")};a.setDocumentModified=function t(e){this.getGlobalUIModel().setProperty("/isDocumentModified",e)};a.setDocumentModifiedOnCreate=function t(e){if(e.isRelative()){this.setDocumentModified(true)}};a.createMultipleDocuments=function n(i,r,s,a,c){let l=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;const d=this.getTransactionHelper(),p=this.getGlobalUIModel();o.lock(p);let u=[];return this.syncTask().then(()=>c?c({contextPath:i&&i.getPath()}):Promise.resolve()).then(()=>{const t=i.getModel(),e=t.getMetaModel();let o;if(i.getContext()){o=e.getMetaPath(`${i.getContext().getPath()}/${i.getPath()}`)}else{o=e.getMetaPath(i.getPath())}this.handleCreateEvents(i);const n=r.map(t=>{const n={data:{}};n.keepTransientContextOnFailed=false;n.busyMode="None";n.creationMode=Pt.CreationRow;n.parentControl=this.getView();n.createAtEnd=s;n.inactive=l;for(const i in t){const r=e.getObject(`${o}/${i}`);if(r&&r.$kind!=="NavigationProperty"&&t[i]){n.data[i]=t[i]}}return d.createDocument(i,n,this.getAppComponent(),this.getMessageHandler(),a,this.getView())});return Promise.all(n)}).then(t=>{if(!l){this.setDocumentModifiedOnCreate(i)}u=t;return Promise.all(t.map(function(t){if(!t.bInactive){return t.created()}}))}).then(()=>{const t=this.getView().getBindingContext();if(!e.hasTransientContext(i)){this.getAppComponent().getSideEffectsService().requestSideEffectsForNavigationProperty(i.getPath(),t)}}).catch(function(e){t.error("Error while creating multiple documents.");return Promise.reject(e)}).finally(function(){o.unlock(p)}).then(()=>u)};a.deleteMultipleDocuments=function n(i,r){const s=this.getGlobalUIModel();const a=this.getView().byId(r.controlId);if(!a){throw new Error("parameter controlId missing or incorrect")}else{r.parentControl=a}const l=a.getBinding("items")||a.getRowBinding();r.bFindActiveContexts=true;o.lock(s);return this.deleteDocumentTransaction(i,r).then(()=>{let t;if(a.isA("sap.ui.mdc.Table")){a.clearSelection()}const o=this.getView().getBindingContext();if(l.isRoot()){t=new Promise(t=>{l.attachEventOnce("dataReceived",function(){t()})});l.refresh()}else if(o){if(!e.hasTransientContext(l)){this.getAppComponent().getSideEffectsService().requestSideEffectsForNavigationProperty(l.getPath(),o)}}if(!this.getAppComponent()._isFclEnabled()){c.setEditStateDirty()}pt(this.getView(),dt.Delete,i.map(t=>t.getPath()));return t}).catch(function(e){t.error("Error while deleting the document(s)",e)}).finally(function(){o.unlock(s)})};a.computeEditMode=async function e(o){const n=this.getProgrammingModel(o);if(n===ht.Draft){try{this.setDraftStatus(yt.Clear);this._setEditablePending(true);const t=await o.requestObject("IsActiveEntity");if(t===false){this.setEditMode(mt.Editable);const t=await o.requestObject("HasActiveEntity");this.setEditMode(undefined,!t)}else{this.setEditMode(mt.Display,false)}this._setEditablePending(false)}catch(e){t.error("Error while determining the editMode for draft",e);throw e}}else if(n===ht.Sticky){const t=this.getInternalModel().getProperty("/lastInvokedAction");if(t&&this._hasNewActionForSticky(o,this.getView(),t)){this.setEditMode(mt.Editable,true);if(!this.getAppComponent()._isFclEnabled()){c.setEditStateDirty()}this.handleStickyOn(o);this.getInternalModel().setProperty("/lastInvokedAction",undefined)}}};a.setEditMode=function t(e,o){const n=this.getGlobalUIModel();if(e){n.setProperty("/isEditable",e==="Editable",undefined,true)}if(o!==undefined){this.setCreationMode(o)}};a._setEditablePending=function t(e){const o=this.getGlobalUIModel();o.setProperty("/isEditablePending",e,undefined,true)};a.setDraftStatus=function t(e){this.base.getView().getModel("ui").setProperty("/draftStatus",e,undefined,true)};a.getRoutingListener=function t(){if(this.base._routing){return this.base._routing}else{throw new Error("Edit Flow works only with a given routing listener")}};a.getGlobalUIModel=function t(){return this.base.getView().getModel("ui")};a.syncTask=function t(e){let o;if(e instanceof Promise){o=function(){return e}}else if(typeof e==="function"){o=e}this._pTasks=this._pTasks||Promise.resolve();if(o){this._pTasks=this._pTasks.then(o).catch(function(){return Promise.resolve()})}return this._pTasks};a.getProgrammingModel=function t(e){return this.getTransactionHelper().getProgrammingModel(e)};a.deleteDocumentTransaction=async function t(e,o){var n;const i=this.getView().getController().oResourceBundle,r=this.getTransactionHelper();o=o||{};o.internalModelContext=o.controlId?(n=sap.ui.getCore().byId(o.controlId))===null||n===void 0?void 0:n.getBindingContext("internal"):null;await this.syncTask();await r.deleteDocument(e,o,this.getAppComponent(),i,this.getMessageHandler());const s=this.getInternalModel();s.setProperty("/sessionOn",false);s.setProperty("/stickySessionToken",undefined)};a.handleCreateEvents=function t(e){this.setDraftStatus(yt.Clear);e=e.getBinding&&e.getBinding()||e;const o=this.getProgrammingModel(e);e.attachEvent("createSent",()=>{if(o===ht.Draft){this.setDraftStatus(yt.Saving)}});e.attachEvent("createCompleted",t=>{const e=t.getParameter("success");if(o===ht.Draft){this.setDraftStatus(e?yt.Saved:yt.Clear)}this.getMessageHandler().showMessageDialog()})};a.getTransactionHelper=function t(){return s};a.getInternalModel=function t(){return this.base.getView().getModel("internal")};a.createActionPromise=function t(e,o){let n,i;this.oActionPromise=new Promise((t,e)=>{n=t;i=e}).then(t=>Object.assign({controlId:o},this.getActionResponseDataAndKeys(e,t)));return{fResolver:n,fRejector:i}};a.getCurrentActionPromise=function t(){return this.oActionPromise};a.deleteCurrentActionPromise=function t(){this.oActionPromise=undefined};a.getActionResponseDataAndKeys=function t(e,o){if(Array.isArray(o)){if(o.length===1){o=o[0].value}else{return null}}if(!o){return null}const n=this.getView(),i=n.getModel().getMetaModel().getData(),r=i&&i[e]&&i[e][0]&&i[e][0].$ReturnType?i[e][0].$ReturnType.$Type:null,s=r&&i[r]?i[r].$Key:null;return{oData:o.getObject(),keys:s}};a.getMessageHandler=function t(){if(this.base.messageHandler){return this.base.messageHandler}else{throw new Error("Edit Flow works only with a given message handler")}};a.handleStickyOn=function e(o){const n=this.getAppComponent();try{if(n===undefined||o===undefined){throw new Error("undefined AppComponent or Context for function handleStickyOn")}if(!n.getRouterProxy().hasNavigationGuard()){const t=n.getRouterProxy().getHash(),e=this.getInternalModel();setTimeout(function(){n.getRouterProxy().setNavigationGuard(o.getPath().substring(1))},0);n.getShellServices().setBackNavigation(this.onBackNavigationInSession.bind(this));this.fnDirtyStateProvider=this._registerDirtyStateProvider(n,e,t);n.getShellServices().registerDirtyStateProvider(this.fnDirtyStateProvider);const i=this.getView().getModel("sap.fe.i18n");this.fnHandleSessionTimeout=this._attachSessionTimeout(o,i);this.getView().getModel().attachSessionTimeout(this.fnHandleSessionTimeout);this.fnStickyDiscardAfterNavigation=this._attachRouteMatched(this,o,n);n.getRoutingService().attachRouteMatched(this.fnStickyDiscardAfterNavigation)}}catch(e){t.info(e);return undefined}return true};a.handleStickyOff=function e(){const o=this.getAppComponent();try{if(o===undefined){throw new Error("undefined AppComponent for function handleStickyOff")}if(o&&o.getRouterProxy){o.getRouterProxy().discardNavigationGuard()}if(this.fnDirtyStateProvider){o.getShellServices().deregisterDirtyStateProvider(this.fnDirtyStateProvider);this.fnDirtyStateProvider=undefined}if(this.getView().getModel()&&this.fnHandleSessionTimeout){this.getView().getModel().detachSessionTimeout(this.fnHandleSessionTimeout)}o.getRoutingService().detachRouteMatched(this.fnStickyDiscardAfterNavigation);this.fnStickyDiscardAfterNavigation=undefined;this.setEditMode(mt.Display,false);if(o){o.getShellServices().setBackNavigation()}}catch(e){t.info(e);return undefined}return true};a.onBackNavigationInSession=function t(){const e=this.getView(),o=this.getAppComponent(),n=o.getRouterProxy();if(n.checkIfBackIsOutOfGuard()){const t=e&&e.getBindingContext();r.processDataLossConfirmation(async()=>{await this.discardStickySession(t);history.back()},e,this.getProgrammingModel(t));return}history.back()};a.discardStickySession=async function t(e){const o=await r.discardDocument(e);if(o!==null&&o!==void 0&&o.hasPendingChanges()){o.getBinding().resetChanges()}o===null||o===void 0?void 0:o.refresh();this.handleStickyOff()};a._hasNewActionForSticky=function e(o,n,i){try{if(o===undefined||n===undefined){throw new Error("Invalid input parameters for function _hasNewActionForSticky")}const t=n.getModel().getMetaModel(),e=o.getPath().substring(0,o.getPath().indexOf("(")),r=t.getObject(`${e}@com.sap.vocabularies.Session.v1.StickySessionSupported`);if(r&&r.NewAction&&r.NewAction===i){return true}else if(r&&r.AdditionalNewActions){return i===r.AdditionalNewActions.find(function(t){return t===i})?true:false}else{return false}}catch(e){t.info(e);return undefined}};a._registerDirtyStateProvider=function e(o,n,i){return function e(r){try{if(r===undefined){throw new Error("Invalid input parameters for function fnDirtyStateProvider")}const t=r.innerAppRoute,e=o.getRouterProxy();let s="";let a;const c=n.getProperty("/sessionOn");if(!c){return undefined}if(!e.isNavigationFinalized()){a=false;s=t}else if(i===t){a=true}else if(e.checkHashWithGuard(t)||e.isGuardCrossAllowedByUser()){s=t;a=false}else{a=true}if(a){setTimeout(function(){o.getShellServices().setDirtyFlag(false)},0)}else{i=s}return a}catch(e){t.info(e);return undefined}}};a._attachSessionTimeout=function e(o,n){return()=>{try{if(o===undefined){throw new Error("Context missing for function fnHandleSessionTimeout")}this.getMessageHandler().removeTransitionMessages();const t=new p({title:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_TITLE}",state:"Warning",content:new u({text:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_MESSAGE}"}),beginButton:new d({text:"{sap.fe.i18n>C_COMMON_DIALOG_OK}",type:"Emphasized",press:()=>{this.handleStickyOff();this.getRoutingListener().navigateBackFromContext(o)}}),afterClose:function(){t.destroy()}});t.addStyleClass("sapUiContentPadding");t.setModel(n,"sap.fe.i18n");this.getView().addDependent(t);t.open()}catch(e){t.info(e);return undefined}return true}};a._attachRouteMatched=function t(e,o,n){return function t(){const i=n.getRouterProxy().getHash();if(!i||!n.getRouterProxy().checkHashWithGuard(i)){e.discardStickySession(o);setTimeout(()=>{o.getModel().clearSessionContext()},0)}}};a._scrollAndFocusOnInactiveRow=function t(e){const o=e.getRowBinding();const n=o.getCount()||0;if(e.data("tableType")!=="ResponsiveTable"){if(n>0){e.scrollToIndex(n-1)}e.focusRow(n,true)}else{const t=o.getContexts();if(!(t!==null&&t!==void 0&&t.length)){e.focusRow(n,true);return}let i=n,r=0;for(const e of t){if(e.isInactive()&&r<i){i=r}r++}if(i>0){e.scrollToIndex(i)}e.focusRow(i,true)}};a.createEmptyRowsAndFocus=async function t(e){var o,n,i;const r=e.getParent();if(r!==null&&r!==void 0&&(o=r.tableDefinition)!==null&&o!==void 0&&(n=o.control)!==null&&n!==void 0&&n.inlineCreationRowsHiddenInEditMode&&!((i=e.getBindingContext("ui"))!==null&&i!==void 0&&i.getProperty("createMode"))){await r.setUpEmptyRows(e,true)}this._scrollAndFocusOnInactiveRow(e)};return i}(g),ft(st.prototype,"createMultipleDocuments",[h,y],Object.getOwnPropertyDescriptor(st.prototype,"createMultipleDocuments"),st.prototype),ft(st.prototype,"deleteMultipleDocuments",[m,P],Object.getOwnPropertyDescriptor(st.prototype,"deleteMultipleDocuments"),st.prototype),ft(st.prototype,"computeEditMode",[w,S],Object.getOwnPropertyDescriptor(st.prototype,"computeEditMode"),st.prototype),ft(st.prototype,"setEditMode",[v,M],Object.getOwnPropertyDescriptor(st.prototype,"setEditMode"),st.prototype),ft(st.prototype,"setDraftStatus",[b,D],Object.getOwnPropertyDescriptor(st.prototype,"setDraftStatus"),st.prototype),ft(st.prototype,"getRoutingListener",[O,C],Object.getOwnPropertyDescriptor(st.prototype,"getRoutingListener"),st.prototype),ft(st.prototype,"getGlobalUIModel",[E,A],Object.getOwnPropertyDescriptor(st.prototype,"getGlobalUIModel"),st.prototype),ft(st.prototype,"syncTask",[k,I],Object.getOwnPropertyDescriptor(st.prototype,"syncTask"),st.prototype),ft(st.prototype,"getProgrammingModel",[T,R],Object.getOwnPropertyDescriptor(st.prototype,"getProgrammingModel"),st.prototype),ft(st.prototype,"deleteDocumentTransaction",[x,_],Object.getOwnPropertyDescriptor(st.prototype,"deleteDocumentTransaction"),st.prototype),ft(st.prototype,"handleCreateEvents",[j,B],Object.getOwnPropertyDescriptor(st.prototype,"handleCreateEvents"),st.prototype),ft(st.prototype,"getTransactionHelper",[N,H],Object.getOwnPropertyDescriptor(st.prototype,"getTransactionHelper"),st.prototype),ft(st.prototype,"getInternalModel",[G,F],Object.getOwnPropertyDescriptor(st.prototype,"getInternalModel"),st.prototype),ft(st.prototype,"createActionPromise",[V,U],Object.getOwnPropertyDescriptor(st.prototype,"createActionPromise"),st.prototype),ft(st.prototype,"getCurrentActionPromise",[L,$],Object.getOwnPropertyDescriptor(st.prototype,"getCurrentActionPromise"),st.prototype),ft(st.prototype,"deleteCurrentActionPromise",[z,K],Object.getOwnPropertyDescriptor(st.prototype,"deleteCurrentActionPromise"),st.prototype),ft(st.prototype,"getActionResponseDataAndKeys",[W,q],Object.getOwnPropertyDescriptor(st.prototype,"getActionResponseDataAndKeys"),st.prototype),ft(st.prototype,"getMessageHandler",[J,X],Object.getOwnPropertyDescriptor(st.prototype,"getMessageHandler"),st.prototype),ft(st.prototype,"handleStickyOn",[Q,Y],Object.getOwnPropertyDescriptor(st.prototype,"handleStickyOn"),st.prototype),ft(st.prototype,"handleStickyOff",[Z,tt],Object.getOwnPropertyDescriptor(st.prototype,"handleStickyOff"),st.prototype),ft(st.prototype,"onBackNavigationInSession",[et,ot],Object.getOwnPropertyDescriptor(st.prototype,"onBackNavigationInSession"),st.prototype),ft(st.prototype,"discardStickySession",[nt,it],Object.getOwnPropertyDescriptor(st.prototype,"discardStickySession"),st.prototype),st))||rt);return wt},false);
//# sourceMappingURL=InternalEditFlow.js.map