/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/base/util/uid","sap/fe/core/buildingBlocks/AttributeModel","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/TypeGuards","sap/fe/macros/ResourceModel","sap/ui/base/BindingParser","sap/ui/core/util/XMLPreprocessor","./TraceInfo"],function(e,t,n,i,o,s,r,a,l,c,f){"use strict";var d={};var u=r.isFunctionArray;var p=r.isContext;var m=s.isBindingToolkitExpression;var g=s.compileExpression;var h=o.Placement;const b="sap.fe.core.buildingBlocks.BuildingBlockRuntime";const x="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1";const y=new DOMParser;let v=false;function C(e){return e.apiVersion===undefined||e.apiVersion===1}function $(e,t,n,i){const o=t[i];const s=o===null||o===void 0?void 0:o.getObject();if(n.required===true&&(!o||s===null)){throw new Error(`${e}: Required metadataContext '${i}' is missing`)}else if(s){if(s.hasOwnProperty("$kind")&&s.$kind!==undefined&&n.$kind!==undefined){if(n.$kind.indexOf(s.$kind)===-1){throw new Error(`${e}: '${i}' must be '$kind' '${n["$kind"]}' but is '${s.$kind}': ${o.getPath()}`)}}else if(s.hasOwnProperty("$Type")&&s.$Type!==undefined&&n.$Type){if(n.$Type.indexOf(s.$Type)===-1){throw new Error(`${e}: '${i}' must be '$Type' '${n["$Type"]}' but is '${s.$Type}': ${o.getPath()}`)}}}}function w(t,n,i,o){const s=n.metadataContexts&&Object.keys(n.metadataContexts)||[],r=n.properties&&Object.keys(n.properties)||[],a={};const l=o.getAttributeNames();for(const e of l){a[e]=true}s.forEach(function(e){const o=n.metadataContexts[e];$(t,i,o,e);delete a[e]});r.forEach(function(e){const i=n.properties[e];if(!o.hasAttribute(e)){if(i.required&&!i.hasOwnProperty("defaultValue")){throw new Error(`${t}: `+`Required property '${e}' is missing`)}}else{delete a[e]}});Object.keys(a).forEach(function(n){if(n.indexOf(":")<0&&!n.startsWith("xmlns")){e.warning(`Unchecked parameter: ${t}: ${n}`,undefined,b)}})}d.validateMacroSignature=w;const O="sap.ui.core.Element";const k="sap.ui.model.Context";d.SAP_UI_MODEL_CONTEXT=k;function P(e){let t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;let n=arguments.length>2?arguments[2]:undefined;if(e){const i={};const o={dependents:{type:O},customData:{type:O}};if(n===2){o.dependents.slot="dependents";o.customData.slot="customData"}const s={};let r;Object.keys(e.properties).forEach(function(t){if(e.properties[t].type!==k){i[t]=e.properties[t]}else{s[t]=e.properties[t]}});if(e.events!==undefined){Object.keys(e.events).forEach(function(t){i[t]={type:"function",...e.events[t]}})}if(e.aggregations!==undefined){Object.keys(e.aggregations).forEach(function(t){o[t]=e.aggregations[t];if(o[t].isDefault){r=t}})}return{properties:i,aggregations:o,defaultAggregation:r,metadataContexts:s,isOpen:t}}else{return{metadataContexts:{},aggregations:{dependents:{type:O},customData:{type:O}},properties:{},isOpen:t}}}function A(e,t){let n;if(t&&t.startsWith("/")){n=t}else{let i=e.currentContextPath.getPath();if(!i.endsWith("/")){i+="/"}n=i+t}return{model:"metaModel",path:n}}function E(e,t,n){let i;if(n.startsWith("/uid--")){const t=R[n];e.models.converterContext.setProperty(n,t);i={model:"converterContext",path:n};delete R[n]}else if(t==="metaPath"&&e.currentContextPath||t==="contextPath"){i=A(e,n)}else if(n&&n.startsWith("/")){i={model:"metaModel",path:n}}else{i={model:"metaModel",path:e.bindingContexts.entitySet?e.bindingContexts.entitySet.getPath(n):n}}return i}function T(e,t,n,i,o,s){let r;if(!o&&t.hasAttribute(n)){const i=t.getAttribute(n);r=l.complexParser(i);if(!r){r=E(e,n,i)}}else if(e.bindingContexts.hasOwnProperty(n)){r={model:n,path:""}}else if(s){try{if(i.getContext(`${n}>`)){r={model:n,path:""}}}catch(e){return undefined}}return r}async function N(n,i,o,s,r){const a=n.properties;const l=Object.keys(a);const c={};for(const n of l){if(a[n].type==="object"){c[n]=t(a[n].defaultValue||{})}else{c[n]=a[n].defaultValue}if(i.hasAttribute(n)&&o&&a[n].isPublic===false){e.error(`Property ${n} was ignored as it is not intended for public usage`)}else if(i.hasAttribute(n)){await s.visitAttribute(i,i.attributes.getNamedItem(n));let e=i.getAttribute(n);if(e!==undefined&&e!==null){if(r===2&&typeof e==="string"&&!e.startsWith("{")){switch(a[n].type){case"boolean":e=e==="true";break;case"number":e=Number(e);break}}e=e===null?undefined:e;c[n]=e}}}return c}function j(e,t,n,i,o,s,r){t.currentContextPath=t.bindingContexts.contextPath;const a={};const l={};const c=e.metadataContexts;const f=Object.keys(c);const d=f.indexOf("contextPath");if(d!==-1){const e=f.splice(d,1);f.splice(0,0,e[0])}for(const d of f){const f=i&&c[d].isPublic===false&&n.hasAttribute(d);const u=T(t,n,d,o,f,e.isOpen);if(u){u.name=d;D(s,o,u,r);if((d==="entitySet"||d==="contextPath")&&!t.bindingContexts.hasOwnProperty(d)){t.bindingContexts[d]=s[d]}if(d==="contextPath"){t.currentContextPath=s[d]}l[d]=s[d]}else{a[d]=true}}return{mMissingContext:a,propertyValues:l}}function B(e,t){const n={};if(e&&e.children.length>0){const i=e.children;for(let e=0;e<i.length;e++){const o=i[e];let s=o.getAttribute("key")||o.getAttribute("id");if(s){s=`InlineXML_${s}`;o.setAttribute("key",s);let e={key:s,position:{placement:o.getAttribute("placement")||h.After,anchor:o.getAttribute("anchor")||undefined},type:"Slot"};if(t){e=t(o,e)}n[e.key]=e}}}return n}async function S(e,t,n,i,o,s){const r={};if(e.firstElementChild!==null){let a=e.firstElementChild;if(s===2){while(a!==null){if(a.namespaceURI===x){const e=a.parentNode;let n;if(e){n=Array.from(e.children).indexOf(a);await t.visitNode(a);a=e.children[n]?e.children[n]:null}else{a=a.nextElementSibling}}else{const e=a.localName;let t=e;if(t[0].toUpperCase()===t[0]){t=n.defaultAggregation||""}const i=n.aggregations[t];if(i!==undefined&&!i.slot){const e=B(a,i.processAggregations);o[t]=e;for(const t in e){n.aggregations[t]=e[t]}}a=a.nextElementSibling}}}if(s!==2){await t.visitChildNodes(e)}a=e.firstElementChild;while(a!==null){const l=a.nextElementSibling;const c=a.localName;let f=c;if(f[0].toUpperCase()===f[0]){f=n.defaultAggregation||""}if(Object.keys(n.aggregations).indexOf(f)!==-1&&(!i||n.aggregations[f].isPublic===true)){if(s===2){const i=n.aggregations[f];if(!i.slot&&a!==null&&a.children.length>0){await t.visitNode(a);let n=a.firstElementChild;while(n){const t=n.nextElementSibling;if(!i.hasVirtualNode){const t=document.createElementNS(e.namespaceURI,n.getAttribute("key"));t.appendChild(n);r[n.getAttribute("key")]=t}else{r[n.getAttribute("key")]=n}n.removeAttribute("key");n=t}}else if(i.slot){if(f!==c){if(!r[f]){const t=document.createElementNS(e.namespaceURI,f);r[f]=t}r[f].appendChild(a)}else{r[f]=a}}}else{await t.visitNode(a);r[a.localName]=a}}else if(Object.keys(n.properties).indexOf(f)!==-1){await t.visitNode(a);if(n.properties[f].type==="object"){const e={};const t=a.getAttributeNames();for(const n of t){e[n]=a.getAttribute(n)}if(a.children.length){for(let t=0;t<a.children.length;t++){const n=a.children[t];const i=n.localName;const o={};const s=n.getAttributeNames();for(const e of s){o[e]=n.getAttribute(e)}e[i]=o}}o[f]=e}else if(n.properties[f].type==="array"){if(a!==null&&a.children.length>0){const e=a.children;const t=[];for(let n=0;n<e.length;n++){const i=e[n];const o={};const s=i.getAttributeNames();for(const e of s){o[e]=i.getAttribute(e)}t.push(o)}o[f]=t}}}a=l}}return r}function M(e,t,n){let i=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;if(Object.keys(e).length>0){Object.keys(e).forEach(function(o){const s=e[o];if(n!==null&&n!==undefined&&s){const e=s.firstElementChild;if(o!=="customData"&&o!=="dependents"){const i=t[o]!==undefined&&t[o].slot||o;const s=n.querySelector(`slot[name='${i}']`);if(s!==null){const t=V(n,o,e);s.replaceWith(...t.children)}}else if(i&&e!==null){const t=V(n,o,e);n.appendChild(t)}}})}}function V(e,t,n){const i=document.createElementNS(e.namespaceURI,t.replace(/:/gi,"_"));while(n){const e=n.nextElementSibling;i.appendChild(n);n=e}return i}async function I(t,n,o){let s=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;const r=t.fragment||`${t.namespace}.${t.xmlTag||t.name}`;const l="this";const c={};const d={};const u=o.getSettings();if(u.models["sap.fe.i18n"]){u.models["sap.fe.i18n"].getResourceBundle().then(function(e){a.setApplicationI18nBundle(e)}).catch(function(t){e.error(t)})}const m=P(t.metadata,t.isOpen,t.apiVersion);if(!u[r]){u[r]={}}let g=await N(m,n,s,o,t.apiVersion);const{mMissingContext:h,propertyValues:b}=j(m,u,n,s,o,c,d);g=Object.assign(g,b);const x=Object.keys(g);try{const a=await S(n,o,m,s,g,t.apiVersion);let d;let b={};if(u.models.viewData){b=u.models.viewData.getProperty("/controlConfiguration")}let x=g;if(C(t)&&t.create){x=t.create.call(t,g,b,u,a,s);Object.keys(m.metadataContexts).forEach(function(e){if(m.metadataContexts[e].computed===true){c[e]=x[e]}});Object.keys(h).forEach(function(e){if(x.hasOwnProperty(e)){c[e]=x[e]}})}else if(t.apiVersion===2){Object.keys(g).forEach(e=>{var n,i,o;let s=g[e];const r=t===null||t===void 0?void 0:(n=t.metadata)===null||n===void 0?void 0:n.properties[e];if(r!==null&&r!==void 0&&r.validate){s=r.validate(s)||s}if((i=s)!==null&&i!==void 0&&(o=i.isA)!==null&&o!==void 0&&o.call(i,k)&&!s.getModel().isA("sap.ui.model.odata.v4.ODataMetaModel")){g[e]=s.getObject()}});const e=t;g.isPublic=s;d=new e({...g,...a},b,u);x=d.getProperties();Object.keys(m.metadataContexts).forEach(function(e){if(x.hasOwnProperty(e)){const t=x[e];if(typeof t==="object"&&!p(t)){const n=F(t);u.models.converterContext.setProperty(n,t);const i=u.models.converterContext.createBindingContext(n);delete R[n];c[e]=i}else if(!c.hasOwnProperty(e)&&t!==undefined){c[e]=t}}})}const $=new i(n,x,t);c[l]=$.createBindingContext("/");let O;if(f.isTraceInfoActive()){const e=f.traceMacroCalls(r,m,c,n,o);if(e!==null&&e!==void 0&&e.macroInfo){O=u["_macroInfo"];u["_macroInfo"]=e.macroInfo}}w(r,m,c,n);const P=o.with(c,t.isOpen!==undefined?!t.isOpen:true);const A=n.parentNode;let E;let T;let N=true;if(A){E=Array.from(A.children).indexOf(n);if(C(t)&&t.getTemplate||t.apiVersion===2&&!t.fragment){let i;let o=false;if(t.apiVersion===2&&d!==undefined){i=await d.getTemplate(n);if(t.isRuntime===true){for(const e in R){const t=R[e];u.models.converterContext.setProperty(e,t);delete R[e]}}o=true}else if(t.getTemplate){i=await t.getTemplate(x)}let s="";if(i){let r=false;let l=_(i,o);for(const e of l){const t=document.createNodeIterator(e,NodeFilter.SHOW_TEXT);let n=t.nextNode();if(e.localName==="parsererror"){r=true}while(n){if(n.textContent&&n.textContent.trim().length>0){s=n.textContent}n=t.nextNode()}}if(r){e.error(`Error while processing building block ${t.xmlTag||t.name}`);try{var y;v=true;const e=(y=d)!==null&&y!==void 0&&y.getTemplate?await d.getTemplate(n):await t.getTemplate(x);l=_(e,true)}finally{v=false}}else if(s.length>0){e.error(`Error while processing building block ${t.xmlTag||t.name}`);const n=W([`Error while processing building block ${t.xmlTag||t.name}`,`Trailing text was found in the XML: ${s}`],l.map(e=>e.outerHTML).join("\n"));l=_(n,true)}n.replaceWith(...l);n=A.children[E];M(a,m.aggregations,n,N);N=false;T=P.visitNode(n)}else{n.remove();T=Promise.resolve()}}else{T=P.insertFragment(r,n)}await T;const i=A.children[E];M(a,m.aggregations,i,N);if(i!==undefined){const e=i.querySelectorAll("slot");e.forEach(function(e){e.remove()})}}if(O){u["_macroInfo"]=O}else{delete u["_macroInfo"]}}catch(i){const o={initialProperties:{},resolvedProperties:{},missingContexts:h};for(const e of x){const t=g[e];if(p(t)){o.initialProperties[e]={path:t.getPath(),value:t.getObject()}}else{o.initialProperties[e]=t}}for(const e in g){const t=g[e];if(!x.includes(e)){if(p(t)){o.resolvedProperties[e]={path:t.getPath(),value:t.getObject()}}else{o.resolvedProperties[e]=t}}}e.error(i);const s=W([`Error while processing building block ${t.name}`],n.outerHTML,o,i.stack);const r=_(s,true);n.replaceWith(...r)}}function D(e,t,n,i){const o=n.name||n.model||undefined;if(i[o]){return}try{let s=n.path;if(n.model!==null){s=`${n.model}>${s}`}const r=t.getSettings();if(n.model==="converterContext"&&n.path.length>0){e[o]=r.models[n.model].getContext(n.path)}else if(!r.bindingContexts[n.model]&&r.models[n.model]){e[o]=r.models[n.model].getContext(n.path)}else{e[o]=t.getContext(s)}i[o]=e[o]}catch(e){}}function L(e){c.plugIn(async(t,n)=>I(e,t,n),e.namespace,e.xmlTag||e.name);if(e.publicNamespace){c.plugIn(async(t,n)=>I(e,t,n,true),e.publicNamespace,e.xmlTag||e.name)}}d.registerBuildingBlock=L;function W(e,t,n,i){const o=e.map(e=>X`<m:Label text="${q(e)}"/>`);let s="";if(i){const e=btoa(`<pre>${i}</pre>`);s=X`<m:FormattedText htmlText="${`{= BBF.base64Decode('${e}') }`}" />`}let r="";if(n){r=X`<m:VBox>
						<m:Label text="Trace Info"/>
						<code:CodeEditor type="json"  value="${`{= BBF.base64Decode('${btoa(JSON.stringify(n,null,4))}') }`}" height="300px" />
					</m:VBox>`}return X`<m:VBox xmlns:m="sap.m" xmlns:code="sap.ui.codeeditor" core:require="{BBF:'sap/fe/core/buildingBlocks/BuildingBlockFormatter'}">
				${o}
				${s}
				<grid:CSSGrid gridTemplateRows="fr" gridTemplateColumns="repeat(2,1fr)" gridGap="1rem" xmlns:grid="sap.ui.layout.cssgrid" >
					<m:VBox>
						<m:Label text="How the building block was called"/>
						<code:CodeEditor type="xml" value="${`{= BBF.base64Decode('${btoa(t.replaceAll("&gt;",">"))}') }`}" height="300px" />
					</m:VBox>
					${r}
				</grid:CSSGrid>
			</m:VBox>`}const R={};function F(e){const t=`/uid--${n()}`;R[t]=e;return t}function _(e){var t,n;let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(i){e=`<template\n\t\t\t\t\t\txmlns:template="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1"\n\t\t\t\t\t\txmlns:m="sap.m"\n\t\t\t\t\t\txmlns:macros="sap.fe.macros"\n\t\t\t\t\t\txmlns:core="sap.ui.core"\n\t\t\t\t\t\txmlns:mdc="sap.ui.mdc"\n\t\t\t\t\t\txmlns:customData="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1">${e}</template>`}const o=y.parseFromString(e,"text/xml");let s=o.firstElementChild;while(((r=s)===null||r===void 0?void 0:r.localName)==="template"){var r;s=s.firstElementChild}const a=(t=s)!==null&&t!==void 0&&t.parentElement?(n=s)===null||n===void 0?void 0:n.parentElement.children:[s];return Array.from(a)}d.parseXMLString=_;function q(e){return e===null||e===void 0?void 0:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}d.escapeXMLAttributeValue=q;function U(e){var t;const n=_(e,true);if((n===null||n===void 0?void 0:n.length)>0&&((t=n[0])===null||t===void 0?void 0:t.localName)==="parsererror"){const t=n[0].innerText||n[0].innerHTML;return W([t.split("\n")[0]],e)}else{return e}}const X=function(e){let t="";let n;for(var i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++){o[s-1]=arguments[s]}for(n=0;n<o.length;n++){t+=e[n];const i=o[n];if(Array.isArray(i)&&i.length>0&&typeof i[0]==="string"){t+=i.flat(5).join("\n").trim()}else if(u(i)){t+=i.map(e=>e()).join("\n")}else if(m(i)){const e=g(i);t+=q(e)}else if(typeof i==="undefined"){t+="{this>undefinedValue}"}else if(typeof i==="function"){t+=i()}else if(typeof i==="object"&&i!==null){if(p(i)){t+=i.getPath()}else{const e=F(i);t+=`${e}`}}else if(i&&typeof i==="string"&&!i.startsWith("<")&&!i.startsWith("&lt;")){t+=q(i)}else{t+=i}}t+=e[n];t=t.trim();if(v){return U(t)}return t};d.xml=X;return d},false);
//# sourceMappingURL=BuildingBlockRuntime.js.map