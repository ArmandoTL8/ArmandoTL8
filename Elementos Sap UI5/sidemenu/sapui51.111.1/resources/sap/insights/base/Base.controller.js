/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","../utils/MetadataAnalyser","../utils/SelectionVariantHelper","sap/fe/navigation/SelectionVariant","sap/m/Token","../utils/oDataModelProvider","sap/ui/core/CustomData","sap/m/DynamicDateUtil","sap/ui/comp/util/DateTimeUtil","sap/ui/core/format/DateFormat","../utils/AppConstants","../utils/UrlGenerateHelper","sap/ui/core/IconPool","sap/base/util/deepClone"],function(e,t,a,r,i,n,o,s,l,d,g,u,c,p,f){"use strict";var h="smartForm";var v="copyCardSmartForm";return e.extend("sap.insights.base.BaseController",{constructor:function(){this._oParentViewModel=new t({oCard:{}});this.oSmartFormMap={};this.oDraftCardParams={};this.bEnableCardEdit=true},_createOdataModelsforDialog:function(e){var t=[];e.forEach(function(e){t.push(o.getOdataModel(e.descriptorContent["sap.app"].dataSources))});if(t.length){return Promise.all(t)}},setFilterTextForNoData:function(e,t,a){sap.ui.getCore().loadLibrary("sap.ui.comp",{async:true}).then(function(){sap.ui.require(["sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartform/Layout","sap/m/Text"],function(r,i,n,o){e.removeAllGroups();var s=new r;var l=new i;var d=new o({text:t?this.i18Bundle.getText("noFilterMsg"):this.i18Bundle.getText("noFilterLoaded"),textAlign:"Center"});l.addElement(d);s.addGroupElement(l);e.setLayout(new n);e.addGroup(s);if(a){e.getAggregation("content").getLayout().setBackgroundDesign("Transparent")}}.bind(this))}.bind(this))},_setSmartFormForCardEdit:function(e){this._oParentViewModel.setProperty("/oCard",e);var t=e.descriptorContent["sap.app"].id,a=this.oSmartFormMap[t]&&!this.smartFormEditable?Promise.resolve(this.oSmartFormMap[t]):this._createSmartFormForCardEdit(e,this.smartFormEditable);a.then(function(t){if(this.smartFormEditable){t.setEditable(true)}var a=this.byId(h)||this.byId(v);a.removeAllItems();var r=e.descriptorContent["sap.app"].dataSources;o.getOdataModel(r).then(function(e){var r=e&&e.loaded;var i=false;if(t.getGroups()&&t.getGroups().length&&t.getGroups()[0].getGroupElements()){i=t.getGroups()[0].getGroupElements().some(function(e){return e.getElements().some(function(e){return e.getVisible()})})}if(t.getAggregation("content").getFormContainers().length&&r&&i){t.setVisible(true);setTimeout(function(){var e=t.getAggregation("content").getLayout();if(e){e.setBackgroundDesign("Transparent")}a.addItem(t)},0)}else{this.setFilterTextForNoData(t,r,true);a.addItem(t)}}.bind(this))}.bind(this))},_createSmartFormForCardEdit:function(e){return new Promise(function(t){sap.ui.getCore().loadLibraries(["sap.ui.comp","sap.m"],{async:true}).then(function(){sap.ui.require(["sap/ui/comp/smartmultiinput/SmartMultiInput","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartform/Layout","sap/m/Title","sap/m/Toolbar"],function(l,d,g,u,p,f,h){var v=e.descriptorContent;var m=v["sap.card"].configuration.parameters;var y=v["sap.insights"].filterEntitySet;var S=m&&m._entitySet.value;var C=v["sap.app"].dataSources;o.getOdataModel(C).then(function(o){var C=o&&o.loaded;this._oParentViewModel.setProperty("/oCard",e);var D={layout:new p({labelSpanS:6}),customToolbar:new h({content:[new f({text:this.i18Bundle.getText("filterBy"),titleStyle:"H5"})],style:"Clear"})};var T=new d(D);var b=new g;var E=[],P=[],I=[],_=[],F,O,V=[];if(m){E=m._mandatoryODataParameters.value||[];P=m._mandatoryODataFilters.value||[];I=m._relevantODataParameters.value||[];_=m._relevantODataFilters.value||[];O=m._semanticDateRangeSetting;if(O){F=JSON.parse(O.value);V=Object.keys(F)||[]}}T.attachEditToggled(function(e){var t=e.getParameters().editable;var a=e.getSource().getGroups()&&e.getSource().getGroups().length?e.getSource().getGroups()[0]:null;if(t&&a){a.getGroupElements().forEach(function(e){e.getFields().forEach(function(e){e.attachInnerControlsCreated(function(e){var t=e.getSource(),a=t.getBindingPath("value");if((E.includes(a)||P.includes(a))&&t.getProperty("editable")){t.setMandatory(true)}else if(t.getMandatory()){t.setMandatory(false)}t.checkClientError()})})})}});var k=function(e,t){if(t){var a=new s({key:"date",value:t});e.insertCustomData(a)}};var A=o&&a.getParameterisedEntitySetByEntitySet(o.oData,y);var x=A?a.getPropertyNamesOfEntitySet(o.oData,A):[];if(C){if(I.length){I.forEach(function(e){var t=A;var r=true;if(x.indexOf(e)===-1){t=S;r=false}var i=a.isValueListWithFixedValues(o.oData,t,e);var s=a.isDate(o.oData,t,e);var d=V.includes(e);var g=new u;var p=new l({entitySet:t,value:"{"+e+"}",editable:r,visible:r,singleTokenMode:true,supportRanges:false,innerControlsCreated:this._handleVisibilityChange.bind(this,d,true)});if(i){p.attachInnerControlsCreated(function(e){var t=e.getSource();if(t.getMode()==="edit"){var a=t.getInnerControls();if(Array.isArray(a)&&a.length){var r=t.getAggregation("_initialTokens");if(t.getSingleTokenMode()){var i=a[0],n=Array.isArray(r)&&r.length?r[0]:null;if(i.setForceSelection){i.setForceSelection(false);if(n){i.setSelectedKey(n.getKey())}else{i.setSelectedItem(null)}}}else{var o=a[0];if(Array.isArray(r)&&r.length){o.setSelectedKeys(r.map(function(e){return e.getKey()}))}}if(t.getMandatory()){t.checkClientError()}}}});p.checkClientError=function(){return this._checkClientError(p)}.bind(this);p.attachSelectionChange(this._handleParameterSelectionChange.bind(this))}else{if(d){p.addStyleClass("semanticDateInsight")}p.attachTokenUpdate(this._handleParameterTokenUpdate.bind(this,null,d))}var f=m[e].value;var h=m[e].label;if(f){var v=new n({key:f,text:h?h:f});if(s){if(!V.includes(e)){k(v,new Date(f))}else{if(F&&this.smartFormEditable){var y=this._getOptionsForDynamicDate(F,e);var C=this.byId("hiddenDDR");C.setOptions(y)}f=c.formatSemanticDateTime(f,"Parameter")[0];k(v,f)}}if(i&&p.getInnerControls().length){var D=p.getInnerControls()[0];D.setSelectedKey(v.getKey())}p.addAggregation("_initialTokens",v)}if(f&&p.getVisible()){g.addElement(p);b.addGroupElement(g)}else if(this.bEnableCardEdit&&p.getVisible()){g.addElement(p);b.addGroupElement(g)}this._attachInitialiseToGroupElement(g)}.bind(this))}var M=a.getPropertyNamesOfEntitySet(o.oData,y);_.forEach(function(e){var t=e;if(!(t==="DisplayCurrency"&&I.indexOf("P_DisplayCurrency")>-1)){var n=y;var s=true;if(M.indexOf(t)===-1){var d="P_"+t;if(x.indexOf(d)>-1){n=A;t=d}else{n=S;s=false}}var g=a.isValueListWithFixedValues(o.oData,n,t);var p=a.isDate(o.oData,n,t);var f=V.includes(t);var h=new u;var v;if(t.indexOf("P_")===0){v=true}else{v=a.getPropertyFilterRestrictionByEntitySet(o.oData,n,t)}var C=new l({entitySet:n,value:"{"+t+"}",editable:s,visible:s,supportRanges:!v,singleTokenMode:v,innerControlsCreated:this._handleVisibilityChange.bind(this,f,false)});if(g){C.attachInnerControlsCreated(function(e){var t=e.getSource();if(t.getMode()==="edit"){var a=t.getInnerControls();if(Array.isArray(a)&&a.length){var r=t.getAggregation("_initialTokens");if(t.getSingleTokenMode()){var i=a[0],n=Array.isArray(r)&&r.length?r[0]:null;if(i.setForceSelection){i.setForceSelection(false);if(n){i.setSelectedKey(n.getKey())}else{i.setSelectedItem(null)}}}else{var o=a[0];if(Array.isArray(r)&&r.length){o.setSelectedKeys(r.map(function(e){return e.getKey()}))}}if(t.getMandatory()){t.checkClientError()}}}});C.checkClientError=function(){return this._checkClientError(C)}.bind(this);C.attachSelectionChange(this._handleFilterSelectionChange.bind(this))}else{if(f){C.setSingleTokenMode(true);C.addStyleClass("semanticDateInsight")}C.attachTokenUpdate(this._handleFilterTokenUpdate.bind(this,null,f))}var D=new i(m[e].value);var T=D.getSelectOption(e);if(T&&T.length){var E=[],P=[];E=r.getTokenFromSelectOptions(T,e);E.forEach(function(t,a){if(p){if(!V.includes(e)){k(t,new Date(t.getKey()))}else{if(F&&this.smartFormEditable){var r=this._getOptionsForDynamicDate(F,e);var i=this.byId("hiddenFilterDDR");i.setOptions(r)}P=c.formatSemanticDateTime(null,T[a],"Filter");P=c.formatSemanticDateTime(T[a],"Filter");P.forEach(function(e){k(t,e)})}}if(g&&C.getInnerControls().length){var n=C.getInnerControls()[0];n.setSelectedKey(t.getKey())}C.addAggregation("_initialTokens",t)}.bind(this));h.addElement(C);b.addGroupElement(h)}else if(this.bEnableCardEdit){h.addElement(C);b.addGroupElement(h)}this._attachInitialiseToGroupElement(h)}}.bind(this))}if(b.getAggregation("formElements")&&b.getAggregation("formElements").length){T.addGroup(b)}var w=v["sap.app"].id;if(C){T.setModel(o.oData)}this.oSmartFormMap[w]=T;t(T)}.bind(this))}.bind(this))}.bind(this))}.bind(this))},_handleVisibilityChange:function(e,t,a){var r=a.getSource();var i=this.byId(h);var n=i&&i.getItems()[0];var o=false;if(e&&r.getMode()==="edit"){var s=t?this.byId("hiddenDDR"):this.byId("hiddenFilterDDR");s.setValue(null);var l=r.getBinding("value").sPath;var d=r.getInnerControls();if(d.length){var g=d[0];r.setShowValueHelp(false);r.setShowSuggestion(false);if(!sap.ui.getCore().byId(g.getId()+"-dynamicDateIcon")){g.addEndIcon({id:g.getId()+"-dynamicDateIcon",src:p.getIconURI("check-availability"),press:t?this._handleParameterTokenUpdate.bind(this,r,true):this._handleFilterTokenUpdate.bind(this,r,true)});g.attachLiveChange(function(){this.bValueApplied=true;g.setValue("");s.attachEventOnce("change",null,t?this._onSemanticParameterDateChange.bind(this,l,r):this._onSemanticFilterDateChange.bind(this,l,r),s);s.openBy(r.getDomRef())}.bind(this))}}}setTimeout(function(){if(n){var e=n.getGroups()&&n.getGroups().length?n.getGroups()[0]:null;var t=e&&e.getGroupElements();if(t&&t.length){t.forEach(function(t){var a=t.getFields();a.forEach(function(e){if(!this.smartFormEditable&&e.getId()===r.getId()&&(e.getTokens&&e.getTokens().length===0)){t.removeField(e)}if(t.getVisible()&&e.getTokens&&e.getTokens().length){o=true}}.bind(this));if(!t.getFields().length){e.removeGroupElement(t)}}.bind(this))}}if(!o&&i){i.removeAllItems();this.setFilterTextForNoData(n,true,false);i.addItem(n)}}.bind(this),0)},_handleFilterTokenUpdate:function(e,t,n){var o=e?e:n.getSource();if(o.getMandatory()){o.checkClientError()}var s=o.getBinding("value").sPath;var l=o.getTokens();var g=this._oParentViewModel.getProperty("/oCard");var c=g.descriptorContent["sap.app"].id;var p=o.getModel();var f=a.isDate(p,o.getEntitySet(),s);var h,v="",m,y={value:"",label:"",description:""};m=g.descriptorContent["sap.card"].configuration.parameters;if(t&&(!l.length||e)){h=this.byId("hiddenFilterDDR");h.attachEventOnce("change",null,this._onSemanticFilterDateChange.bind(this,s,o),h);this.bValueApplied=true;h.openBy(o.getDomRef());if(!l.length){y.value=r.getEmptySVStringforProperty(s)}else{v=h._parseValue(l[0].getKey());if(v){h.setValue(v)}else{y.description=h.getValue()?JSON.stringify(h.getValue()):"";if(!h.getValue()&&m[s]&&m[s].description){var S;y.description=m[s].description;y.value=m[s].value;S=JSON.parse(y.description);S.values.forEach(function(e,t){if(u.DATE_OPTIONS.DATE_LIST.includes(S.operator)){var a=new Date(e);if(e.match&&!(e.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})Z$/gm)&&e.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})Z$/gm).length)){S.values[t]=d.utcToLocal(a);if(!["DATETIMERANGE","FROMDATETIME","TODATETIME","DATETIME"].includes(S.operator)){S.values[t]=d.normalizeDate(S.values[t],true)}}else{S.values[t]=a}}});h.setValue(S)}else{h.setValue(h.getValue())}}}}else if(l.length){var C=new i;var D=[];var T="";l.forEach(function(e){T="";if(e.data("selectOption")){var t=e.data("selectOption");if(!t.Text){t.Text=e.getText?e.getText():null}D.push(t)}else if(e.data("range")){var a=e.data("range");var i=r.getSelectOptionFromRange(a,e.getText());D.push(i)}else if(f){var n=p.formatValue(e.getKey(),"Edm.DateTime");C.addSelectOption(s,"I","EQ",n,null,n)}else if(o._parseValue){var l=o._parseValue(e.getKey());T=e.getText()?e.getText():e.getKey();C.addSelectOption(s,"I","EQ",l,null,T)}else{T=e.getText()?e.getText():e.getKey();C.addSelectOption(s,"I","EQ",e.getKey(),null,T)}});C.massAddSelectOption(s,D);y.value=C.toJSONString()}else{y.value=r.getEmptySVStringforProperty(s)}this.oDraftCardParams[c][s]=y.value?y:this.oDraftCardParams[c][s]},getLabelForField:function(e,t,a,r){if(e&&t){var i=r==="Parameter"?this.byId("hiddenDDR"):this.byId("hiddenFilterDDR");var n=i.getIdForLabel()||"";n=n.substring(0,n.lastIndexOf("-"));if(n){var o=sap.ui.getCore().byId(n);return o&&o.getValue()}else if(i&&i.getProperty("value")){return i.getProperty("value")}else if(a&&typeof a.getTokens==="function"){var s=a.getTokens()||[],l=s.map(function(e){return e.getText()});return{type:"filters",value:l}}}},_handleFilterSelectionChange:function(e){var t=e.getParameters();var a=e.getSource().getBinding("value").getPath();var o=this._oParentViewModel.getProperty("/oCard");var s=o.descriptorContent["sap.app"].id;var l=e.getSource();var d=new i;var g="",u={value:"",label:"",description:""};if(t.selectedItem){l.setValueState("None");var c=e.getParameter("selectedItem");if(c){g=c.getText()?c.getText():c.getKey();l.removeAllAggregation("_initialTokens");l.addAggregation("_initialTokens",new n({key:c.getKey(),text:g}));d.addSelectOption(a,"I","EQ",c.getKey(),null,g);u.value=d.toJSONString()}else{u.value=r.getEmptySVStringforProperty(a)}}else{var p=e.getSource().getInnerControls()[0].getSelectedItems();if(p.length){l.setValueState("None");l.removeAllAggregation("_initialTokens");p.forEach(function(e){g=e.getText()?e.getText():e.getKey();l.addAggregation("_initialTokens",new n({key:e.getKey(),text:g}));d.addSelectOption(a,"I","EQ",e.getKey(),null,g)});u.value=d.toJSONString()}else{u.value=r.getEmptySVStringforProperty(a)}}this.oDraftCardParams[s][a]=u},_handleParameterSelectionChange:function(e){var t=e.getParameter("selectedItem");var a=e.getSource(),r="";var i={value:"",label:"",description:""};if(t){a.setValueState("None");r=t.getText()?t.getText():t.getKey();i.value=t.getKey();i.label=r}a.removeAllAggregation("_initialTokens");a.addAggregation("_initialTokens",new n({key:i.value,text:i.label}));var o=e.getSource().getBinding("value").getPath();var s=this._oParentViewModel.getProperty("/oCard").descriptorContent["sap.app"].id;this.oDraftCardParams[s][o]=i},_handleParameterTokenUpdate:function(e,t,r){var i=e?e:r.getSource();if(i.getMandatory()){i.checkClientError()}var n=i.getBinding("value").sPath;var o=i.getTokens();var s=this._oParentViewModel.getProperty("/oCard").descriptorContent["sap.app"].id;var l={value:"",label:"",description:""};var d=i.getModel();var g=a.isDate(d,i.getEntitySet(),n);var p,f;if(t&&(!o.length||e)){f=this.byId("hiddenDDR");f.attachChange(this._onSemanticParameterDateChange.bind(this,n,i));f.openBy(i.getDomRef())}if(o.length){l.label=o[0].getText()?o[0].getText():o[0].getKey();if(t&&!f){f=this.byId("hiddenDDR")}if(f&&f._parseValue){p=f._parseValue(o[0].getKey());if(p){f.setValue(p);l.value=c.getDateRangeValue(p,true);l.description=JSON.stringify(p);var h=this.getLabelForField(n,p,e,"Parameter");var v="";var m=p.operator==="DATE";if(h&&typeof h==="string"){v=h.substring(0,h.indexOf("(")-1);if(!v&&m){v=h}}l.label=v?v:p.operator}else{l.value=o[0].getKey();if(Date.parse(l.value)){l.value=new Date(l.value)}l.description=f.getValue()?JSON.stringify(f.getValue()):"";var y=this._oParentViewModel.getProperty("/oCard").descriptorContent["sap.card"].configuration.parameters;if(!f.getValue()&&y[n]&&y[n].description){var S;l.description=y[n].description;S=JSON.parse(l.description);if(u.DATE_OPTIONS.DATE_LIST.includes(S.operator)){S.values[0]=new Date(S.values[0]);l.value=typeof o[0].getKey()==="string"?new Date(o[0].getKey()):o[0].getKey()}f.setValue(S)}else{f.setValue(f.getValue())}}}else{p=i._parseValue&&i._parseValue(o[0].getKey());if(g&&p){p=i.getModel().formatValue(p,i.getDataType());l.value=p}else if(p){l.value=p}else{p=o[0].getKey();l.value=p}}}this.oDraftCardParams[s][n]=l},_mergeDraftParamsIncard:function(e){var t=e.descriptorContent["sap.card"].configuration.parameters;var a=e.descriptorContent["sap.app"].id;var r=this.oDraftCardParams[a];Object.keys(r).forEach(function(e){if(r[e]){if(t[e]){if(t[e].type==="datetime"&&typeof t[e].value==="string"&&t[e].value.includes("operation")){var a=JSON.parse(t[e].value);a.operation=r[e];t[e].value=JSON.stringify(a)}else{t[e].value=r[e].value?r[e].value:r[e];if(r[e].label){t[e].label=r[e].label}t[e].description=r[e].description}}else if(e.indexOf("P_")===0&&t[e.replace("P_","")]){r[e.replace("P_","")]=r[e].replace("P_","");t[e.replace("P_","")].value=r[e].replace("P_","");delete r[e]}}});c.processPrivateParams(e,r);Object.keys(t).forEach(function(e){var a=t[e].value;if(t[e].type==="datetime"&&typeof a==="string"&&a.includes("datetime")){a=a.split("datetime");a=a[a.length-1];a=a.replace(/["']/g,"");t[e].value=a}});return e},_checkClientError:function(e){var t=e.getSingleTokenMode()?!e.getInnerControls()[0].getSelectedKey():!e.getInnerControls()[0].getSelectedKeys().length,a=e.getMandatory()&&t;e.setValueState(a?"Error":"None");return a},_attachInitialiseToGroupElement:function(e){if(e.getFields()&&e.getFields().length){e.getFields()[0].attachInitialise(function(){if(e.getFields().length&&e.getLabelControl()&&!e.getLabelControl().getText()){var t=e.getFields()[0].getBindingPath("value");if(t&&e.getFields()[0].getVisible()){e.getFields()[0].setTextLabel(t)}}})}},_onSemanticParameterDateChange:function(e,t,a){var r=a.getParameter("value");var i=this._oParentViewModel.getProperty("/oCard");var o=i.descriptorContent["sap.app"].id;var s=this.getLabelForField(e,r,t,"Parameter");var l="";var d=r.operator==="DATE";if(s&&typeof s==="string"){l=s.substring(0,s.indexOf("(")-1);if(!l&&d){l=s}}if(!this.oDraftCardParams[o][e]){this.oDraftCardParams[o][e]={}}this.oDraftCardParams[o][e].value=d?r.values[0]:r.operator;this.oDraftCardParams[o][e].label=d?r.values[0]:r.operator;this.oDraftCardParams[o][e].description=JSON.stringify(r);t.getInnerControls()[0].setTokens([]);if(l){this.oDraftCardParams[o][e].label=l}var g=new n({key:this.oDraftCardParams[o][e].value,text:this.oDraftCardParams[o][e].label});t.getInnerControls()[0].setTokens([g]);var u=a.getParameter("valid");t.setValueState(u?"None":"Error")},_onSemanticFilterDateChange:function(e,t,a){if(this.bValueApplied){var n=a.getParameter("value");var o=this.getLabelForField(e,n,t,"Filter");var s=f(n);var l=c.getDateRangeValue(s,false,o);var d=this._oParentViewModel.getProperty("/oCard");var g=d.descriptorContent["sap.app"].id;var u=new i;if(!l.High){l.High=""}if(!this.oDraftCardParams[g][e]){this.oDraftCardParams[g][e]={}}u.addSelectOption(e,"I",l.Option,l.Low,l.High,l.Text);this.oDraftCardParams[g][e].value=u.toJSONString();this.oDraftCardParams[g][e].description=JSON.stringify(s);t.getInnerControls()[0].setTokens([]);var p=r.getTokenFromSelectOptions(u.getSelectOption(e),e);t.getInnerControls()[0].setTokens(p);var h=a.getParameter("valid");t.setValueState(h?"None":"Error");this.bValueApplied=false}},_getOptionsForDynamicDate:function(e,t){var a;if(e[t]["sap:filter-restriction"]==="single-value"){a=u.DATE_OPTIONS.SINGLE_OPTIONS}else if(e[t]["sap:filter-restriction"]==="interval"){a=u.DATE_OPTIONS.RANGE_OPTIONS;a=a.concat(u.DATE_OPTIONS.SINGLE_OPTIONS)}if(e&&e[t].exclude){a=a.filter(function(a){return!e[t].selectedValues.includes(a)})}return a}})});
//# sourceMappingURL=Base.controller.js.map