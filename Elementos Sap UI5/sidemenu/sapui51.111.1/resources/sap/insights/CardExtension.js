/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 * This extension is for OVP Analytical cards delivered in 2208.
 */
sap.ui.define(["sap/ui/integration/Extension","sap/ui/core/format/NumberFormat","sap/fe/navigation/SelectionVariant","sap/base/Log","sap/ui/core/format/DateFormat","sap/ui/core/ValueState","sap/m/ValueColor","sap/ui/integration/util/Utils","sap/m/DynamicDateUtil","sap/ui/core/Core","sap/fe/navigation/NavError","sap/insights/utils/UrlGenerateHelper"],function(e,t,r,a,i,n,s,o,f,l,c,u){"use strict";var m={StateValues:{None:"None",Negative:"Error",Critical:"Warning",Positive:"Success"},ColorValues:{None:"Neutral",Negative:"Error",Critical:"Critical",Positive:"Good"}};var p=a.getLogger("sap.insights.CardExtension");var v=function(e,t){return e&&e.indexOf(t,e.length-t.length)!==-1};var g=function(e,t){var r;if(t){r=t.None;if(e&&e.EnumMember){var a=e.EnumMember;if(v(a,"Negative")){r=t.Negative}else if(v(a,"Critical")){r=t.Critical}else if(v(a,"Positive")){r=t.Positive}}}return r};var d=function(e,t,r,a,i,n,s){var o={};o.EnumMember="None";var f=Number.NEGATIVE_INFINITY;var l=Number.POSITIVE_INFINITY;if(!i&&i!==0&&(r||r===0)){i=r}if(!n&&n!==0&&(a||a===0)){n=a}if(!r&&r!==0){r=f}if(!a&&a!==0){a=l}if(e!==undefined){e=Number(e);if(v(t,"Minimize")||v(t,"Minimizing")){if((n||n===0)&&(a||a===0)){if(e<=parseFloat(n)){o.EnumMember="Positive"}else if(e>parseFloat(a)){o.EnumMember="Negative"}else{o.EnumMember="Critical"}}}else if(v(t,"Maximize")||v(t,"Maximizing")){if((i||i===0)&&(r||r===0)){if(e>=parseFloat(i)){o.EnumMember="Positive"}else if(e<parseFloat(r)){o.EnumMember="Negative"}else{o.EnumMember="Critical"}}}else if(v(t,"Target")){if((n||n===0)&&(a||a===0)&&(i||i===0)&&(r||r===0)){if(e>=parseFloat(i)&&e<=parseFloat(n)){o.EnumMember="Positive"}else if(e<parseFloat(r)||e>parseFloat(a)){o.EnumMember="Negative"}else{o.EnumMember="Critical"}}}}return g(o,s)};var b=function(e,t,r,a){if(!e||!t){return}e=Number(e);if(!a&&e-t>=0){return"Up"}if(!r&&e-t<=0){return"Down"}if(t&&a&&e-t>=a){return"Up"}if(t&&r&&e-t<=r){return"Down"}};var h=function(e,r,a){var i=r||{},n=e;var s=t.getFloatInstance({minFractionDigits:i.NumberOfFractionalDigits,maxFractionDigits:i.NumberOfFractionalDigits,style:"short",showScale:true,shortRefNumber:n});var o=s.format(Number(n)),f=s.getScale()||"";if(!a&&o){var l=o[o.length-1];return l===f?o.slice(0,o.length-1):o}if(a&&i.percentageAvailable){return f+"%"}if(a&&!i.percentageAvailable){return f}return""};var N=function(){var e=this.getCard().getCombinedParameters();return e._headerDataUrl};var S=function(){var e=this.getCard().getCombinedParameters();return e._contentDataUrl};var D=function(e,r,a){var i,n,s;if(isNaN(+e)){return""}if(e==0){s=r}else{s=e}if(a.NumberOfFractionalDigits){n=+a.NumberOfFractionalDigits}if(r){i=r}else if(a.manifestTarget){i=a.manifestTarget}if(!n||n<0){n=0}else if(n>2){n=2}if(i){var o=t.getFloatInstance({minFractionDigits:n,maxFractionDigits:n,style:"short",showScale:true,shortRefNumber:s});return o.format(+i)}};var P=function(e,r,a){var i,n;if(isNaN(+e)){return""}e=+e;if(a.NumberOfFractionalDigits){i=+a.NumberOfFractionalDigits}if(r){n=+r}else if(a.manifestTarget){n=+a.manifestTarget}if(!i||i<0){i=0}else if(i>2){i=2}if(n){var s=(e-n)/n;var o=t.getPercentInstance({style:"short",minFractionDigits:i,maxFractionDigits:i,showScale:true});return o.format(s)}};var O=function(e){var t={};t.EnumMember="None";if(Number(e)===1){t.EnumMember="Negative"}else if(Number(e)===2){t.EnumMember="Critical"}else if(Number(e)===3){t.EnumMember="Positive"}return g(t,m.ColorValues)};var y=function(){var e=arguments[arguments.length-1];var t=1;return d(arguments[0],e.sImprovementDirection,e.bIsDeviationLowBinding?arguments[t++]:e.deviationLow,e.bIsDeviationHighBinding?arguments[t++]:e.deviationHigh,e.bIsToleranceLowBinding?arguments[t++]:e.toleranceLow,e.bIsToleranceHighBinding?arguments[t++]:e.toleranceHigh,e.oCriticalityConfigValues)};var C=function(){var e=arguments[arguments.length-1];var t=1;return b(arguments[0],e.bIsRefValBinding?arguments[t++]:e.referenceValue,e.bIsDownDiffBinding?arguments[t++]:e.downDifference,e.bIsUpDiffBinding?arguments[t++]:e.upDifference)};var I=function(e){var t;var r=arguments[arguments.length-1],a=r&&r.propertyType;switch(a){case"yearmonth":var i=parseInt(e.substr(0,4),10),n=e.substr(4),s=parseInt(n,10)-1;t=new Date(Date.UTC(i,s));break;case"yearquarter":var i=parseInt(e.substr(0,4),10),o=e.substr(4),f=parseInt(o,10)*3-2,s=f-1;t=new Date(Date.UTC(i,s));break;case"yearweek":var i=parseInt(e.substr(0,4),10),l=e.substr(4),c=1+(parseInt(l,10)-1)*7;t=new Date(Date.UTC(i,0,c));break;default:break}return t};var w=function(e,t){if(e){var r=o.parseJsonDateTime(e);return i.getInstance(t).format(new Date(r),t.bUTC)}};var E=function(e){if(e){var r=t.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});return r.format(Number(e))}};var F=function(e,r,a,i){var n;if(e){e.maxFractionDigits=e.numberOfFractionalDigits||0;e.minFractionDigits=e.numberOfFractionalDigits||0;e.style=e.style||"short";e.showScale=e.showScale||true;e.shortRefNumber=e.scaleFactor;n=t.getFloatInstance(e)}var s=[];if(!isNaN(parseFloat(a))&&n){s.push(n.format(a))}else{s.push(a)}if(!isNaN(parseFloat(i))&&n){s.push(n.format(i))}else{s.push(i)}var o="";if(r&&r.length){r.forEach(function(e){if(typeof e==="number"){o=o+s[e]}else{o=o+e}})}return o};var V=function(e,t){if(t==="state"){switch(String(e)){case"1":case"Error":return n.Error;case"2":case"Warning":return n.Warning;case"3":case"Success":return n.Success;default:return n.None}}if(t==="color"){switch(String(e)){case"1":case"Error":return s.Error;case"2":case"Critical":return s.Critical;case"3":case"Good":return s.Good;default:return s.Neutral}}};var M=function(e,t){var r=this.getCard().getModel().getProperty("/content/d/results")||this.getCard().getModel().getProperty("/d/results")||[];var a=r.map(function(t){return t[e]});if(a.indexOf("0")===-1){a.push(0)}return Math[t].apply(Math,a)};var T=function(e,t,r){var a=1;var i=2;var n=4;for(var s in e){if(e.hasOwnProperty(s)){var o=e[s];if(o instanceof Date){o=o.toJSON()}else if(Array.isArray(o)||o&&typeof o==="object"){o=JSON.stringify(o)}else if(typeof o==="number"||typeof o==="boolean"){o=o.toString()}if(o===""){if(r&a){p.info("Semantic attribute "+s+" is an empty string and due to the chosen Suppression Behiavour is being ignored.");continue}}if(o===null){if(r&i){throw new p.error("NavigationHandler.INVALID_INPUT")}else{p.warning("Semantic attribute "+s+" is null and ignored for mix in to selection variant");continue}}if(o===undefined){if(r&n){throw new p.error("NavigationHandler.INVALID_INPUT")}else{p.warning("Semantic attribute "+s+" is undefined and ignored for mix in to selection variant");continue}}if(typeof o==="string"||o instanceof String){t.addSelectOption(s,"I","EQ",o)}else{throw new p.error("NavigationHandler.INVALID_INPUT")}}}return t};var x=function(e,t,a){var i=new r(t);var n=new r;if(i.getFilterContextUrl()){n.setFilterContextUrl(i.getFilterContextUrl())}if(i.getParameterContextUrl()){n.setParameterContextUrl(i.getParameterContextUrl())}if(Array.isArray(e)){e.forEach(function(e){T(e,n,a)})}else{T(e,n,a)}var s=i.getParameterNames();var o;for(o=0;o<s.length;o++){if(!n.getSelectOption(s[o])){n.addSelectOption(s[o],"I","EQ",i.getParameter(s[o]))}}var f=i.getSelectOptionsPropertyNames();for(o=0;o<f.length;o++){var l=i.getSelectOption(f[o]);if(!n.getSelectOption(f[o])){for(var c=0;c<l.length;c++){n.addSelectOption(f[o],l[c].Sign,l[c].Option,l[c].Low,l[c].High)}}}return n};function U(e){if(e){if(e.hasOwnProperty("SelectionVariantID")){delete e.SelectionVariantID}else if(e.hasOwnProperty("PresentationVariantID")){delete e.PresentationVariantID}delete e.Text;delete e.ODataFilterExpression;delete e.Version;delete e.FilterContextUrl;delete e.ParameterContextUrl;return e}return e}var H=function(e){try{if(JSON.parse(e)){return true}}catch(e){return false}};var L=function(e){var t=e&&e.length===1,r=e&&e[0];return t&&r["Option"]==="EQ"&&!r["High"]&&r["Low"]&&r["Sign"]==="I"};function A(e,t){var r=this.getCard().getManifestEntry("sap.card"),a=r&&r.configuration.parameters,i=new sap.fe.navigation.SelectionVariant,n=a._relevantODataFilters.value||[];e=e&&JSON.parse(e);var s=e&&e.sensitiveProps,o=r&&r.header.actions[0].parameters.ibnParams,f=r&&r.content.actions[0].parameters.ibnParams;n.forEach(function(e){var t=H(a[e].value);if(t&&!(s&&s[e])){var r=JSON.parse(a[e].value);var n=r.SelectOptions.Ranges;if(n&&n.length){var l=L(n);if(o[e]&&f[e]){if(l){o[e]=n[0].Low;f[e]=n[0].Low}else if(!l){delete f[e];delete o[e];i.massAddSelectOption(e,n)}}else{i.massAddSelectOption(e,n)}}}});if(t){var l=Object.keys(t)||[];for(var c=0;c<l.length;c++){if(s&&s[l[c]]||l[c]==="__metadata"){delete t[l[c]]}}var u=x(t,i&&i.toJSONObject());u=U(u.toJSONObject());e.selectionVariant=u}if(e&&e.sensitiveProps){delete e.sensitiveProps}return JSON.stringify(e)}var J=function(e){var t=i.getDateInstance({pattern:"''yyyy-MM-dd'T'HH:mm:ss.SSS'Z'''",calendarType:"Gregorian"});if(e){var r=t.format(e,true);return String(r).replace(/'/g,"")}};var _=function(e){var t=i.getDateInstance({pattern:"''yyyy-MM-dd'T'HH:mm:ss.SSS''",calendarType:"Gregorian"});var r=e instanceof Date?e:new Date(e);var a=t.format(r);return String(a).replace(/'/g,"")};var k=function(e,t,r){var a=[];if(e.operation==="DATE"&&e.value1){a=f.toDates({values:[e.value1],operator:e.operation})||[]}else{a=f.toDates({values:[],operator:e.operation})||[]}var i=a[0]&&a[0].oDate;var n=a[1]&&a[1].oDate;var s="",o="";if(e["sap:filter-restriction"]==="single-value"){if(e.type==="Edm.DateTime"&&i instanceof Date){s=_(i);if(s){t.massAddSelectOption(r,[{Sign:"I",Option:e.operator,Low:s,High:null}])}}else if(e.type==="Edm.String"){s=J(i);if(s){t.massAddSelectOption(r,[{Sign:"I",Option:e.operator,Low:s,High:null}])}}}else if(e["sap:filter-restriction"]==="interval"){if(e.type==="Edm.DateTime"){if(i instanceof Date){s=_(i)}if(n instanceof Date){o=_(n)}if(s&&o){t.massAddSelectOption(r,[{Sign:"I",Option:e.operator,Low:s,High:o}])}}else if(e.type==="Edm.String"){if(i instanceof Date){s=J(i)}if(n instanceof Date){o=J(n)}if(s&&o){t.massAddSelectOption(r,[{Sign:"I",Option:e.operator,Low:s,High:o}])}}}};function j(e){var t={};var a;if(typeof e==="string"){a=new r(e)}else if(typeof e==="object"){a=e}else{throw new c("NavigationHandler.INVALID_INPUT")}var i=a.getSelectOptionsPropertyNames();for(var n=0;n<i.length;n++){var s=a.getSelectOption(i[n]);if(s.length===1&&s[0].Sign==="I"&&s[0].Option==="EQ"){t[i[n]]=s[0].Low}}var o=a.getParameterNames();for(var n=0;n<o.length;n++){var f=a.getParameter(o[n]);t[o[n]]=f}return t}function B(e,t){var a=this.getCard().getManifestEntry("sap.card"),i=a&&a.configuration.parameters,n=new r,s=i._relevantODataFilters.value||[],o=i._mandatoryODataParameters.value||[],f=e&&JSON.parse(e)||{},l=f&&f.parameters,c=l&&l.ibnParams,u=c&&c.sensitiveProps,m=f&&f.sensitiveProps,p=i._semanticDateRangeSetting,v,g=[];if(p){v=JSON.parse(p.value);g=Object.keys(v)||[]}var d={};o.forEach(function(e){var t=H(i[e].value);if(t&&(u&&!u[e]||m&&!m.includes(e))){var r=JSON.parse(i[e].value);if(r&&r.operation){k(r,n,e)}}});i._relevantODataParameters.value.forEach(function(e){if(i[e].value&&!g.includes(e)){if(c){c[e]=i[e].value}else if(f&&f.ibnParams){f.ibnParams[e]=i[e].value}}});s.forEach(function(e){var t=H(i[e].value);if(t&&(u&&!u[e]||m&&!m.includes(e))){var r=JSON.parse(i[e].value);if(r&&r.operation){k(r,n,e)}else{var a=r.SelectOptions.Ranges||r.SelectOptions&&r.SelectOptions[0]&&r.SelectOptions[0].Ranges;if(a&&a.length){var s=L(a);if(s){if(c){c[e]=a[0].Low}else if(f&&f.ibnParams){f.ibnParams[e]=a[0].Low}}else{if(c&&c[e]&&!s){delete c[e]}n.massAddSelectOption(e,a)}}}}});var b=t||{};var h=Object.keys(b)||[];for(var N=0;N<h.length;N++){if(u&&u[h[N]]||m&&m.includes(h[N])||h[N]==="__metadata"){delete b[h[N]]}}var S=x(b,n&&n.toJSONObject());var D=j(S);S=U(S.toJSONObject());if(c&&c.presentationVariant){d["presentationVariant"]=c.presentationVariant}else if(f&&f.ibnParams&&f.ibnParams.presentationVariant){d["presentationVariant"]=f.ibnParams.presentationVariant}if(S.Parameters.length||S.SelectOptions.length){d["selectionVariant"]=S}if(l&&!l.ibnParams){l.ibnParams={}}if(d["selectionVariant"]||d["presentationVariant"]){if(l&&l.ibnParams){l.ibnParams["sap-xapp-state-data"]=JSON.stringify(d)}else if(f&&f.ibnParams){f.ibnParams["sap-xapp-state-data"]=JSON.stringify(d)}}if(c&&c.sensitiveProps){delete c.sensitiveProps}for(var P in D){if(l&&l.ibnParams){l.ibnParams[P]=D[P]}else if(f&&f.ibnParams){f.ibnParams[P]=D[P]}}if(c){delete c.selectionVariant;delete c.presentationVariant}if(f&&f.ibnParams&&f.ibnParams.presentationVariant){delete f.ibnParams.presentationVariant}return f.parameters?f.parameters:f}function R(){var e={descriptorContent:{}};e.descriptorContent=this.getCard().getManifestEntry("/");var t=q(e,"header");return t}function G(){var e={descriptorContent:{}};e.descriptorContent=this.getCard().getManifestEntry("/");var t=e.descriptorContent["sap.card"]["configuration"]["csrfTokens"]["token1"].data.request.url;var r=q(e,"content");if(e.descriptorContent["sap.card"]["data"]["request"]&&e.descriptorContent["sap.card"]["data"]["request"]["batch"]){return r}return t+"/"+r}function q(e,t){var r=u.processPrivateParams(e,null,true);if(t==="header"&&r.header){return r.header}else if(t==="content"&&r.content){return r.content}}return e.extend("sap.insights.CardExtension",{init:function(){e.prototype.init.apply(this,arguments);this.setFormatters({kpiformatter:h,formatHeaderUrl:N.bind(this),formatContentUrl:S.bind(this),returnPercentageChange:P,targetValueFormatter:D,kpiValueCriticality:O,formatValueColor:y,formatTrendIcon:C,formatDateValue:I,addPropertyValueToAppState:A.bind(this),getNavigationContext:B.bind(this),formatDate:w,formatNumber:F,formatHeaderCount:E,formatCriticality:V,getMinMax:M.bind(this),formatHeaderDataUrlForSemanticDate:R.bind(this),formatContentDataUrlForSemanticDate:G.bind(this)})},loadDependencies:function(){var e=this.getCard(),t=e.getManifestEntry("/sap.card/type");if(t!=="Analytical"){return Promise.resolve()}return l.loadLibrary("sap.viz",{async:true}).then(function(){return new Promise(function(e){sap.ui.require(["sap/insights/OVPChartFormatter"],function(t){t.registerCustomFormatters();e()})})})}})});
//# sourceMappingURL=CardExtension.js.map