sap.ui.define(["sap/ui/base/Object","sap/ui/model/Context","sap/suite/ui/generic/template/lib/MessageUtils","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/suite/ui/generic/template/genericUtilities/CacheHelper","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser"],function(e,t,n,r,a,i,s,o){"use strict";var l=Promise.reject();l.catch(Function.prototype);function u(e,t,n,r,a){var i=n.createEntry(t,{properties:r,context:e,batchGroupId:"Changes",changeSetId:"Changes",canonicalRequest:a});return i}function f(e,t,n,r,a,i,s,o){n=n||"/"+t;var l=a.mustRequireRequestsCanonical();s.oFunctionImportDialogInfo={getTitleText:function(){return o.getText("DIALOG_TITLE_NEW_ACTION_FOR_CREATE")},getActionButtonText:function(){return o.getText("DIALOG_ACTION_BUTTON_NEW_ACTION_FOR_CREATE")}};return e.createNewDraftEntity(t,n,i,l,s).then(function(e){return e.context})}function c(e,t,n){var r=new Promise(function(n,r){e.read(t,{urlParameters:{$expand:"DraftAdministrativeData"},success:function(e){n(e)},error:function(e){r(e)}})});n.setBusy(r,true);return r}function d(e,t,n,i,s,o){var l=new Promise(function(o,l){var u,f,c,d,g=[];if(n&&i&&s){f=n.length;for(u=0;u<f;u++){c=n[u].PropertyPath;d=i[c][0];g.push(new r(c,a.EQ,d))}if(e.getDraftController().getDraftContext().isDraftEnabled(t)){var p=new r({filters:[new r("IsActiveEntity","EQ",false),new r("SiblingEntity/IsActiveEntity","EQ",null)],and:false});g.push(p)}var D=new r(g,true);s.read("/"+t,{urlParameters:{$expand:"DraftAdministrativeData"},filters:[D],success:function(e){var t=v(e,s,i);if(t){o(t)}else{l(e)}},error:function(e){l(e)}})}});o.oBusyHelper.setBusy(l,true);return l}function v(e,t,n){var r,a,i,s;if(e&&e.results){i=e.results.length;if(i==0){s=null}else if(i==1){s=e.results[0]}else if(i>=1){var o=[];var l=[];for(a=0;a<i;a++){r=e.results[a];if(r&&r.IsActiveEntity){l.push(r)}else if(r&&r.IsActiveEntity==false){o.push(r)}}if(l.length==0&&o.length>=2){var u;for(var f=0;f<o.length;f++){u=o[f];if(u.DraftUUID==n.DraftUUID){s=u;break}}if(!s){s=o[0]}}else if(l.length==1&&o.length==1){s=l[0]}else if(l.length==1&&o.length>=2){s=l[0]}}}return s}function g(e){var t=e.oAppComponent;var r=t.getModel();var a=r.getMetaModel();var i=t.getNavigationController();var s=t.getApplicationController();var o=s.getTransactionController().getDraftController().getDraftContext();var l=function(t){e.oApplicationProxy.getResourceBundleForEditPromise().then(function(a){n.handleError(n.operations.modifyEntity,null,null,t,{resourceBundle:a,navigationController:i,model:r});n.handleTransientMessages(e)})};var u=function(t){var n=t.getParameter("context");if(!o.hasDraft(n)){return}if(!a.getODataEntitySet(n.getPath().split("(")[0].substring(1))){return}var r=t.getParameter("path");s.propertyChanged(r,n).catch(l);e.oApplicationProxy.markCurrentDraftAsModified()};r.attachPropertyChange(u)}function p(e,t,n,r,a){var s=e||n;return new Promise(function(e,n){var o=s.getText("DRAFT_LOCK_EXPIRED",[t.LastChangedByUserDescription||t.LastChangedByUser]);var l=s.getText("Edit");var u=s.getText("CANCEL");i.warning(o,{title:s.getText("ST_UNSAVED_CHANGES_TITLE"),actions:[l,u],emphasizedAction:l,onClose:function(t){if(t===l){e()}else if(t===u){if(a){r.navigateUp()}}n()}})})}function D(e,n,r,a,i,o,l,u){var f=new Promise(function(f,v){var g=function(t,n){var r=e.editEntity(t,false,n);f(r);r.then(function(){a.invalidateEntry(t)})};if(r===""&&l&&u){var D=s.getInfoForContentIdPromise(n,a,i.oAppComponent.getId());Promise.all([D,d(e,n,l,u,a,i)]).then(function(e){var s=e[1];var l=e[0].contentIdRequestPossible?e[0].parametersForContentIdRequest.sRootExpand:null;var u="/"+a.createKey(n,s);a.createBindingContext(r,null,null,function(e){var e=new t(a,u);if(!s.DraftAdministrativeData||s.DraftAdministrativeData.DraftIsCreatedByMe){g(e,l)}else if(s.DraftAdministrativeData.InProcessByUser){v({lockedByUser:s.DraftAdministrativeData.InProcessByUserDescription||s.DraftAdministrativeData.InProcessByUser})}else{p(i,s.DraftAdministrativeData,o).then(function(){g(e)},function(){v({lockedByUser:s.DraftAdministrativeData.LastChangedByUserDescription||s.DraftAdministrativeData.LastChangedByUser})})}})},function(e){v({draftAdminReadResponse:e})})}else{var m=e.getDraftController().getDraftContext();a.createBindingContext(r,null,null,function(e){if(m.isDraftEnabled(n)){if(true||!m.hasPreserveChanges(e)){c(a,r,i.oBusyHelper).then(function(t){if(!t.DraftAdministrativeData||t.DraftAdministrativeData.DraftIsCreatedByMe){g(e)}else if(t.DraftAdministrativeData.InProcessByUser){v({lockedByUser:t.DraftAdministrativeData.InProcessByUserDescription||t.DraftAdministrativeData.InProcessByUser})}else{var n=function(){g(e)};var r=function(){v({lockedByUser:t.DraftAdministrativeData.LastChangedByUserDescription||t.DraftAdministrativeData.LastChangedByUser})};var a=p(i,t.DraftAdministrativeData,o);a.then(n,r)}},function(e){v({draftAdminReadResponse:e})})}}else{f({context:e})}})}});i.oBusyHelper.setBusy(f,true);return f}function m(e,t,n,r,a,i,s,o,l){var u=e.getDraftController().getDraftContext();var f=new Promise(function(d,v){r.createBindingContext(n,null,null,function(g){if(u.isDraftEnabled(t)){e.editEntity(g,true).then(function(e){g.getModel().invalidateEntry(g);s.setRootPageToDirty();d({context:e.context})},function(t){if(t&&t.response&&t.response.statusCode==="409"){a.removeTransientMessages();c(r,n,a.getBusyHelper()).then(function(t){if(t.DraftAdministrativeData.InProcessByUser){v({lockedByUser:t.DraftAdministrativeData.InProcessByUserDescription||t.DraftAdministrativeData.InProcessByUser})}else{var n=function(){var t=e.editEntity(g,false).then(function(e){g.getModel().invalidateEntry(g);s.setRootPageToDirty();d({context:e.context})});a.getBusyHelper().setBusy(t,true)};var r=Function.prototype;var u=p(undefined,t.DraftAdministrativeData,i,o,l);u.then(n,r)}},function(e){v({draftAdminReadResponse:e})});a.getBusyHelper().setBusy(f,true)}else{v(t)}})}else{return d({context:g})}})});return f}function y(e,t,n,r,a,i){var s=e.hasActiveEntity(r);var o=s&&!a?n.getDraftSiblingPromise(r):Promise.resolve();return o.then(function(e){var o=t(a,s,r);if(!a){var l=function(){return{context:e}};var u=o.then(l);n.cancellationStarted(r,u,i,e)}return o})}function h(e,t,n,r){var a=function(e,n,r){return t.deleteEntity(r)};return y(e,a,n,r,false,"discardAction")}function C(e,t,r){var a=t.getMessageModel();var i=a.bindList("/",null,null,[e]);var s=i.getAllCurrentContexts().map(function(e){return e.getObject()});if(r){s=s.filter(function(e){return!n.isMessageETagMessage(e)})}return s}function A(e,t,r,a,i,s){if(r.isBusy()){return l}var u=new Promise(function(l,u){var f=e?e:i.getView().getBindingContext();var c=t?t:a.oTemplateCapabilities.oMessageButtonHelper&&a.oTemplateCapabilities.oMessageButtonHelper.getContextFilter(true);var d=sap.ui.getCore().getMessageManager();var v=i.getView().getModel();var g=o.isContentIdReferencingAllowed(v)?s.getRootExpand():undefined;var p;var D=function(e){var t=p||C(c,d);var o=a.oDraftController.activateDraftEntity(f,e,g);a.oApplication.activationStarted(f,o);o.then(function(e){d.removeMessages(t);l(e)});o.catch(function(r){p=C(c,d);if(p.length>0){var o=p[0];var l=t.some(function(e){return e===o});if(l){u();return}}var f=a.oApplication.getTransientMessages();var v=[];var g=[];var m=false;f.forEach(function(t){m=!e&&(m||t.technicalDetails&&t.technicalDetails.statusCode==="412"&&t.technicalDetails.headers&&t.technicalDetails.headers["preference-applied"]==="handling=strict");if(t.type==="Warning"){v.push(t)}else if(t.type==="Error"){g.push(t)}});var y=p.some(function(e){return e.type==="Error"});var h=m&&!y;if(h){a.oApplication.removeTransientMessages();var A={messagesForUserDecison:p.concat(v)};var E=s.getCRUDActionHandler();E.handleCRUDScenario(4,D.bind(null,true),u,"Activate",A);return}u();if(y){a.oApplication.removeTransientMessages();if(a.oTemplateCapabilities&&a.oTemplateCapabilities.oMessageButtonHelper){a.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover();return}}n.handleError(n.operations.activateDraftEntity,i,a,r,null)});r.setBusy(o)};var m=a.oApplication.getDraftSiblingPromise(f).then(function(e){if(e){i.getOwnerComponent().getModel().invalidateEntry(e)}});r.setBusy(m);m.then(D.bind(null,false))});return u}return{createNonDraft:u,create:f,edit:D,directEdit:m,enableAutomaticDraftSaving:g,discardDraft:h,deleteEntity:y,activateDraftEntity:A,fnGetMessagesFromContextFilter:C}});
//# sourceMappingURL=CRUDHelper.js.map