sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/lib/navigation/routingHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/extend","sap/base/util/deepExtend","sap/base/util/isEmptyObject"],function(e,t,n,r,a,i,l){"use strict";var s=new r("lib.StatePreserver").getLogger();function u(e,n){var r=t.getCrossAppNavService();var a=e.componentRegistry[n.oComponent.getId()];var u=a.viewLevel===0;var p="";var o=Promise.resolve();var c=null;var f=Promise.resolve();var v=null;var g=null;var y=null;var S,m;var x=Object.create(null);var b={};var d={};function E(){x.permanentEntries=Object.create(null);x.sessionEntries=Object.create(null);x.pageEntries=Object.create(null);x.allEntries=Object.create(null)}E();function K(e){E();for(var t in e){var n=i({},e[t]);x.allEntries[t]=n;var r=n.lifecycle||Object.create(null);if(r.permanent){x.permanentEntries[t]=n}else if(r.session){x.sessionEntries[t]=n}if(r.page||r.pagination){x.pageEntries[t]=n}}return x}function h(e,t){if(t===e){return}var n=t.next.next;t.next.next=e.next;e.next=t.next;t.next=n}function P(e,t,a){if(l(t)){return{appStateKey:""}}var i=JSON.stringify(t);var s=0;var u;for(u=e;u.next&&s<10;s++){if(u.next.serialize===i){h(e,u);return{appStateKey:e.next.appStateKey}}u=u.next}u.next=null;var p=r.createEmptyAppState(n.oComponent.getAppComponent(),!a);var o={next:e.next,serialize:i,appStateKey:p.getKey()};p.setData(t);p.save();e.next=o;return{appStateKey:o.appStateKey}}function A(){var t=P(d,x.sessionEntries,false);var r=Object.create(null);if(t.appStateKey){r.sessionAppStateKey=t.appStateKey}if(!l(x.permanentEntries)){r.permanentEntries=x.permanentEntries}g=P(b,r,true);var i=Promise.resolve();if(y===g.appStateKey){g=null}else if(a.utils.isComponentActive()){i=e.oNavigationControllerProxy.navigateByExchangingQueryParam(n.appStateName,g.appStateKey)}else{p=g.appStateKey;g=null}if(v){v(i.then(e.oBusyHelper.getUnbusy));v=null}}function O(){if(!v||p!==y){return}var e=n.getCurrentState()||Object.create(null);K(e);A()}function j(){var t=a.aKeys;var n="";var r=a.route;for(var i=t.length-1;i>0;i--){var l=e.mRoutingTree[r];var s=i===1?l.entitySet:l.navigationProperty;n="/"+s+(t[i]?"("+t[i]+")":"")+n;r=l.parentRoute}return n}function C(e,t){return o.then(function(){var t=Object.create(null);var r=(!e||j()===e)&&S;if(r){t[n.appStateName]=r}return t})}function N(){if(e.bStateHandlingSuspended){return}if(!v){f=new Promise(function(e){v=e;setTimeout(O,0)})}return f}function w(){p=y;g=null;S=y}function H(e,t,n){if(!t){return}for(var r in t){var a=t[r];if(n||a.lifecycle.page){e[r]=a}}}function F(e,t){K(t);var r=Object.create(null);for(var a in t){r[a]=t[a].data}n.applyState(r,e);if(c){c();c=null}w();A();O()}function I(e,t,n){for(var r=e;r.next;r=r.next){if(r.next.appStateKey===n){h(e,r);return}}var a={next:e.next,serialize:JSON.stringify(t),appStateKey:n};e.next=a}function L(t,n,r,a,i,l){if(e.bStateHandlingSuspended){return}if(y===null){y=t}else if(t!==y){return}if(l){I(d,l,i);H(r,l,true)}H(r,a,true);F(n,r)}function R(t,n,r,a){var i=a||Object.create(null);I(b,i,t);if(u&&!i.permanentEntries){i={permanentEntries:{permanentState:{data:i,lifecycle:{permanent:true}}}}}var l=e.oNavigationControllerProxy.getAppStateFromShell(i.sessionAppStateKey).catch(Function.prototype);l.then(L.bind(null,t,n,r,i.permanentEntries,i.sessionAppStateKey))}function U(t){var r=e.componentRegistry[n.oComponent.getId()];var a=r.utils.getHeaderDataAvailablePromise()||Promise.resolve();return a.then(function(){return e.oApplicationProxy.areTwoKnownPathesIdentical(m,t,r.viewLevel===1)})}function z(e,t){if(e===m){t(true);return}if(!e||!m){t(false);return}U(e).then(t)}function T(t,r){z(t,function(i){if(!n.callAlways&&i){if(y===p){a.utils.hidePlaceholder();return}if(!y){A();return}}m=t;var l=Object.create(null);H(l,x[i?"allEntries":"pageEntries"],i||r);if(!y){if(i){H(l,x.sessionEntries,true);H(l,x.permanentEntries,true)}F(i,l);return}if(!c){o=new Promise(function(e){c=e})}var s=e.bStateHandlingSuspended?"":y;var u=e.oNavigationControllerProxy.getAppStateFromShell(s).catch(Function.prototype);u.then(R.bind(null,s,i,l))})}function B(){for(var e in x.pageEntries){var t=x.pageEntries[e].lifecycle;if(!t.permanent&&!t.session){delete x.allEntries[e];delete x.pageEntries[e]}}}function D(e){y=e[n.appStateName]||"";if(Array.isArray(y)){y=y.sort()[0]||""}if(g){if(g.appStateKey!==y){s.error("StatePreserver: Got AppstateKey "+y+" expected "+g.appStateKey);return false}w();return true}return false}function J(){return{isStateChange:D,leaveApp:B}}function G(e){if(e){var t=n.getInitialState();n.applyState(t,true);p="";return}T(m,true)}return{getUrlParameterInfo:C,stateChanged:N,applyAppState:T,getAsStateChanger:J,setState:G}}return e.extend("sap.suite.ui.generic.template.lib.StatePreserver",{constructor:function(e,t){a(this,u(e,t))}})});
//# sourceMappingURL=StatePreserver.js.map