sap.ui.define(["sap/ui/base/Object","sap/base/util/extend","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/MessageUtils"],function(e,t,o,r){"use strict";function n(e){var t,n;function i(e){var t=e.getContent()[1];return t.getSelectedItem().data("itemKey")}function a(e){var t=e.getContent()[1];var o=t.getItems()[0];t.setSelectedItem(o);o.focus()}function l(o,r,l){t=o;n=r;var u,v=p(),d=v.oController;var g="sap.suite.ui.generic.template.ObjectPage.view.fragments.DraftConfirmationPopup";v.oControllerUtils.oCommonUtils.getDialogFragmentAsync(g,{onDraftPopupOk:function(){var o=i(u);switch(o){case"draftPopupOptionSave":{var r=Promise.resolve(p().oController.beforeSaveExtension());r.then(s.bind(null,e,l),Function.prototype);u.close()}break;case"draftPopupOptionKeep":{t();u.close()}break;case"draftPopupOptionDiscard":{var a=c(l).then(t);a.catch(n);u.close()}break;default:break}},onDraftPopupCancel:function(){n();u.close()}},"draftConfirmationPopup").then(function(e){u=e;var t,o=f(d);if(o){t=p().oControllerUtils.oCommonUtils.getText("ST_KEEP_DRAFT_MESSAGE_CREATE")}else{t=p().oControllerUtils.oCommonUtils.getText("ST_KEEP_DRAFT_MESSAGE_EDIT")}u.getContent()[0].setProperty("text",t);a(e);u.open()})}function s(e,n){var i=p();var a=i.oControllerUtils.oServices;var l=i.oController;var s=o.activateDraftEntity(null,null,e.oBusyHelper,a,l,i.oControllerUtils.oComponentUtils);var c=s.then(function(o){var s=l.getOwnerComponent();var c=f(l);if(c){r.showSuccessMessageIfRequired(i.oControllerUtils.oCommonUtils.getText("OBJECT_CREATED"),a)}else{r.showSuccessMessageIfRequired(i.oControllerUtils.oCommonUtils.getText("OBJECT_SAVED"),a)}a.oViewDependencyHelper.setAllPagesDirty([s.getId()]);a.oViewDependencyHelper.unbindChildren(s);a.oApplication.invalidatePaginatorInfo();var u=o.context;var p=n==="LeaveApp"&&e.oApplicationProxy.navigateAfterActivation(u,true)||Promise.resolve();return p.then(function(o){e.oNavigationControllerProxy.setBackNavigationOption(o);t()})},function(){i.oControllerUtils.oInfoObjectHandler.executeForAllInformationObjects("smartTable",function(e){e.onSaveWithError()})});e.oBusyHelper.setBusy(c);var u={activationPromise:s};i.oControllerUtils.oComponentUtils.fire(i.oController,"AfterActivate",u)}function c(t){var r=e.oAppComponent.getTransactionController();var n=r.getDraftController();var i=e.oApplicationProxy;var a=i.getContextForPath(d());var l=e.oNavigationControllerProxy.getCurrentIdentity();var s=t==="LeaveApp"&&e.oApplicationProxy.getNavigateAfterDraftCancelPromise(a,true)||Promise.resolve();var c=s.then(function(t){return o.discardDraft(n,r,i,a).then(function(){e.oNavigationControllerProxy.setBackNavigationOption(t);e.oViewDependencyHelper.setRootPageToDirty();e.oViewDependencyHelper.unbindChildrenUsingTreeNode(l.treeNode);i.invalidatePaginatorInfo()})});e.oBusyHelper.setBusy(c);return c}function u(t,o,r,n){var i=e.oNavigationControllerProxy.isDiscardDraftConfirmationNeeded();var a=(i==="always"&&r.startsWith("Leave")||i==="restricted"&&r==="LeavePage")&&v();if(a){l(t,o,r)}else{t()}}function p(){var t;var o=e.oNavigationControllerProxy.getCurrentIdentity();var r=e.oApplicationProxy.getAncestralNode(o.treeNode,1);var n=r.componentId?r.componentId:o.treeNode.componentId;t=e.componentRegistry[n];return t}function f(e){var t=e.getOwnerComponent().getModel("ui");return t.getProperty("/createMode")}function v(){return e.oApplicationProxy.checkIfObjectIsADraftInstance(d())}function d(){var t=e.oNavigationControllerProxy.getCurrentIdentity();var o=e.oApplicationProxy.getAncestralNode(t.treeNode,1);var r=o.getPath(3,t.keys);return r}function g(t,o,r,n,i){var a=new Promise(function(a,l){var s=function(){var e=t();a(e)};var c=function(){o();l()};if(n){u(s,c,r,i)}else{e.oApplicationProxy.performAfterSideEffectExecution(u.bind(null,s,c,r,i),true)}});return a}return{discardDraft:c,performAfterDiscardOrKeepDraft:g}}return e.extend("sap.suite.ui.generic.template.lib.PageLeaveHandler",{constructor:function(e){t(this,n(e))}})});
//# sourceMappingURL=PageLeaveHandler.js.map