sap.ui.define(["sap/ui/integration/widgets/Card","sap/ovp/cards/Integration/Helpers/IntegrationCardPersonalization","sap/ovp/app/OVPLogger","sap/ovp/cards/AnnotationHelper","sap/ui/model/FilterOperator","sap/ovp/app/NavigationHelper","sap/ovp/cards/Integration/Helpers/AnalyticalCard","sap/ovp/cards/Integration/Helpers/i18n","sap/ovp/cards/Integration/Helpers/Batch","sap/ovp/cards/Integration/Helpers/Filters","sap/ovp/app/resources","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ovp/cards/MetadataAnalyser","sap/ovp/helpers/ODataDelegator","sap/ovp/cards/Integration/Helpers/CardHeader","sap/fe/navigation/SelectionVariant","sap/ovp/cards/CommonUtils","sap/ui/core/Core","sap/ovp/cards/Integration/Helpers/ListContentHelper","sap/ovp/cards/Integration/Helpers/ContentHelper","sap/ovp/cards/Integration/Helpers/TableContentHelper","sap/insights/CardHelper","sap/m/MessageToast","sap/ovp/cards/Integration/Helpers/CardAction"],function(e,t,a,r,n,i,o,s,l,p,u,d,c,v,f,g,m,h,y,P,b,C,T,S,D){"use strict";var O=new a("sap.ovp.cards.Integration.IntegrationCard");var V="module:sap/insights/CardExtension";var w="";var I=function(e,t,a,r,n){var i=e&&e.getBinding(t);var o,s,l,p,u,d;var c,v,f;var g=r&&n!="sap.ovp.cards.charts.analytical"&&n!="sap.ovp.cards.charts.smart.chart";if(i){o=i.aApplicationFilters;s=i.getPath();l=i.mParameters.select;p=L(l&&l.split(","));l=p&&p.join();u=i.sSortParams;d=i.sRangeParams;c=i&&i.sCustomParams;v=c&&c.split("&");v=v&&v.filter(function(e){return e.indexOf("$expand")>-1});f=v&&v[0]}var m=d&&d.split("&")||[];var h,y;for(var P=0;P<m.length;P++){var b=m[P];if(b.indexOf("$skip")>-1){h=b.split("&")[0]}if(b.indexOf("$top")>-1){y=b.split("&")[0]}}if(g&&a&&a.length){var C=l&&l.split(",")||[];a.forEach(function(e){if(!C.includes(e)){C.push(e)}});l=C.join(",")}return{sBindingPath:s,aApplicationFilters:o,sSelect:l?"$select="+l:"",sSortParameters:u?u:"",skip:h?h:"",top:y?y:"",sExpandParam:f||""}};var F=function(e,t){var a=e.view.getController(),r=a&&a._getEntityNavigationParameters(),n=r&&r.sNavSelectionVariant,i=n&&JSON.parse(n),o=i&&i.SelectOptions||[];return o.filter(function(e){return t.indexOf(e["PropertyName"])>-1})};var M=function(e,t,a,r,n){var i=n.view.getModel(),o=n&&n.entityType,s=o&&o.property;var l,p=[],u,d,c=o&&o.name,f=t&&t.name;var g=i.oMetadata._getEntityTypeByName(c);var m=a&&a.oMetadata._getEntityTypeByName(f);if(!g&&!m){return}else if(g&&!m){p=[g.property]}else if(g&&m){p=[g.property,m.property]}for(var h=0;h<p.length;h++){s=JSON.parse(JSON.stringify(p[h]));for(var y=0;y<s.length;y++){if(s[y].name===e){l=s[y];return l}if("P_"+s[y].name===e||s[y].name==="P_"+e||"$Parameter.P_"+s[y].name===e||s[y].name==="$Parameter.P_"+e){l=s[y];if(l&&v.checkAnalyticalParameterisedEntitySet(i,n.entitySet.name)){u=r.length&&R(e,r)}return u&&u.length?u[0]:l}}}if(v.checkAnalyticalParameterisedEntitySet(i,n.entitySet.name)){d=r.length&&R(e,r);if((!d||!d.length)&&e.includes("/")){var P=e.split("/");d=P.length&&R(P[P.length-1],r)}}if(d&&d.length){return d[0]}return undefined};var x=function(e,t){var a;if(e&&e[t]){return e[t]}else if(e&&e.extensions){a=e.extensions;for(var r=0;r<a.length;r++){if(a[r].name===t){return a[r].value}}}return""};var R=function(e,t){return t.filter(function(t){if(t.name===e||"P_"+t.name===e||t.name==="P_"+e||"$Parameter.P_"+t.name===e||t.name==="$Parameter.P_"+e||t.name==="$Parameter."+e||"$Parameter."+t.name===e){return t}})};var N=function(e){return e["sap:filterable"]?e["sap:filterable"]!=="false":true};var E=function(e,t,a){var r=t.filter(function(t){var a=e.some(function(e){return e===t.name});return N(t)&&a})||[];if(a&&a.length>0){e.forEach(function(e){var t="P_"+e.name;if(a.includes(t)){r.push(e)}})}return r};var A=function(e){var t=[];if(e&&e.extensions){t=e.extensions;for(var a=0;a<t.length;a++){if(t[a].name==="parameter"&&t[a].value==="mandatory"){return e.name}else if(t[a].name==="required-in-filter"&&t[a].value==="true"){return e.name}}}};var _=function(e,t){if(t&&t.length){var a=t.filter(function(t){return t.name===e.name});return a&&a[0]}};var k=function(e,t,a,r,n,i,o){var s=o.cardComponentData.mainComponent.oGlobalFilter,l=o.view.getModel("ovpCardProperties"),u=l&&l.getProperty("/bInsightRTEnabled");var d;if(e["PropertyName"]&&e["PropertyName"]["PropertyPath"]){var c=e["PropertyName"]["PropertyPath"];if(e["PropertyValue"]&&e["PropertyValue"]["String"]){var v=M(c,undefined,undefined,a,o);c=v&&v.name?v.name:c;var f=A(v);var g=p.getParameterActualValue(c,s);if(f&&r.includes(f)){n.push(f);t[c]={value:u&&g?g:e["PropertyValue"]["String"],type:p.getPropertyType(v),description:v&&v.description?v.description:null,label:p.getLabelForConfigParams(c,s,t,o,e["PropertyValue"]["String"])};var h=p.IsSemanticDateRangeValid(o,v);if(h){d=p.getDateRangeControlValue(c,s)}t[c]["description"]=d||x(v,"description")}else if(f){i.push(f);var y=new m;var P=p.getLabelForConfigParams(c,s,t,o,e["PropertyValue"]["String"])||[];var b="";if(u&&g){b=p.getRelatedTextToRange({Low:g},P,s,c);y.addSelectOption(c,"I","EQ",g,null,b)}else{b=p.getRelatedTextToRange({Low:e["PropertyValue"]["String"]},P,s,c);y.addSelectOption(c,"I","EQ",e["PropertyValue"]["String"],null,b)}t[c]={value:y.toJSONString(),type:p.getPropertyType(v),description:v&&v.description?v.description:null};t[c].value=p.enhanceVariant(t[c].value);var h=p.IsSemanticDateRangeValid(o,v);if(h){d=p.getDateRangeControlValue(c,s)}t[c]["description"]=d||x(v,"description")}}}};var L=function(e){return e&&e.filter(function(t,a){return e.indexOf(t)===a})};var H=function(e,t){if(!h.isODataV4(t)){return e.property.map(function(e){return e.name})}else{return Object.keys(e.property)}};var j=function(e){var t={filters:{}};var a=t.filters;var r=e.cardComponentData.mainComponent.oGlobalFilter;var n=r&&r.getModel();var i=r&&r.getEntityType();var o=e.view.getModel();var s=e.entityType,l,u=[];var d=[],c=[],g=[],h=[],y,P,b=[];var C=[];var T=n&&n.getMetaModel();var S=T&&T.getODataEntityContainer();var D=T.getODataEntityType(i);var O=S&&S.entitySet&&S.entitySet.filter(function(e){return e.entityType===i});var V=O&&O.length>0?O[0]:{};var w=[];if(n){var I=v.checkAnalyticalParameterisedEntitySet(n,V&&V.name);if(I){var R=f.getParametersByEntitySet(n,V);if(R.entitySetName){w=R.parameters||[]}}}var N=f.getParametersByEntitySet(o,e.entitySet).parameters;var j=e.view.getModel("ovpCardProperties");var U=j&&j.getProperty("/bInsightRTEnabled");var J="";var Q;N.forEach(function(t){var i=A(t);var s=p.getParameterDefaultValue(n,V,i,e);var l=p.getParameterDefaultValue(o,e.entitySet,i,e);var d=s||l||t.defaultValue||"";var c=p.getParameterActualValue(t.name,r);J=p.getLabelForConfigParams(t.name,r,a,e,d);var v=p.IsSemanticDateRangeValid(e,t);if(v){var f=c.conditionTypeInfo;var m=f&&f.data&&f.data["operation"];p.setFilterRestrictionToSemanticDateRange(t,true);d=p.getDateRangeDefaultValue(e,t.name)||d;c=p.getDateRangeValueForParameters(c)||c;var h=p.getDateOperationValue(m)||false;if(!h){if(U&&J&&typeof J==="string"){J=J.substring(0,J.indexOf("(")-1)}else if(d){J=d;p.getLabelForConfigParams(t.name,r,a,e,d,true)}}Q=p.getDateRangeControlValue(t.name,r)}if(i){g.push(t.name)}a[t.name]={value:U&&c?c:d,type:p.getPropertyType(t),description:Q||t&&t.description,label:J};a[t.name]["description"]=Q||x(t,"description");u.push(t.name);b.push(t.name)});w=w.filter(function(e){return!b.includes(e)});if(s&&s.property&&D&&D.property){var $=H(s,o);C=E($,D.property,w)}for(var B=0;B<C.length;B++){var q=C[B],K="";var W=_(q,s.property);var z=A(W);var X=p.getFilterDefaultValue(q.name,D,s)||q.defaultValue||"";var G=p.getParameterActualValue(q.name,r);if(b.includes(q.name)){J=p.getLabelForConfigParams(q.name,r,a,e,X);var Y=p.IsSemanticDateRangeValid(e,q);if(Y){p.setFilterRestrictionToSemanticDateRange(q,true);X=p.getDateRangeDefaultValue(e,q.name)||X;G=p.getDateRangeValueForParameters(G)||G;if(U&&J&&typeof J==="string"){J=J.substring(0,J.indexOf("(")-1)}else if(X){J=X;p.getLabelForConfigParams(q.name,r,a,e,X,true)}Q=p.getDateRangeControlValue(q.name,r)}a[q.name]={value:U&&G?G:X,type:p.getPropertyType(q),description:Q||q&&q.description,label:J};if(z){g.push(z)}u.push(q.name)}else{y=new m;var Z=p.getLabelForConfigParams(q.name,r,a,e,X);var G;var Y=p.IsSemanticDateRangeValid(e,q);if(Y){p.setFilterRestrictionToSemanticDateRange(q,false);p.addDateRangeValueToSV(e,q,X,y,Z);Q=p.getDateRangeControlValue(q.name,r)}else{if(U){p.addFiltervalues(r,q.name,y,Z)}else if(X){var ee=p.getRelatedTextToRange({Low:X},Z,r,q.name);y.addSelectOption(q.name,"I","EQ",X,null,ee)}else{y.addSelectOption(q.name,"I","EQ",K)}}a[q.name]={value:y.toJSONString(),type:p.getPropertyType(q),description:Q||q&&q.description};a[q.name].value=p.enhanceVariant(a[q.name].value);if(z){h.push(z)}d.push(q.name)}a[q.name]["description"]=Q||x(q,"description")}var te=e.cardComponentData.settings["selectionAnnotationPath"];var ae=e.entityType[te]&&JSON.parse(JSON.stringify(e.entityType[te]));var re=[],ne;for(var ie in ae){if(ae.hasOwnProperty(ie)){ne="";var oe=Array.isArray(ae[ie])&&ae[ie];if(ie==="Parameters"){for(var se=0;oe&&se<oe.length;se++){if(oe[se]["PropertyName"][["PropertyPath"]].includes("/")){var le=oe[se]["PropertyName"][["PropertyPath"]].split("/");u.push(le[le.length-1])}else{u.push(oe[se]["PropertyName"][["PropertyPath"]])}ne=oe[se];k(ne,a,N,b,g,h,e)}}else if(ie==="SelectOptions"){re=ae["SelectOptions"];for(var pe=0;oe&&pe<oe.length;pe++){if(re[pe].Ranges){c.push(ae["SelectOptions"][pe]["PropertyName"]["PropertyPath"])}d.push(ae["SelectOptions"][pe]["PropertyName"]["PropertyPath"]);ne=oe[pe];k(ne,a,N,b,g,h,e)}P=F(e,c)}}}if(P){P.forEach(function(t){var i=t&&t.PropertyName;var o=p.getLabelForConfigParams(i,r,a,e)||[];var s=t&&t.Ranges||[];s.forEach(function(e){var t=p.getRelatedTextToRange(e,o,r,i);if(t){e.Text=t}});var u={Parameters:[],SelectOptions:[t]};var d=M(i,D,n,N,e);if(d){i=d.name}a[i]={value:JSON.stringify(u),type:p.getPropertyType(d),description:d&&d.description};a[i]["description"]=x(l,"description");var c=A(d);if(c&&b.includes(c)){g.push(c)}else if(c){h.push(c)}})}var ue=L(d);var de=L(u);var ce=L(g);var ve=L(h);p.updateRangeValue(a);a["_relevantODataFilters"]={value:ue};a["_relevantODataParameters"]={value:de};a["_mandatoryODataParameters"]={value:ce};a["_mandatoryODataFilters"]={value:ve};return t};var U=function(e,t,a){var r="";if(t){for(var n=0;n<e.length;n++){r=r+"${"+e[n]+"},"}}if(a){if(t){return"{= extension.formatters.formatValueColor("+r+JSON.stringify(t)+")}"}else if(e.length){return"{= extension.formatters.kpiValueCriticality(${"+e[0]+"})}"}}else{return"{= extension.formatters.formatTrendIcon("+r+JSON.stringify(t)+")}"}};var J=function(e,t,a){var r=e.view.getModel("ovpCardProperties");var n=e.entityType[r.getProperty("/presentationAnnotationPath")];var i=p.getRequestAtLeastFields(n);var o=r.getProperty("/addODataSelect");var s=r.getProperty("/template");if(e){var l,u="";switch(e.cardComponentName){case"Analytical":var d=e.vizFrame;l=d&&d.getParent();u="data";break;case"List":l=e.view.byId("ovpList");u="items";break;case"Table":l=e.view.byId("ovpTable");u="items";break}var c=I(l,u,i,o,s);a["_contentSkipQuery"]={value:c.skip};if(e.cardComponentName==="List"||e.cardComponentName==="Table"){a["_contentTopQuery"]={value:"$top=13"}}else{a["_contentTopQuery"]={value:c.top}}a["_contentSortQuery"]={value:c.sSortParameters};a["_contentSelectQuery"]={value:c.sSelect};a["_contentExpandQuery"]={value:c.sExpandParam}}if(t==="Numeric"){var v=e.view.byId("kpiHBoxNumeric");var f=I(v,"items",i,o,s);a["_headerSkipQuery"]={value:f.skip};a["_headerTopQuery"]={value:f.top};a["_headerSortQuery"]={value:f.sSortParameters};a["_headerSelectQuery"]={value:f.sSelect};a["_headerExpandQuery"]={value:f.sExpandParam}}};var Q=function(e,t){var a=e.cardComponentData.settings;var r=e.view;var n=r&&r.getController();var o=n._getEntityNavigationParameters().sNavSelectionVariant;o=o?JSON.parse(o):"";var s=o&&o.SelectOptions;var l=a.requireAppAuthorization;var p={},u={},d={},c={};if(l){p=i.getNavigationIntentFromAuthString(l);d=p.parameters}var v=Object.keys(d);if(v.length>0){for(var f=0;f<v.length;f++){if(!Array.isArray(d[v[f]])){u[v[f]]={defaultValue:{value:d[v[f]]}}}}}if(s&&s.length){s.forEach(function(e){var a=e["PropertyName"];var r=t.filters._relevantODataFilters.value.includes(a),n=t.filters._relevantODataParameters.value.includes(e["PropertyName"]);var i;if(e&&a&&!u[a]&&e.Ranges.length&&e.Ranges[0].Option==="EQ"&&!(r||n)){i=e.Ranges[0].Low;if(i!==undefined||i!==null){try{i=JSON.parse(e.Ranges[0].Low)}catch(e){}if(!Array.isArray(i)){u[a]=i}}}})}c={inbounds:{intent:{signature:{additionalParameters:"allowed"}}}};h.updatePropertyValueForObject(c.inbounds.intent,p.semanticObject,"semanticObject");h.updatePropertyValueForObject(c.inbounds.intent,p.action,"action");h.updatePropertyValueForObject(c.inbounds.intent.signature,u&&Object.keys(u).length?u:null,"parameters");return c};var $=function(e,t){if(!e||!t){return}var a=e.getMetaModel();var r=a&&a.getODataEntityContainer();var n=r&&r.entitySet;if(!n||!Array.isArray(n)){return}var i=n.length;for(var o=0;o<i;o++){if(n[o].entityType===t){return n[o].name}}};var B=function(e,t,a){if(e.startsWith("/sap/opu/odata")&&!e.endsWith(".xml")){return{uri:e,type:"ODataAnnotation"}}else if((!e.startsWith("/sap/opu/odata")||e.startsWith("/sap/opu/odata"))&&e.endsWith(".xml")){if(t&&a["sap.platform.abap"]){var r=a["sap.platform.abap"].uri;if(e.indexOf("./")===0){e=e.replace("./","")}else if(e.indexOf("/")===0){e=e.replace("/","")}else if(e.indexOf("../")===0){e=e.replace("../","")}e=r+"/"+e}return{uri:e,type:"XML"}}};var q=function(e,t){var a=e.cardComponentData.model.sServiceUrl;var r=e.view.getModel();var n;if(!h.isODataV4(r)){n="{{destinations.service}}"+a+"/$batch"}else{n="{{destinations.service}}"+a+"$batch"}var i={};var o=l.getBatchObject(e,t["configuration"]);i["request"]={url:n,method:"POST",headers:{Accept:"multipart/mixed","X-CSRF-Token":"{{csrfTokens.token1}}"},batch:o};if(i.request.batch.header){i.request.batch.header.url="{{parameters._headerDataUrl}}"}i.request.batch.content.url="{{parameters._contentDataUrl}}";if(!o.header){var s=i["request"].batch.content;s.headers["X-CSRF-Token"]="{{csrfTokens.token1}}";if(!h.isODataV4(r)){s.url="{{destinations.service}}"+a+"/"+s.url}else{s.url="{{destinations.service}}"+a+s.url}i["request"]=s}return i};var K=function(e){var t=e.cardComponentData.model.sServiceUrl;var a={};a["parameters"]=j(e)["filters"];a["destinations"]={service:{name:"(default)",defaultUrl:"/"}};a["csrfTokens"]={token1:{data:{request:{url:"{{destinations.service}}"+t,method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}}}};return a};var W=function(e,t,a){var r=g.getHeaderDetails(e),n=e.cardComponentData.cardId,i=e.cardComponentData.appComponent.getManifestObject().getRawJson(),p=i["sap.ovp"]["cards"][n].settings,u=e.cardComponentData.settings,d=u&&u.selectedKey,c,v=e.view.getModel();J(e,r,t["configuration"]["parameters"]);var f=t.extension&&r==="Numeric"?g.mainIndicatorDetails(e):"";var m=f&&f.path&&f.path.length?g.mainIndicatorNumberPath(f.path,f.ovpProp):"";s.createKeysFromText(n,p.title,"Title","card Title","header.title");s.createKeysFromText(n,p.subTitle,"Title","card subTitle","header.subTitle");var y=f&&f.valueColor?U(f.valueColor.path,f.valueColor.ovpProp,true):null;var P=f&&f.indicator?U(f.indicator.path,f.indicator.ovpProp,false):null;var C=f&&f.target?f.target:null;var T=f&&f.deviation?f.deviation:null;var S="",D,O="",V,w=[],I={},F={};if(C&&C.parts.length){S=g.targetDeviationValuePath(C,e.view.getModel("ovpCardProperties"),"targetValueFormatter");D=e.view.getModel("ovpCardProperties").getProperty("/bPercentageAvailableForTarget")?"%":null;if(S){h.updatePropertyValueForObject(F,f.target.text,"title");h.updatePropertyValueForObject(F,S,"number");h.updatePropertyValueForObject(F,D,"unit");w.push(F)}}if(f&&f.ovpProp){V=g.mainIndicatorNumberPath(f.path,f.ovpProp,true)}if(T&&T.parts.length){O=g.targetDeviationValuePath(T,e.view.getModel("ovpCardProperties"),"returnPercentageChange");F={};if(O){h.updatePropertyValueForObject(F,f.deviation.text,"title");h.updatePropertyValueForObject(F,O,"number");w.push(F)}}var M=o.getUoMForSubTitle(n);if(r!=="Default"){I={type:r,title:p.title,subTitle:p.subTitle,details:g.generateDetailsExpression(t,p,n,d)};h.updatePropertyValueForObject(I,M,"unitOfMeasurement");h.updatePropertyValueForObject(I,w,"sideIndicators");if(m){I["mainIndicator"]={};h.updatePropertyValueForObject(I.mainIndicator,m,"number");h.updatePropertyValueForObject(I.mainIndicator,y,"state");h.updatePropertyValueForObject(I.mainIndicator,P,"trend");h.updatePropertyValueForObject(I.mainIndicator,V,"unit")}c=I}else{c={type:r,title:p.title,subTitle:p.subTitle,details:g.generateDetailsExpression(t,p,n,d)}}if(a){c.data={path:l.getBatchRequestPath("/header/d/results/0",v)}}if(c.details){c.type="Numeric"}if(t["type"]==="List"||t["type"]==="Table"){c.status=b.getHeaderStatus(a)}return c};var z=function(e,t){var a=e.cardComponentData.settings;var r;switch(t["type"]){case"Analytical":r=o.createChartContent(e,a.chartAnnotationPath,t);r.chartProperties["title"]=r.title;delete r.title;break;case"List":r=P.getListContent(e,t);break;case"Table":r=C.getTableContent(e,t);break;default:r={};break}return r};var X=function(e){var t={},a=e.cardComponentData.cardId;t["extension"]=V;t["type"]=e.cardComponentName;t["configuration"]=K(e);t["data"]=q(e,t);t["header"]=W(e,t,t["data"].request.batch);t["content"]=z(e,t);var r=p.getSemanticDateConfiguration(e)||{};if(Object.keys(r).length){t["configuration"]["parameters"]["_semanticDateRangeSetting"]={value:JSON.stringify(r)}}s.replaceStringsWithKeys(t,a);var n=e.view.getModel("ovpCardProperties");var i=n&&n.getProperty("/bInsightDTEnabled");if(i){l.updateBatchObject(e,t["configuration"],true)}return t};var G=function(e){var t=e.cardComponentData.appComponent.getManifest()["sap.app"],a=t.id,r=e.cardComponentData.settings,n=e.cardComponentData.cardId,i=e.cardComponentData.appComponent.getManifestObject().getRawJson(),o=i["sap.app"].i18n&&i["sap.app"].i18n.bundleUrl||i["sap.app"].i18n,l=i["sap.platform.abap"]&&i["sap.platform.abap"].uri,p=r&&r.selectedKey,u=e.view.getModel("ovpCardProperties"),d=u&&u.getProperty("/bInsightRTEnabled");var c=i["sap.fiori"]&&i["sap.fiori"].registrationIds&&i["sap.fiori"].registrationIds[0]||a,v=p?c+".cards."+n+".tab_"+p:c+".cards."+n;var f=p?"../../../":"../../";w=f+o;if(l){if(l.startsWith("/")){l=l.substring(1)}o=l+"/"+o}if(d){v="user."+v+"."+Date.now()}var g;if(d){g={title:t&&t.title||"",subtitle:t&&(t.subtitle||t.description)||""}}else{g=s.getKeysForAppProperties(t,i,e)}var m=g&&g.title,h=g&&g.subtitle,y=j(e),P={id:v,type:"card",embeddedBy:f,i18n:f+o,tags:{keywords:["Analytical","Card","Line","Sample"]},crossNavigation:Q(e,y),dataSources:{}};if(m){P.title=m}if(h){P.subTitle=h}var b=e.cardComponentData.appComponent.getManifest()["sap.ovp"];var C=b.globalFilterModel;var T=e.cardComponentData.appComponent.getManifest()["sap.ui5"].models[C].dataSource;var S=t.dataSources;var D=S[T];var O={},V=[],I="",F;if(D&&D.settings){var M=D.settings.annotations,x;M.length&&M.forEach(function(e){for(var t in S){x=S[e].uri;if(t===e&&x){V.push(t);O[t]=B(x,d,i);break}}});if(D&&D.uri){F=B(D.uri,d,i)}I=D.settings&&D.settings["odataVersion"]}P.dataSources=O;P.dataSources["filterService"]={uri:D&&D.uri,settings:{annotations:V,odataVersion:I?I:"2.0"},type:F&&F.type};return P};var Y=function(e){var t=e.cardComponentData.appComponent.getManifest()["sap.app"],a=t.id,r=e.cardComponentData.appComponent.getManifest()["sap.ovp"],n=e.view.getModel("ovpCardProperties"),i=n&&n.getProperty("/bInsightRTEnabled"),o="",s=e.cardComponentData.mainComponent.oGlobalFilter,l=s&&s.getEntityType(),p=e.cardComponentData.mainComponent.getOwnerComponent(),u=p.oOvpConfig.sapUICoreVersionInfo||{};if(!r.globalFilterEntitySet){o=$(s&&s.getModel(),l)}return{templateName:"OVP",parentAppId:a,filterEntitySet:r.globalFilterEntitySet?r.globalFilterEntitySet:o,cardType:i?"RT":"DT",versions:{ui5:u.version+"-"+u.buildTimestamp}}};var Z=function(e){var t={};t["sap.card"]=X(e);t["sap.app"]=G(e);t["sap.insights"]=Y(e);var a=D.getCardActions(e,t["sap.card"]);if(a.header.enabled){t["sap.card"].header.actions=a.header.actions}if(a.content.enabled){switch(e.cardComponentName){case"Analytical":t["sap.card"].content.actions=a.content.actions;break;case"List":t["sap.card"].content.item.actions=a.content.actions;break;case"Table":t["sap.card"].content.row.actions=a.content.actions;break}}return t};var ee=function(e,t,a){var r=e["sap.card"]["header"][a];if(r&&r.startsWith("{{")){var n=r.split("{{")[1].split("}}")[0];var i=t.view.getModel("@i18n")?t.view.getModel("@i18n"):t.view.getModel("i18n");r=i?i.getProperty(n):undefined}return r?r:""};var te=function(e,t,a,r){r.valueState=t;r.valueStateText=a;e.setValueState(r.valueState);e.setValueStateText(r.valueStateText)};var ae={createManifestFor:Z,saveCardManifest:function(e,a){t.create().then(function(t){if(!a){var r=e["sap.app"].id;t.writeManifest(r,e)}})},downloadCardManifest:function(e){},createCard:function(t){var a=Z(t),r=window.location.origin,n=r+"/resources",i=new e({height:"533px",width:"314px",manifest:a,baseUrl:n});return i},UpdateManifestDeltaChanges:function(e,t,a,r){var n={_version:"1.1.0",contentDensities:{compact:true,cozy:true},dependencies:{libs:{"sap.insights":{lazy:false}}}};e["sap.ui5"]=n;if(e["sap.app"]["i18n"]!==w){e["sap.app"]["i18n"]=w}l.enhanceHeaderAndContentURLForSemanticDate(e["sap.card"]);l.enhanceHeaderAndContentURL(e["sap.card"]);var i=t.view.getModel("ovpCardProperties");var o=i&&i.getProperty("/bInsightRTEnabled");var p=i&&i.getProperty("/bInsightDTEnabled");if(p){var u=ee(e,t,"title");var d=ee(e,t,"subTitle");var c=y.byId(a+"--titleTextInput");if(c&&c.getValue()){var v=y.byId(a+"--subTitleTextInput");var f=t.cardComponentData.cardId;if(this.titleChanged&&c.getValue()!==u){s.createKeysFromText(f,c.getValue(),"Title","card Title","header.title");this.titleChanged=false}var g=v.getValue();var m=v&&g&&this.subTitleChanged&&g!==d;if(m){s.createKeysFromText(f,g,"Title","card subTitle","header.subTitle");this.subTitleChanged=false}else if(v&&!g){this.subTitleChanged=false;delete e["sap.card"].header.subTitle}}s.inserti18nKeysManifest(e["sap.card"]);s.writei18nPayload();l.updateBatchObject(t,e["sap.card"]["configuration"],false);if(r==="Create"){this.saveCardManifest(e,o)}else if(r==="Download"){this.downloadCardManifest(e)}s.reseti18nProperties()}else if(o){var h=t.view.getModel("@i18n");if(e["sap.card"].type==="Analytical"){e["sap.card"]["content"].chartProperties.title.text=s.getI18nValueOrDefaultString(e["sap.card"]["content"].chartProperties.title.text,h)}else if(e["sap.card"].type==="Table"){var P=e["sap.card"].content.row.columns;if(Array.isArray(P)&&P.length){P.forEach(function(e,t){P[t].title=s.getI18nValueOrDefaultString(e.title,h)})}}else if(e["sap.card"].type==="List"){var b=e["sap.card"]["content"];var C=(((b||{}).item||{}).info||{}).value;var T=C&&C.split(",").slice(-1);var S=T&&T[0]&&T[0].split("/")[1];var D=e["sap.card"].configuration.parameters;var O=D[S]&&D[S].value;if(O&&O.startsWith("{{")){D[S].value=h.getProperty(S)}}s.fnReplacei18nKeysWithText(e,h)}},showCard:function(e){var t=e.view.getModel("ovpCardProperties"),a=t&&t.getProperty("/bInsightRTEnabled"),r=t&&t.getProperty("/bInsightDTEnabled"),n=this.createCard(e),i=n.getManifest();if(a){this.UpdateManifestDeltaChanges(i,e);return T.getServiceAsync("UIService").then(function(e){return e.showCardPreview(i).then(function(){return Promise.resolve(i)})}).catch(function(e){S.show(e.message)})}else if(r){return new Promise(function(t,a){var r=u.oResourceModel,o=ee(i,e,"title"),l=ee(i,e,"subTitle"),p={draggable:true,cardTitle:o,cardSubTitle:l,valueState:o?"None":"Error",valueStateText:o?"":u.getText("INT_Preview_Title_ValueStateText")},v=new c({dialogSettings:p}),f=h.getApp().getOwnerComponent(),g=f.createId("integrationCardPreview");this.handleCancel=function(){this.previewDialogPromise.then(function(e){e.close();s.reseti18nProperties();e.destroy();this.titleChanged=false;this.subTitleChanged=false}.bind(this))};this.handleTitleLiveChange=function(e){var t=e.getSource();var a=t.getValue();this.previewDialogPromise.then(function(){if(a&&n.getCardHeader().getTitle()!==a){te(t,"None","",p);n.getCardHeader().setTitle(a);this.titleChanged=true}else if(!a){this.titleChanged=true;te(t,"Error",u.getText("INT_Preview_Title_ValueStateText"),p)}else{te(t,"None","",p)}}.bind(this))};this.handleSubTitleLiveChange=function(e){var t=e.getSource();var a=t.getValue();this.previewDialogPromise.then(function(){if(n.getCardHeader().getSubtitle()!==a){n.getCardHeader().setSubtitle(a);this.subTitleChanged=true}}.bind(this))};this.confirmActionHandler=function(){this.previewDialogPromise.then(function(a){this.UpdateManifestDeltaChanges(i,e,g,"Create");a.close();a.destroy();t(i)}.bind(this))};this.downloadCardManifestHandler=function(){this.previewDialogPromise.then(function(a){this.UpdateManifestDeltaChanges(i,e,g,"Download");a.close();a.destroy();t(i)}.bind(this))};this.previewDialogPromise=d.load({id:g,type:"XML",name:"sap.ovp.cards.Integration.Preview",controller:this}).then(function(t){t.setModel(v);t.setModel(e.view.getModel("i18n"),"i18n");t.setModel(r,"ovpResourceModel");var a=y.byId(g+"--subFlexBoxNew");a.addItem(n);this.titleChanged=false;this.subTitleChanged=false;if(e.cardComponentName!=="Analytical"){y.byId(g+"--ovpIntPreviewOverflowLayer").setVisible(true)}t.open();return t}.bind(this)).catch(function(e){O.error("Integration card preview fragment failed to load, "+e)})}.bind(this))}}};return ae},true);
//# sourceMappingURL=IntegrationCard.js.map