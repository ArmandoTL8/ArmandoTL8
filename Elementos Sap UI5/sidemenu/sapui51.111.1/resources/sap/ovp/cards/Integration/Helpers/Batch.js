sap.ui.define(["sap/ovp/cards/AnnotationHelper","sap/fe/navigation/SelectionVariant","sap/ui/model/Filter","sap/ovp/cards/Integration/Helpers/Filters","sap/ovp/app/FilterHelper","sap/base/security/encodeURL","sap/ovp/cards/CommonUtils","sap/ui/model/odata/ODataUtils","sap/ui/model/FilterProcessor"],function(t,e,a,r,n,i,l,o,s){"use strict";var u={contentDataUrlUpdated:false,headerDataUrlUpdated:false};function f(t,e){var a=t.split(/\?/);var r=a[1]&&a[1].replace(/^.*\?/,"").split(/&/);var n="";r&&r.forEach(function(t){if(t.indexOf(e)===-1){if(n.length===0){n+=t}else{n+="&"+t}}});return a[0]+(n!==""?"?"+n:"")}function v(t,e){if(t&&e){if(t.indexOf("?")===-1){t+="?"+e}else{t+="&"+e}}return t}function p(t,e){var a=t.split(/\?/);if(a.length>1){var r=a[1].replace(/^.*\?/,"").split(/&/);var n=r.filter(function(t){return t.includes(e)});return n.length===1?n[0]:""}return""}function d(t,e,a,r){if(r){var n=a&&a._oFilterProvider;var i=n&&n._oParameterization;var l=i&&i.getNavigationPropertyToQueryResult();return{_entitySet:{value:i&&i.getName()},_urlSuffix:{value:"/"+l}}}else{var o=t.split("/").length>2?t.substring(t.lastIndexOf("/")):"";return{_entitySet:{value:e.oCardComponentData.settings.entitySet},_urlSuffix:{value:o}}}}function c(e){var a=e.cardComponentData.mainComponent;var r=e.view.getController();var n=a.getGlobalFilter();var i=r.getCardItemsBinding().getPath();var l;if(n&&n.getConsiderAnalyticalParameters()){var o=n.getAnalyticBindingPath();var s=r.getEntitySet().entityType;var u=n.getEntityType();if(o&&o.length>0){if(s===u){l=d(o,r,n,true);return{sPath:o,_entitySet:l._entitySet,_urlSuffix:l._urlSuffix}}}else{var f=r.getCardPropertiesModel().getProperty("/selectionAnnotationPath");var v=e.entityType[f];var p=t.resolveParameterizedEntitySet(r.getModel(),e.entitySet,v);l=d(p,r,n,false);return{sPath:p,_entitySet:l._entitySet,_urlSuffix:l._urlSuffix}}}l=d(i,r,n,false);return{sPath:"",_entitySet:l._entitySet,_urlSuffix:l._urlSuffix}}function g(t,e){var a=e.oMainComponent,r=a.getGlobalFilter(),n=r&&r.getAnalyticBindingPath();var i=e.getModel();var o=i.getMetaModel();if(!l.isODataV4(i)){var s=e.getEntityType().name;var u=o.getODataEntityContainer();var f=u.entitySet.filter(function(t){return t.entityType===u.namespace+"."+s});var v=f.length>0?f[0]:{}}else{var s=e.oCardComponentData.settings.entitySet;var u=o.getObject("/");var v=u[s];v.entityType=v.$Type}if(r&&r.getConsiderAnalyticalParameters()){var n=r.getAnalyticBindingPath();var p,d,c;if(n&&n.length>0){if(v.entityType===r.getEntityType()){d=t;p=t.indexOf("$");if(p>0){d=t.substring(0,p-1)}c=n;if(c.startsWith("/")){c=c.slice(1)}if(d!==c){t=t.replace(d,c)}}else{var g=a._getParametersFromEntityPath(t);var h=a._getParametersFromEntityPath(n);var m,y,U;var _={};if(g&&g.length>0){var D=a._getEntityTypeFromPath(i,t,_.context,true);for(var S=0;S<h.length;S++){m=a._getPropertyMapping(g,h[S].name,D.name,r.getEntityType(),i,r.getModel());if(m){y=m+"=.*?[,)]";U=t.match(new RegExp(y));if(U&&U.length>0){d=U[0].slice(0,-1);c=m+"="+h[S].sValue;if(d!==c){t=t.replace(d,c)}}}}}}}}return t}function h(t,e,a,r){var n=t.view.getModel("ovpCardProperties");var l=n&&n.getProperty("/bInsightRTEnabled");var o="";if(l||r){o+=_(t)}else{o+=m(t,e)}var s=p(a,"$filter");if(s.length>0){s=decodeURIComponent(s);s=s.replace("$filter=","");s=!s.startsWith("(")?"("+s+")":s}if(o.length>0&&s.length>0){o=!o.startsWith("(")?"("+o+")":o;o+=" and "}o+=s;if(o.length!==0){return"$filter="+i(o)}return""}function m(t,n){var i=t.cardComponentData.mainComponent;var l=i.getGlobalFilter();var o=l&&l.getUiState();var s=l&&l.determineMandatoryFilterItems();var u=n.parameters._mandatoryODataFilters.value;var f=new e(o&&o.getSelectionVariant());if(!s||s.length===0||(!u||u.length===0)){return""}else{var v=[];for(var p=0;p<u.length;p++){var d=u[p];var c=f.getSelectOption(d);var g=new a(c);var h=g.aFilters&&g.aFilters.length||0;var m=[];for(var y=0;y<h;y++){var U=g.aFilters[y];var _=r.getSingleFilterValue(U,d);if(_.length>0){m.push(_)}}if(m.length>0){var D=m.join(" or ");D="("+D+")";v.push(D)}}return v.length>0?v.join(" and "):""}}function y(t,e){t&&t.forEach(function(t){if(t&&t.getFilters()){y(t.getFilters(),e)}else if(t&&t.getPath()&&e.indexOf(t.getPath())===-1){e.push(t.getPath())}});return e}function U(t,e){if(t&&e){var a=t&&t.property.filter(function(t){return e.indexOf(t.name)>-1})||[];a.forEach(function(t){var e=t.type||"";if(!e.startsWith("Edm")){t.type="Edm."+t.type}})}}function _(t){var e=t.view;var a=e.getController();var r=a.getEntityType(),i=a.oMainComponent.getGlobalFilter(),l=i&&i.getModel(),u=a.getView().getModel("ovpCardProperties"),f=u&&u.getProperty("/entityType"),v=f&&f.name,p=a.oMainComponent.aFilters;if(r&&l&&v){var d=n.getEntityRelevantFilters(r,p,v,l);if(d.length){var c=s.groupFilters(d),g=y(d,[]),h=e&&e.getModel()&&e.getModel().oMetadata;U(r,g);var m=o.createFilterParams(c,h,r);if(m.length){m=m.replace("$filter=","");m=decodeURIComponent(m);return m}return""}}return""}function D(t,e,a,r){var n=t.view;if(!n){return{}}var i=t.cardComponentData.model.sServiceUrl;var o=n.getController();var s=a?o.getKPIBinding():o.getCardItemsBinding();var u=s&&s.sRangeParams||"";if(t.cardComponentName==="List"||t.cardComponentName==="Table"){u="$skip=0&$top=13"}var d=c(t);var m=s&&s.getDownloadUrl()||"";var y;if(m){m=f(m,"sap-client");m=f(m,"_requestFrom");if(!l.isODataV4(n.getModel())){m=m.split(i+"/")[1]}else{m=m.split(i)[1]}m=g(m,o);y=h(t,e,m,r);if(y.length>0){m=f(m,"$filter");m=v(m,y)}var U=p(m,"$inlinecount");if(U.length===0&&(t.cardComponentName==="List"||t.cardComponentName==="Table")&&!l.isODataV4(n.getModel())){var _="$inlinecount=allpages";m=v(m,_)}if(u){m=v(m,u)}}return{sPath:m,_entitySet:d._entitySet,_urlSuffix:d._urlSuffix}}function S(t,e,a){if(!u.headerDataUrlUpdated){var r=this._getRequestUrlAndEntityInfo(t,e,true,a);e["parameters"]["_headerDataUrl"]={value:r.sPath}}if(!u.contentDataUrlUpdated){var n=this._getRequestUrlAndEntityInfo(t,e,false,a)||"";e["parameters"]["_contentDataUrl"]={value:n.sPath}}u.contentDataUrlUpdated=false;u.headerDataUrlUpdated=false}function P(t,e){var a=t.cardComponentData.settings,r=t.entitySet.name||a.entitySet,n={};if(r.endsWith("Results")){r=r.replace("Results","")}if(a.dataPointAnnotationPath||a.kpiAnnotationPath){var i=this._getRequestUrlAndEntityInfo(t,e,true)||"";e["parameters"]["_headerDataUrl"]={value:i.sPath};if(i.sPath){n.header={method:"GET",url:i.sPath,headers:{Accept:"application/json","Accept-Language":"{{parameters.LOCALE}}"},retryAfter:30}}}var l=this._getRequestUrlAndEntityInfo(t,e,false)||"";e["parameters"]["_contentDataUrl"]={value:l.sPath};if(l.sPath){n.content={method:"GET",url:l.sPath,headers:{Accept:"application/json","Accept-Language":"{{parameters.LOCALE}}"}}}if(l._entitySet||l._urlSuffix){e["parameters"]["_entitySet"]=l._entitySet;e["parameters"]["_urlSuffix"]=l._urlSuffix}return n}function C(t){var e=t.configuration.parameters;var a=e._mandatoryODataParameters.value;var r=e._mandatoryODataFilters.value;var n=r.some(function(t){var a=e[t]&&e[t].value;var r=true;if(a&&l.isJSONData(a)){a=JSON.parse(a);var n=a&&a["SelectOptions"];n.forEach(function(t){if(t&&t["Ranges"]&&t["Ranges"].length>0){r=false}});return r}return false});var i=a.some(function(t){return e[t]&&!e[t].value});if(n||i){if(!e._headerDataUrl){e._headerDataUrl={value:""}}if(!e._contentDataUrl){e._contentDataUrl={value:""}}e._headerDataUrl.value="";e._contentDataUrl.value="";u.headerDataUrlUpdated=true;u.contentDataUrlUpdated=true}}function E(t){var e=t&&t.data&&t.data.request,a=t&&t.configuration.parameters._headerDataUrl,n=t&&t.configuration.parameters._contentDataUrl,i=a&&a.value,l=n&&n.value;if(e&&e.batch){var o=e.batch.header||{},s=e.batch.content||{},f=r.IsSemanticDateExistsInUrl(i),v=r.IsSemanticDateExistsInUrl(l);if(f){o.url="{= extension.formatters.formatHeaderDataUrlForSemanticDate() }";a.value="";u.headerDataUrlUpdated=true}if(v){s.url="{= extension.formatters.formatContentDataUrlForSemanticDate() }";n.value="";u.contentDataUrlUpdated=true}}else if(e&&e.url){var p=r.IsSemanticDateExistsInUrl(l);if(p){e.url="{= extension.formatters.formatContentDataUrlForSemanticDate() }";n.value="";u.contentDataUrlUpdated=true}}}function F(t,e){if(!l.isODataV4(e)){return t}else{return t.replace("d/results","value")}}return{_getQueryParam:p,_removeQueryParam:f,_getRequestUrlAndEntityInfo:D,getBatchObject:P,enhanceHeaderAndContentURL:C,updateBatchObject:S,enhanceHeaderAndContentURLForSemanticDate:E,getBatchRequestPath:F}},true);
//# sourceMappingURL=Batch.js.map