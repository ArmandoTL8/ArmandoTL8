sap.ui.define(["sap/ui/core/mvc/Controller","sap/ovp/cards/ActionUtils","sap/fe/navigation/SelectionVariant","sap/fe/navigation/PresentationVariant","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/ui/core/ResizeHandler","sap/ui/core/format/NumberFormat","sap/ovp/cards/v4/V4AnnotationHelper","sap/ui/model/odata/AnnotationHelper","sap/m/MessageBox","sap/ui/generic/app/navigation/service/NavError","sap/ui/core/CustomData","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/MessageToast","sap/ui/generic/app/library","sap/ui/thirdparty/jquery","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/ui/events/KeyCodes","sap/base/util/isPlainObject","sap/base/util/merge","sap/ovp/app/OVPLogger","sap/ovp/cards/jUtils","sap/base/util/isEmptyObject","sap/ovp/cards/Filterhelper","sap/ui/model/odata/v4/AnnotationHelper","sap/ui/util/openWindow","sap/ui/core/Component","sap/ovp/placeholder/placeholderHelper","sap/ui/core/library","sap/ovp/helpers/V4/MetadataAnalyzer","sap/ui/core/Fragment","sap/ovp/app/NavigationHelper"],function(t,e,a,i,r,n,o,s,l,d,p,c,g,v,h,f,u,m,C,jQuery,y,b,I,P,S,D,N,w,O,A,T,k,E,M,V,F,x){"use strict";var L=M.TextDirection;var H=new D("OVP.generic.Card");return t.extend("sap.ovp.cards.v4.generic.Card",{initKeyboardNavigation:function(){var t=function(t){this.init(t)};t.prototype.layoutItemFocusHandler=function(){var t=jQuery(document.activeElement);if(t){var e=t.find("[aria-label]");var a,i="";if(t.find(".valueStateText").length==1){var r=t.find(".valueStateText").find(".sapMObjectNumberText").text();var n=t.find(".valueStateText").find(".sapUiInvisibleText").text();t.find(".valueStateText").attr("aria-label",r+" "+n);t.find(".valueStateText").attr("aria-labelledby","")}t.find("[role='listitem']").attr("aria-label","");if(t.hasClass("sapOvpCardHeader")&&!t.hasClass("sapOvpStackCardContent")){var o="";var s=t.find(".cardHeaderType");if(s.length===0){var l=y.getText("CardHeaderType");o="cardHeaderType_"+(new Date).getTime();var d='<div id="'+o+'" class="cardHeaderType" aria-label="'+l+'" hidden></div>';t.append(d)}else{o=s[0].id}i+=o+" "}for(a=0;a<e.length;a++){if(e[a].getAttribute("role")==="heading"){i+=e[a].id+" "}}if(t.hasClass("sapOvpCardHeader")){var p=t.find(".cardHeaderText");if(p.length!==0){for(var a=0;a<p.length;a++){if(i.indexOf(p[a].id)===-1){i+=p[a].id+" "}}}}if(i.length){t.attr("aria-labelledby",i)}if(t.prop("nodeName")==="LI"&&t.find(".linkListHasPopover").length!==0){if(t.find("#hasDetails").length===0){t.append("<div id='hasDetails' hidden>"+y.getText("HAS_DETAILS")+"</div>");t.attr("aria-describedby","hasDetails")}}var c=t.attr("id");if(c&&c.indexOf("ovpTable")!=-1&&t.find("[role='Link']")&&!t.hasClass("sapUiCompSmartLink")){var g=t.closest("td").attr("data-sap-ui-column"),v=t.closest("tbody").siblings().children().filter("tr").children();for(var a=0;a<v.length;a++){if(v[a].getAttribute("data-sap-ui")==g&&v[a].hasChildNodes("span")){var h=v[a].firstElementChild.getAttribute("id");t.attr("aria-labelledby",h)}}}}};t.prototype.init=function(t){this.cardLayout=t;this.keyCodes=I;this.jqElement=jQuery(t.getView().$());this.jqElement=this.jqElement.parent().parent().parent();this.jqElement.on("focus.keyboardNavigation",this.layoutItemFocusHandler.bind(this))};this.keyboardNavigation=new t(this)},onInit:function(){this.oCardComponent=this.getOwnerComponent();this.oCardComponentData=this.oCardComponent&&this.oCardComponent.getComponentData();this.oMainComponent=this.oCardComponentData&&this.oCardComponentData.mainComponent;this.sCardId=this.oCardComponentData.cardId;var t=this.getView().mPreprocessors.xml[0].ovpCardProperties.oData.state;if(t!=="Error"){var e=this.getView().byId("ovpCardHeader");if(!!e){e.attachBrowserEvent("click",this.onHeaderClick.bind(this));e.addEventDelegate({onkeydown:function(t){if(!t.shiftKey&&t.keyCode==13){t.preventDefault();this.onHeaderClick(t)}else if(!t.shiftKey&&t.keyCode==32){t.preventDefault()}}.bind(this)});e.addEventDelegate({onkeyup:function(t){if(!t.shiftKey&&t.keyCode==32){t.preventDefault();this.onHeaderClick(t)}}.bind(this)})}}var a=this.getView().byId("kpiNumberValue");if(a){a.addEventDelegate({onAfterRendering:function(){var t=a.$();var e=t.find(".sapMNCValueScr");var i=t.find(".sapMNCScale");e.attr("aria-label",e.text());i.attr("aria-label",i.text());var r=this.getView().byId("ovpCardHeader").getDomRef();var n=this.getOwnerComponent().getComponentData();if(!!n&&!!n.appComponent){var o=n.appComponent;if(!!o.getModel("ui")){var s=o.getModel("ui");if(!!s.getProperty("/containerLayout")&&s.getProperty("/containerLayout")==="resizable"){var l=n.appComponent.getDashboardLayoutUtil();if(!!l){l.setKpiNumericContentWidth(r)}}}}}.bind(this)})}},exit:function(){if(this.resizeHandlerId){o.deregister(this.resizeHandlerId)}},onExit:function(){var t=this;this.GloabalEventBus.unsubscribe("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",t.eventhandler)},onAfterRendering:function(){var t=this.getView().byId("ovpCardHeader");var e=t&&t.getDomRef();var a=this.getView().byId("ovpHeaderTitle"),i=this.getView().byId("ovpQuickviewCardHeader");if(e&&!e.getAttribute("ariaLabelledBy")){if(a&&a.getText()){var r=a.getDomRef().getAttribute("id");e.setAttribute("arialabelledby",r)}else if(i&&i.getText()){var s=i.getDomRef().getAttribute("id");e.setAttribute("arialabelledby",s)}}var l=this.getCardPropertiesModel();this.enableClick=true;var d=l.getProperty("/contentFragment");var p=this.getOwnerComponent().getComponentData();var c=l.getProperty("/selectedKey");var g=this.getCardItemsBinding();if(!g&&E.hidePlaceholderNeeded()){E.hidePlaceholder()}if(c&&l.getProperty("/state")!=="Loading"){var v=this.getView().byId("ovp_card_dropdown");if(v){v.setSelectedKey(c)}}try{var p=this.getOwnerComponent().getComponentData();if(p&&p.appComponent){var h=p.appComponent;if(h.getModel("ui")){var f=h.getModel("ui");if(f.getProperty("/containerLayout")==="resizable"){var u=h.getDashboardLayoutUtil();if(u){this.oDashboardLayoutUtil=u;this.cardId=p.cardId;if(u.isCardAutoSpan(p.cardId)){this.resizeHandlerId=o.register(this.getView(),function(t){H.info("DashboardLayout autoSize:"+t.target.id+" -> "+t.size.height);u.setAutoCardSpanHeight(t)})}}}}}}catch(t){H.error("DashboardLayout autoSpan check failed.")}if(this.oDashboardLayoutUtil&&this.oDashboardLayoutUtil.isCardAutoSpan(this.cardId)){var m=jQuery("#"+this.oDashboardLayoutUtil.getCardDomId(this.cardId));if(this.oView.$().outerHeight()>m.innerHeight()){this.oDashboardLayoutUtil.setAutoCardSpanHeight(null,this.cardId,this.oView.$().height())}}var C=0;if(p&&p.mainComponent){var y=p.mainComponent;if(y.bGlobalFilterLoaded){C=!this.checkHeaderNavForChart()&&this.checkNavigation()}}else if(n.checkIfAPIIsUsed(this)){C=this.checkAPINavigation()}var b=this.getCardPropertiesModel();var I=b.getProperty("/state");if(I!=="Loading"&&I!=="Error"){var P=b.getProperty("/template");if(P==="sap.ovp.cards.stack"){if(!C){var S=this.getView().byId("ViewAll");if(S){S=S.getDomRef();S.parentNode.removeChild(S)}}}}if(C){if(d?d!=="sap.ovp.cards.quickview.Quickview":true){if(d==="sap.ovp.cards.stack.Stack"){var D=this.getView().getDomRef();var w=D.querySelectorAll(".sapOvpCardContentRightHeader");if(w.length!==0){N.addClassToAllElements(w,"sapOvpCardNavigable")}}else{this.getView().addStyleClass("sapOvpCardNavigable")}}if(d&&d==="sap.ovp.cards.quickview.Quickview"){var O=this.byId("ovpCardHeader");if(O){O.addStyleClass("sapOvpCardNavigable")}}}else{if(d){this.getView().addStyleClass("ovpNonNavigableItem");var O=this.byId("ovpCardHeader");if(O){O.$().removeAttr("role");O.addStyleClass("ovpNonNavigableItem")}var A=this.checkLineItemNavigation();if(!A){switch(d){case"sap.ovp.cards.v4.list.List":var T=this.getView().byId("listItem");if(T){T.setType("Inactive")}break;case"sap.ovp.cards.v4.table.Table":var T=this.getView().byId("tableItem");if(T){T.setType("Inactive")}break;case"sap.ovp.cards.v4.linklist.LinkList":if(!this.checkNavigationForLinkedList()){var T=this.getView().byId("ovpCLI");if(T){T.setType("Inactive")}}break}}}}var k=this.getView().byId("ovp_card_dropdown");var M=this.getView().byId("ovp_card_dropdown_label");if(k){k.addAriaLabelledBy(M.getId());if(this.getView().getModel("ui").getProperty("/bSelectionChanged")){var V=document.getElementById(v.sId);V&&V.focus();this.getView().getModel("ui").setProperty("/bSelectionChanged",false)}}if(n.checkIfAPIIsUsed(this)){this.initKeyboardNavigation()}this._handleCountHeader();this._handleKPIHeader();if(this.getView()&&this.getView().byId("sapOvpCardAdditionalActions")){this.getView().byId("sapOvpCardAdditionalActions").setEnabled(true)}},checkNavigation:function(){var t=this.getCardPropertiesModel();var e=this.getEntityType();if(e){if(t){var a=t.getProperty("/identificationAnnotationPath");var i=a;var r=t.getProperty("/contentFragment");if(r&&(r==="sap.ovp.cards.stack.Stack"||r==="sap.ovp.cards.quickview.Quickview")){var n=a?a.split(","):[];if(n&&n.length>1){if(r==="sap.ovp.cards.stack.Stack"){i=n[0]}else{i=n[1]}}}var o=e["@"+i];if(this.isNavigationInAnnotation(o)){return 1}if(t&&t.getProperty("/template")==="sap.ovp.cards.charts.analytical"){var s=t.getProperty("/kpiAnnotationPath");if(e&&s){var l=e[s];if(l&&l.Detail){var d=l.Detail.SemanticObject&&l.Detail.SemanticObject.String;var p=l.Detail.Action&&l.Detail.Action.String;if(d&&p){return 1}}}}}}else if(t&&t.getProperty("/template")==="sap.ovp.cards.v4.linklist"&&t.getProperty("/staticContent")&&t.getProperty("/targetUri")){return 1}return 0},checkNavigationForLinkedList:function(){if(this.getEntityType()){var t=this.getEntityType();var e=t["com.sap.vocabularies.UI.v1.LineItem"];if(e&&(e[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||e[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl")){return true}}return false},checkLineItemNavigation:function(){if(this.getEntityType()){var t=this.getEntityType();var e=this.getCardPropertiesModel();if(e){var a=e.getProperty("/annotationPath");var i=t["@"+a];return this.isNavigationInAnnotation(i)}}},isNavigationInAnnotation:function(t){if(t&&t.length){for(var e=0;e<t.length;e++){var a=t[e];if(a.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||a.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"||a.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){return 1}}}return 0},checkAPINavigation:function(){var t=this.getOwnerComponent().getComponentData(),e=t.fnCheckNavigation&&typeof t.fnCheckNavigation==="function",a=e?t.fnCheckNavigation:null;if(a){if(a()){return true}}else{if(!this.checkHeaderNavForChart()&&this.checkNavigation()){return true}}return false},onHeaderClick:function(t){var e=t&&t.target&&t.target.id;if(e&&e.indexOf("sapOvpCardAdditionalActions")>-1){return}var a=t.ctrlKey||t.metaKey?b.constants.explace:b.constants.inplace;if(n.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){r.onHeaderClicked()}}else{var i=this.getCardPropertiesModel();var o=i.getProperty("/template");var s=i.getProperty("/targetUri");if(o=="sap.ovp.cards.v4.linklist"&&i.getProperty("/staticContent")!==undefined&&s){window.location.href=s}else if(i.getProperty("/staticContent")!==undefined&&s===""){return}else if(this.checkHeaderNavForChart()){return}else{this.doNavigation(this.getView().getBindingContext(),null,a)}}},checkHeaderNavForChart:function(){var t=this.getCardPropertiesModel();var e=t.getProperty("/template");var a=t.getProperty("/navigation");if(a=="noHeaderNav"&&(e=="sap.ovp.cards.charts.analytical"||"sap.ovp.cards.charts.smart.chart")){return true}else{return false}},resizeCard:function(t){H.info(t);if(this.resizeHandlerId){o.deregister(this.resizeHandlerId);this.resizeHandlerId=null}},_handleCountHeader:function(){var t=this.getView().byId("ovpCountHeader");if(t){var e=this.getCardItemsBinding();if(e){if(e.getLength()>0){this.setHeaderCounter(e,t)}e.attachDataReceived(function(){if(E.hidePlaceholderNeeded()){E.hidePlaceholder()}this.setHeaderCounter(e,t)}.bind(this));e.attachChange(function(){this.setHeaderCounter(e,t)}.bind(this))}}else{var e=this.getCardItemsBinding();if(e){e.attachDataReceived(function(){if(E.hidePlaceholderNeeded()){E.hidePlaceholder()}})}}},setHeaderCounter:function(t,e){var a=t.getLength();var i=t.getCurrentContexts().length;var r,n="";var o=s.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});i=parseFloat(i,10);var l=this.getOwnerComponent().getComponentData();if(l&&l.appComponent){var d=l.appComponent;if(d.getModel("ui")){var p=d.getModel("ui");if(p.getProperty("/containerLayout")!=="resizable"){if(a!==0){a=o.format(Number(a))}if(i!==0){i=o.format(Number(i))}}else{r=d.getDashboardLayoutUtil().dashboardLayoutModel.getCardById(l.cardId)}}}if(i===0||a===0){n=""}else if(r&&r.dashboardLayout.showOnlyHeader){n=y.getText("Count_Header_Total",[a])}else if(a!=i){n=y.getText("Count_Header",[i,a])}e.setText(n);e.addEventDelegate({onAfterRendering:function(){var t=e.$();t.attr("aria-label",n)}})},_handleKPIHeader:function(){var t,e;if(this.getView()&&this.getView().getDomRef()){t=this.getView().getDomRef().getElementsByClassName("numericContentHbox");e=this.getView().getDomRef().getElementsByClassName("noDataSubtitle")}else{return}if(t||e){var a=this.getKPIBinding();if(a){a.attachDataReceived(function(i){var r=i.getSource().getCurrentContexts().map(function(t){return t&&t.getObject()})[0];var n=a.getLength();if(t[0]){t[0].style.visibility=null;if(n===0){t[0].style.visibility="hidden"}else{this._setSubTitleWithUnitOfMeasure(r);t[0].style.visibility="visible"}}if(e.length!==0){e[0].style.display="none";if(n===0){e[0].style.display="flex"}}}.bind(this))}}},getKPIBinding:function(){var t=this.byId("kpiHBoxNumeric"),e=t&&t.getBindingInfo("items")&&t.getBindingInfo("items").binding;return e},_setSubTitleWithUnitOfMeasure:function(t){var e=this.getCardPropertiesModel();if(!!e){var a=e.getData();var i=this.getView().byId("SubTitle-Text");if(!!i){i.setText(a.subTitle);if(!!a&&!!a.entityType&&!!a.dataPointAnnotationPath){var n=this.getEntityType();var o=a.dataPointAnnotationPath.split("/");var s=o.length===1?n["@"+a.dataPointAnnotationPath]:n["@"+o[0]]["@"+o[1]];var l;if(s&&s.Value&&s.Value.$Path){l=s.Value.$Path}else if(s&&s.Description&&s.Description.Value&&s.Description.Value.$Path){l=s.Description.Value.$Path}var d=this.getMetaModel();var p=this.getEntitySet();var c=V.getEntitySetName(d,p.$Type);if(!!l){var g=r.getUnitColumnForODataV4(l,d,c);var v;if(!!g&&!!t){v=t[g]}else{v=r.getUnitColumnForODataV4(l,d,c,true)}var h=y.getText("SubTitle_IN");if(!!a.subTitle&&!!h&&!!v){i.setText(a.subTitle+" "+h+" "+v);var f=i.getAggregation("customData");if(f){var u;for(u in f){var m=f[u];if(m.getKey()==="aria-label"){m.setValue(a.subTitle+" "+h+" "+v);break}}}}}}}}},getCardItemsBinding:function(){},onActionPress:function(t){var e=t.getSource(),a=this._getActionObject(e),i=e.getBindingContext();if(a.type.indexOf("DataFieldForAction")!==-1){this.doAction(i,a)}else{this.doNavigation(i,a)}},_getActionObject:function(t){var e=t.getCustomData();var a={};for(var i=0;i<e.length;i++){a[e[i].getKey()]=e[i].getValue()}return a},doNavigation:function(t,e,a){if(!a){a=b.constants.inplace}if(!this.enableClick){return}this.enableClick=false;setTimeout(function(){this.enableClick=true}.bind(this),1e3);if(!this.oMainComponent){return}if(!e){e=this.getEntityNavigationEntries(t)[0]}var i=S({},t);var r=S({},e);var n=this.oMainComponent.doCustomNavigation&&this.oMainComponent.doCustomNavigation(this.sCardId,i,r);var o=this.oMainComponent.templateBaseExtension&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation(this.sCardId,i,r);var s;if(n){s=n}if(o){s=o}if(s){var l=s.type;if(l&&typeof l==="string"&&l.length>0){l=l.split(".").pop().split("/").pop().toLowerCase();switch(l){case"datafieldwithurl":s.type="com.sap.vocabularies.UI.v1.DataFieldWithUrl";break;case"datafieldforintentbasednavigation":s.type="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation";break}e=s}}function d(a){if(!a){a=b.constants.inplace}if(e){switch(e.type){case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":this.doNavigationWithUrl(t,e,a);break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":this.doIntentBasedNavigation(t,e,false,a);break;case"com.sap.vocabularies.UI.v1.KPIDetailType":this.doIntentBasedNavigation(t,e,false,a);break}}}if(!this.oMainComponent.oAppStatePromise){d.call(this,a)}else{this.oMainComponent.oAppStatePromise.then(d.bind(this,a))}},doNavigationWithUrl:function(t,e,a){if(!a){a=b.constants.inplace}if(!(sap.ushell&&sap.ushell.Container)){if(e&&e.url){T(e.url,"newWindow")}return}var i=sap.ushell.Container.getService("URLParsing");if(!i.isIntentUrl(e.url)){T(e.url,"newWindow")}else{var r=i.parseShellHash(e.url);var n=r.appSpecificRoute?true:false;this.doIntentBasedNavigation(t,r,n,a)}},fnHandleError:function(t){if(t instanceof c){if(t.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){p.show(y.getText("OVP_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:y.getText("OVP_GENERIC_ERROR_TITLE")})}else{p.show(t.getErrorCode(),{title:y.getText("OVP_GENERIC_ERROR_TITLE")})}}},doCrossApplicationNavigation:function(t,e){var a="#"+t.semanticObject+"-"+t.action;if(t.params){var i=this.oCardComponent&&this.oCardComponent.getComponentData();var r=i&&i.appComponent;if(r){var n=r._formParamString(t.params);a=a+n}}var o=this;if(!sap.ushell.Container){return}sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported([a]).done(function(t){if(t[a].supported===true){if(!!e.params){if(typeof e.params=="string"){try{e.params=JSON.parse(e.params)}catch(t){H.error("Could not parse the Navigation parameters");return}}}var i=o.getOwnerComponent().getComponentData();var r=i?i.globalFilter:undefined;var n=r&&r.getUiState({allFilters:false});var s=n?JSON.stringify(n.getSelectionVariant()):"{}";r=JSON.parse(s);var l=o._getFilterPreference();r=o._removeFilterFromGlobalFilters(l,r);if(!e.params){e.params={}}if(!!r&&!!r.SelectOptions){for(var d=0;d<r.SelectOptions.length;d++){var p=r.SelectOptions[d].Ranges;if(!!p){var g=[];for(var v=0;v<p.length;v++){if(p[v].Sign==="I"&&p[v].Option==="EQ"){g.push(p[v].Low)}}e.params[r.SelectOptions[d].PropertyName]=g}}}sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(e)}else{var h=new c("NavigationHandler.isIntentSupported.notSupported");o.fnHandleError(h)}}).then(function(){H.error("Could not get authorization from isIntentSupported")})},doIntentBasedNavigation:function(t,e,a,i){if(!i){i=b.constants.inplace}var n=this.oCardComponent&&this.oCardComponent.getComponentData();if(n&&n.appComponent&&n.appComponent.ovpConfig&&n.appComponent.ovpConfig.isTeamsModeActive){i=b.constants.explace}if(sap.ushell&&!sap.ushell.Container){return}var o,s,l,d=t?t.getObject():null;var p=this.getCardPropertiesModel(),c=p.getProperty("/customParams");if(t&&typeof t.getAllData==="function"&&c){l=t.getAllData()}else if(p.getProperty("/staticContent")){l={iStaticLinkListIndex:e.iStaticLinkListIndex,bStaticLinkListIndex:true}}if(d&&d.__metadata){delete d.__metadata}var g=r.getNavigationHandler();if(g){if(e){o=this._getEntityNavigationParameters(d,l,t);s={target:{semanticObject:e.semanticObject,action:e.action},appSpecificRoute:e.appSpecificRoute,params:o.sNavSelectionVariant};var v={};if(o.sNavPresentationVariant){v.presentationVariant=o.sNavPresentationVariant}if(a){if(e&&e.semanticObject&&e.action){var h=this.getCardPropertiesModel().getProperty("/staticParameters");s.params=!!h?h:{};this.doCrossApplicationNavigation(e,s)}}else{g.navigate(s.target.semanticObject,s.target.action,s.params,null,this.fnHandleError,v,i)}}}},doAction:function(t,a){this.actionData=e.getActionInfo(t,a,this.getEntityType());if(this.actionData.allParameters.length>0){this._loadParametersForm()}else{this._callFunction()}},getEntityNavigationEntries:function(t,e){var a=[];var i=this.getEntityType();var r=this.getCardPropertiesModel();var n=r.getProperty("/template");if(!i){return a}if(!e&&!t){if(!this.oCardComponentData.settings.identificationAnnotationPath){var o=r.getProperty("/kpiAnnotationPath");if(o&&n==="sap.ovp.cards.charts.analytical"){e=o;var s=i[e];var d=s&&s.Detail;var p=d.SemanticObject&&d.SemanticObject.String;var c=d.Action&&d.Action.String;if(d.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){if(p&&c){a.push({type:d.RecordType,semanticObject:p,action:c,label:""})}else{H.error("Invalid Semantic object and action configured for annotation "+d.RecordType)}}}}}if(!e){var v=r.getProperty("/identificationAnnotationPath");var h=v?v.split(","):[];if(h&&h.length>1){e=h[0]}else{e=v}}var f=i["@"+e];if(Array.isArray(f)){f=l.sortCollectionByImportance(f);for(var u=0;u<f.length;u++){if(f[u].$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){a.push({type:f[u].$Type,semanticObject:f[u].SemanticObject,action:f[u].Action,label:f[u].Label?f[u].Label:null})}if(f[u].$Type==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!f[u].Url.UrlRef){var m=this.getView().getModel();var C=m.getMetaModel();var y;if(t){y=t.getInterface(0).getPath()}else{y="/"+r.getInterface().getData().entitySet}var b=C.createBindingContext(y);var I=A.format(f[u].Url,{context:b});var P=new g({key:"url",value:I});if(t&&n==="sap.ovp.cards.charts.analytical"){m=t.getModel()}P.setModel(m);P.setBindingContext(t);var S=P.getValue();a.push({type:f[u].$Type,url:S,value:f[u].Value,label:f[u].Label?f[u].Label:null})}}}return a},getModel:function(){if(this.getView()){return this.getView().getModel()}},getMetaModel:function(){if(this.getModel()){return this.getModel().getMetaModel()}},getCardPropertiesModel:function(){if(!this.oCardPropertiesModel||w(this.oCardPropertiesModel)){this.oCardPropertiesModel=this.getView().getModel("ovpCardProperties")}return this.oCardPropertiesModel},getEntitySet:function(){if(!this.entitySet){var t=this.getCardPropertiesModel().getProperty("/entitySet");this.entitySet=this.getMetaModel()&&this.getMetaModel().getObject("/"+t)}return this.entitySet},getEntityType:function(){if(!this.entityType){var t=this.getMetaModel();var e=this.getEntitySet();if(t&&e){var a=t.getData().$Annotations[e.$Type];var i={property:t.getObject("/"+e.$Type+"/")};this.entityType=b.merge(true,{},a,i)}}return this.entityType},getCardContentContainer:function(){if(!this.cardContentContainer){this.cardContentContainer=this.getView().byId("ovpCardContentContainer")}return this.cardContentContainer},_processCustomParameters:function(t,e,a){var i=this.getCardPropertiesModel();if(!this.oMainComponent||!i){return}var r;if(t&&t.bStaticLinkListIndex){var n=i.getProperty("/staticContent");r=n[t.iStaticLinkListIndex]["customParams"];t=null}else{r=i.getProperty("/customParams")}if(!r||!this.oMainComponent.templateBaseExtension.provideCustomParameter||!this.oMainComponent.onCustomParams){return}var o=this.oMainComponent.templateBaseExtension.provideCustomParameter(r)?this.oMainComponent.templateBaseExtension.provideCustomParameter(r):this.oMainComponent.onCustomParams(r);if(!o||!N.checkIfFunction(o)){return}var s=S({},t);var l=S({},e);var d=o(s,l);if(!d||!Array.isArray(d)&&!P(d)){return}var p=P(d);if(p&&w(d)){return}var c=p&&(d.bIgnoreEmptyString||d.ignoreEmptyString);var g=p?d.aSelectionVariant||d.selectionVariant:d;if(!Array.isArray(g)){return}var v,h,f,u,m,C;h=g.length;for(v=0;v<h;v++){f=g[v];if(!f){continue}u=f.path;m=f.value1;C=f.value2;if(!u||typeof u!=="string"||u===""){H.error("Custom Variant property path '"+u+"' should be valid string");continue}if(!(m||m===0||m===false||m===""||m===""&&c)){continue}m=m.toString();C=C&&C.toString();if(m===""&&c){e.removeSelectOption(u)}if(t){delete t[u]}if(a){delete a[u]}e.addSelectOption(u,f.sign,f.operator,m,C)}if(c){this._removeEmptyStringsFromSelectionVariant(e)}return c},_getEntityNavigationParameters:function(t,e,n){var o={};var s,d,p;var c=this.getOwnerComponent().getComponentData();var g=c?c.globalFilter:undefined;var h=this.getCardPropertiesModel();var f=h&&h.getProperty("/staticContent");if(!f){var u=l.getCardSelections(this.getCardPropertiesModel());var m=u.filters;var y=u.parameters;var b=this.getEntityType();m&&m.forEach(function(t){t.path=t.path.replace("/",".");switch(t.operator){case v.NE:t.operator=v.EQ;t.sign="E";break;case v.Contains:t.operator="CP";var e=t.value1;t.value1="*"+e+"*";break;case v.EndsWith:t.operator="CP";var e=t.value1;t.value1="*"+e;break;case v.StartsWith:t.operator="CP";var e=t.value1;t.value1=e+"*"}});u.filters=m;if(n&&t&&t.hasOwnProperty("$isOthers")){var I=n.getOtherNavigationDimensions();for(var P in I){var S=I[P];for(var D=0;D<S.length;D++){u.filters.push({path:P,operator:"EQ",value1:S[D],sign:"E"})}}}y&&y.forEach(function(t){t.path=t.path.replace("/",".")});u.parameters=y;var N=l.getCardSorters(this.getCardPropertiesModel());if(t){var P,w=b&&b.property&&Object.keys(b.property);for(var D=0;D<w.length;D++){if(w[D].startsWith("$")){continue}P=w[D];var O=t[P];if(t.hasOwnProperty(P)){if(Array.isArray(t[P])&&t[P].length===1){o[P]=t[P][0]}else if(jQuery.type(O)!=="object"){o[P]=O}}}}var A=h&&h.getProperty("/kpiAnnotationPath");var T=h&&h.getProperty("/template");if(A&&T==="sap.ovp.cards.charts.analytical"){var k=b[A];var E=k&&k.Detail;if(E&&E.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){o["kpiID"]=k.ID.String}}d=N&&new i(N);s=this._buildSelectionVariant(g,u);p=h&&h.getProperty("/staticParameters")}else{var M=g&&g.getUiState({allFilters:false});var V=M?JSON.stringify(M.getSelectionVariant()):"{}";s=new a(V);var F=this._getFilterPreference();s=this._removeFilterFromGlobalFilters(F,s);if(f[e.iStaticLinkListIndex].params){p=f[e.iStaticLinkListIndex].params}else if(f[e.iStaticLinkListIndex].staticParameters){p=f[e.iStaticLinkListIndex].staticParameters}}var x;if(e&&!e.bStaticLinkListIndex){x=this._processCustomParameters(e,s,o)}else if(e&&e.bStaticLinkListIndex){x=this._processCustomParameters(e,s)}else{x=this._processCustomParameters(o,s)}var L=x?C.navigation.service.SuppressionBehavior.ignoreEmptyString:undefined;if(p){for(var P in p){if(!o.hasOwnProperty(P)){o[P]=p[P]}}}var H=r.getNavigationHandler();var _=H&&H.mixAttributesAndSelectionVariant(o,s.toJSONString(),L);if(!f){this._removeSensitiveAttributesFromNavSelectionVariant(b,_)}return{sNavSelectionVariant:_?_.toJSONString():null,sNavPresentationVariant:d?d.toJSONString():null}},_removeSensitiveAttributesFromNavSelectionVariant:function(t,e){for(var a=0;a<t.property.length;a++){if(t.property[a]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]&&t.property[a]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]){e.removeSelectOption(t.property[a].name)}}},_removeEmptyStringsFromSelectionVariant:function(t){var e=t.getParameterNames();for(var a=0;a<e.length;a++){if(t.getParameter(e[a])===""){t.removeParameter(e[a])}}var i=t.getSelectOptionsPropertyNames();for(a=0;a<i.length;a++){var r=t.getSelectOption(i[a]);for(var n=0;n<r.length;n++){if(r[n].Low===""&&!r[n].High){r.splice(n,1);n--}}if(r.length===0){t.removeSelectOption(i[a])}}return t},_checkIfCardFiltersAreValid:function(t,e){var a=true;if(t&&t.filterAll==="global"){a=false}else if(t&&t.globalFilter){if(t.globalFilter.indexOf(e)>=0){a=false}}return a},_getFilterPreference:function(){var t=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;var e;if(t&&t.mainComponent){e=t.mainComponent._getFilterPreference(t.cardId)}return e},_removeFilterFromGlobalFilters:function(t,e){var a=[];if(t&&t.filterAll==="card"){a=e.getSelectOptionsPropertyNames()}else if(t&&t.cardFilter){a=t.cardFilter}a.forEach(function(t){if(t!=="$.basicSearch"){e.removeSelectOption(t)}});return e},_buildSelectionVariant:function(t,e){var i=t&&t.getUiState({allFilters:false});var r=i?JSON.stringify(i.getSelectionVariant()):"{}";var n=new a(r);var o,s,l,d;var p=this._getFilterPreference();n=this._removeFilterFromGlobalFilters(p,n);var c=e.filters;var g=e.parameters;for(var v=0;v<c.length;v++){o=c[v];if(o.path&&o.operator&&typeof o.value1!=="undefined"){s=o.value1.toString();l=typeof o.value2!=="undefined"?o.value2.toString():undefined;if(this._checkIfCardFiltersAreValid(p,o.path)){n.addSelectOption(o.path,o.sign,o.operator,s,l)}}}var h,f,u;for(var m=0;m<g.length;m++){d=g[m];if(!d.path||!d.value){continue}h=d.path.split("/").pop();h=h.split(".").pop();if(h.indexOf("P_")===0){f=h;u=h.substr(2)}else{f="P_"+h;u=h}if(n.getParameter(f)){continue}if(n.getParameter(u)){continue}n.addParameter(h,d.value)}return n},_loadParametersForm:function(){var t=new h;t.setData(this.actionData.parameterData);var a=this;var i=new f("ovpCardActionDialog",{title:this.actionData.sFunctionLabel,afterClose:function(){i.destroy()}}).addStyleClass("sapUiNoContentPadding");var r=new u({text:this.actionData.sFunctionLabel,press:function(t){var r=e.getParameters(t.getSource().getModel(),a.actionData.oFunctionImport);i.close();a._callFunction(r,a.actionData.sFunctionLabel)}});var n=new u({text:"Cancel",press:function(){i.close()}});i.setBeginButton(r);i.setEndButton(n);var o=function(t){var i=e.mandatoryParamsMissing(t.getSource().getModel(),a.actionData.oFunctionImport);r.setEnabled(!i)};var s=e.buildParametersForm(this.actionData,o);i.addContent(s);i.setModel(t);i.open()},_callFunction:function(t,e){var a={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:t,forceSubmit:true,context:this.actionData.oContext,functionImport:this.actionData.oFunctionImport};var i=this;var n=new Promise(function(t,r){var n=i.actionData.oContext.getModel();var o;o="/"+a.functionImport.name;n.callFunction(o,{method:a.functionImport.httpMethod,urlParameters:a.urlParameters,batchGroupId:a.batchGroupId,changeSetId:a.changeSetId,headers:a.headers,success:function(e,a){t(a)},error:function(t){t.actionText=e;r(t)}})});n.then(function(t){return m.show(y.getText("Toast_Action_Success"),{duration:1e3})},function(t){var e=r.showODataErrorMessages(t);if(e===""&&t.actionText){e=y.getText("Toast_Action_Error")+' "'+t.actionText+'"'+"."}return p.error(e,{title:y.getText("OVP_GENERIC_ERROR_TITLE"),onClose:null,styleClass:"",initialFocus:null,textDirection:L.Inherit})})},setErrorState:function(){var t=this.getOwnerComponent();if(!t||!t.oContainer){return}var e=t.oContainer;var a=this.getCardPropertiesModel();var i={name:"sap.ovp.cards.loading",componentData:{model:this.getView().getModel(),settings:{category:a.getProperty("/category"),title:a.getProperty("/title"),description:a.getProperty("/description"),entitySet:a.getProperty("/entitySet"),state:b.loadingState.ERROR,template:a.getProperty("/template")}}};k.create(i).then(function(a){e.setComponent(a);setTimeout(function(){t.destroy()},0)})},changeSelection:function(t,e,a){if(!e){var i=this.getView().byId("ovp_card_dropdown");t=parseInt(i.getSelectedKey(),10);if(this.getView()){this.getView().getModel("ui").setProperty("/bSelectionChanged",true)}}var r={};if(!e){r=this.getCardPropertiesModel().getProperty("/tabs")[t-1]}else{r=a.tabs[t-1]}var o={cardId:this.getOwnerComponent().getComponentData().cardId,selectedKey:t};for(var s in r){o[s]=r[s]}if(n.checkIfAPIIsUsed(this)){n.recreateCard(o,this.getOwnerComponent().getComponentData())}else{this.getOwnerComponent().getComponentData().mainComponent.recreateCard(o);this.getOwnerComponent().getComponentData().mainComponent.setOrderedCardsSelectedKey(this.getOwnerComponent().getComponentData().cardId,t)}},getItemHeight:function(t,e,a){if(!!t){var i=t.getView().byId(e);var r=0;if(!!i){if(a){if(i.getItems()[0]&&i.getItems()[0].getDomRef()){r=N.getOuterHeight(i.getItems()[0].getDomRef())}}else{if(i.getDomRef()){r=N.getOuterHeight(i.getDomRef())}}}return r}},getHeaderHeight:function(){var t=this.getItemHeight(this,"ovpCardHeader"),e=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;if(e&&e.appComponent){var a=e.appComponent.getDashboardLayoutUtil(),i=a.getDashboardLayoutModel().getCardById(e.cardId);if(t!==0){i.dashboardLayout.headerHeight=t}}return t},onShowAdditionalCardActions:function(t){var e=t.getSource();t.cancelBubble();if(!this.additionalCardActionsMenu){this.additionalCardActionsMenu=F.load({id:this.getView().getId(),name:"sap.ovp.cards.generic.HeaderActions",controller:this}).then(function(t){this.getView().addDependent(t);return t}.bind(this))}var a=this;this.additionalCardActionsMenu.then(function(t){var i=a.getView(),r=i.byId("ovpAddToInsightButton"),n=r&&r.getEnabled();if(!n&&a.bdataLoadedToEnableAddToInsight){r.setEnabled(true)}t.openBy(e)})},checkIBNNavigationExistsForCard:function(){var t=this.getCardPropertiesModel(),e=this.getEntityType(),a=t.getProperty("/contentFragment"),i=this.getView().getModel();if(t&&e&&a){if(a==="sap.ovp.cards.v4.list.List"||a==="sap.ovp.cards.v4.table.Table"){var r=x.checkIdentificationAnnotationNavigation(t,e,i),n=x.checkLineItemNavigation(t,e,i);return r||n}if(a==="sap.ovp.cards.v4.charts.analytical.analyticalChart"){var o=x.checkHeaderNavForChart(t),s=x.checkIdentificationAnnotationNavigation(t,e,i),l=x.checkKPIAnnotationNavigation(t,e),r=o&&s;return r||s||l}}return false},saveGeneratedCardManifest:function(t){var e=this.oCardComponentData.cardId,a=this.oCardComponentData.settings.selectedKey,i=this.getView(),r=i.getModel("ovpCardProperties"),n=r&&r.getProperty("/bInsightDTEnabled");if(n){var o=a?e+"/tab_"+a:e;jQuery.ajax({type:"POST",url:"/editor/card/"+o+"/manifest",headers:{"Content-Type":"application/json"},data:JSON.stringify(t),success:function(t){H.info("Success:",t)},error:function(t){H.error("Error:",t)}})}},refreshCardContent:function(){if(this.getKPIBinding()){this.getKPIBinding().refresh()}if(this.getCardItemsBinding()){this.getCardItemsBinding().refresh()}},onCardManage:function(t){this.oMainComponent._onManageCardsMenuButtonPress()}})});
//# sourceMappingURL=Card.controller.js.map